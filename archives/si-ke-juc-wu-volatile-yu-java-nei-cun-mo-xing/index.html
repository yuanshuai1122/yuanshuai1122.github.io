<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="en">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:title" content="死磕juc（五）volatile与Java内存模型" />
<meta property="og:description" content="volatile与Java内存模型 一、被volatile修改的变量有2大特点 1.1 特点 可见性 有序性 1.2 volatile的内存语义 当写一个volat" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanshuai1122.github.io/archives/si-ke-juc-wu-volatile-yu-java-nei-cun-mo-xing/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-08-29T12:35:28+00:00" />
<meta property="article:modified_time" content="2022-08-29T12:35:28+00:00" />
<title>死磕juc（五）volatile与Java内存模型</title>

    <link rel="canonical" href="/archives/si-ke-juc-wu-volatile-yu-java-nei-cun-mo-xing/">

    <link rel="stylesheet" href="/css/global.css">

    <link rel="stylesheet" href="/css/custom.css">

    <link rel="stylesheet" href="/css/search.css" />

    
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/ " class="nav-title">iTheme</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="/posts " class="nav-item-content">Articles</a>
          </div><div class="nav-item-wrapper">
            <a href="/about" class="nav-item-content">About</a>
          </div><div class="nav-item-wrapper">
            <a href="/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yuanshuai1122.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        juc
                      
                    
                  </span>
                  <span class="category-eyebrow__date">August 29, 2022</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">死磕juc（五）volatile与Java内存模型</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="/tags/juc" class="tag">
                    juc
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            
<div class="component-content pagebody component">
  <h1 id="volatile与java内存模型" class="pagebody-header">
    volatile与Java内存模型
  </h1>
</div>
<div class="component-content pagebody component">
  <h2 id="一被volatile修改的变量有2大特点" class="pagebody-header">
    一、被volatile修改的变量有2大特点
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="11-特点" class="pagebody-header">
    1.1 特点
  </h3>
</div><div class="component-content component"><ul>
<li>可见性</li>
<li>有序性</li>
</ul></div>

<div class="component-content pagebody component">
  <h3 id="12-volatile的内存语义" class="pagebody-header">
    1.2 volatile的内存语义
  </h3>
</div><div class="component-content component"><ul>
<li>当写一个volatile变量时，JMM会把该线程对应的本地内存中的共享变量值立即刷新回主内存中。</li>
<li>当读一个volatile变量时，JMM会把该线程对应的本地内存设置为无效，直接从主内存中读取共享变量</li>
<li>所以volatile的写内存语义是直接刷新到主内存中，读的内存语义是直接从主内存中读取。</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="二内存屏障" class="pagebody-header">
    二、内存屏障
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="21-是什么" class="pagebody-header">
    2.1 是什么
  </h3>
</div><p class="component-content component">内存屏障（也称内存栅栏，内存栅障，屏障指令等，是一类同步屏障指令，是CPU或编译器在对内存随机访问的操作中的一个同步点，使得此点之前的所有读写操作都执行后才可以开始执行此点之后的操作），避免代码重排序。内存屏障其实就是一种JVM指令，Java内存模型的重排规则会要求Java编译器在生成JVM指令时插入特定的内存屏障指令，通过这些内存屏障指令，volatile实现了Java内存模型中的可见性和有序性，但volatile无法保证原子性。</p>
<p class="component-content component">内存屏障之前的所有写操作都要回写到主内存，内存屏障之后的所有读操作都能获得内存屏障之前的所有写操作的最新结果(实现了可见性)。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-59bcce6bfb2bfb1c445e2a7a271ff5d6" id="lht59bcce6bfb2bfb1c445e2a7a271ff5d6">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291227645.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">因此重排序时，不允许把内存屏障之后的指令重排序到内存屏障之前。</p>
<p class="component-content component">一句话：对一个 volatile 域的写, happens-before 于任意后续对这个 volatile 域的读，也叫写后读。</p>

<div class="component-content pagebody component">
  <h3 id="22-volatile凭什么可以保证可见性和有序性" class="pagebody-header">
    2.2 volatile凭什么可以保证可见性和有序性？
  </h3>
</div><blockquote>
<p class="component-content component">内存屏障 (Memory Barriers / Fences)</p>
</blockquote>

<div class="component-content pagebody component">
  <h3 id="23-jvm中提供了四类内存屏障指令" class="pagebody-header">
    2.3 JVM中提供了四类内存屏障指令
  </h3>
</div>
<div class="component-content pagebody component">
  <h4 id="231-c源码分析" class="pagebody-header">
    2.3.1 C++源码分析
  </h4>
</div><p class="component-content component">IDEA工具里面找Unsafe.class</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-c1dd60206a40fd832532e99fbd80834f" id="lhtc1dd60206a40fd832532e99fbd80834f">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291227949.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">Unsafe.java</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-f7659210fd0abce128798b02de4c6f2d" id="lhtf7659210fd0abce128798b02de4c6f2d">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291227097.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">Unsafe.cpp</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-dd53cbb805362626ca463eebaee60cc6" id="lhtdd53cbb805362626ca463eebaee60cc6">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291227001.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">OrderAccess.hpp</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-bfe6d0841efe765c0380552020a71135" id="lhtbfe6d0841efe765c0380552020a71135">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291227852.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">orderAccess_linux_x86.inline.hpp</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-aca038eb5d28f509a47a7461e2721c20" id="lhtaca038eb5d28f509a47a7461e2721c20">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291227924.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h4 id="232-四大屏障分别是什么意思" class="pagebody-header">
    2.3.2 四大屏障分别是什么意思
  </h4>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-99b2e18a433abb3196b9678fc89fb08b" id="lht99b2e18a433abb3196b9678fc89fb08b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291227256.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h4 id="233-happens-before-之-volatile-变量规则" class="pagebody-header">
    2.3.3 happens-before 之 volatile 变量规则
  </h4>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-6f71c71b7e16ef0e8a6c03c187e407ec" id="lht6f71c71b7e16ef0e8a6c03c187e407ec">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291227356.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><table>
<thead>
<tr>
<th>当第一个操作为volatile读时，不论第二个操作是什么，都不能重排序。这个操作保证了volatile读之后的操作不会被重排到volatile读之前。</th>
</tr>
</thead>
<tbody>
<tr>
<td>当第二个操作为volatile写时，不论第一个操作是什么，都不能重排序。这个操作保证了volatile写之前的操作不会被重排到volatile写之后。</td>
</tr>
<tr>
<td>当第一个操作为volatile写时，第二个操作为volatile读时，不能重排。</td>
</tr>
</tbody>
</table></div>

<div class="component-content pagebody component">
  <h4 id="234-jmm-就将内存屏障插策略分为-4-种" class="pagebody-header">
    2.3.4 JMM 就将内存屏障插⼊策略分为 4 种
  </h4>
</div><blockquote>
<p class="component-content component">写</p>
</blockquote>
<div class="component-content component"><ol>
<li>在每个 volatile 写操作的前⾯插⼊⼀个 StoreStore 屏障</li>
<li>在每个 volatile 写操作的后⾯插⼊⼀个 StoreLoad 屏障</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-8061e9dde6e6352ec73cb7e9c022fba9" id="lht8061e9dde6e6352ec73cb7e9c022fba9">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291227599.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-c167dcc641fb3fac16e2ba1ba8a0d667" id="lhtc167dcc641fb3fac16e2ba1ba8a0d667">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291228836.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component">读</p>
</blockquote>
<ol start="3">
<li>在每个 volatile 读操作的后⾯插⼊⼀个 LoadLoad 屏障</li>
<li>在每个 volatile 读操作的后⾯插⼊⼀个 LoadStore 屏障</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-d15e38ae08abbc719a89bf3f4b846001" id="lhtd15e38ae08abbc719a89bf3f4b846001">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291228878.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-72c97646a92dabb28108e3a97b55f8db" id="lht72c97646a92dabb28108e3a97b55f8db">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291228597.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="三volatile特性" class="pagebody-header">
    三、volatile特性
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="31-保证可见性" class="pagebody-header">
    3.1 保证可见性
  </h3>
</div>
<div class="component-content pagebody component">
  <h4 id="311-说明" class="pagebody-header">
    3.1.1 说明
  </h4>
</div><p class="component-content component">保证不同线程对这个变量进行操作时的可见性，即变量一旦改变所有线程立即可见</p>

<div class="component-content pagebody component">
  <h4 id="312-code" class="pagebody-header">
    3.1.2 Code
  </h4>
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VolatileSeeDemo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span>          <span style="color:#66d9ef">boolean</span> flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>       <span style="color:#75715e">//不加volatile，没有可见性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">//static volatile boolean flag = true;       //加了volatile，保证可见性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34;\t come in&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>flag<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()+</span><span style="color:#e6db74">&#34;\t flag被修改为false,退出.....&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">},</span><span style="color:#e6db74">&#34;t1&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//暂停2秒钟后让main线程修改flag值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span><span style="color:#ae81ff">2</span><span style="color:#f92672">);</span> <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;main线程修改完成&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">不加volatile，没有可见性，程序无法停止</p>
<p class="component-content component">加了volatile，保证可见性，程序可以停止</p>

<div class="component-content pagebody component">
  <h4 id="313-上述代码原理解释" class="pagebody-header">
    3.1.3 上述代码原理解释
  </h4>
</div><p class="component-content component">线程t1中为何看不到被主线程main修改为false的flag的值？</p>
<p class="component-content component">问题可能:</p>
<div class="component-content component"><ol>
<li>主线程修改了flag之后没有将其刷新到主内存，所以t1线程看不到。</li>
<li>主线程将flag刷新到了主内存，但是t1一直读取的是自己工作内存中flag的值，没有去主内存中更新获取flag最新的值。</li>
</ol></div>
<p class="component-content component">我们的诉求：
1.线程中修改了工作内存中的副本之后，立即将其刷新到主内存；
2.工作内存中每次读取共享变量时，都去主内存中重新读取，然后拷贝到工作内存。</p>
<p class="component-content component">解决：
使用volatile修饰共享变量，就可以达到上面的效果，被volatile修改的变量有以下特点：</p>
<div class="component-content component"><ol>
<li>线程中读取的时候，每次读取都会去主内存中读取共享变量最新的值，然后将其复制到工作内存</li>
<li>线程中修改了工作内存中变量的副本，修改之后会立即刷新到主内存</li>
</ol></div>

<div class="component-content pagebody component">
  <h4 id="314-volatile变量的读写过程" class="pagebody-header">
    3.1.4 volatile变量的读写过程
  </h4>
</div><p class="component-content component">Java内存模型中定义的8种工作内存与主内存之间的原子操作</p>
<p class="component-content component">read(读取)→load(加载)→use(使用)→assign(赋值)→store(存储)→write(写入)→lock(锁定)→unlock(解锁)</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-e2b25acd3f1cce0d133a4f7439f8788d" id="lhte2b25acd3f1cce0d133a4f7439f8788d">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291228532.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">read: 作用于主内存，将变量的值从主内存传输到工作内存，主内存到工作内存</p>
<p class="component-content component">load: 作用于工作内存，将read从主内存传输的变量值放入工作内存变量副本中，即数据加载</p>
<p class="component-content component">use: 作用于工作内存，将工作内存变量副本的值传递给执行引擎，每当JVM遇到需要该变量的字节码指令时会执行该操作</p>
<p class="component-content component">assign: 作用于工作内存，将从执行引擎接收到的值赋值给工作内存变量，每当JVM遇到一个给变量赋值字节码指令时会执行该操作</p>
<p class="component-content component">store: 作用于工作内存，将赋值完毕的工作变量的值写回给主内存</p>
<p class="component-content component">write: 作用于主内存，将store传输过来的变量值赋值给主内存中的变量</p>
<p class="component-content component">由于上述只能保证单条指令的原子性，针对多条指令的组合性原子保证，没有大面积加锁，所以，JVM提供了另外两个原子指令：</p>
<p class="component-content component">lock: 作用于主内存，将一个变量标记为一个线程独占的状态，只是写时候加锁，就只是锁了写变量的过程。</p>
<p class="component-content component">unlock: 作用于主内存，把一个处于锁定状态的变量释放，然后才能被其他线程占用</p>

<div class="component-content pagebody component">
  <h3 id="32-没有原子性" class="pagebody-header">
    3.2 没有原子性
  </h3>
</div>
<div class="component-content pagebody component">
  <h4 id="321-volatile变量的复合操作如i不具有原子性" class="pagebody-header">
    3.2.1 volatile变量的复合操作(如i++)不具有原子性
  </h4>
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyNumber</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> number <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addPlusPlus</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        number<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VolatileNoAtomicDemo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> InterruptedException
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        MyNumber myNumber <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> MyNumber<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;=</span><span style="color:#ae81ff">10</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> j <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span> j <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">1000</span><span style="color:#f92672">;</span> j<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                    myNumber<span style="color:#f92672">.</span><span style="color:#a6e22e">addPlusPlus</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">},</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">valueOf</span><span style="color:#f92672">(</span>i<span style="color:#f92672">)).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//暂停几秒钟线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span><span style="color:#ae81ff">3</span><span style="color:#f92672">);</span> <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;\t&#34;</span> <span style="color:#f92672">+</span> myNumber<span style="color:#f92672">.</span><span style="color:#a6e22e">number</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">从i++的字节码角度说明</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-44e63bc1490968da07731967d779b488" id="lht44e63bc1490968da07731967d779b488">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291228582.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">原子性指的是一个操作是不可中断的，即使是在多线程环境下，一个操作一旦开始就不会被其他线程影响。
public void add(){
i++; //不具备原子性，该操作是先读取值，然后写回一个新值，相当于原来的值加上1，分3步完成
}
如果第二个线程在第一个线程读取旧值和写回新值期间读取i的域值，那么第二个线程就会与第一个线程一起看到同一个值，并执行相同值的加1操作，这也就造成了线程安全失败，因此对于add方法必须使用synchronized修饰，以便保证线程安全.</p>
<p class="component-content component">读取赋值一个普通变量的情况</p>
<p class="component-content component">当线程1对主内存对象发起read操作到write操作第一套流程的时间里，线程2随时都有可能对这个主内存对象发起第二套操作</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-4480bd6364ccb69659bfbffd0a9a151d" id="lht4480bd6364ccb69659bfbffd0a9a151d">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291228758.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h4 id="322-既然一修改就是可见为什么还不能保证原子性" class="pagebody-header">
    3.2.2 既然一修改就是可见，为什么还不能保证原子性？
  </h4>
</div><p class="component-content component">volatile主要是对其中部分指令做了处理</p>
<blockquote>
<p class="component-content component">要use(使用)一个变量的时候必需load(载入），要载入的时候必需从主内存read(读取）这样就解决了读的可见性。</p>
<p class="component-content component">写操作是把assign和store做了关联(在assign(赋值)后必需store(存储))。store(存储)后write(写入)。</p>
<p class="component-content component">也就是做到了给一个变量赋值的时候一串关联指令直接把变量值写到主内存。</p>
<p class="component-content component">就这样通过用的时候直接从主内存取，在赋值到直接写回主内存做到了内存可见性。注意蓝色框框的间隙。。。。。。o(╥﹏╥)o</p>
</blockquote>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-3b76afffd0062e3d2088a4c9a40cbc2c" id="lht3b76afffd0062e3d2088a4c9a40cbc2c">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291228155.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-ce4e6ca5c2ab7a8d06e39829ec27007e" id="lhtce4e6ca5c2ab7a8d06e39829ec27007e">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291228916.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h4 id="323-结论" class="pagebody-header">
    3.2.3 结论
  </h4>
</div><p class="component-content component">读取赋值一个volatile变量的情况</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-4817544f67f615805c5c51c0959fbc0a" id="lht4817544f67f615805c5c51c0959fbc0a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291228152.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component">read-load-use 和 assign-store-write 成为了两个不可分割的原子操作，但是在use和assign之间依然有极小的一段真空期，有可能变量会被其他线程读取，导致写丢失一次&hellip;o(╥﹏╥)o
但是无论在哪一个时间点主内存的变量和任一工作内存的变量的值都是相等的。这个特性就导致了volatile变量不适合参与到依赖当前值的运算，如i = i + 1; i++;之类的那么依靠可见性的特点volatile可以用在哪些地方呢？ 通常volatile用做保存某个状态的boolean值or int值。</p>
</blockquote>
<p class="component-content component">《深入理解Java虚拟机》提到：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-4f2da1a278b9cee2498d04c753514979" id="lht4f2da1a278b9cee2498d04c753514979">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229332.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">JVM的字节码，i++分成三步，间隙期不同步非原子操作(i++)</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-e8efd63fbf998acf91f8d6278b5af8f8" id="lhte8efd63fbf998acf91f8d6278b5af8f8">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229405.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="33-指令禁重排" class="pagebody-header">
    3.3 指令禁重排
  </h3>
</div>
<div class="component-content pagebody component">
  <h4 id="331-说明与案例" class="pagebody-header">
    3.3.1 说明与案例
  </h4>
</div><p class="component-content component">重排序</p>
<p class="component-content component">重排序是指编译器和处理器为了优化程序性能而对指令序列进行重新排序的一种手段，有时候会改变程序语句的先后顺序</p>
<div class="component-content component"><ul>
<li>
<p class="component-content component">不存在数据依赖关系，可以重排序；</p>
</li>
<li>
<p class="component-content component">存在数据依赖关系，禁止重排序 ；</p>
</li>
</ul></div>
<p class="component-content component">但重排后的指令绝对不能改变原有的串行语义！ 这点在并发设计中必须要重点考虑！</p>
<p class="component-content component">重排序的分类和执行流程</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-52ea4fdb9684bcadf58615e182e376f2" id="lht52ea4fdb9684bcadf58615e182e376f2">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229566.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>
<p class="component-content component">编译器优化的重排序 ： 编译器在不改变单线程串行语义的前提下，可以重新调整指令的执行顺序</p>
</li>
<li>
<p class="component-content component">指令级并行的重排序 ： 处理器使用指令级并行技术来讲多条指令重叠执行，若不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序</p>
</li>
<li>
<p class="component-content component">内存系统的重排序 ： 由于处理器使用缓存和读/写缓冲区，这使得加载和存储操作看上去可能是乱序执行</p>
</li>
</ul></div>
<p class="component-content component"><strong>数据依赖性</strong> ： 若两个操作访问同一变量，且这两个操作中有一个为写操作，此时两操作间就存在数据依赖性。</p>
<p class="component-content component">案例 ：</p>
<p class="component-content component"><strong>不存在</strong> 数据依赖关系，可以重排序===&gt; 重排序OK  。</p>
<div class="component-content component"><table>
<thead>
<tr>
<th>重排前</th>
<th>重排后</th>
</tr>
</thead>
<tbody>
<tr>
<td>int a = 1; //1 int b = 20; //2 int c = a + b; //3</td>
<td>int b = 20; //1int a = 1; //2 int c = a + b; //3</td>
</tr>
<tr>
<td>结论：编译器调整了语句的顺序，但是不影响程序的最终结果。</td>
<td>重排序OK</td>
</tr>
</tbody>
</table></div>
<p class="component-content component"><strong>存在</strong> 数据依赖关系 ，禁止重排序 ===&gt; 重排序发生，会导致程序运行结果不同。</p>
<p class="component-content component">编译器和处理器在重排序时，会遵守数据依赖性，不会改变存在依赖关系的两个操作的执行,但不同处理器和不同线程之间的数据性不会被编译器和处理器考虑，其只会作用于单处理器和单线程环境，下面三种情况，只要重排序两个操作的执行顺序，程序的执行结果就会被改变。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-f166d3cf72fbee94d43d64522491d8da" id="lhtf166d3cf72fbee94d43d64522491d8da">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229014.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h4 id="332-volatile的底层实现是通过内存屏障" class="pagebody-header">
    3.3.2 volatile的底层实现是通过内存屏障
  </h4>
</div><p class="component-content component">volatile有关的禁止指令重排的行为</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-449cf386ba8c250be61fa6d55ebedccf" id="lht449cf386ba8c250be61fa6d55ebedccf">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229587.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>当第一个操作为volatile读时，不论第二个操作是什么，都不能重排序。这个操作保证了volatile读之后的操作不会被重排到volatile读之前。</li>
<li>当第二个操作为volatile写时，不论第一个操作是什么，都不能重排序。这个操作保证了volatile写之前的操作不会被重排到volatile写之后。</li>
<li>当第一个操作为volatile写时，第二个操作为volatile读时，不能重排。</li>
</ul></div>
<p class="component-content component">四大屏障的插入情况</p>
<div class="component-content component"><ul>
<li>在每一个volatile写操作前面插入一个StoreStore屏障
<div class="component-content component"><ul>
<li>StoreStore屏障可以保证在volatile写之前，其前面的所有普通写操作都已经刷新到主内存中。</li>
</ul></div>
</li>
<li>在每一个volatile写操作后面插入一个StoreLoad屏障
<div class="component-content component"><ul>
<li>StoreLoad屏障的作用是避免volatile写与后面可能有的volatile读/写操作重排序</li>
</ul></div>
</li>
<li>在每一个volatile读操作后面插入一个LoadLoad屏障
<div class="component-content component"><ul>
<li>LoadLoad屏障用来禁止处理器把上面的volatile读与下面的普通读重排序。</li>
</ul></div>
</li>
<li>在每一个volatile读操作后面插入一个LoadStore屏障
<div class="component-content component"><ul>
<li>LoadStore屏障用来禁止处理器把上面的volatile读与下面的普通写重排序。</li>
</ul></div>
</li>
</ul></div>
<p class="component-content component">Code说明</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//模拟一个单线程，什么顺序读？什么顺序写？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">VolatileTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">boolean</span> flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">read</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span>flag<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;---i = &#34;</span> <span style="color:#f92672">+</span> i<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-1cc13a1239a792ab305ce8ca7bc93e91" id="lht1cc13a1239a792ab305ce8ca7bc93e91">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229540.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-294544afc9990a332d53021962953755" id="lht294544afc9990a332d53021962953755">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229771.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-dcd85b354107de9fb0523479efcfd2da" id="lhtdcd85b354107de9fb0523479efcfd2da">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229260.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="四如何正确使用volatile" class="pagebody-header">
    四、如何正确使用volatile
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="41-单一赋值可以but含复合运算赋值不可以i之类" class="pagebody-header">
    4.1 单一赋值可以，but含复合运算赋值不可以(i++之类)
  </h3>
</div><div class="component-content component"><ul>
<li>volatile int a = 10</li>
<li>volatile boolean flag = false</li>
</ul></div>

<div class="component-content pagebody component">
  <h3 id="42-状态标志判断业务是否结束" class="pagebody-header">
    4.2 状态标志，判断业务是否结束
  </h3>
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 使用：作为一个布尔状态标志，用于指示发生了一个重要的一次性事件，例如完成初始化或任务结束
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 理由：状态标志并不依赖于程序内任何其他状态，且通常只有一种状态转换
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 例子：判断业务是否结束
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UseVolatileDemo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">boolean</span> flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span><span style="color:#f92672">(</span>flag<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">//do something......
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">},</span><span style="color:#e6db74">&#34;t1&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//暂停几秒钟线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span> TimeUnit<span style="color:#f92672">.</span><span style="color:#a6e22e">SECONDS</span><span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span><span style="color:#ae81ff">2L</span><span style="color:#f92672">);</span> <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span> e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            flag <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">},</span><span style="color:#e6db74">&#34;t2&#34;</span><span style="color:#f92672">).</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="43-开销较低的读写锁策略" class="pagebody-header">
    4.3 开销较低的读，写锁策略
  </h3>
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UseVolatileDemo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 使用：当读远多于写，结合使用内部锁和 volatile 变量来减少同步的开销
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 理由：利用volatile保证读取操作的可见性；利用synchronized保证复合操作的原子性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Counter</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> value<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getValue</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> value<span style="color:#f92672">;</span>   <span style="color:#75715e">//利用volatile保证读取操作的可见性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>              <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">synchronized</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">increment</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> value<span style="color:#f92672">++;</span> <span style="color:#75715e">//利用synchronized保证复合操作的原子性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>               <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="44-dcl双端锁的发布" class="pagebody-header">
    4.4 DCL双端锁的发布
  </h3>
</div>
<div class="component-content pagebody component">
  <h4 id="441-问题" class="pagebody-header">
    4.4.1 问题
  </h4>
</div><p class="component-content component">单线程看问题代码</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SafeDoubleCheckSingleton</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> SafeDoubleCheckSingleton singleton<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//私有化构造方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">SafeDoubleCheckSingleton</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//双重锁设计
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> SafeDoubleCheckSingleton <span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>singleton <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//1.多线程并发创建对象时，会通过加锁保证只有一个线程能创建对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>SafeDoubleCheckSingleton<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>singleton <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">//隐患：多线程环境下，由于重排序，该对象可能还未完成初始化就被其他线程读取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    singleton <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SafeDoubleCheckSingleton<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.对象创建完毕，执行getInstance()将不需要获取锁，直接返回创建对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> singleton<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">单线程看问题代码</p>
<div class="component-content component"><ul>
<li>单线程环境下(或者说正常情况下)，在&quot;问题代码处&quot;，会执行如下操作，保证能获取到已完成初始化的实例</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-8278f50de3c7dad0e1e95c9fab022511" id="lht8278f50de3c7dad0e1e95c9fab022511">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229476.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">由于存在指令重排序&hellip;&hellip;</p>
<p class="component-content component">多线程看问题代码</p>
<div class="component-content component"><ul>
<li>隐患：多线程环境下，在&quot;问题代码处&quot;，会执行如下操作，由于重排序导致2,3乱序，后果就是其他线程得到的是null而不是完成初始化的对象</li>
</ul></div>
<p class="component-content component">right</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-f1dbbd23444ba470e82c80afb64b8ca5" id="lhtf1dbbd23444ba470e82c80afb64b8ca5">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291229388.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">problem</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-c42e5ad93e11e93012481d394fef8534" id="lhtc42e5ad93e11e93012481d394fef8534">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291230900.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h4 id="442-解决01" class="pagebody-header">
    4.4.2 解决01
  </h4>
</div><p class="component-content component">加volatile修饰</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SafeDoubleCheckSingleton</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//通过volatile声明，实现线程安全的延迟初始化。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">static</span> SafeDoubleCheckSingleton singleton<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//私有化构造方法
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">SafeDoubleCheckSingleton</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//双重锁设计
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> SafeDoubleCheckSingleton <span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>singleton <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//1.多线程并发创建对象时，会通过加锁保证只有一个线程能创建对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>SafeDoubleCheckSingleton<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>singleton <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">//隐患：多线程环境下，由于重排序，该对象可能还未完成初始化就被其他线程读取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                                      <span style="color:#75715e">//原理:利用volatile，禁止 &#34;初始化对象&#34;(2) 和 &#34;设置singleton指向内存空间&#34;(3) 的重排序
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                    singleton <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SafeDoubleCheckSingleton<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//2.对象创建完毕，执行getInstance()将不需要获取锁，直接返回创建对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> singleton<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h4 id="443-解决02" class="pagebody-header">
    4.4.3 解决02
  </h4>
</div><p class="component-content component">采用静态内部类的方式实现</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">//现在比较好的做法就是采用静态内部内的方式实现
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SingletonDemo</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">SingletonDemo</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SingletonDemoHandler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> SingletonDemo instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SingletonDemo<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> SingletonDemo <span style="color:#a6e22e">getInstance</span><span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> SingletonDemoHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">instance</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="五最后的小总结" class="pagebody-header">
    五、最后的小总结
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="51-内存屏障是什么" class="pagebody-header">
    5.1 内存屏障是什么
  </h3>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-68d8758795eae6c87c461f75c01e00bc" id="lht68d8758795eae6c87c461f75c01e00bc">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291230045.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="52-内存屏障能干嘛" class="pagebody-header">
    5.2 内存屏障能干嘛
  </h3>
</div><div class="component-content component"><ul>
<li>阻止屏障两边的指令重排序</li>
<li>写数据时加入屏障，强制将线程私有工作内存的数据刷回主物理内存</li>
<li>读数据时加入屏障，线程私有工作内存的数据失效，重新到主物理内存中获取最新数据</li>
</ul></div>

<div class="component-content pagebody component">
  <h3 id="53-内存屏障四大指令" class="pagebody-header">
    5.3 内存屏障四大指令
  </h3>
</div><div class="component-content component"><ul>
<li>在每一个volatile写操作前面插入一个StoreStore屏障</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-c5fd673af5389cf72a108040a4be167e" id="lhtc5fd673af5389cf72a108040a4be167e">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291230309.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>在每一个volatile写操作后面插入一个StoreLoad屏障</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-fc3e81722788185e7eb4addf809389e7" id="lhtfc3e81722788185e7eb4addf809389e7">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291231722.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>在每一个volatile读操作后面插入一个LoadLoad屏障</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-29988f5ab4ba6388386634fc9c92ada3" id="lht29988f5ab4ba6388386634fc9c92ada3">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291231900.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>在每一个volatile读操作后面插入一个LoadStore屏障</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-dd83966286e9f85f144cd22dbe421516" id="lhtdd83966286e9f85f144cd22dbe421516">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291231409.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="54-凭什么我们java写了一个volatile关键字-系统底层加入内存屏障两者关系怎么勾搭上的" class="pagebody-header">
    5.4 凭什么我们java写了一个volatile关键字 系统底层加入内存屏障？两者关系怎么勾搭上的?
  </h3>
</div><p class="component-content component">字节码层面</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-535f1908468a6b57d4d15dec12773be8" id="lht535f1908468a6b57d4d15dec12773be8">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291231294.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">关键字</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-37eb2eca8d6da56e35e9fb095af61677" id="lht37eb2eca8d6da56e35e9fb095af61677">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291231556.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="55-volatile可见性" class="pagebody-header">
    5.5 volatile可见性
  </h3>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-9a2af2dc062d803c887107bcf5ae62d0" id="lht9a2af2dc062d803c887107bcf5ae62d0">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291231293.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="56-volatile禁重排" class="pagebody-header">
    5.6 volatile禁重排
  </h3>
</div><p class="component-content component">写指令</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-bbfec45670fe57832843b8c25844d03d" id="lhtbbfec45670fe57832843b8c25844d03d">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291231696.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">读指令</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-e08ae29e4181ceeb34b3773b6b61aa65" id="lhte08ae29e4181ceeb34b3773b6b61aa65">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291231206.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="57-对比javautilconcurrentlockslock来理解" class="pagebody-header">
    5.7 对比java.util.concurrent.locks.Lock来理解
  </h3>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-5863c62255e8e42abb0fa99128572aa8" id="lht5863c62255e8e42abb0fa99128572aa8">
        <picture  class="picture">
          <img class="picture-image" data-src="https://yyss-blog.oss-cn-beijing.aliyuncs.com/202208291231060.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="58-一句话总结" class="pagebody-header">
    5.8 一句话总结
  </h3>
</div><div class="component-content component"><ul>
<li>volatile写之前的操作，都禁止重排序到volatile之后</li>
<li>volatile读之后的操作，都禁止重排序到volatile之前</li>
<li>volatile写之后volatile读，禁止重排序</li>
</ul></div>

          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  Copyright: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">Author:   </p>
                <p class="content">Posted on:  August 29, 2022</p>
              </div>
            </div>
          </div></article>
      </section>
  </main>

  <script>
    var script = document.createElement("script");script.src = "https://yuanshuai1122.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:floyd.li@outlook.com">floyd.li@outlook.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">Social Media</div>
            
              <a href="https://github.com/floyd-li" target="_blank">Github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">Related</div>
            
              <a href="https://yufengbiji.com/" target="_blank">驭风笔记</a>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2023
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
