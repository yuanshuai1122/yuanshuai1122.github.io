<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="en">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:title" content="NPS内网穿透的搭建与演示" />
<meta property="og:description" content="概念 内网穿透：内网穿透，即NAT穿透，网络连接时术语，计算机是局域网内时，外网与内网的计算机节点需要连接通信，有时就会出现不支持内网穿透。就" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanshuai1122.github.io/archives/nps%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E6%BC%94%E7%A4%BA/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-23T23:16:13+00:00" />
<meta property="article:modified_time" content="2021-11-23T23:16:13+00:00" />
<title>NPS内网穿透的搭建与演示</title>

    <link rel="canonical" href="/archives/nps%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F%E7%9A%84%E6%90%AD%E5%BB%BA%E4%B8%8E%E6%BC%94%E7%A4%BA/">

    <link rel="stylesheet" href="/css/global.css">

    <link rel="stylesheet" href="/css/custom.css">

    <link rel="stylesheet" href="/css/search.css" />

    
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/ " class="nav-title">iTheme</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="/posts " class="nav-item-content">Articles</a>
          </div><div class="nav-item-wrapper">
            <a href="/about" class="nav-item-content">About</a>
          </div><div class="nav-item-wrapper">
            <a href="/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yuanshuai1122.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        计算机网络
                      
                    
                  </span>
                  <span class="category-eyebrow__date">November 23, 2021</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">NPS内网穿透的搭建与演示</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C" class="tag">
                    计算机网络
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            <blockquote>
<p class="component-content component">概念</p>
</blockquote>
<p class="component-content component">内网穿透：内网穿透，即NAT穿透，网络连接时术语，计算机是局域网内时，外网与内网的计算机节点需要连接通信，有时就会出现不支持内网穿透。就是说映射端口，能让外网的电脑找到处于内网的电脑，提高下载速度。不管是内网穿透还是其他类型的网络穿透，都是网络穿透的统一方法来研究和解决。</p>
<p class="component-content component">简而言之：在外网访问局域网/内网的地址。</p>
<p class="component-content component">假设场景：人在外面逛街，但能通过手机浏览器访问家里的路由管理界面，或者远程操作家里的电脑。</p>
<p class="component-content component">常见内网穿透工具：ngrok、frpc、nps</p>
<p class="component-content component">nps是一款轻量级、功能强大的内网穿透代理服务器。支持tcp、udp流量转发，支持内网http代理、内网socks5代理，同时支持snappy压缩、站点保护、加密传输、多路复用、header修改等。支持web图形化管理，集成多用户模式。</p>
<blockquote>
<p class="component-content component">操作步骤</p>
</blockquote>
<p class="component-content component">前期准备：</p>
<div class="component-content component"><ul>
<li>外网能访问到的云服务器：阿里云、腾讯云等。</li>
<li>内网自己搭建的服务器：我这里用的是树莓派4B 8G 64位arm架构的Debian系统服务器</li>
</ul></div>
<p class="component-content component"><code>因为我们内网搭建的服务器，在外网是访问不到的，所以我们需要一台云服务器，利用nps进行转发，并实现访问树莓派服务器。</code></p>
<p class="component-content component">接着在nps 的releases 页面:https://github.com/cnlh/nps/releases
找到你需要的版本，我这里用的服务器是腾讯云的centos 7，那么也就是Linux的64位版本，下载对应的服务端为<code>linux_386_server</code>,对客户端为<code>linux_arm64_client</code>。</p>
<p class="component-content component">仓库里有两个这种的系统，注意区分，x86要用下面的client对应的server，否则域名解析和http都穿透不了！！！！</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-014b93a31b2b035bb0a9fbefb72c9e80" id="lht014b93a31b2b035bb0a9fbefb72c9e80">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/1.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component">配置云服务器</p>
</blockquote>
<p class="component-content component">下载服务端<code>linux_386_server.tar.gz</code>并上传到云服务器。</p>
<p class="component-content component">解压：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>tar -zxvf linux_386_server.tar.gz</span></span></code></pre></div></div>
  
</div><p class="component-content component">解压后发现有两个文件夹：1、<code>conf</code>:包含了nps的配置文件。2、<code>web</code>:nps的web界面文件</p>
<p class="component-content component">和一个可执行文件：<code>nps</code></p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-bdbede38fe1b2551d782d1ddcaf01dfc" id="lhtbdbede38fe1b2551d782d1ddcaf01dfc">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/3.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">进入conf</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd conf/</span></span></code></pre></div></div>
  
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-48ea2d3643bdafb08b1d92da3562e8a6" id="lht48ea2d3643bdafb08b1d92da3562e8a6">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/4.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">编辑<code>nps.conf</code>:这是nps的配置文件。</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>vim nps.conf </span></span></code></pre></div></div>
  
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-52189699c50a5d145fcbfcdff63c0a92" id="lht52189699c50a5d145fcbfcdff63c0a92">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/5.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">http和https端口，修改为和你内网服务相同的端口，这样才可以进行穿透。比如你建立了个博客，http端口为5000，https端口为：5100，那么服务端就要设置为对应的端口。</p>
<p class="component-content component">建议结合nginx使用，这样就可以一台服务器，部署多个服务，非常的丝滑。</p>
<p class="component-content component">修改下面的web配置：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-6e6d4421309b3a151e5178ab13e4690a" id="lht6e6d4421309b3a151e5178ab13e4690a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/6.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">默认web界面的密码和端口，建议修改成自己的。</p>
<p class="component-content component">全部设置完毕后，保存退出。</p>
<p class="component-content component">注：我这里将http端口设置为：5800，https：5200，bridge_port:5300</p>
<p class="component-content component"><code>别忘了去云服务器防火墙开启对应的端口哦！！！</code></p>
<p class="component-content component">接下来回到nps上层目录</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cd ..</span></span></code></pre></div></div>
  
</div><p class="component-content component">启动nps</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>./nps</span></span></code></pre></div></div>
  
</div><p class="component-content component">建议后台启动，还可以打印日志</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nohup ./nps &gt;&gt; /root/test/nps/nps.log &amp;</span></span></code></pre></div></div>
  
</div><p class="component-content component">进入nps的web界面</p>
<p class="component-content component">http://云服务器ip:8080</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-ac5b1c259615903d91fbd545ca9ec563" id="lhtac5b1c259615903d91fbd545ca9ec563">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/7.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">输入账号密码，进行登录</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-b5f3c4b338c71b32ccbe2c9578c81f81" id="lhtb5f3c4b338c71b32ccbe2c9578c81f81">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/8.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">这就是nps的web界面，我们可以看到客户端连接端口为：5300，http端口：5800，https端口：5200</p>
<p class="component-content component">加下来点击左边客户端，添加一个客户端（现在显示客户端总数为1，是因为我之前添加过一个）</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-0630b7cfc311209bd21093c3082b30fb" id="lht0630b7cfc311209bd21093c3082b30fb">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/9.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-cd789e8f32c5be0688b9a10637038ef7" id="lhtcd789e8f32c5be0688b9a10637038ef7">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/10.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">备注可以写你内网服务器的名字什么的（我们这里写内网测试），其他的都可以留空，会自动生成秘钥！</p>
<p class="component-content component">点击新增：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-eeb5cce4dac09526e06b5447d1f19821" id="lhteeb5cce4dac09526e06b5447d1f19821">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/11.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-48e0ec579f6d62ef4c95598b7663200e" id="lht48e0ec579f6d62ef4c95598b7663200e">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/12.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">我们可以看到自动生成了秘钥，并且客户端还没有连接，显示离线。</p>
<p class="component-content component">接下来，配置内网服务器。</p>
<blockquote>
<p class="component-content component">配置内网服务器</p>
</blockquote>
<p class="component-content component">类似于服务端的配置，将下载的nps客户端，上传的内网服务器，解压，进入。</p>
<p class="component-content component">启动nps客户端</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>nohup ./npc -server<span style="color:#f92672">=</span>云服务器ip:5300 -vkey<span style="color:#f92672">=</span>fjwbqfxwsy5lr9ui &gt;&gt; /root/test/npc/npc.log &amp;</span></span></code></pre></div></div>
  
</div><p class="component-content component">5300是我们上面设置的bridge_port,         fjwbqfxwsy5lr9ui是我们客户端生成的秘钥</p>
<p class="component-content component">注：客户端启动文件叫npc，区别于服务端nps</p>
<p class="component-content component">接下来返回到web界面</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-c8c483e76b85cedb9afd84e03aa9af3b" id="lhtc8c483e76b85cedb9afd84e03aa9af3b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/13.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">可以看到变成了在线，并且显示了客户端地址，我们点击隧道，进去点击新增，创建内网穿透服务。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-088556efe15ab0a20c1f8d8e74d92bb3" id="lht088556efe15ab0a20c1f8d8e74d92bb3">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/14.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">比如我们创建一条tcp通道，将外网的33端口，作为访问内网的ssh端口即22端口，就可以上面这样写。</p>
<p class="component-content component">点击新增</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-2ebccf7e30519b2092c8293fb46b2947" id="lht2ebccf7e30519b2092c8293fb46b2947">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/15.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">这样我们就可以用外网，用ssh连接工具，连接云服务器ip的33端口，进行ssh内网穿透，实现ssh连接内网的服务器。</p>
<p class="component-content component">当然也支持其他常见的协议穿透，具体可以参见nps官方文档。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-ae671d5c937aa1aba7bdc068abd49f45" id="lhtae671d5c937aa1aba7bdc068abd49f45">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/operation/16.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">文档地址：https://ehang-io.github.io/nps/#/?id=nps</p>
<p class="component-content component">再见！</p>

          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  Copyright: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">Author:   </p>
                <p class="content">Posted on:  November 23, 2021</p>
              </div>
            </div>
          </div></article>
      </section>
  </main>

  <script>
    var script = document.createElement("script");script.src = "https://yuanshuai1122.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:floyd.li@outlook.com">floyd.li@outlook.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">Social Media</div>
            
              <a href="https://github.com/floyd-li" target="_blank">Github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">Related</div>
            
              <a href="https://yufengbiji.com/" target="_blank">驭风笔记</a>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2023
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
