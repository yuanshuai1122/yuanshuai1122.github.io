<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="en">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:title" content="微信登录实现（PC端）" />
<meta property="og:description" content="微信登录实现（PC端） 中心思想： 通过微信扫码和微信交互，最终拿到openid（相当于数据库主键id，是微信用户唯一标识），然后通过openi" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanshuai1122.github.io/archives/%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E5%AE%9E%E7%8E%B0pc%E7%AB%AF/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-07-12T17:58:33+00:00" />
<meta property="article:modified_time" content="2022-07-12T17:58:33+00:00" />
<title>微信登录实现（PC端）</title>

    <link rel="canonical" href="/archives/%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E5%AE%9E%E7%8E%B0pc%E7%AB%AF/">

    <link rel="stylesheet" href="/css/global.css">

    <link rel="stylesheet" href="/css/custom.css">

    <link rel="stylesheet" href="/css/search.css" />

    
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/ " class="nav-title">iTheme</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="/posts " class="nav-item-content">Articles</a>
          </div><div class="nav-item-wrapper">
            <a href="/about" class="nav-item-content">About</a>
          </div><div class="nav-item-wrapper">
            <a href="/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yuanshuai1122.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        微信
                      
                    
                  </span>
                  <span class="category-eyebrow__date">July 12, 2022</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">微信登录实现（PC端）</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="/tags/%E5%BE%AE%E4%BF%A1" class="tag">
                    微信
                  </a>
                
                  
                  <a href="/tags/oauth2.0" class="tag">
                    OAuth2.0
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            
<div class="component-content pagebody component">
  <h1 id="微信登录实现pc端" class="pagebody-header">
    微信登录实现（PC端）
  </h1>
</div>
<div class="component-content pagebody component">
  <h3 id="中心思想" class="pagebody-header">
    中心思想：
  </h3>
</div><p class="component-content component"><code>通过微信扫码和微信交互，最终拿到openid（相当于数据库主键id，是微信用户唯一标识），然后通过openid和业务交互。</code></p>

<div class="component-content pagebody component">
  <h3 id="具体实现" class="pagebody-header">
    具体实现：
  </h3>
</div><p class="component-content component">一共4个步骤，其实不论是微信授权登录，还是QQ授权登录,或者支付宝授权登录&hellip;..等只要是OAuth2.0协议都是这逻辑</p>
<blockquote>
<p class="component-content component">1 第一步：用户同意授权，获取code</p>
<p class="component-content component">2 第二步：通过code换取网页授权access_token</p>
<p class="component-content component">3 第三步：刷新access_token（如果需要）</p>
<p class="component-content component">4 第四步：拉取用户信息(需scope为 snsapi_userinfo)</p>
</blockquote>

<div class="component-content pagebody component">
  <h3 id="准备工作" class="pagebody-header">
    准备工作：
  </h3>
</div>
<div class="component-content pagebody component">
  <h4 id="1注册账号" class="pagebody-header">
    1、注册账号
  </h4>
</div><p class="component-content component"><code>https://open.weixin.qq.com</code> 注册微信开发平台</p>

<div class="component-content pagebody component">
  <h4 id="2开发者资质认证" class="pagebody-header">
    2、开发者资质认证
  </h4>
</div><p class="component-content component">准备营业执照，1-2个工作日审批，300元</p>

<div class="component-content pagebody component">
  <h4 id="3创建网站应用" class="pagebody-header">
    3、创建网站应用
  </h4>
</div><p class="component-content component">提交审核，七个工作日审批</p>

<div class="component-content pagebody component">
  <h4 id="4开发流程" class="pagebody-header">
    4、开发流程
  </h4>
</div><p class="component-content component"><code>https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html</code></p>
<blockquote>
<div class="component-content component"><ol>
<li>第三方发起微信授权登录请求，微信用户允许授权第三方应用后，微信会拉起应用或重定向到第三方网站，并且带上授权临时票据 code 参数；</li>
<li>通过 code 参数加上 AppID 和AppSecret等，通过 API 换取access_token；</li>
<li>通过access_token进行接口调用，获取用户基本数据资源或帮助用户实现基本操作。</li>
</ol></div>
</blockquote>
<p class="component-content component">获取access_token时序图：</p>
<!-- raw HTML omitted -->

<div class="component-content pagebody component">
  <h3 id="前端微信登录二维码展示" class="pagebody-header">
    前端微信登录二维码展示：
  </h3>
</div><p class="component-content component">以<code>vue.js</code>为例：</p>
<p class="component-content component">需要在<code>loginApi.js</code>中配置接口，检查是否登录。</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">checkLogin</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">request</span>({
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">url</span><span style="color:#f92672">:</span> <span style="color:#e6db74">`/user/wx/checklogin`</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">method</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;get&#39;</span>,
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">在<code>login.vue</code>中添加属性</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vue" data-lang="vue"><span style="display:flex;"><span><span style="color:#75715e">// 需要在页面head中先引入如下 JS 文件（支持https）：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">head</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">script</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>    {<span style="color:#a6e22e">src</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http://res.wx.qq.com/connect/zh_CN/htmledition/js/wxLogin.js&#39;</span>}
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 定义对话框开启关闭的boolean类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">data</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">wxDialog</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">添加微信登录对话框</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vue" data-lang="vue"><span style="display:flex;"><span><span style="color:#75715e">// @opened 对话框打开后的回调
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>&lt;<span style="color:#f92672">el-dialog</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">:visible.sync</span><span style="color:#e6db74">=&#34;wxDialog&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">@opened</span><span style="color:#e6db74">=&#34;wxOpen&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">width</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;30%&#34;</span><span style="color:#960050;background-color:#1e0010">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">center</span>
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">div</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;qrCode&#34;</span> <span style="color:#a6e22e">style</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;padding-left: 110px;&#34;</span>&gt;&lt;/<span style="color:#f92672">div</span>&gt;
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;</span><span style="color:#960050;background-color:#1e0010">/el-dialog&gt;</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">在微信图标添加点击事件</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vue" data-lang="vue"><span style="display:flex;"><span>&lt;<span style="color:#f92672">a</span> <span style="color:#a6e22e">id</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;weixin&#34;</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;weixin&#34;</span> <span style="color:#a6e22e">target</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;_blank&#34;</span> <span style="color:#f92672">@click</span><span style="color:#e6db74">=&#34;wxDialog=true&#34;</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">i</span> <span style="color:#a6e22e">class</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;iconfont icon-weixin&#34;</span>/&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">a</span>&gt;</span></span></code></pre></div></div>
  
</div><p class="component-content component">在<code>methods</code>中添加弹出二维码方法，这里用到了之前申请的<code>appid</code>，<code>redirect_uri</code>等，注意了解下<code>scope</code></p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-vue" data-lang="vue"><span style="display:flex;"><span><span style="color:#a6e22e">methods</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wxCreate</span>() {
</span></span><span style="display:flex;"><span>		 <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">obj</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WxLogin</span>({
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">self_redirect</span><span style="color:#f92672">:</span><span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">id</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;qrCode&#34;</span>, 
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">appid</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, 
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">scope</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>, 
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">redirect_uri</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">state</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">style</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;black&#34;</span>,
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">href</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>         });
</span></span><span style="display:flex;"><span>},
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">wxOpen</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 生成登录二维码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">wxCreate</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 验证是否已经扫码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">loginApi</span>.<span style="color:#a6e22e">checkLogin</span>().<span style="color:#a6e22e">then</span>(<span style="color:#a6e22e">response</span> =&gt; {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">success</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 携带token跳转到到首页
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$router</span>.<span style="color:#a6e22e">push</span>( <span style="color:#a6e22e">path</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#39;/&#39;</span>,<span style="color:#a6e22e">query</span><span style="color:#f92672">:</span>{<span style="color:#a6e22e">token</span><span style="color:#f92672">:</span><span style="color:#a6e22e">response</span>.<span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">token</span>}})
</span></span><span style="display:flex;"><span>        }<span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">$message</span>({
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">type</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;error&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">message</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;登录失败，请重试&#39;</span>
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">wxOpen</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    })
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component"><code>前端的总体思路就是：点击微信icon打开对话框，此时不断检查是否登录，如果已经登录，跳转首页，登陆成功，未登录，等待扫码，扫码后回调</code></p>

<div class="component-content pagebody component">
  <h3 id="后端验证用户是否扫码成功" class="pagebody-header">
    后端验证用户是否扫码成功
  </h3>
</div><p class="component-content component"><code>总体思路为：再死循环中不断检查isLogin标志位是否为TRUE</code></p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RequestMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/user&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WxLoginController</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> String app_id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wx92b66fgfg8c01fc87&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> String app_secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;d734ba63fgfggb3b573d7cb1cdcb958eea&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> String redirect_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://wwwxxxx.com/wechat/callBack&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 记录当前用户是否已经登录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> isLogin<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 记录当前用户是否扫码登录失败
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">boolean</span> isLoginFail<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 检查是否登录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return 是否登录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/wx/checklogin&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseEntity<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">checkLogin</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        ResponseEntity<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> responseEntity<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 定义flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">int</span> flag <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 一直查询是否登录
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 检查flag是否超过120 即60s
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>flag <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">120</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                responseEntity <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ResponseEntity<span style="color:#f92672">&lt;&gt;(</span><span style="color:#e6db74">&#34;登录超时&#34;</span><span style="color:#f92672">,</span>HttpStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">INTERNAL_SERVER_ERROR</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 登陆成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isLogin<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 如果已经登录，返回用户token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                responseEntity <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ResponseEntity<span style="color:#f92672">&lt;&gt;(</span>token<span style="color:#f92672">,</span>HttpStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">OK</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 登录状态复位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                isLogin <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 登录失败
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>isLoginFail<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                responseEntity <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ResponseEntity<span style="color:#f92672">&lt;&gt;(</span><span style="color:#e6db74">&#34;登录失败&#34;</span><span style="color:#f92672">,</span>HttpStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">INTERNAL_SERVER_ERROR</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 每隔0.5s查询一次状态
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">sleep</span><span style="color:#f92672">(</span><span style="color:#ae81ff">500</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            flag<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> responseEntity<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="微信登录后端回调业务" class="pagebody-header">
    微信登录后端回调业务
  </h3>
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> String app_id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;wx92b66fgfg8c01fc87&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> String app_secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;d734ba63fgfggb3b573d7cb1cdcb958eea&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">final</span> String redirect_url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://wwwxxxx.com/wechat/callBack&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/wx/callback&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseEntity<span style="color:#f92672">&lt;</span>Object<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">callback</span><span style="color:#f92672">(</span>String code<span style="color:#f92672">,</span> String state<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;fm&#34;</span><span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span>state<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 1.换取access_token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                String getToken <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://api.weixin.qq.com/sns/oauth2/access_token?&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;appid=%s&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;&amp;secret=%s&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;&amp;code=%s&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#e6db74">&#34;&amp;grant_type=authorization_code&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 拼接请求地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                getToken <span style="color:#f92672">=</span> String<span style="color:#f92672">.</span><span style="color:#a6e22e">format</span><span style="color:#f92672">(</span>getToken<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        app_id<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        app_secret<span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>                        code<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 2.发送请求，换取access_token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> tokenMap <span style="color:#f92672">=</span> CommonUtils<span style="color:#f92672">.</span><span style="color:#a6e22e">doGet</span><span style="color:#f92672">(</span>getToken<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                Object rsStr <span style="color:#f92672">=</span> tokenMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;rsStr&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                Map resMap <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>Map<span style="color:#f92672">)</span>rsStr<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 3.解析返回值,拿到access_token 和 open_id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                String accessToken <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span> resMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;access_token&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                String openid <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>String<span style="color:#f92672">)</span> resMap<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;openid&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                JSONObject jsonObject <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> JSONObject<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                jsonObject<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;accessToken&#34;</span><span style="color:#f92672">,</span>accessToken<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                jsonObject<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;openid&#34;</span><span style="color:#f92672">,</span>openid<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// TODO 根据openid去换id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// TODO 成功登录，返回token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#75715e">// 修改标志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isLogin</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// ......这里就可以和我们具体业务对接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                <span style="color:#f92672">......</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseEntity<span style="color:#f92672">&lt;&gt;(</span>jsonObject<span style="color:#f92672">,</span>HttpStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">OK</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span><span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">isLoginFail</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseEntity<span style="color:#f92672">&lt;&gt;(</span>HttpStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">INTERNAL_SERVER_ERROR</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseEntity<span style="color:#f92672">&lt;&gt;(</span>HttpStatus<span style="color:#f92672">.</span><span style="color:#a6e22e">INTERNAL_SERVER_ERROR</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h4 id="这样就可以完成微信的扫码登录qq微博同理到此结束" class="pagebody-header">
    这样就可以完成微信的扫码登录，qq微博同理，到此结束
  </h4>
</div>
          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  Copyright: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">Author:   </p>
                <p class="content">Posted on:  July 12, 2022</p>
              </div>
            </div>
          </div></article>
      </section>
  </main>

  <script>
    var script = document.createElement("script");script.src = "https://yuanshuai1122.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:floyd.li@outlook.com">floyd.li@outlook.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">Social Media</div>
            
              <a href="https://github.com/floyd-li" target="_blank">Github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">Related</div>
            
              <a href="https://yufengbiji.com/" target="_blank">驭风笔记</a>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2023
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
