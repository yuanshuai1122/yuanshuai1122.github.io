<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="zh-hans">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:title" content="Kubernetes-Service详解" />
<meta property="og:description" content="一、Service介绍 在kubernetes中，pod是应用程序的载体，我们可以通过pod的ip来访问应用程序，但是pod的ip地址不是固定" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanshuai1122.github.io/11/kubernetes-service%E8%AF%A6%E8%A7%A3/" /><meta property="article:section" content="11" />
<meta property="article:published_time" content="2023-07-19T18:12:20+00:00" />
<meta property="article:modified_time" content="2023-07-19T18:12:20+00:00" />
<title>Kubernetes-Service详解</title>

    <link rel="canonical" href="/11/kubernetes-service%E8%AF%A6%E8%A7%A3/">

    <link rel="stylesheet" href="/css/global.css">

    <link rel="stylesheet" href="/css/custom.css">

    <link rel="stylesheet" href="/css/search.css" />

    
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/ " class="nav-title">🧀</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="/posts " class="nav-item-content">目录</a>
          </div><div class="nav-item-wrapper">
            <a href="/about" class="nav-item-content">关于</a>
          </div><div class="nav-item-wrapper">
            <a href="/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yuanshuai1122.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        docker
                      
                    
                  </span>
                  <span class="category-eyebrow__date">2023年7月19日</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">Kubernetes-Service详解</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="/tags/docker" class="tag">
                    docker
                  </a>
                
                  
                  <a href="/tags/k8s" class="tag">
                    k8s
                  </a>
                
                  
                  <a href="/tags/%E5%AE%B9%E5%99%A8" class="tag">
                    容器
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            
<div class="component-content pagebody component">
  <h2 id="一service介绍" class="pagebody-header">
    一、Service介绍
  </h2>
</div><p class="component-content component">在kubernetes中，pod是应用程序的载体，我们可以通过pod的ip来访问应用程序，但是pod的ip地址不是固定的，这也就意味着不方便直接采用pod的ip对服务进行访问。</p>
<p class="component-content component">为了解决这个问题，kubernetes提供了Service资源，Service会对提供同一个服务的多个pod进行聚合，并且提供一个统一的入口地址。通过访问Service的入口地址就能访问到后面的pod服务。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-3fffd12ee260b7d8c570b59bdb554d03" id="lht3fffd12ee260b7d8c570b59bdb554d03">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212211613.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">Service在很多情况下只是一个概念，真正起作用的其实是kube-proxy服务进程，每个Node节点上都运行着一个kube-proxy服务进程。当创建Service的时候会通过api-server向etcd写入创建的service的信息，而kube-proxy会基于监听的机制发现这种Service的变动，然后它会将最新的Service信息转换成对应的访问规则。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-3bab8cfe218e05d85b4a7ee623ca92ed" id="lht3bab8cfe218e05d85b4a7ee623ca92ed">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212211132.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content pagebody component code">
  
  
  
  <pre><code class=""># 10.97.97.97:80 是service提供的访问入口
# 当访问这个入口的时候，可以发现后面有三个pod的服务在等待调用，
# kube-proxy会基于rr（轮询）的策略，将请求分发到其中一个pod上去
# 这个规则会同时在集群内的所有节点上都生成，所以在任何一个节点上，都可以访问。
[root@node1 ~]# ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.97.97.97:80 rr
  -&gt; 10.244.1.39:80               Masq    1      0          0
  -&gt; 10.244.1.40:80               Masq    1      0          0
  -&gt; 10.244.2.33:80               Masq    1      0          0</code></pre>
  
</div><p class="component-content component">kube-proxy目前支持三种工作模式:</p>

<div class="component-content pagebody component">
  <h3 id="11-userspace-模式" class="pagebody-header">
    1.1 userspace 模式
  </h3>
</div><p class="component-content component">userspace模式下，kube-proxy会为每一个Service创建一个监听端口，发向Cluster IP的请求被Iptables规则重定向到kube-proxy监听的端口上，kube-proxy根据LB算法选择一个提供服务的Pod并和其建立链接，以将请求转发到Pod上。 该模式下，kube-proxy充当了一个四层负责均衡器的角色。由于kube-proxy运行在userspace中，在进行转发处理时会增加内核和用户空间之间的数据拷贝，虽然比较稳定，但是效率比较低。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-13992d71f55ac9ee65133b7c8b13dc02" id="lht13992d71f55ac9ee65133b7c8b13dc02">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212211012.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="12-iptables-模式" class="pagebody-header">
    1.2 iptables 模式
  </h3>
</div><p class="component-content component">iptables模式下，kube-proxy为service后端的每个Pod创建对应的iptables规则，直接将发向Cluster IP的请求重定向到一个Pod IP。 该模式下kube-proxy不承担四层负责均衡器的角色，只负责创建iptables规则。该模式的优点是较userspace模式效率更高，但不能提供灵活的LB策略，当后端Pod不可用时也无法进行重试。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-02c24ba4a78beded11b01cf6b4288c9b" id="lht02c24ba4a78beded11b01cf6b4288c9b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212211996.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="13-ipvs-模式" class="pagebody-header">
    1.3 ipvs 模式
  </h3>
</div><p class="component-content component">ipvs模式和iptables类似，kube-proxy监控Pod的变化并创建相应的ipvs规则。ipvs相对iptables转发效率更高。除此以外，ipvs支持更多的LB算法。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-b52ccd3384f888c800d29ac144c3623f" id="lhtb52ccd3384f888c800d29ac144c3623f">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212212002.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 此模式必须安装ipvs内核模块，否则会降级为iptables</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 开启ipvs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit cm kube-proxy -n kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改mode: &#34;ipvs&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete pod -l k8s-app=kube-proxy -n kube-system</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@node1 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>IP Virtual Server version 1.2.1 <span style="color:#f92672">(</span>size<span style="color:#f92672">=</span>4096<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Prot LocalAddress:Port Scheduler Flags
</span></span><span style="display:flex;"><span>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn
</span></span><span style="display:flex;"><span>TCP  10.97.97.97:80 rr
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.39:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.40:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.2.33:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="二service类型" class="pagebody-header">
    二、Service类型
  </h2>
</div><p class="component-content component">Service的资源清单文件：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service </span> <span style="color:#75715e"># 资源类型</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1 </span> <span style="color:#75715e"># 资源版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service</span> <span style="color:#75715e"># 资源名称</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span> <span style="color:#75715e"># 命名空间</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 标签选择器，用于确定当前service代理哪些pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#75715e"># Service类型，指定service的访问方式</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>:  <span style="color:#75715e"># 虚拟服务的ip地址</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">sessionAffinity</span>: <span style="color:#75715e"># session亲和性，支持ClientIP、None两个选项</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>: <span style="color:#75715e"># 端口信息</span>
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">3017</span>  <span style="color:#75715e"># service端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">5003</span> <span style="color:#75715e"># pod端口</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">31122</span> <span style="color:#75715e"># 主机端口</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>ClusterIP：默认值，它是Kubernetes系统自动分配的虚拟IP，只能在集群内部访问</li>
<li>NodePort：将Service通过指定的Node上的端口暴露给外部，通过此方法，就可以在集群外部访问服务</li>
<li>LoadBalancer：使用外接负载均衡器完成到服务的负载分发，注意此模式需要外部云环境支持</li>
<li>ExternalName： 把集群外部的服务引入集群内部，直接使用</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="三service使用" class="pagebody-header">
    三、Service使用
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="31-实验环境准备" class="pagebody-header">
    3.1 实验环境准备
  </h3>
</div><p class="component-content component">在使用service之前，首先利用Deployment创建出3个pod，注意要为pod设置app=nginx-pod的标签</p>
<p class="component-content component">创建deployment.yaml，内容如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment      </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f deployment.yaml</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod详情</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -o wide --show-labels</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS     IP            NODE     LABELS
</span></span><span style="display:flex;"><span>pc-deployment-66cb59b984-8p84h   1/1     Running    10.244.1.39   node1    app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>pc-deployment-66cb59b984-vx8vx   1/1     Running    10.244.2.33   node2    app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>pc-deployment-66cb59b984-wnncx   1/1     Running    10.244.1.40   node1    app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为了方便后面的测试，修改下三台nginx的index.html页面（三台修改的IP地址不一致）</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># echo &#34;10.244.1.39&#34; &gt; /usr/share/nginx/html/index.html</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#修改完毕之后，访问测试</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.244.1.39</span>
</span></span><span style="display:flex;"><span>10.244.1.39
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.244.2.33</span>
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.244.1.40</span>
</span></span><span style="display:flex;"><span>10.244.1.40</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="32-clusterip类型的service" class="pagebody-header">
    3.2 ClusterIP类型的Service
  </h3>
</div><p class="component-content component">创建service-clusterip.yaml文件</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-clusterip</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">10.97.97.97</span> <span style="color:#75715e"># service的ip地址，如果不写，默认会生成一个</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>  <span style="color:#75715e"># Service端口       </span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span> <span style="color:#75715e"># pod端口</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f service-clusterip.yaml</span>
</span></span><span style="display:flex;"><span>service/service-clusterip created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                TYPE        CLUSTER-IP    EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>   AGE   SELECTOR
</span></span><span style="display:flex;"><span>service-clusterip   ClusterIP   10.97.97.97   &lt;none&gt;        80/TCP    13s   app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看service的详细信息</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在这里有一个Endpoints列表，里面就是当前service可以负载到的服务入口</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe svc service-clusterip -n dev</span>
</span></span><span style="display:flex;"><span>Name:              service-clusterip
</span></span><span style="display:flex;"><span>Namespace:         dev
</span></span><span style="display:flex;"><span>Labels:            &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Selector:          app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>Type:              ClusterIP
</span></span><span style="display:flex;"><span>IP:                10.97.97.97
</span></span><span style="display:flex;"><span>Port:              &lt;unset&gt;  80/TCP
</span></span><span style="display:flex;"><span>TargetPort:        80/TCP
</span></span><span style="display:flex;"><span>Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80
</span></span><span style="display:flex;"><span>Session Affinity:  None
</span></span><span style="display:flex;"><span>Events:            &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看ipvs的映射规则</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>TCP  10.97.97.97:80 rr
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.39:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.40:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.2.33:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 访问10.97.97.97:80观察效果</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># curl 10.97.97.97:80</span>
</span></span><span style="display:flex;"><span>10.244.2.33</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="33-endpoint" class="pagebody-header">
    3.3 Endpoint
  </h3>
</div><p class="component-content component">Endpoint是kubernetes中的一个资源对象，存储在etcd中，用来记录一个service对应的所有pod的访问地址，它是根据service配置文件中selector描述产生的。</p>
<p class="component-content component">一个Service由一组Pod组成，这些Pod通过Endpoints暴露出来，Endpoints是实现实际服务的端点集合。换句话说，service和pod之间的联系是通过endpoints实现的。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-e0d92bba4ba166dba94565d47b4dd809" id="lhte0d92bba4ba166dba94565d47b4dd809">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212212435.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component"><strong>负载分发策略</strong></p>
<p class="component-content component">对Service的访问被分发到了后端的Pod上去，目前kubernetes提供了两种负载分发策略：</p>
<div class="component-content component"><ul>
<li>如果不定义，默认使用kube-proxy的策略，比如随机、轮询</li>
<li>基于客户端地址的会话保持模式，即来自同一个客户端发起的所有请求都会转发到固定的一个Pod上</li>
<li>此模式可以使在spec中添加sessionAffinity:ClientIP选项</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看ipvs的映射规则【rr 轮询】</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>TCP  10.97.97.97:80 rr
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.39:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.40:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.2.33:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 循环访问测试</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># while true;do curl 10.97.97.97:80; sleep 5; done;</span>
</span></span><span style="display:flex;"><span>10.244.1.40
</span></span><span style="display:flex;"><span>10.244.1.39
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>10.244.1.40
</span></span><span style="display:flex;"><span>10.244.1.39
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改分发策略----sessionAffinity:ClientIP</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看ipvs规则【persistent 代表持久】</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># ipvsadm -Ln</span>
</span></span><span style="display:flex;"><span>TCP  10.97.97.97:80 rr persistent <span style="color:#ae81ff">10800</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.39:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.1.40:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>  -&gt; 10.244.2.33:80               Masq    <span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span>          <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 循环访问测试</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># while true;do curl 10.97.97.97; sleep 5; done;</span>
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>10.244.2.33
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f service-clusterip.yaml</span>
</span></span><span style="display:flex;"><span>service <span style="color:#e6db74">&#34;service-clusterip&#34;</span> deleted</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="34-headliness类型的service" class="pagebody-header">
    3.4 HeadLiness类型的Service
  </h3>
</div><p class="component-content component">在某些场景中，开发人员可能不想使用Service提供的负载均衡功能，而希望自己来控制负载均衡策略，针对这种情况，kubernetes提供了HeadLiness Service，这类Service不会分配Cluster IP，如果想要访问service，只能通过service的域名进行查询。</p>
<p class="component-content component">创建service-headliness.yaml</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-headliness</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span> <span style="color:#75715e"># 将clusterIP设置为None，即可创建headliness Service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f service-headliness.yaml</span>
</span></span><span style="display:flex;"><span>service/service-headliness created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取service， 发现CLUSTER-IP未分配</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc service-headliness -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>   AGE   SELECTOR
</span></span><span style="display:flex;"><span>service-headliness   ClusterIP   None         &lt;none&gt;        80/TCP    11s   app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看service详情</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe svc service-headliness  -n dev</span>
</span></span><span style="display:flex;"><span>Name:              service-headliness
</span></span><span style="display:flex;"><span>Namespace:         dev
</span></span><span style="display:flex;"><span>Labels:            &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Selector:          app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>Type:              ClusterIP
</span></span><span style="display:flex;"><span>IP:                None
</span></span><span style="display:flex;"><span>Port:              &lt;unset&gt;  80/TCP
</span></span><span style="display:flex;"><span>TargetPort:        80/TCP
</span></span><span style="display:flex;"><span>Endpoints:         10.244.1.39:80,10.244.1.40:80,10.244.2.33:80
</span></span><span style="display:flex;"><span>Session Affinity:  None
</span></span><span style="display:flex;"><span>Events:            &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看域名的解析情况</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl exec -it pc-deployment-66cb59b984-8p84h -n dev /bin/sh</span>
</span></span><span style="display:flex;"><span>/ <span style="color:#75715e"># cat /etc/resolv.conf</span>
</span></span><span style="display:flex;"><span>nameserver 10.96.0.10
</span></span><span style="display:flex;"><span>search dev.svc.cluster.local svc.cluster.local cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># dig @10.96.0.10 service-headliness.dev.svc.cluster.local</span>
</span></span><span style="display:flex;"><span>service-headliness.dev.svc.cluster.local. <span style="color:#ae81ff">30</span> IN A 10.244.1.40
</span></span><span style="display:flex;"><span>service-headliness.dev.svc.cluster.local. <span style="color:#ae81ff">30</span> IN A 10.244.1.39
</span></span><span style="display:flex;"><span>service-headliness.dev.svc.cluster.local. <span style="color:#ae81ff">30</span> IN A 10.244.2.33</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="35-nodeport类型的service" class="pagebody-header">
    3.5 NodePort类型的Service
  </h3>
</div><p class="component-content component">在之前的样例中，创建的Service的ip地址只有集群内部才可以访问，如果希望将Service暴露给集群外部使用，那么就要使用到另外一种类型的Service，称为NodePort类型。NodePort的工作原理其实就是将service的端口映射到Node的一个端口上，然后就可以通过NodeIp:NodePort来访问service了。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-cebcf3f2919521950513468b2531cf5b" id="lhtcebcf3f2919521950513468b2531cf5b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212212702.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">创建service-nodeport.yaml</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">service-nodeport</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span> <span style="color:#75715e"># service类型</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">30002</span> <span style="color:#75715e"># 指定绑定的node的端口(默认的取值范围是：30000-32767), 如果不指定，会默认分配</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f service-nodeport.yaml</span>
</span></span><span style="display:flex;"><span>service/service-nodeport created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME               TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>       SELECTOR
</span></span><span style="display:flex;"><span>service-nodeport   NodePort   10.105.64.191   &lt;none&gt;        80:30002/TCP  app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 接下来可以通过电脑主机的浏览器去访问集群中任意一个nodeip的30002端口，即可访问到pod</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="36-loadbalancer类型的service" class="pagebody-header">
    3.6 LoadBalancer类型的Service
  </h3>
</div><p class="component-content component">LoadBalancer和NodePort很相似，目的都是向外部暴露一个端口，区别在于LoadBalancer会在集群的外部再来做一个负载均衡设备，而这个设备需要外部环境支持的，外部服务发送到这个设备上的请求，会被设备负载之后转发到集群中。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-32d97ffe0b3de534970b1a2d4a4a02cb" id="lht32d97ffe0b3de534970b1a2d4a4a02cb">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212212778.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="37-externalname类型的service" class="pagebody-header">
    3.7 ExternalName类型的Service
  </h3>
</div><p class="component-content component">ExternalName类型的Service用于引入集群外部的服务，它通过externalName属性指定外部一个服务的地址，然后在集群内部访问此service就可以访问到外部的服务了。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-47e482face9e9d576267e7643e1936e5" id="lht47e482face9e9d576267e7643e1936e5">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212212299.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span>kind: Service
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  name: service-externalname
</span></span><span style="display:flex;"><span>  namespace: dev
</span></span><span style="display:flex;"><span>spec:
</span></span><span style="display:flex;"><span>  type: ExternalName <span style="color:#75715e"># service类型</span>
</span></span><span style="display:flex;"><span>  externalName: www.baidu.com  <span style="color:#75715e">#改成ip地址也可以</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl  create -f service-externalname.yaml</span>
</span></span><span style="display:flex;"><span>service/service-externalname created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 域名解析</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># dig @10.96.0.10 service-externalname.dev.svc.cluster.local</span>
</span></span><span style="display:flex;"><span>service-externalname.dev.svc.cluster.local. <span style="color:#ae81ff">30</span> IN CNAME www.baidu.com.
</span></span><span style="display:flex;"><span>www.baidu.com.          <span style="color:#ae81ff">30</span>      IN      CNAME   www.a.shifen.com.
</span></span><span style="display:flex;"><span>www.a.shifen.com.       <span style="color:#ae81ff">30</span>      IN      A       39.156.66.18
</span></span><span style="display:flex;"><span>www.a.shifen.com.       <span style="color:#ae81ff">30</span>      IN      A       39.156.66.14</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="四ingress介绍" class="pagebody-header">
    四、Ingress介绍
  </h2>
</div><p class="component-content component">在前面已经提到，Service对集群之外暴露服务的主要方式有两种：NotePort和LoadBalancer，但是这两种方式，都有一定的缺点：</p>
<p class="component-content component">NodePort方式的缺点是会占用很多集群机器的端口，那么当集群服务变多的时候，这个缺点就愈发明显
LB方式的缺点是每个service需要一个LB，浪费、麻烦，并且需要kubernetes之外设备的支持
基于这种现状，kubernetes提供了Ingress资源对象，Ingress只需要一个NodePort或者一个LB就可以满足暴露多个Service的需求。工作机制大致如下图表示：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-c6d30ff12c6e9b6939a70d785484bf2e" id="lhtc6d30ff12c6e9b6939a70d785484bf2e">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212212625.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">实际上，Ingress相当于一个7层的负载均衡器，是kubernetes对反向代理的一个抽象，它的工作原理类似于Nginx，可以理解成在Ingress里建立诸多映射规则，Ingress Controller通过监听这些配置规则并转化成Nginx的反向代理配置 , 然后对外部提供服务。在这里有两个核心概念：</p>
<div class="component-content component"><ul>
<li>ingress：kubernetes中的一个对象，作用是定义请求如何转发到service的规则</li>
<li>ingress controller：具体实现反向代理及负载均衡的程序，对ingress定义的规则进行解析，根据配置的规则来实现请求转发，实现方式有很多，比如Nginx, Contour, Haproxy等等</li>
</ul></div>
<p class="component-content component">Ingress（以Nginx为例）的工作原理如下：</p>
<div class="component-content component"><ol>
<li>用户编写Ingress规则，说明哪个域名对应kubernetes集群中的哪个Service</li>
<li>Ingress控制器动态感知Ingress服务规则的变化，然后生成一段对应的Nginx反向代理配置</li>
<li>Ingress控制器会将生成的Nginx配置写入到一个运行着的Nginx服务中，并动态更新</li>
<li>到此为止，其实真正在工作的就是一个Nginx了，内部配置了用户定义的请求转发规则</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-c7b158d13e8a46e723216e5a88f8d6e2" id="lhtc7b158d13e8a46e723216e5a88f8d6e2">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212212244.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="五ingress使用" class="pagebody-header">
    五、Ingress使用
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="51-环境准备-搭建ingress环境" class="pagebody-header">
    5.1 环境准备 搭建ingress环境
  </h3>
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建文件夹</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># mkdir ingress-controller</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># cd ingress-controller/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取ingress-nginx，本次案例使用的是0.30版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ingress-controller<span style="color:#f92672">]</span><span style="color:#75715e"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/mandatory.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ingress-controller<span style="color:#f92672">]</span><span style="color:#75715e"># wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/nginx-0.30.0/deploy/static/provider/baremetal/service-nodeport.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改mandatory.yaml文件中的仓库</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改quay.io/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 为quay-mirror.qiniu.com/kubernetes-ingress-controller/nginx-ingress-controller:0.30.0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ingress-controller<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f ./</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看ingress-nginx</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ingress-controller<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n ingress-nginx</span>
</span></span><span style="display:flex;"><span>NAME                                           READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginx-ingress-controller-fbf967dd5-4qpbp   1/1     Running   <span style="color:#ae81ff">0</span>          12h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ingress-controller<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -n ingress-nginx</span>
</span></span><span style="display:flex;"><span>NAME            TYPE       CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>                      AGE
</span></span><span style="display:flex;"><span>ingress-nginx   NodePort   10.98.75.163   &lt;none&gt;        80:32240/TCP,443:31335/TCP   11h</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="52-准备service和pod" class="pagebody-header">
    5.2 准备service和pod
  </h3>
</div><p class="component-content component">为了后面的实验比较方便，创建如下图所示的模型</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-b9be2b4bd2569c230487e2012fe17f3b" id="lhtb9be2b4bd2569c230487e2012fe17f3b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308212213988.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">创建tomcat-nginx.yaml</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">tomcat-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">tomcat-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">tomcat:8.5-jre10-slim</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">tomcat-service</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">tomcat-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">clusterIP</span>: <span style="color:#ae81ff">None</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f tomcat-nginx.yaml</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get svc -n dev</span>
</span></span><span style="display:flex;"><span>NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>    AGE
</span></span><span style="display:flex;"><span>nginx-service    ClusterIP   None         &lt;none&gt;        80/TCP     48s
</span></span><span style="display:flex;"><span>tomcat-service   ClusterIP   None         &lt;none&gt;        8080/TCP   48s</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="53-http代理" class="pagebody-header">
    5.3 Http代理
  </h3>
</div><p class="component-content component">创建ingress-http.yaml</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-http</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">nginx.yuanshuai.vip</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">nginx-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tomcat.yuanshuai.vip</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">tomcat-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f ingress-http.yaml</span>
</span></span><span style="display:flex;"><span>ingress.extensions/ingress-http created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ing ingress-http -n dev</span>
</span></span><span style="display:flex;"><span>NAME           HOSTS                                  ADDRESS   PORTS   AGE
</span></span><span style="display:flex;"><span>ingress-http   nginx.yuanshuai.vip,tomcat.yuanshuai.vip             <span style="color:#ae81ff">80</span>      22s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看详情</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe ing ingress-http  -n dev</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Rules:
</span></span><span style="display:flex;"><span>Host                Path  Backends
</span></span><span style="display:flex;"><span>----                ----  --------
</span></span><span style="display:flex;"><span>nginx.yuanshuai.vip   / nginx-service:80 <span style="color:#f92672">(</span>10.244.1.96:80,10.244.1.97:80,10.244.2.112:80<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>tomcat.yuanshuai.vip  / tomcat-service:8080<span style="color:#f92672">(</span>10.244.1.94:8080,10.244.1.95:8080,10.244.2.111:8080<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 接下来,在本地电脑上配置host文件,解析上面的两个域名到192.168.109.100(master)上</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 然后,就可以分别访问tomcat.yuanshuai.vip:32240  和  nginx.yuanshuai.vip:32240 查看效果了</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="54-https代理" class="pagebody-header">
    5.4 Https代理
  </h3>
</div><p class="component-content component">创建证书</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 生成证书</span>
</span></span><span style="display:flex;"><span>openssl req -x509 -sha256 -nodes -days <span style="color:#ae81ff">365</span> -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span style="color:#e6db74">&#34;/C=CN/ST=BJ/L=BJ/O=nginx/CN=yuanshuai.vip&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建密钥</span>
</span></span><span style="display:flex;"><span>kubectl create secret tls tls-secret --key tls.key --cert tls.crt</span></span></code></pre></div></div>
  
</div><p class="component-content component">创建ingress-https.yaml</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">ingress-https</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">tls</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">hosts</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">nginx.yuanshuai.vip</span>
</span></span><span style="display:flex;"><span>      - <span style="color:#ae81ff">tomcat.yuanshuai.vip</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">secretName</span>: <span style="color:#ae81ff">tls-secret</span> <span style="color:#75715e"># 指定秘钥</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">nginx.yuanshuai.vip</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">nginx-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">tomcat.yuanshuai.vip</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">serviceName</span>: <span style="color:#ae81ff">tomcat-service</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">servicePort</span>: <span style="color:#ae81ff">8080</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f ingress-https.yaml</span>
</span></span><span style="display:flex;"><span>ingress.extensions/ingress-https created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get ing ingress-https -n dev</span>
</span></span><span style="display:flex;"><span>NAME            HOSTS                                  ADDRESS         PORTS     AGE
</span></span><span style="display:flex;"><span>ingress-https   nginx.yuanshuai.vip,tomcat.yuanshuai.vip   10.104.184.38   80, <span style="color:#ae81ff">443</span>   2m42s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看详情</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl describe ing ingress-https -n dev</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>TLS:
</span></span><span style="display:flex;"><span>  tls-secret terminates nginx.yuanshuai.vip,tomcat.yuanshuai.vip
</span></span><span style="display:flex;"><span>Rules:
</span></span><span style="display:flex;"><span>Host              Path Backends
</span></span><span style="display:flex;"><span>----              ---- --------
</span></span><span style="display:flex;"><span>nginx.yuanshuai.vip  /  nginx-service:80 <span style="color:#f92672">(</span>10.244.1.97:80,10.244.1.98:80,10.244.2.119:80<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>tomcat.yuanshuai.vip /  tomcat-service:8080<span style="color:#f92672">(</span>10.244.1.99:8080,10.244.2.117:8080,10.244.2.120:8080<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 下面可以通过浏览器访问https://nginx.yuanshuai.vip:31335 和 https://tomcat.yuanshuai.vip:31335来查看了</span></span></span></code></pre></div></div>
  
</div>
          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  版权声明: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">版权声明：署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">作者:  yuanshuai </p>
                <p class="content">发表日期:  2023年7月19日</p>
              </div>
            </div>
          </div></article>
      </section>
  </main>

  <script>
    var script = document.createElement("script");script.src = "https://yuanshuai1122.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:shuaiyuan@gmail.com">shuaiyuan@gmail.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">社交媒体</div>
            
              <a href="https://github.com/yuanshuai1122" target="_blank">Github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">友链</div>
            
              <a href="https://yuanshuaicn.com/" target="_blank">👋</a>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2023
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
