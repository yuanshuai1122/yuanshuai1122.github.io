<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="zh-hans">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:title" content="ElasticSearch-高级特性" />
<meta property="og:description" content="分布式搜索引擎03 1.数据聚合 **聚合（aggregations）**可以让我们极其方便的实现对数据的统计、分析、运算。例如： 什么品牌的手机" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanshuai1122.github.io/11/elasticsearch-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" /><meta property="article:section" content="11" />
<meta property="article:published_time" content="2023-07-19T18:12:20+00:00" />
<meta property="article:modified_time" content="2023-07-19T18:12:20+00:00" />
<title>ElasticSearch-高级特性</title>

    <link rel="canonical" href="/11/elasticsearch-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/">

    <link rel="stylesheet" href="/css/global.css">

    <link rel="stylesheet" href="/css/custom.css">

    <link rel="stylesheet" href="/css/search.css" />

    
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/ " class="nav-title">🧀</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="/posts " class="nav-item-content">目录</a>
          </div><div class="nav-item-wrapper">
            <a href="/about" class="nav-item-content">关于</a>
          </div><div class="nav-item-wrapper">
            <a href="/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yuanshuai1122.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        docker
                      
                    
                  </span>
                  <span class="category-eyebrow__date">2023年7月19日</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">ElasticSearch-高级特性</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="/tags/docker" class="tag">
                    docker
                  </a>
                
                  
                  <a href="/tags/es" class="tag">
                    es
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            
<div class="component-content pagebody component">
  <h1 id="分布式搜索引擎03" class="pagebody-header">
    分布式搜索引擎03
  </h1>
</div>
<div class="component-content pagebody component">
  <h1 id="1数据聚合" class="pagebody-header">
    1.数据聚合
  </h1>
</div><p class="component-content component">**<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">聚合（</a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">aggregations</a><a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations.html">）</a>**可以让我们极其方便的实现对数据的统计、分析、运算。例如：</p>
<div class="component-content component"><ul>
<li>什么品牌的手机最受欢迎？</li>
<li>这些手机的平均价格、最高价格、最低价格？</li>
<li>这些手机每月的销售情况如何？</li>
</ul></div>
<p class="component-content component">实现这些统计功能的比数据库的sql要方便的多，而且查询速度非常快，可以实现近实时搜索效果。</p>

<div class="component-content pagebody component">
  <h2 id="11聚合的种类" class="pagebody-header">
    1.1.聚合的种类
  </h2>
</div><p class="component-content component">聚合常见的有三类：</p>
<div class="component-content component"><ul>
<li>
<p class="component-content component">**桶（Bucket）**聚合：用来对文档做分组</p>
<div class="component-content component"><ul>
<li>TermAggregation：按照文档字段值分组，例如按照品牌值分组、按照国家分组</li>
</ul></div>
<div class="component-content component"><ul>
<li>Date Histogram：按照日期阶梯分组，例如一周为一组，或者一月为一组</li>
</ul></div>
</li>
<li>
<p class="component-content component">**度量（Metric）**聚合：用以计算一些值，比如：最大值、最小值、平均值等</p>
<div class="component-content component"><ul>
<li>Avg：求平均值</li>
</ul></div>
<div class="component-content component"><ul>
<li>Max：求最大值</li>
<li>Min：求最小值</li>
<li>Stats：同时求max、min、avg、sum等</li>
</ul></div>
</li>
<li>
<p class="component-content component">**管道（pipeline）**聚合：其它聚合的结果为基础做聚合</p>
</li>
</ul></div>
<blockquote>
<p class="component-content component">**注意：**参加聚合的字段必须是keyword、日期、数值、布尔类型</p>
</blockquote>

<div class="component-content pagebody component">
  <h2 id="12dsl实现聚合" class="pagebody-header">
    1.2.DSL实现聚合
  </h2>
</div><p class="component-content component">现在，我们要统计所有数据中的酒店品牌有几种，其实就是按照品牌对数据分组。此时可以根据酒店品牌的名称做聚合，也就是Bucket聚合。</p>

<div class="component-content pagebody component">
  <h3 id="121bucket聚合语法" class="pagebody-header">
    1.2.1.Bucket聚合语法
  </h3>
</div><p class="component-content component">语法如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET</span> <span style="color:#960050;background-color:#1e0010">/hotel/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">0</span>,  <span style="color:#75715e">// 设置size为0，结果中不包含文档，只包含聚合结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#f92672">&#34;aggs&#34;</span>: { <span style="color:#75715e">// 定义聚合
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">&#34;brandAgg&#34;</span>: { <span style="color:#75715e">//给聚合起个名字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#f92672">&#34;terms&#34;</span>: { <span style="color:#75715e">// 聚合的类型，按照品牌值聚合，所以选择term
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">&#34;field&#34;</span>: <span style="color:#e6db74">&#34;brand&#34;</span>, <span style="color:#75715e">// 参与聚合的字段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">20</span> <span style="color:#75715e">// 希望获取的聚合结果数量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">结果如图：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-d1b450df1cccbba88379eff477950de5" id="lhtd1b450df1cccbba88379eff477950de5">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272249661.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="122聚合结果排序" class="pagebody-header">
    1.2.2.聚合结果排序
  </h3>
</div><p class="component-content component">默认情况下，Bucket聚合会统计Bucket内的文档数量，记为_count，并且按照_count降序排序。</p>
<p class="component-content component">我们可以指定order属性，自定义聚合的排序方式：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET</span> <span style="color:#960050;background-color:#1e0010">/hotel/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">0</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;aggs&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;brandAgg&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;terms&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;field&#34;</span>: <span style="color:#e6db74">&#34;brand&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;order&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;_count&#34;</span>: <span style="color:#e6db74">&#34;asc&#34;</span> <span style="color:#75715e">// 按照_count升序排列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="123限定聚合范围" class="pagebody-header">
    1.2.3.限定聚合范围
  </h3>
</div><p class="component-content component">默认情况下，Bucket聚合是对索引库的所有文档做聚合，但真实场景下，用户会输入搜索条件，因此聚合必须是对搜索结果聚合。那么聚合必须添加限定条件。</p>
<p class="component-content component">我们可以限定要聚合的文档范围，只要添加query条件即可：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET</span> <span style="color:#960050;background-color:#1e0010">/hotel/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;query&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;range&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;price&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;lte&#34;</span>: <span style="color:#ae81ff">200</span> <span style="color:#75715e">// 只对200元以下的文档聚合
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }, 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">0</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;aggs&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;brandAgg&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;terms&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;field&#34;</span>: <span style="color:#e6db74">&#34;brand&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">这次，聚合得到的品牌明显变少了：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-234ec60b1720dd3aac7b58f5a4777d07" id="lht234ec60b1720dd3aac7b58f5a4777d07">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272249419.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="124metric聚合语法" class="pagebody-header">
    1.2.4.Metric聚合语法
  </h3>
</div><p class="component-content component">上节课，我们对酒店按照品牌分组，形成了一个个桶。现在我们需要对桶内的酒店做运算，获取每个品牌的用户评分的min、max、avg等值。</p>
<p class="component-content component">这就要用到Metric聚合了，例如stat聚合：就可以获取min、max、avg等结果。</p>
<p class="component-content component">语法如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">GET</span> <span style="color:#960050;background-color:#1e0010">/hotel/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">0</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;aggs&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;brandAgg&#34;</span>: { 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;terms&#34;</span>: { 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;field&#34;</span>: <span style="color:#e6db74">&#34;brand&#34;</span>, 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">20</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;aggs&#34;</span>: { <span style="color:#75715e">// 是brands聚合的子聚合，也就是分组后对每组分别计算
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">&#34;score_stats&#34;</span>: { <span style="color:#75715e">// 聚合名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#f92672">&#34;stats&#34;</span>: { <span style="color:#75715e">// 聚合类型，这里stats可以计算min、max、avg等
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">&#34;field&#34;</span>: <span style="color:#e6db74">&#34;score&#34;</span> <span style="color:#75715e">// 聚合字段，这里是score
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">这次的score_stats聚合是在brandAgg的聚合内部嵌套的子聚合。因为我们需要在每个桶分别计算。</p>
<p class="component-content component">另外，我们还可以给聚合结果做个排序，例如按照每个桶的酒店平均分做排序：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-c1ad332f9c41070cd7fba7d8aa121f47" id="lhtc1ad332f9c41070cd7fba7d8aa121f47">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272249120.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="125小结" class="pagebody-header">
    1.2.5.小结
  </h3>
</div><p class="component-content component">aggs代表聚合，与query同级，此时query的作用是？</p>
<div class="component-content component"><ul>
<li>限定聚合的的文档范围</li>
</ul></div>
<p class="component-content component">聚合必须的三要素：</p>
<div class="component-content component"><ul>
<li>聚合名称</li>
<li>聚合类型</li>
<li>聚合字段</li>
</ul></div>
<p class="component-content component">聚合可配置属性有：</p>
<div class="component-content component"><ul>
<li>size：指定聚合结果数量</li>
<li>order：指定聚合结果排序方式</li>
<li>field：指定聚合字段</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="13restapi实现聚合" class="pagebody-header">
    1.3.RestAPI实现聚合
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="131api语法" class="pagebody-header">
    1.3.1.API语法
  </h3>
</div><p class="component-content component">聚合条件与query条件同级别，因此需要使用request.source()来指定聚合条件。</p>
<p class="component-content component">聚合条件的语法：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-a393190c0fadfaeb33be0b4259dd6f62" id="lhta393190c0fadfaeb33be0b4259dd6f62">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272249538.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">聚合的结果也与查询结果不同，API也比较特殊。不过同样是JSON逐层解析：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-ea1f6465a46cc23f4bf83573aacd3d3a" id="lhtea1f6465a46cc23f4bf83573aacd3d3a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272249918.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="132业务需求" class="pagebody-header">
    1.3.2.业务需求
  </h3>
</div><p class="component-content component">需求：搜索页面的品牌、城市等信息不应该是在页面写死，而是通过聚合索引库中的酒店数据得来的：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-aab0bef6ebf4cb05e77e6a730aaad6c6" id="lhtaab0bef6ebf4cb05e77e6a730aaad6c6">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272250754.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">分析：</p>
<p class="component-content component">目前，页面的城市列表、星级列表、品牌列表都是写死的，并不会随着搜索结果的变化而变化。但是用户搜索条件改变时，搜索结果会跟着变化。</p>
<p class="component-content component">例如：用户搜索“东方明珠”，那搜索的酒店肯定是在上海东方明珠附近，因此，城市只能是上海，此时城市列表中就不应该显示北京、深圳、杭州这些信息了。</p>
<p class="component-content component">也就是说，搜索结果中包含哪些城市，页面就应该列出哪些城市；搜索结果中包含哪些品牌，页面就应该列出哪些品牌。</p>
<p class="component-content component">如何得知搜索结果中包含哪些品牌？如何得知搜索结果中包含哪些城市？</p>
<p class="component-content component">使用聚合功能，利用Bucket聚合，对搜索结果中的文档基于品牌分组、基于城市分组，就能得知包含哪些品牌、哪些城市了。</p>
<p class="component-content component">因为是对搜索结果聚合，因此聚合是<strong>限定范围的聚合</strong>，也就是说聚合的限定条件跟搜索文档的条件一致。</p>
<p class="component-content component">查看浏览器可以发现，前端其实已经发出了这样的一个请求：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-ad3345af660ddd4e2e4c7b9242682c75" id="lhtad3345af660ddd4e2e4c7b9242682c75">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272250683.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">请求<strong>参数与搜索文档的参数完全一致</strong>。</p>
<p class="component-content component">返回值类型就是页面要展示的最终结果：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-23b602ac38959d90341641d3145d2f04" id="lht23b602ac38959d90341641d3145d2f04">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272250749.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">结果是一个Map结构：</p>
<div class="component-content component"><ul>
<li>key是字符串，城市、星级、品牌、价格</li>
<li>value是集合，例如多个城市的名称</li>
</ul></div>

<div class="component-content pagebody component">
  <h3 id="133业务实现" class="pagebody-header">
    1.3.3.业务实现
  </h3>
</div><p class="component-content component">在<code>hotel.web</code>包的<code>HotelController</code>中添加一个方法，遵循下面的要求：</p>
<div class="component-content component"><ul>
<li>
<p class="component-content component">请求方式：<code>POST</code></p>
</li>
<li>
<p class="component-content component">请求路径：<code>/hotel/filters</code></p>
</li>
<li>
<p class="component-content component">请求参数：<code>RequestParams</code>，与搜索文档的参数一致</p>
</li>
<li>
<p class="component-content component">返回值类型：<code>Map&amp;lt;String, List&lt;String&gt;;</code></p>
<p class="component-content component">代码：</p>
</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#a6e22e">@PostMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;filters&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">getFilters</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@RequestBody</span> RequestParams params<span style="color:#f92672">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> hotelService<span style="color:#f92672">.</span><span style="color:#a6e22e">getFilters</span><span style="color:#f92672">(</span>params<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">这里调用了IHotelService中的getFilters方法，尚未实现。</p>
<p class="component-content component">在<code>hotel.service.IHotelService</code>中定义新方法：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">filters</span><span style="color:#f92672">(</span>RequestParams params<span style="color:#f92672">);</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">在<code>hotel.service.impl.HotelService</code>中实现该方法：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;&gt;</span> <span style="color:#a6e22e">filters</span><span style="color:#f92672">(</span>RequestParams params<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1.准备Request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SearchRequest request <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SearchRequest<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hotel&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2.准备DSL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">// 2.1.query
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        buildBasicQuery<span style="color:#f92672">(</span>params<span style="color:#f92672">,</span> request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2.2.设置size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        request<span style="color:#f92672">.</span><span style="color:#a6e22e">source</span><span style="color:#f92672">().</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#ae81ff">0</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2.3.聚合
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        buildAggregation<span style="color:#f92672">(</span>request<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3.发出请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SearchResponse response <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">search</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> RequestOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.解析结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;&gt;</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>        Aggregations aggregations <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">getAggregations</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.1.根据品牌名称，获取品牌结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> brandList <span style="color:#f92672">=</span> getAggByName<span style="color:#f92672">(</span>aggregations<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;brandAgg&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        result<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;品牌&#34;</span><span style="color:#f92672">,</span> brandList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.2.根据品牌名称，获取品牌结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> cityList <span style="color:#f92672">=</span> getAggByName<span style="color:#f92672">(</span>aggregations<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;cityAgg&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        result<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;城市&#34;</span><span style="color:#f92672">,</span> cityList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.3.根据品牌名称，获取品牌结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> starList <span style="color:#f92672">=</span> getAggByName<span style="color:#f92672">(</span>aggregations<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;starAgg&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        result<span style="color:#f92672">.</span><span style="color:#a6e22e">put</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;星级&#34;</span><span style="color:#f92672">,</span> starList<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">buildAggregation</span><span style="color:#f92672">(</span>SearchRequest request<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    request<span style="color:#f92672">.</span><span style="color:#a6e22e">source</span><span style="color:#f92672">().</span><span style="color:#a6e22e">aggregation</span><span style="color:#f92672">(</span>AggregationBuilders
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">.</span><span style="color:#a6e22e">terms</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;brandAgg&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">.</span><span style="color:#a6e22e">field</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;brand&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#ae81ff">100</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    request<span style="color:#f92672">.</span><span style="color:#a6e22e">source</span><span style="color:#f92672">().</span><span style="color:#a6e22e">aggregation</span><span style="color:#f92672">(</span>AggregationBuilders
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">.</span><span style="color:#a6e22e">terms</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;cityAgg&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">.</span><span style="color:#a6e22e">field</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;city&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#ae81ff">100</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    request<span style="color:#f92672">.</span><span style="color:#a6e22e">source</span><span style="color:#f92672">().</span><span style="color:#a6e22e">aggregation</span><span style="color:#f92672">(</span>AggregationBuilders
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">.</span><span style="color:#a6e22e">terms</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;starAgg&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">.</span><span style="color:#a6e22e">field</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;starName&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                 <span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#ae81ff">100</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getAggByName</span><span style="color:#f92672">(</span>Aggregations aggregations<span style="color:#f92672">,</span> String aggName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4.1.根据聚合名称获取聚合结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Terms brandTerms <span style="color:#f92672">=</span> aggregations<span style="color:#f92672">.</span><span style="color:#a6e22e">get</span><span style="color:#f92672">(</span>aggName<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4.2.获取buckets
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    List<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Terms<span style="color:#f92672">.</span><span style="color:#a6e22e">Bucket</span><span style="color:#f92672">&gt;</span> buckets <span style="color:#f92672">=</span> brandTerms<span style="color:#f92672">.</span><span style="color:#a6e22e">getBuckets</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4.3.遍历
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> brandList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Terms<span style="color:#f92672">.</span><span style="color:#a6e22e">Bucket</span> bucket <span style="color:#f92672">:</span> buckets<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.4.获取key
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        String key <span style="color:#f92672">=</span> bucket<span style="color:#f92672">.</span><span style="color:#a6e22e">getKeyAsString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        brandList<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>key<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> brandList<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h1 id="2自动补全" class="pagebody-header">
    2.自动补全
  </h1>
</div><p class="component-content component">当用户在搜索框输入字符时，我们应该提示出与该字符有关的搜索项，如图：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-684da8ee0e8f13911f0db88dc8a53739" id="lht684da8ee0e8f13911f0db88dc8a53739">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272251286.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">这种根据用户输入的字母，提示完整词条的功能，就是自动补全了。</p>
<p class="component-content component">因为需要根据拼音字母来推断，因此要用到拼音分词功能。</p>

<div class="component-content pagebody component">
  <h2 id="21拼音分词器" class="pagebody-header">
    2.1.拼音分词器
  </h2>
</div><p class="component-content component">要实现根据字母做补全，就必须对文档按照拼音分词。在GitHub上恰好有elasticsearch的拼音分词插件。地址：<a href="https://github.com/medcl/elasticsearch-analysis-pinyin">https://github.com/medcl/elasticsearch-analysis-pinyin</a></p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-9d13e37aed89d93558f9c9383adf73ed" id="lht9d13e37aed89d93558f9c9383adf73ed">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272252061.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">安装方式与IK分词器一样，分三步：</p>
<div class="component-content pagebody component code">
  
  
  
  <pre><code class="">①解压

②上传到虚拟机中，elasticsearch的plugin目录

③重启elasticsearch

④测试</code></pre>
  
</div><p class="component-content component">详细安装步骤可以参考IK分词器的安装过程。</p>
<p class="component-content component">测试用法如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST</span> <span style="color:#960050;background-color:#1e0010">/_analyze</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;如家酒店还不错&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;analyzer&#34;</span>: <span style="color:#e6db74">&#34;pinyin&#34;</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">结果：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-7e9e0223804ca85b218d40312e01ac22" id="lht7e9e0223804ca85b218d40312e01ac22">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272251736.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="22自定义分词器" class="pagebody-header">
    2.2.自定义分词器
  </h2>
</div><p class="component-content component">默认的拼音分词器会将每个汉字单独分为拼音，而我们希望的是每个词条形成一组拼音，需要对拼音分词器做个性化定制，形成自定义分词器。</p>
<p class="component-content component">elasticsearch中分词器（analyzer）的组成包含三部分：</p>
<div class="component-content component"><ul>
<li>
<p class="component-content component">character filters：在tokenizer之前对文本进行处理。例如删除字符、替换字符</p>
</li>
<li>
<p class="component-content component">tokenizer：将文本按照一定的规则切割成词条（term）。例如keyword，就是不分词；还有ik_smart</p>
</li>
<li>
<p class="component-content component">tokenizer filter：将tokenizer输出的词条做进一步处理。例如大小写转换、同义词处理、拼音处理等</p>
<p class="component-content component">文档分词时会依次由这三部分来处理文档：</p>
</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-563e939be3dfeb0c59531bb3e7b02583" id="lht563e939be3dfeb0c59531bb3e7b02583">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272253222.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">声明自定义分词器的语法如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">PUT</span> <span style="color:#960050;background-color:#1e0010">/test</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;settings&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;analysis&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;analyzer&#34;</span>: { <span style="color:#75715e">// 自定义分词器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">&#34;my_analyzer&#34;</span>: {  <span style="color:#75715e">// 分词器名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#f92672">&#34;tokenizer&#34;</span>: <span style="color:#e6db74">&#34;ik_max_word&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;filter&#34;</span>: <span style="color:#e6db74">&#34;py&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;filter&#34;</span>: { <span style="color:#75715e">// 自定义tokenizer filter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">&#34;py&#34;</span>: { <span style="color:#75715e">// 过滤器名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>          <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;pinyin&#34;</span>, <span style="color:#75715e">// 过滤器类型，这里是pinyin
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		  <span style="color:#f92672">&#34;keep_full_pinyin&#34;</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;keep_joined_full_pinyin&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;keep_original&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;limit_first_letter_length&#34;</span>: <span style="color:#ae81ff">16</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;remove_duplicated_term&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;none_chinese_pinyin_tokenize&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;mappings&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;name&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;text&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;analyzer&#34;</span>: <span style="color:#e6db74">&#34;my_analyzer&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;search_analyzer&#34;</span>: <span style="color:#e6db74">&#34;ik_smart&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">测试：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-fa23dbc2580da6ca6f324c71517e260b" id="lhtfa23dbc2580da6ca6f324c71517e260b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272253644.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">总结：</p>
<p class="component-content component">如何使用拼音分词器？</p>
<div class="component-content component"><ul>
<li>①下载pinyin分词器</li>
<li>②解压并放到elasticsearch的plugin目录</li>
<li>③重启即可</li>
</ul></div>
<p class="component-content component">如何自定义分词器？</p>
<div class="component-content component"><ul>
<li>①创建索引库时，在settings中配置，可以包含三部分</li>
<li>②character filter</li>
<li>③tokenizer</li>
<li>④filter</li>
</ul></div>
<p class="component-content component">拼音分词器注意事项？</p>
<div class="component-content component"><ul>
<li>为了避免搜索到同音字，搜索时不要使用拼音分词器</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="23自动补全查询" class="pagebody-header">
    2.3.自动补全查询
  </h2>
</div><p class="component-content component">elasticsearch提供了<a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.6/search-suggesters.html">Completion Suggester</a>查询来实现自动补全功能。这个查询会匹配以用户输入内容开头的词条并返回。为了提高补全查询的效率，对于文档中字段的类型有一些约束：</p>
<div class="component-content component"><ul>
<li>参与补全查询的字段必须是completion类型。</li>
<li>字段的内容一般是用来补全的多个词条形成的数组。</li>
</ul></div>
<p class="component-content component">比如，一个这样的索引库：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#75715e">// 创建索引库
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">PUT</span> <span style="color:#960050;background-color:#1e0010">test</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;mappings&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;title&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;completion&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">然后插入下面的数据：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#75715e">// 示例数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">POST</span> <span style="color:#960050;background-color:#1e0010">test/_doc</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;title&#34;</span>: [<span style="color:#e6db74">&#34;Sony&#34;</span>, <span style="color:#e6db74">&#34;WH-1000XM3&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST</span> <span style="color:#960050;background-color:#1e0010">test/_doc</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;title&#34;</span>: [<span style="color:#e6db74">&#34;SK-II&#34;</span>, <span style="color:#e6db74">&#34;PITERA&#34;</span>]
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">POST</span> <span style="color:#960050;background-color:#1e0010">test/_doc</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;title&#34;</span>: [<span style="color:#e6db74">&#34;Nintendo&#34;</span>, <span style="color:#e6db74">&#34;switch&#34;</span>]
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div><p class="component-content component">查询的DSL语句如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#75715e">// 自动补全查询
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">GET</span> <span style="color:#960050;background-color:#1e0010">/test/_search</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;suggest&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;title_suggest&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;s&#34;</span>, <span style="color:#75715e">// 关键字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      <span style="color:#f92672">&#34;completion&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;field&#34;</span>: <span style="color:#e6db74">&#34;title&#34;</span>, <span style="color:#75715e">// 补全查询的字段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">&#34;skip_duplicates&#34;</span>: <span style="color:#66d9ef">true</span>, <span style="color:#75715e">// 跳过重复的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#f92672">&#34;size&#34;</span>: <span style="color:#ae81ff">10</span> <span style="color:#75715e">// 获取前10条结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="24实现酒店搜索框自动补全" class="pagebody-header">
    2.4.实现酒店搜索框自动补全
  </h2>
</div><p class="component-content component">现在，我们的hotel索引库还没有设置拼音分词器，需要修改索引库中的配置。但是我们知道索引库是无法修改的，只能删除然后重新创建。</p>
<p class="component-content component">另外，我们需要添加一个字段，用来做自动补全，将brand、suggestion、city等都放进去，作为自动补全的提示。</p>
<p class="component-content component">因此，总结一下，我们需要做的事情包括：</p>
<div class="component-content component"><ol>
<li>修改hotel索引库结构，设置自定义拼音分词器</li>
<li>修改索引库的name、all字段，使用自定义分词器</li>
<li>索引库添加一个新字段suggestion，类型为completion类型，使用自定义的分词器</li>
<li>给HotelDoc类添加suggestion字段，内容包含brand、business</li>
<li>重新导入数据到hotel库</li>
</ol></div>

<div class="component-content pagebody component">
  <h3 id="241修改酒店映射结构" class="pagebody-header">
    2.4.1.修改酒店映射结构
  </h3>
</div><p class="component-content component">代码如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#75715e">// 酒店数据索引库
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">PUT</span> <span style="color:#960050;background-color:#1e0010">/hotel</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;settings&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;analysis&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;analyzer&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;text_anlyzer&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;tokenizer&#34;</span>: <span style="color:#e6db74">&#34;ik_max_word&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;filter&#34;</span>: <span style="color:#e6db74">&#34;py&#34;</span>
</span></span><span style="display:flex;"><span>        },
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;completion_analyzer&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;tokenizer&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;filter&#34;</span>: <span style="color:#e6db74">&#34;py&#34;</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;filter&#34;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;py&#34;</span>: {
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;pinyin&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;keep_full_pinyin&#34;</span>: <span style="color:#66d9ef">false</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;keep_joined_full_pinyin&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;keep_original&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;limit_first_letter_length&#34;</span>: <span style="color:#ae81ff">16</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;remove_duplicated_term&#34;</span>: <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;none_chinese_pinyin_tokenize&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&#34;mappings&#34;</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;properties&#34;</span>: {
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;id&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;name&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;text&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;analyzer&#34;</span>: <span style="color:#e6db74">&#34;text_anlyzer&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;search_analyzer&#34;</span>: <span style="color:#e6db74">&#34;ik_smart&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;copy_to&#34;</span>: <span style="color:#e6db74">&#34;all&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;address&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;index&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;price&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;score&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;integer&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;brand&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;copy_to&#34;</span>: <span style="color:#e6db74">&#34;all&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;city&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;starName&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;business&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;copy_to&#34;</span>: <span style="color:#e6db74">&#34;all&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;location&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;geo_point&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;pic&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;keyword&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;index&#34;</span>: <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;all&#34;</span>:{
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;text&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;analyzer&#34;</span>: <span style="color:#e6db74">&#34;text_anlyzer&#34;</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;search_analyzer&#34;</span>: <span style="color:#e6db74">&#34;ik_smart&#34;</span>
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&#34;suggestion&#34;</span>:{
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;type&#34;</span>: <span style="color:#e6db74">&#34;completion&#34;</span>,
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&#34;analyzer&#34;</span>: <span style="color:#e6db74">&#34;completion_analyzer&#34;</span>
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="242修改hoteldoc实体" class="pagebody-header">
    2.4.2.修改HotelDoc实体
  </h3>
</div><p class="component-content component">HotelDoc中要添加一个字段，用来做自动补全，内容可以是酒店品牌、城市、商圈等信息。按照自动补全字段的要求，最好是这些字段的数组。</p>
<p class="component-content component">因此我们在HotelDoc中添加一个suggestion字段，类型为<code>List&lt;String&gt;;</code>，然后将brand、city、business等信息放到里面。</p>
<p class="component-content component">代码如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> cn.itcast.hotel.pojo<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> lombok.Data<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> lombok.NoArgsConstructor<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.ArrayList<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Arrays<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.Collections<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> java.util.List<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@NoArgsConstructor</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HotelDoc</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Long id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String name<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String address<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Integer price<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Integer score<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String brand<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String city<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String starName<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String business<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String location<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String pic<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Object distance<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Boolean isAD<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> suggestion<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">HotelDoc</span><span style="color:#f92672">(</span>Hotel hotel<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getId</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">name</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">address</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getAddress</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">price</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getPrice</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">score</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getScore</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brand</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getBrand</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">city</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getCity</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">starName</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getStarName</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">business</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getBusiness</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">location</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getLatitude</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, &#34;</span> <span style="color:#f92672">+</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getLongitude</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">pic</span> <span style="color:#f92672">=</span> hotel<span style="color:#f92672">.</span><span style="color:#a6e22e">getPic</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 组装suggestion
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">business</span><span style="color:#f92672">.</span><span style="color:#a6e22e">contains</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">)){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// business有多个值，需要切割
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            String<span style="color:#f92672">[]</span> arr <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">business</span><span style="color:#f92672">.</span><span style="color:#a6e22e">split</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 添加元素
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">suggestion</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">suggestion</span><span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brand</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            Collections<span style="color:#f92672">.</span><span style="color:#a6e22e">addAll</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">suggestion</span><span style="color:#f92672">,</span> arr<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span><span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">suggestion</span> <span style="color:#f92672">=</span> Arrays<span style="color:#f92672">.</span><span style="color:#a6e22e">asList</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">brand</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">business</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="243重新导入" class="pagebody-header">
    2.4.3.重新导入
  </h3>
</div><p class="component-content component">重新执行之前编写的导入数据功能，可以看到新的酒店数据中包含了suggestion：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-ce7e15b37fa509b4b0da8570b66b837a" id="lhtce7e15b37fa509b4b0da8570b66b837a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272253873.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="244自动补全查询的javaapi" class="pagebody-header">
    2.4.4.自动补全查询的JavaAPI
  </h3>
</div><p class="component-content component">之前我们学习了自动补全查询的DSL，而没有学习对应的JavaAPI，这里给出一个示例：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-a1705003e4ccb2522f538854f9bb6dc7" id="lhta1705003e4ccb2522f538854f9bb6dc7">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272253988.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">而自动补全的结果也比较特殊，解析的代码如下：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-7da8bf6ba31ccdf2a55b8851bf5fe8d6" id="lht7da8bf6ba31ccdf2a55b8851bf5fe8d6">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272253164.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="245实现搜索框自动补全" class="pagebody-header">
    2.4.5.实现搜索框自动补全
  </h3>
</div><p class="component-content component">查看前端页面，可以发现当我们在输入框键入时，前端会发起ajax请求：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-0394cea34416672c14f0d886e7da9665" id="lht0394cea34416672c14f0d886e7da9665">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272253215.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">返回值是补全词条的集合，类型为<code>List&lt;String&gt;;</code></p>
<p class="component-content component">1）在<code>HotelController</code>中添加新接口，接收新的请求：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@GetMapping</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;suggestion&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getSuggestions</span><span style="color:#f92672">(</span><span style="color:#a6e22e">@RequestParam</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;key&#34;</span><span style="color:#f92672">)</span> String prefix<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> hotelService<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuggestions</span><span style="color:#f92672">(</span>prefix<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">2）在<code>IhotelService</code>中添加方法：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getSuggestions</span><span style="color:#f92672">(</span>String prefix<span style="color:#f92672">);</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">3）在<code>HotelService</code>中实现该方法：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">getSuggestions</span><span style="color:#f92672">(</span>String prefix<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 1.准备Request
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SearchRequest request <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SearchRequest<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hotel&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2.准备DSL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        request<span style="color:#f92672">.</span><span style="color:#a6e22e">source</span><span style="color:#f92672">().</span><span style="color:#a6e22e">suggest</span><span style="color:#f92672">(</span><span style="color:#66d9ef">new</span> SuggestBuilder<span style="color:#f92672">().</span><span style="color:#a6e22e">addSuggestion</span><span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;suggestions&#34;</span><span style="color:#f92672">,</span>
</span></span><span style="display:flex;"><span>            SuggestBuilders<span style="color:#f92672">.</span><span style="color:#a6e22e">completionSuggestion</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;suggestion&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">prefix</span><span style="color:#f92672">(</span>prefix<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">skipDuplicates</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">(</span><span style="color:#ae81ff">10</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 3.发起请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SearchResponse response <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span><span style="color:#a6e22e">search</span><span style="color:#f92672">(</span>request<span style="color:#f92672">,</span> RequestOptions<span style="color:#f92672">.</span><span style="color:#a6e22e">DEFAULT</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.解析结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        Suggest suggest <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuggest</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.1.根据补全查询名称，获取补全结果
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        CompletionSuggestion suggestions <span style="color:#f92672">=</span> suggest<span style="color:#f92672">.</span><span style="color:#a6e22e">getSuggestion</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;suggestions&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.2.获取options
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>CompletionSuggestion<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Option</span><span style="color:#f92672">&gt;</span> options <span style="color:#f92672">=</span> suggestions<span style="color:#f92672">.</span><span style="color:#a6e22e">getOptions</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 4.3.遍历
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> list <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;(</span>options<span style="color:#f92672">.</span><span style="color:#a6e22e">size</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>CompletionSuggestion<span style="color:#f92672">.</span><span style="color:#a6e22e">Entry</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Option</span> option <span style="color:#f92672">:</span> options<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            String text <span style="color:#f92672">=</span> option<span style="color:#f92672">.</span><span style="color:#a6e22e">getText</span><span style="color:#f92672">().</span><span style="color:#a6e22e">toString</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>            list<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>text<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> list<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> RuntimeException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h1 id="3数据同步" class="pagebody-header">
    3.数据同步
  </h1>
</div><p class="component-content component">elasticsearch中的酒店数据来自于mysql数据库，因此mysql数据发生改变时，elasticsearch也必须跟着改变，这个就是elasticsearch与mysql之间的<strong>数据同步</strong>。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-aebe54dc3fb63d001f3b88d188c7f357" id="lhtaebe54dc3fb63d001f3b88d188c7f357">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272254817.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="31思路分析" class="pagebody-header">
    3.1.思路分析
  </h2>
</div><p class="component-content component">常见的数据同步方案有三种：</p>
<div class="component-content component"><ul>
<li>同步调用</li>
<li>异步通知</li>
<li>监听binlog</li>
</ul></div>

<div class="component-content pagebody component">
  <h3 id="311同步调用" class="pagebody-header">
    3.1.1.同步调用
  </h3>
</div><p class="component-content component">方案一：同步调用</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-081f3e4918d6969037e34a87dad35588" id="lht081f3e4918d6969037e34a87dad35588">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272254458.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">基本步骤如下：</p>
<div class="component-content component"><ul>
<li>hotel-demo对外提供接口，用来修改elasticsearch中的数据</li>
<li>酒店管理服务在完成数据库操作后，直接调用hotel-demo提供的接口，</li>
</ul></div>

<div class="component-content pagebody component">
  <h3 id="312异步通知" class="pagebody-header">
    3.1.2.异步通知
  </h3>
</div><p class="component-content component">方案二：异步通知</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-2294cec91e082b5dbe5eb356f42b385f" id="lht2294cec91e082b5dbe5eb356f42b385f">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272254862.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">流程如下：</p>
<div class="component-content component"><ul>
<li>hotel-admin对mysql数据库数据完成增、删、改后，发送MQ消息</li>
<li>hotel-demo监听MQ，接收到消息后完成elasticsearch数据修改</li>
</ul></div>

<div class="component-content pagebody component">
  <h3 id="313监听binlog" class="pagebody-header">
    3.1.3.监听binlog
  </h3>
</div><p class="component-content component">方案三：监听binlog</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-ad71f89ed082e3c1b7b4bdba7a3b01bf" id="lhtad71f89ed082e3c1b7b4bdba7a3b01bf">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272254165.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">流程如下：</p>
<div class="component-content component"><ul>
<li>给mysql开启binlog功能</li>
<li>mysql完成增、删、改操作都会记录在binlog中</li>
<li>hotel-demo基于canal监听binlog变化，实时更新elasticsearch中的内容</li>
</ul></div>

<div class="component-content pagebody component">
  <h3 id="314选择" class="pagebody-header">
    3.1.4.选择
  </h3>
</div><p class="component-content component">方式一：同步调用</p>
<div class="component-content component"><ul>
<li>优点：实现简单，粗暴</li>
<li>缺点：业务耦合度高</li>
</ul></div>
<p class="component-content component">方式二：异步通知</p>
<div class="component-content component"><ul>
<li>优点：低耦合，实现难度一般</li>
<li>缺点：依赖mq的可靠性</li>
</ul></div>
<p class="component-content component">方式三：监听binlog</p>
<div class="component-content component"><ul>
<li>优点：完全解除服务间耦合</li>
<li>缺点：开启binlog增加数据库负担、实现复杂度高</li>
</ul></div>

<div class="component-content pagebody component">
  <h1 id="4集群" class="pagebody-header">
    4.集群
  </h1>
</div>
<div class="component-content pagebody component">
  <h2 id="41-集群问题" class="pagebody-header">
    4.1 集群问题
  </h2>
</div><p class="component-content component">单机的elasticsearch做数据存储，必然面临两个问题：海量数据存储问题、单点故障问题。</p>
<div class="component-content component"><ul>
<li>海量数据存储问题：将索引库从逻辑上拆分为N个分片（shard），存储到多个节点</li>
<li>单点故障问题：将分片数据在不同节点备份（replica ）</li>
</ul></div>
<p class="component-content component"><strong>ES集群相关概念</strong>:</p>
<div class="component-content component"><ul>
<li>
<p class="component-content component">集群（cluster）：一组拥有共同的 cluster name 的 节点。</p>
</li>
<li>
<p class="component-content component"><!-- raw HTML omitted -->节点（node)<!-- raw HTML omitted -->   ：集群中的一个 Elasticearch 实例</p>
</li>
<li>
<p class="component-content component"><!-- raw HTML omitted -->分片（shard）<!-- raw HTML omitted -->：索引可以被拆分为不同的部分进行存储，称为分片。在集群环境下，一个索引的不同分片可以拆分到不同的节点中</p>
<p class="component-content component">解决问题：数据量太大，单点存储量有限的问题。</p>
</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-4e561412b4f3a3eb99251858125a47ff" id="lht4e561412b4f3a3eb99251858125a47ff">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272254870.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component">此处，我们把数据分成3片：shard0、shard1、shard2</p>
</blockquote>
<div class="component-content component"><ul>
<li>
<p class="component-content component">主分片（Primary shard）：相对于副本分片的定义。</p>
</li>
<li>
<p class="component-content component">副本分片（Replica shard）每个主分片可以有一个或者多个副本，数据和主分片一样。</p>
</li>
</ul></div>
<p class="component-content component">数据备份可以保证高可用，但是每个分片备份一份，所需要的节点数量就会翻一倍，成本实在是太高了！</p>
<p class="component-content component">为了在高可用和成本间寻求平衡，我们可以这样做：</p>
<div class="component-content component"><ul>
<li>首先对数据分片，存储到不同节点</li>
<li>然后对每个分片进行备份，放到对方节点，完成互相备份</li>
</ul></div>
<p class="component-content component">这样可以大大减少所需要的服务节点数量，如图，我们以3分片，每个分片备份一份为例：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-58fefa4ccba1626e5a081147e4bcb5e5" id="lht58fefa4ccba1626e5a081147e4bcb5e5">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272254650.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">现在，每个分片都有1个备份，存储在3个节点：</p>
<div class="component-content component"><ul>
<li>node0：保存了分片0和1</li>
<li>node1：保存了分片0和2</li>
<li>node2：保存了分片1和2</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="42集群脑裂问题" class="pagebody-header">
    4.2.集群脑裂问题
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="421集群职责划分" class="pagebody-header">
    4.2.1.集群职责划分
  </h3>
</div><p class="component-content component">elasticsearch中集群节点有不同的职责划分：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-04705506522726c0119f298c84ae722e" id="lht04705506522726c0119f298c84ae722e">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272255217.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">默认情况下，集群中的任何一个节点都同时具备上述四种角色。</p>
<p class="component-content component">但是真实的集群一定要将集群职责分离：</p>
<div class="component-content component"><ul>
<li>master节点：对CPU要求高，但是内存要求第</li>
<li>data节点：对CPU和内存要求都高</li>
<li>coordinating节点：对网络带宽、CPU要求高</li>
</ul></div>
<p class="component-content component">职责分离可以让我们根据不同节点的需求分配不同的硬件去部署。而且避免业务之间的互相干扰。</p>
<p class="component-content component">一个典型的es集群职责划分如图：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-1899b02569e4a6a6e4e7e8a50bef6c23" id="lht1899b02569e4a6a6e4e7e8a50bef6c23">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272255421.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="422脑裂问题" class="pagebody-header">
    4.2.2.脑裂问题
  </h3>
</div><p class="component-content component">脑裂是因为集群中的节点失联导致的。</p>
<p class="component-content component">例如一个集群中，主节点与其它节点失联：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-a7548246ce7286d4fad17d289db59c91" id="lhta7548246ce7286d4fad17d289db59c91">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272255983.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">此时，node2和node3认为node1宕机，就会重新选主。</p>
<p class="component-content component">当node3当选后，集群继续对外提供服务，node2和node3自成集群，node1自成集群，两个集群数据不同步，出现数据差异。</p>
<p class="component-content component">当网络恢复后，因为集群中有两个master节点，集群状态的不一致，出现脑裂的情况：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-06b1c6ef03ba5c974c8aad9163b9e84a" id="lht06b1c6ef03ba5c974c8aad9163b9e84a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272255649.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">解决脑裂的方案是，要求选票超过 ( eligible节点数量 + 1 ）/ 2 才能当选为主，因此eligible节点数量最好是奇数。对应配置项是discovery.zen.minimum_master_nodes，在es7.0以后，已经成为默认配置，因此一般不会发生脑裂问题</p>
<p class="component-content component">例如：3个节点形成的集群，选票必须超过 （3 + 1） / 2 ，也就是2票。node3得到node2和node3的选票，当选为主。node1只有自己1票，没有当选。集群中依然只有1个主节点，没有出现脑裂。</p>

<div class="component-content pagebody component">
  <h3 id="423小结" class="pagebody-header">
    4.2.3.小结
  </h3>
</div><p class="component-content component">master eligible节点的作用是什么？</p>
<div class="component-content component"><ul>
<li>参与集群选主</li>
<li>主节点可以管理集群状态、管理分片信息、处理创建和删除索引库的请求</li>
</ul></div>
<p class="component-content component">data节点的作用是什么？</p>
<div class="component-content component"><ul>
<li>数据的CRUD</li>
</ul></div>
<p class="component-content component">coordinator节点的作用是什么？</p>
<div class="component-content component"><ul>
<li>
<p class="component-content component">路由请求到其它节点</p>
</li>
<li>
<p class="component-content component">合并查询到的结果，返回给用户</p>
</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="43集群分布式存储" class="pagebody-header">
    4.3.集群分布式存储
  </h2>
</div><p class="component-content component">当新增文档时，应该保存到不同分片，保证数据均衡，那么coordinating node如何确定数据该存储到哪个分片呢？</p>

<div class="component-content pagebody component">
  <h3 id="431分片存储测试" class="pagebody-header">
    4.3.1.分片存储测试
  </h3>
</div><p class="component-content component">插入三条数据：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-a5250034e12ee6f3a33e9c266a4f218f" id="lhta5250034e12ee6f3a33e9c266a4f218f">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272255399.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-2068b6cb0ae10e223fc10b32e79b55e5" id="lht2068b6cb0ae10e223fc10b32e79b55e5">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272255665.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-9fc8f447abd122cac4a8282b9f559ca8" id="lht9fc8f447abd122cac4a8282b9f559ca8">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272255071.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">测试可以看到，三条数据分别在不同分片：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-b418d1d31c4f32e645c33bede07f2629" id="lhtb418d1d31c4f32e645c33bede07f2629">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272255818.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">结果：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-138c5c3dceaee8d643ccafc0ffcceb0e" id="lht138c5c3dceaee8d643ccafc0ffcceb0e">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272255211.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="432分片存储原理" class="pagebody-header">
    4.3.2.分片存储原理
  </h3>
</div><p class="component-content component">elasticsearch会通过hash算法来计算文档应该存储到哪个分片：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-6760a09818f1818b91e2808fb5d3a217" id="lht6760a09818f1818b91e2808fb5d3a217">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272256317.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">说明：</p>
<div class="component-content component"><ul>
<li>_routing默认是文档的id</li>
<li>算法与分片数量有关，因此索引库一旦创建，分片数量不能修改！</li>
</ul></div>
<p class="component-content component">新增文档的流程如下：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-f08f27bd2bbce1d24d7d79c458a699ee" id="lhtf08f27bd2bbce1d24d7d79c458a699ee">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272256718.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">解读：</p>
<div class="component-content component"><ul>
<li>1）新增一个id=1的文档</li>
<li>2）对id做hash运算，假如得到的是2，则应该存储到shard-2</li>
<li>3）shard-2的主分片在node3节点，将数据路由到node3</li>
<li>4）保存文档</li>
<li>5）同步给shard-2的副本replica-2，在node2节点</li>
<li>6）返回结果给coordinating-node节点</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="44集群分布式查询" class="pagebody-header">
    4.4.集群分布式查询
  </h2>
</div><p class="component-content component">elasticsearch的查询分成两个阶段：</p>
<div class="component-content component"><ul>
<li>
<p class="component-content component">scatter phase：分散阶段，coordinating node会把请求分发到每一个分片</p>
</li>
<li>
<p class="component-content component">gather phase：聚集阶段，coordinating node汇总data node的搜索结果，并处理为最终结果集返回给用户</p>
</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-5117658c9b9429e34b0c9808260bd459" id="lht5117658c9b9429e34b0c9808260bd459">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272256139.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="45集群故障转移" class="pagebody-header">
    4.5.集群故障转移
  </h2>
</div><p class="component-content component">集群的master节点会监控集群中的节点状态，如果发现有节点宕机，会立即将宕机节点的分片数据迁移到其它节点，确保数据安全，这个叫做故障转移。</p>
<p class="component-content component">1）例如一个集群结构如图：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-27378b7349cc90bd039959daaacc9344" id="lht27378b7349cc90bd039959daaacc9344">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272256294.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">现在，node1是主节点，其它两个节点是从节点。</p>
<p class="component-content component">2）突然，node1发生了故障：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-d09b1f2822797a5b770a32aeb22eca8b" id="lhtd09b1f2822797a5b770a32aeb22eca8b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272256214.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">宕机后的第一件事，需要重新选主，例如选中了node2：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-bf70cfb3c4509b03b45103881b07437f" id="lhtbf70cfb3c4509b03b45103881b07437f">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272256104.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">node2成为主节点后，会检测集群监控状态，发现：shard-1、shard-0没有副本节点。因此需要将node1上的数据迁移到node2、node3：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-d5fb93b599dec917ffe976c3a8464261" id="lhtd5fb93b599dec917ffe976c3a8464261">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308272256961.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  版权声明: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">版权声明：署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">作者:  yuanshuai </p>
                <p class="content">发表日期:  2023年7月19日</p>
              </div>
            </div>
          </div></article>
      </section>
  </main>

  <script>
    var script = document.createElement("script");script.src = "https://yuanshuai1122.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:shuaiyuan@gmail.com">shuaiyuan@gmail.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">社交媒体</div>
            
              <a href="https://github.com/yuanshuai1122" target="_blank">Github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">友链</div>
            
              <a href="https://yuanshuaicn.com/" target="_blank">👋</a>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2023
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
