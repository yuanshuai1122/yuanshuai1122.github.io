<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="zh-hans">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:title" content="Kubernetes-Pod控制器详解" />
<meta property="og:description" content="一、Pod控制器介绍 Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类： 自主式pod" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanshuai1122.github.io/11/kubernetes-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3/" /><meta property="article:section" content="11" />
<meta property="article:published_time" content="2023-07-19T18:12:20+00:00" />
<meta property="article:modified_time" content="2023-07-19T18:12:20+00:00" />
<title>Kubernetes-Pod控制器详解</title>

    <link rel="canonical" href="/11/kubernetes-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3/">

    <link rel="stylesheet" href="/css/global.css">

    <link rel="stylesheet" href="/css/custom.css">

    <link rel="stylesheet" href="/css/search.css" />

    
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/ " class="nav-title">🧀</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="/posts " class="nav-item-content">目录</a>
          </div><div class="nav-item-wrapper">
            <a href="/about" class="nav-item-content">关于</a>
          </div><div class="nav-item-wrapper">
            <a href="/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yuanshuai1122.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        docker
                      
                    
                  </span>
                  <span class="category-eyebrow__date">2023年7月19日</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">Kubernetes-Pod控制器详解</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="/tags/docker" class="tag">
                    docker
                  </a>
                
                  
                  <a href="/tags/k8s" class="tag">
                    k8s
                  </a>
                
                  
                  <a href="/tags/%E5%AE%B9%E5%99%A8" class="tag">
                    容器
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            
<div class="component-content pagebody component">
  <h2 id="一pod控制器介绍" class="pagebody-header">
    一、Pod控制器介绍
  </h2>
</div><p class="component-content component">Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类：</p>
<div class="component-content component"><ul>
<li>自主式pod：kubernetes直接创建出来的Pod，这种pod删除后就没有了，也不会重建</li>
<li>控制器创建的pod：kubernetes通过控制器创建的pod，这种pod删除了之后还会自动重建</li>
</ul></div>
<blockquote>
<p class="component-content component">什么是Pod控制器</p>
<p class="component-content component">Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。</p>
</blockquote>
<p class="component-content component">在kubernetes中，有很多类型的pod控制器，每种都有自己的适合的场景，常见的有下面这些：</p>
<div class="component-content component"><ul>
<li>ReplicationController：比较原始的pod控制器，已经被废弃，由ReplicaSet替代</li>
<li>ReplicaSet：保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级</li>
<li>Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本</li>
<li>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整Pod的数量，实现削峰填谷</li>
<li>DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务</li>
<li>Job：它创建出来的pod只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</li>
<li>Cronjob：它创建的Pod负责周期性任务控制，不需要持续后台运行</li>
<li>StatefulSet：管理有状态应用</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="二replicasetrs" class="pagebody-header">
    二、ReplicaSet(RS)
  </h2>
</div><p class="component-content component">ReplicaSet的主要作用是保证一定数量的pod正常运行，它会持续监听这些Pod的运行状态，一旦Pod发生故障，就会重启或重建。同时它还支持对pod数量的扩缩容和镜像版本的升降级。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-a6733cfcbda75e78400511600f4cbc30" id="lhta6733cfcbda75e78400511600f4cbc30">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840790.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">ReplicaSet的资源清单文件：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet</span> <span style="color:#75715e"># 类型       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rs名称 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># 所属命名空间 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">rs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:      <span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">nginx-pod]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">在这里面，需要新了解的配置项就是spec下面几个选项：</p>
<div class="component-content component"><ul>
<li>replicas：指定副本数量，其实就是当前rs创建出来的pod的数量，默认为1</li>
<li>selector：选择器，它的作用是建立pod控制器和pod之间的关联关系，采用的Label Selector机制</li>
<li>在pod模板上定义label，在控制器上定义选择器，就可以表明当前控制器能管理哪些pod了</li>
<li>template：模板，就是当前控制器创建pod所使用的模板板，里面其实就是前一章学过的pod的定义</li>
</ul></div>
<p class="component-content component"><strong>创建ReplicaSet</strong></p>
<p class="component-content component">创建pc-replicaset.yaml文件，内容如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ReplicaSet   </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-replicaset</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建rs</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-replicaset.yaml</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看rs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># DESIRED:期望副本数量  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CURRENT:当前副本数量  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># READY:已经准备好提供服务的副本数量</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs pc-replicaset -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR
</span></span><span style="display:flex;"><span>pc-replicaset <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       <span style="color:#ae81ff">3</span>     22s   nginx        nginx:1.17.1       app<span style="color:#f92672">=</span>nginx-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看当前控制器创建出来的pod</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这里发现控制器创建出来的pod的名称是在控制器名称后面拼接了-xxxxx随机码</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n dev</span>
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-6vmvt   1/1     Running   <span style="color:#ae81ff">0</span>          54s
</span></span><span style="display:flex;"><span>pc-replicaset-fmb8f   1/1     Running   <span style="color:#ae81ff">0</span>          54s
</span></span><span style="display:flex;"><span>pc-replicaset-snrk2   1/1     Running   <span style="color:#ae81ff">0</span>          54s</span></span></code></pre></div></div>
  
</div><p class="component-content component">扩缩容</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 编辑rs的副本数量，修改spec:replicas: 6即可</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit rs pc-replicaset -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset edited
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-6vmvt   1/1     Running   <span style="color:#ae81ff">0</span>          114m
</span></span><span style="display:flex;"><span>pc-replicaset-cftnp   1/1     Running   <span style="color:#ae81ff">0</span>          10s
</span></span><span style="display:flex;"><span>pc-replicaset-fjlm6   1/1     Running   <span style="color:#ae81ff">0</span>          10s
</span></span><span style="display:flex;"><span>pc-replicaset-fmb8f   1/1     Running   <span style="color:#ae81ff">0</span>          114m
</span></span><span style="display:flex;"><span>pc-replicaset-s2whj   1/1     Running   <span style="color:#ae81ff">0</span>          10s
</span></span><span style="display:flex;"><span>pc-replicaset-snrk2   1/1     Running   <span style="color:#ae81ff">0</span>          114m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 当然也可以直接使用命令实现</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用scale命令实现扩缩容， 后面--replicas=n直接指定目标数量即可</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl scale rs pc-replicaset --replicas=2 -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset scaled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 命令运行完毕，立即查看，发现已经有4个开始准备退出了</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS        RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-6vmvt   0/1     Terminating   <span style="color:#ae81ff">0</span>          118m
</span></span><span style="display:flex;"><span>pc-replicaset-cftnp   0/1     Terminating   <span style="color:#ae81ff">0</span>          4m17s
</span></span><span style="display:flex;"><span>pc-replicaset-fjlm6   0/1     Terminating   <span style="color:#ae81ff">0</span>          4m17s
</span></span><span style="display:flex;"><span>pc-replicaset-fmb8f   1/1     Running       <span style="color:#ae81ff">0</span>          118m
</span></span><span style="display:flex;"><span>pc-replicaset-s2whj   0/1     Terminating   <span style="color:#ae81ff">0</span>          4m17s
</span></span><span style="display:flex;"><span>pc-replicaset-snrk2   1/1     Running       <span style="color:#ae81ff">0</span>          118m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#稍等片刻，就只剩下2个了</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-fmb8f   1/1     Running   <span style="color:#ae81ff">0</span>          119m
</span></span><span style="display:flex;"><span>pc-replicaset-snrk2   1/1     Running   <span style="color:#ae81ff">0</span>          119m</span></span></code></pre></div></div>
  
</div><p class="component-content component">镜像升级</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 编辑rs的容器镜像 - image: nginx:1.17.2</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit rs pc-replicaset -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset edited
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 再次查看，发现镜像版本已经变更了</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        ...
</span></span><span style="display:flex;"><span>pc-replicaset       <span style="color:#ae81ff">2</span>        <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       140m   nginx         nginx:1.17.2  ...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 同样的道理，也可以使用命令完成这个工作</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># kubectl set image rs rs名称 容器=镜像版本 -n namespace</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps/pc-replicaset image updated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 再次查看，发现镜像版本已经变更了</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            ...
</span></span><span style="display:flex;"><span>pc-replicaset        <span style="color:#ae81ff">2</span>        <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       145m   nginx        nginx:1.17.1 ... </span></span></code></pre></div></div>
  
</div><p class="component-content component">删除ReplicaSet</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 使用kubectl delete命令会删除此RS以及它管理的Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 在kubernetes删除RS前，会将RS的replicasclear调整为0，等待所有的Pod被删除后，在执行RS对象的删除</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete rs pc-replicaset -n dev</span>
</span></span><span style="display:flex;"><span>replicaset.apps <span style="color:#e6db74">&#34;pc-replicaset&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n dev -o wide</span>
</span></span><span style="display:flex;"><span>No resources found in dev namespace.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果希望仅仅删除RS对象（保留Pod），可以使用kubectl delete命令时添加--cascade=false选项（不推荐）。</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete rs pc-replicaset -n dev --cascade=false</span>
</span></span><span style="display:flex;"><span>replicaset.apps <span style="color:#e6db74">&#34;pc-replicaset&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                  READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-replicaset-cl82j   1/1     Running   <span style="color:#ae81ff">0</span>          75s
</span></span><span style="display:flex;"><span>pc-replicaset-dslhb   1/1     Running   <span style="color:#ae81ff">0</span>          75s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 也可以使用yaml直接删除(推荐)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pc-replicaset.yaml</span>
</span></span><span style="display:flex;"><span>replicaset.apps <span style="color:#e6db74">&#34;pc-replicaset&#34;</span> deleted</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="三deploymentdeploy" class="pagebody-header">
    三、Deployment(Deploy)
  </h2>
</div><p class="component-content component">为了更好的解决服务编排的问题，kubernetes在V1.2版本开始，引入了Deployment控制器。值得一提的是，这种控制器并不直接管理pod，而是通过管理ReplicaSet来简介管理Pod，即：Deployment管理ReplicaSet，ReplicaSet管理Pod。所以Deployment比ReplicaSet功能更加强大。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-cdeafd4d7a9b22c7035bd81c7d43d9c1" id="lhtcdeafd4d7a9b22c7035bd81c7d43d9c1">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840290.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">Deployment主要功能有下面几个：</p>
<div class="component-content component"><ul>
<li>支持ReplicaSet的所有功能</li>
<li>支持发布的停止、继续</li>
<li>支持滚动升级和回滚版本</li>
</ul></div>
<p class="component-content component">Deployment的资源清单文件：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span> <span style="color:#75715e"># 类型       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rs名称 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># 所属命名空间 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">deploy</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 副本数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 保留历史版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">paused</span>: <span style="color:#66d9ef">false</span> <span style="color:#75715e"># 暂停部署，默认是false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">progressDeadlineSeconds</span>: <span style="color:#ae81ff">600</span> <span style="color:#75715e"># 部署超时时间（s），默认是600</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># 策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># 滚动更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>: <span style="color:#75715e"># 滚动更新</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max违规词汇</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%</span> <span style="color:#75715e"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">30</span><span style="color:#ae81ff">%</span> <span style="color:#75715e"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:      <span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">nginx-pod]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="31-创建deployment" class="pagebody-header">
    3.1 创建deployment
  </h3>
</div><p class="component-content component">创建pc-deployment.yaml，内容如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment      </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-deployment</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-deployment.yaml --record=true</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># UP-TO-DATE 最新版本的pod的数量</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># AVAILABLE  当前可用的pod的数量</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>NAME            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>pc-deployment   3/3     <span style="color:#ae81ff">3</span>            <span style="color:#ae81ff">3</span>           15s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看rs</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 发现rs的名称是在原来deployment的名字后面添加了一个10位数的随机串</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       23s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-d2c8n   1/1     Running   <span style="color:#ae81ff">0</span>          107s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-smpvp   1/1     Running   <span style="color:#ae81ff">0</span>          107s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-wvjd8   1/1     Running   <span style="color:#ae81ff">0</span>          107s</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="32-扩缩容" class="pagebody-header">
    3.2 扩缩容
  </h3>
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 变更副本数量为5个</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl scale deploy pc-deployment --replicas=5  -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment scaled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>NAME            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>pc-deployment   5/5     <span style="color:#ae81ff">5</span>            <span style="color:#ae81ff">5</span>           2m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-d2c8n   1/1     Running   <span style="color:#ae81ff">0</span>          4m19s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-jxmdq   1/1     Running   <span style="color:#ae81ff">0</span>          94s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-mktqv   1/1     Running   <span style="color:#ae81ff">0</span>          93s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-smpvp   1/1     Running   <span style="color:#ae81ff">0</span>          4m19s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-wvjd8   1/1     Running   <span style="color:#ae81ff">0</span>          4m19s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 编辑deployment的副本数量，修改spec:replicas: 4即可</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl edit deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment edited
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-d2c8n   1/1     Running   <span style="color:#ae81ff">0</span>          5m23s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-jxmdq   1/1     Running   <span style="color:#ae81ff">0</span>          2m38s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-smpvp   1/1     Running   <span style="color:#ae81ff">0</span>          5m23s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78-wvjd8   1/1     Running   <span style="color:#ae81ff">0</span>          5m23s</span></span></code></pre></div></div>
  
</div><p class="component-content component">镜像更新</p>
<p class="component-content component"><code>deployment</code>支持两种更新策略:<code>重建更新</code>和<code>滚动更新</code>,可以通过<code>strategy</code>指定策略类型,支持两个属性:</p>
<blockquote>
<p class="component-content component">strategy：指定新的Pod替换旧的Pod的策略， 支持两个属性：
type：指定策略类型，支持两种策略
Recreate：在创建出新的Pod之前会先杀掉所有已存在的Pod
RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本Pod
rollingUpdate：当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：
maxUnavailable：用来指定在升级过程中不可用Pod的最大数量，默认为25%。
max违规词汇： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</p>
</blockquote>
<p class="component-content component">重建更新</p>
<div class="component-content component"><ol>
<li>编辑pc-deployment.yaml,在spec节点下添加更新策略</li>
</ol></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># 策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Recreate</span> <span style="color:#75715e"># 重建更新</span></span></span></code></pre></div></div>
  
</div><ol start="2">
<li>创建deploy进行验证</li>
</ol></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 变更镜像</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment image updated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 观察升级过程</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-65qcw   1/1     Running   <span style="color:#ae81ff">0</span>          31s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-w5nzv   1/1     Running   <span style="color:#ae81ff">0</span>          31s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-xpt7w   1/1     Running   <span style="color:#ae81ff">0</span>          31s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-xpt7w   1/1     Terminating   <span style="color:#ae81ff">0</span>          41s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-65qcw   1/1     Terminating   <span style="color:#ae81ff">0</span>          41s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-w5nzv   1/1     Terminating   <span style="color:#ae81ff">0</span>          41s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-grn8z   0/1     Pending       <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-hbl4v   0/1     Pending       <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-67nz2   0/1     Pending       <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-grn8z   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-hbl4v   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-67nz2   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-grn8z   1/1     Running             <span style="color:#ae81ff">0</span>          1s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-67nz2   1/1     Running             <span style="color:#ae81ff">0</span>          1s
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b-hbl4v   1/1     Running             <span style="color:#ae81ff">0</span>          2s</span></span></code></pre></div></div>
  
</div><p class="component-content component">滚动更新</p>
<div class="component-content component"><ol>
<li>编辑pc-deployment.yaml,在spec节点下添加更新策略</li>
</ol></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># 策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># 滚动更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">max违规词汇</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">% </span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">25</span><span style="color:#ae81ff">%</span></span></span></code></pre></div></div>
  
</div><ol start="2">
<li>创建deploy进行验证</li>
</ol></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 变更镜像</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">root@k8s-master01 ~]# kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev </span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">deployment.apps/pc-deployment image updated</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 观察升级过程</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">root@k8s-master01 ~]# kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">NAME                           READY   STATUS    RESTARTS   AGE</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-c848d767-8rbzt   1/1     Running   0          31m</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-c848d767-h4p68   1/1     Running   0          31m</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-c848d767-hlmz4   1/1     Running   0          31m</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-c848d767-rrqcn   1/1     Running   0          31m</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-226rx   0/1     Pending             0          0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-226rx   0/1     ContainerCreating   0          0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-226rx   1/1     Running             0          1s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-c848d767-h4p68    0/1     Terminating         0          34m</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-cnd44   0/1     Pending             0          0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-cnd44   0/1     ContainerCreating   0          0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-cnd44   1/1     Running             0          2s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-c848d767-hlmz4    0/1     Terminating         0          34m</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-px48p   0/1     Pending             0          0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-px48p   0/1     ContainerCreating   0          0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-px48p   1/1     Running             0          0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-c848d767-8rbzt    0/1     Terminating         0          34m</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-dkmqp   0/1     Pending             0          0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-dkmqp   0/1     ContainerCreating   0          0s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-966bf7f44-dkmqp   1/1     Running             0          2s</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">pc-deployment-c848d767-rrqcn    0/1     Terminating         0          34m</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 至此，新版本的pod创建完毕，就版本的pod销毁完毕</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 中间过程是滚动进行的，也就是边销毁边创建</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">滚动更新的过程：</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-eb23a41fda4ae0fb708c030c125717d4" id="lhteb23a41fda4ae0fb708c030c125717d4">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841230.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">镜像更新中rs的变化</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看rs,发现原来的rs的依旧存在，只是pod数量变为了0，而后又新产生了一个rs，pod数量为4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 其实这就是deployment能够进行版本回退的奥妙所在，后面会详细解释</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       7m37s
</span></span><span style="display:flex;"><span>pc-deployment-6696798b11   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       5m37s
</span></span><span style="display:flex;"><span>pc-deployment-c848d76789   <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>       72s</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="33-版本回退" class="pagebody-header">
    3.3 版本回退
  </h3>
</div><p class="component-content component">deployment支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</p>
<p class="component-content component">kubectl rollout： 版本升级相关功能，支持下面的选项：</p>
<div class="component-content component"><ul>
<li>status 显示当前升级状态</li>
<li>history 显示 升级历史记录</li>
<li>pause 暂停版本升级过程</li>
<li>resume 继续已经暂停的版本升级过程</li>
<li>restart 重启版本升级过程</li>
<li>undo 回滚到上一级版本（可以使用–to-revision回滚到指定版本）</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看当前升级版本的状态</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout status deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>deployment <span style="color:#e6db74">&#34;pc-deployment&#34;</span> successfully rolled out
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看升级历史记录</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout history deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment
</span></span><span style="display:flex;"><span>REVISION  CHANGE-CAUSE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>         kubectl create --filename<span style="color:#f92672">=</span>pc-deployment.yaml --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>         kubectl create --filename<span style="color:#f92672">=</span>pc-deployment.yaml --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>         kubectl create --filename<span style="color:#f92672">=</span>pc-deployment.yaml --record<span style="color:#f92672">=</span>true
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可以发现有三次版本记录，说明完成过两次升级</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 版本回滚</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这里直接使用--to-revision=1回滚到了1版本， 如果省略这个选项，就是回退到上个版本，就是2版本</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment rolled back
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看发现，通过nginx镜像版本可以发现到了第一版</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deploy -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         
</span></span><span style="display:flex;"><span>pc-deployment   4/4     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">4</span>           74m   nginx        nginx:1.17.1   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看rs，发现第一个rs中有4个pod运行，后面两个版本的rs中pod为运行</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 其实deployment之所以可是实现版本的回滚，就是通过记录下历史rs来实现的，</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 一旦想回滚到哪个版本，只需要将当前版本pod数量降为0，然后将回滚版本的pod提升为目标数量就可以了</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6696798b78   <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>       78m
</span></span><span style="display:flex;"><span>pc-deployment-966bf7f44    <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       37m
</span></span><span style="display:flex;"><span>pc-deployment-c848d767     <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       71m</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="34-金丝雀发布" class="pagebody-header">
    3.4 金丝雀发布
  </h3>
</div><p class="component-content component">Deployment控制器支持控制更新过程中的控制，如“暂停(pause)”或“继续(resume)”更新操作。</p>
<p class="component-content component">比如有一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的Pod应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的Pod资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 更新deployment的版本，并配置暂停deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment image updated
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment paused
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#观察更新状态</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout status deploy pc-deployment -n dev　</span>
</span></span><span style="display:flex;"><span>Waiting <span style="color:#66d9ef">for</span> deployment <span style="color:#e6db74">&#34;pc-deployment&#34;</span> rollout to finish: <span style="color:#ae81ff">2</span> out of <span style="color:#ae81ff">4</span> new replicas have been updated...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9   <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>         <span style="color:#ae81ff">3</span>       19m     nginx        nginx:1.17.1   
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       14m     nginx        nginx:1.17.2   
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb   <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>         <span style="color:#ae81ff">2</span>       3m16s   nginx        nginx:1.17.4   
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-rj8sq   1/1     Running   <span style="color:#ae81ff">0</span>          7m33s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-ttwgg   1/1     Running   <span style="color:#ae81ff">0</span>          7m35s
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9-v4wvc   1/1     Running   <span style="color:#ae81ff">0</span>          7m34s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-996rt   1/1     Running   <span style="color:#ae81ff">0</span>          3m31s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   <span style="color:#ae81ff">0</span>          3m31s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 确保更新的pod没问题了，继续更新</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl rollout resume deploy pc-deployment -n dev</span>
</span></span><span style="display:flex;"><span>deployment.apps/pc-deployment resumed
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看最后的更新情况</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get rs -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
</span></span><span style="display:flex;"><span>pc-deployment-5d89bdfbf9   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       21m     nginx        nginx:1.17.1   
</span></span><span style="display:flex;"><span>pc-deployment-675d469f8b   <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>         <span style="color:#ae81ff">0</span>       16m     nginx        nginx:1.17.2   
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb   <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>         <span style="color:#ae81ff">4</span>       5m11s   nginx        nginx:1.17.4   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-7bfwh   1/1     Running   <span style="color:#ae81ff">0</span>          37s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-996rt   1/1     Running   <span style="color:#ae81ff">0</span>          5m27s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   <span style="color:#ae81ff">0</span>          5m27s
</span></span><span style="display:flex;"><span>pc-deployment-6c9f56fcfb-rf84v   1/1     Running   <span style="color:#ae81ff">0</span>          37s</span></span></code></pre></div></div>
  
</div><p class="component-content component">删除Deployment</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 删除deployment，其下的rs和pod也将被删除</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pc-deployment.yaml</span>
</span></span><span style="display:flex;"><span>deployment.apps <span style="color:#e6db74">&#34;pc-deployment&#34;</span> deleted</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="四horizontal-pod-autoscalerhpa" class="pagebody-header">
    四、Horizontal Pod Autoscaler(HPA)
  </h2>
</div><p class="component-content component">在前面，我们已经可以实现通过手工执行kubectl scale命令实现Pod扩容或缩容，但是这显然不符合Kubernetes的定位目标–自动化、智能化。 Kubernetes期望可以实现通过监测Pod的使用情况，实现pod数量的自动调整，于是就产生了Horizontal Pod Autoscaler（HPA）这种控制器。</p>
<p class="component-content component">HPA可以获取每个Pod利用率，然后和HPA中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现Pod的数量的调整。其实HPA与之前的Deployment一样，也属于一种Kubernetes资源对象，它通过追踪分析RC控制的所有目标Pod的负载变化情况，来确定是否需要针对性地调整目标Pod的副本数，这是HPA的实现原理。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-8ceff66b23e11264c9f7caa0889e799c" id="lht8ceff66b23e11264c9f7caa0889e799c">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841514.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">接下来，我们来做一个实验</p>

<div class="component-content pagebody component">
  <h3 id="41-安装metrics-server" class="pagebody-header">
    4.1 安装metrics-server
  </h3>
</div><p class="component-content component">metrics-server可以用来收集集群中的资源使用情况</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#75715e"># 安装git</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">root@k8s-master01 ~]# yum install git -y</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 获取metrics-server, 注意使用的版本</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">root@k8s-master01 ~]# git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 修改deployment, 注意修改的是镜像和初始化参数</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">root@k8s-master01 ~]# cd /root/metrics-server/deploy/1.8+/</span>
</span></span><span style="display:flex;"><span>[<span style="color:#ae81ff">root@k8s-master01 1.8+]# vim metrics-server-deployment.yaml</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">按图中添加下面选项</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">hostNetwork</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">image</span>: <span style="color:#ae81ff">registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">args</span>:
</span></span><span style="display:flex;"><span>- --<span style="color:#ae81ff">kubelet-insecure-tls</span>
</span></span><span style="display:flex;"><span>- --<span style="color:#ae81ff">kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-11fe267511853f456b07a3af2fea7312" id="lht11fe267511853f456b07a3af2fea7312">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841011.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 安装metrics-server</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl apply -f ./</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod运行情况</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pod -n kube-system</span>
</span></span><span style="display:flex;"><span>metrics-server-6b976979db-2xwbj   1/1     Running   <span style="color:#ae81ff">0</span>          90s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用kubectl top node 查看资源使用情况</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl top node</span>
</span></span><span style="display:flex;"><span>NAME           CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   CPU%   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>   MEMORY%
</span></span><span style="display:flex;"><span>k8s-master01   289m         14%    1582Mi          54%       
</span></span><span style="display:flex;"><span>k8s-node01     81m          4%     1195Mi          40%       
</span></span><span style="display:flex;"><span>k8s-node02     72m          3%     1211Mi          41%  
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl top pod -n kube-system</span>
</span></span><span style="display:flex;"><span>NAME                              CPU<span style="color:#f92672">(</span>cores<span style="color:#f92672">)</span>   MEMORY<span style="color:#f92672">(</span>bytes<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>coredns-6955765f44-7ptsb          3m           9Mi
</span></span><span style="display:flex;"><span>coredns-6955765f44-vcwr5          3m           8Mi
</span></span><span style="display:flex;"><span>etcd-master                       14m          145Mi
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 至此,metrics-server安装完成</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="42-准备deployment和servie" class="pagebody-header">
    4.2 准备deployment和servie
  </h3>
</div><p class="component-content component">创建pc-hpa-pod.yaml文件，内容如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>: <span style="color:#75715e"># 策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># 滚动更新策略</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">resources</span>: <span style="color:#75715e"># 资源配额</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">limits</span>:  <span style="color:#75715e"># 限制资源（上限）</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;1&#34;</span> <span style="color:#75715e"># CPU限制，单位是core数</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">requests</span>: <span style="color:#75715e"># 请求资源（下限）</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">cpu</span>: <span style="color:#e6db74">&#34;100m&#34;</span>  <span style="color:#75715e"># CPU限制，单位是core数</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 创建service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 查看</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deployment,pod,svc -n dev</span>
</span></span><span style="display:flex;"><span>NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>deployment.apps/nginx   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           47s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME                         READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pod/nginx-7df9756ccc-bh8dr   1/1     Running   <span style="color:#ae81ff">0</span>          47s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>        AGE
</span></span><span style="display:flex;"><span>service/nginx   NodePort   10.101.18.29   &lt;none&gt;        80:31830/TCP   35s</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="43-部署hpa" class="pagebody-header">
    4.3 部署HPA
  </h3>
</div><p class="component-content component">创建pc-hpa.yaml文件，内容如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">autoscaling/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">HorizontalPodAutoscaler</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-hpa</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReplicas</span>: <span style="color:#ae81ff">1</span>  <span style="color:#75715e">#最小pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">maxReplicas</span>: <span style="color:#ae81ff">10</span> <span style="color:#75715e">#最大pod数量</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">targetCPUUtilizationPercentage</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># CPU使用率指标</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scaleTargetRef</span>:   <span style="color:#75715e"># 指定要控制的nginx信息</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">apiVersion</span>:  <span style="color:#ae81ff">/v1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建hpa</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-hpa.yaml</span>
</span></span><span style="display:flex;"><span>horizontalpodautoscaler.autoscaling/pc-hpa created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看hpa</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[</span>root@k8s-master01 1.8+<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get hpa -n dev</span>
</span></span><span style="display:flex;"><span>NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span style="display:flex;"><span>pc-hpa   Deployment/nginx   0%/3%     <span style="color:#ae81ff">1</span>         <span style="color:#ae81ff">10</span>        <span style="color:#ae81ff">1</span>          62s</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="44-测试" class="pagebody-header">
    4.4 测试
  </h3>
</div><p class="component-content component">使用压测工具对service地址192.168.5.4:31830进行压测，然后通过控制台查看hpa和pod的变化</p>
<p class="component-content component">hpa变化</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get hpa -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">1</span>      4m11s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">1</span>      5m19s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  22%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">1</span>      6m50s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  22%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">4</span>      7m5s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  22%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">8</span>      7m21s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  6%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">8</span>      7m51s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">8</span>      9m6s
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">8</span>      13m
</span></span><span style="display:flex;"><span>pc-hpa  Deployment/nginx  0%/3%   <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">1</span>      14m</span></span></code></pre></div></div>
  
</div><p class="component-content component">deployment变化</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get deployment -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style="display:flex;"><span>nginx   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           11m
</span></span><span style="display:flex;"><span>nginx   1/4     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           13m
</span></span><span style="display:flex;"><span>nginx   1/4     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           13m
</span></span><span style="display:flex;"><span>nginx   1/4     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           13m
</span></span><span style="display:flex;"><span>nginx   1/4     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">1</span>           13m
</span></span><span style="display:flex;"><span>nginx   1/8     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">1</span>           14m
</span></span><span style="display:flex;"><span>nginx   1/8     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">1</span>           14m
</span></span><span style="display:flex;"><span>nginx   1/8     <span style="color:#ae81ff">4</span>            <span style="color:#ae81ff">1</span>           14m
</span></span><span style="display:flex;"><span>nginx   1/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">1</span>           14m
</span></span><span style="display:flex;"><span>nginx   2/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">2</span>           14m
</span></span><span style="display:flex;"><span>nginx   3/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">3</span>           14m
</span></span><span style="display:flex;"><span>nginx   4/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">4</span>           14m
</span></span><span style="display:flex;"><span>nginx   5/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">5</span>           14m
</span></span><span style="display:flex;"><span>nginx   6/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">6</span>           14m
</span></span><span style="display:flex;"><span>nginx   7/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">7</span>           14m
</span></span><span style="display:flex;"><span>nginx   8/8     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">8</span>           15m
</span></span><span style="display:flex;"><span>nginx   8/1     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">8</span>           20m
</span></span><span style="display:flex;"><span>nginx   8/1     <span style="color:#ae81ff">8</span>            <span style="color:#ae81ff">8</span>           20m
</span></span><span style="display:flex;"><span>nginx   1/1     <span style="color:#ae81ff">1</span>            <span style="color:#ae81ff">1</span>           20m</span></span></code></pre></div></div>
  
</div><p class="component-content component">pod变化</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-bh8dr   1/1     Running   <span style="color:#ae81ff">0</span>          11m
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-cpgrv   0/1     Pending   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-8zhwk   0/1     Pending   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-rr9bn   0/1     Pending   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-m9gsj   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-g56qb   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-sl9c6   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-fgst7   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-g56qb   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-fgst7   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-8zhwk   1/1     Running             <span style="color:#ae81ff">0</span>          19s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-rr9bn   1/1     Running             <span style="color:#ae81ff">0</span>          30s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-m9gsj   1/1     Running             <span style="color:#ae81ff">0</span>          21s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-cpgrv   1/1     Running             <span style="color:#ae81ff">0</span>          47s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-sl9c6   1/1     Running             <span style="color:#ae81ff">0</span>          33s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-g56qb   1/1     Running             <span style="color:#ae81ff">0</span>          48s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-fgst7   1/1     Running             <span style="color:#ae81ff">0</span>          66s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-fgst7   1/1     Terminating         <span style="color:#ae81ff">0</span>          6m50s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-8zhwk   1/1     Terminating         <span style="color:#ae81ff">0</span>          7m5s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-cpgrv   1/1     Terminating         <span style="color:#ae81ff">0</span>          7m5s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-g56qb   1/1     Terminating         <span style="color:#ae81ff">0</span>          6m50s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-rr9bn   1/1     Terminating         <span style="color:#ae81ff">0</span>          7m5s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-m9gsj   1/1     Terminating         <span style="color:#ae81ff">0</span>          6m50s
</span></span><span style="display:flex;"><span>nginx-7df9756ccc-sl9c6   1/1     Terminating         <span style="color:#ae81ff">0</span>          6m50s</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="五daemonsetds" class="pagebody-header">
    五、DaemonSet(DS)
  </h2>
</div><p class="component-content component">DaemonSet类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个Pod提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类Pod就适合使用DaemonSet类型的控制器创建。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-7fa4a4113e2843c86409ad5549b6b315" id="lht7fa4a4113e2843c86409ad5549b6b315">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841881.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">DaemonSet控制器的特点：</p>
<div class="component-content component"><ul>
<li>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</li>
<li>当节点从集群中移除时，Pod 也就被垃圾回收了</li>
</ul></div>
<p class="component-content component">下面先来看下DaemonSet的资源清单文件</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet</span> <span style="color:#75715e"># 类型       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rs名称 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># 所属命名空间 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">daemonset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">revisionHistoryLimit</span>: <span style="color:#ae81ff">3</span> <span style="color:#75715e"># 保留历史版本</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">updateStrategy</span>: <span style="color:#75715e"># 更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span> <span style="color:#75715e"># 滚动更新策略</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>: <span style="color:#75715e"># 滚动更新</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">1</span> <span style="color:#75715e"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:      <span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">nginx-pod]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">创建pc-daemonset.yaml，内容如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">apps/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">DaemonSet      </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-daemonset</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">nginx-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">nginx:1.17.1</span></span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建daemonset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f  pc-daemonset.yaml</span>
</span></span><span style="display:flex;"><span>daemonset.apps/pc-daemonset created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看daemonset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get ds -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES         
</span></span><span style="display:flex;"><span>pc-daemonset   <span style="color:#ae81ff">2</span>        <span style="color:#ae81ff">2</span>        <span style="color:#ae81ff">2</span>      <span style="color:#ae81ff">2</span>           <span style="color:#ae81ff">2</span>        24s   nginx        nginx:1.17.1   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod,发现在每个Node上都运行一个pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e">#  kubectl get pods -n dev -o wide</span>
</span></span><span style="display:flex;"><span>NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    
</span></span><span style="display:flex;"><span>pc-daemonset-9bck8   1/1     Running   <span style="color:#ae81ff">0</span>          37s   10.244.1.43   node1     
</span></span><span style="display:flex;"><span>pc-daemonset-k224w   1/1     Running   <span style="color:#ae81ff">0</span>          37s   10.244.2.74   node2      
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除daemonset</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pc-daemonset.yaml</span>
</span></span><span style="display:flex;"><span>daemonset.apps <span style="color:#e6db74">&#34;pc-daemonset&#34;</span> deleted</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="六job" class="pagebody-header">
    六、Job
  </h2>
</div><p class="component-content component">Job，主要用于负责**批量处理(一次要处理指定数量任务)短暂的一次性(每个任务仅运行一次就结束)**任务。Job特点如下：</p>
<div class="component-content component"><ul>
<li>当Job创建的pod执行成功结束时，Job将记录成功结束的pod数量</li>
<li>当成功结束的pod达到指定的数量时，Job将完成执行</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-a382b55e627c3b1badd418fb55359238" id="lhta382b55e627c3b1badd418fb55359238">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841970.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">Job的资源清单文件：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job</span> <span style="color:#75715e"># 类型       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rs名称 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># 所属命名空间 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">completions: 1 # 指定job需要成功运行Pods的次数。默认值</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">parallelism: 1 # 指定job在任一时刻应该并发运行Pods的数量。默认值</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span> <span style="color:#75715e"># 指定job可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span> <span style="color:#75715e"># 指定job失败后进行重试的次数。默认是6</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 是否可以使用selector选择器选择pod，默认是false</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>: <span style="color:#75715e"># 选择器，通过它指定该控制器管理哪些pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:      <span style="color:#75715e"># Labels匹配规则</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchExpressions</span>: <span style="color:#75715e"># Expressions匹配规则</span>
</span></span><span style="display:flex;"><span>      - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">counter-pod]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>: <span style="color:#75715e"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span> <span style="color:#75715e"># 重启策略只能设置为Never或者OnFailure</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&#34;</span>]</span></span></code></pre></div></div>
  
</div><blockquote>
<p class="component-content component">关于重启策略设置的说明：
如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变
如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加1
如果指定为Always的话，就意味着一直重启，意味着job任务会重复去执行了，当然不对，所以不能设置为Always</p>
</blockquote>
<p class="component-content component">创建pc-job.yaml，内容如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Job      </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-job</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span>]</span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-job.yaml</span>
</span></span><span style="display:flex;"><span>job.batch/pc-job created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get job -n dev -o wide  -w</span>
</span></span><span style="display:flex;"><span>NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span style="display:flex;"><span>pc-job   0/1           21s        21s   counter      busybox:1.30   app<span style="color:#f92672">=</span>counter-pod
</span></span><span style="display:flex;"><span>pc-job   1/1           31s        79s   counter      busybox:1.30   app<span style="color:#f92672">=</span>counter-pod
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 通过观察pod状态可以看到，pod在运行完毕任务后，就会变成Completed状态</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME           READY   STATUS     RESTARTS      AGE
</span></span><span style="display:flex;"><span>pc-job-rxg96   1/1     Running     <span style="color:#ae81ff">0</span>            29s
</span></span><span style="display:flex;"><span>pc-job-rxg96   0/1     Completed   <span style="color:#ae81ff">0</span>            33s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 接下来，调整下pod运行的总数量和并行数量 即：在spec下设置下面两个选项</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  completions: 6 # 指定job需要成功运行Pods的次数为6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  parallelism: 3 # 指定job并发运行Pods的数量为3</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#  然后重新运行job，观察效果，此时会发现，job会每次运行3个pod，总共执行了6个pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev -w</span>
</span></span><span style="display:flex;"><span>NAME           READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>pc-job-684ft   1/1     Running   <span style="color:#ae81ff">0</span>          5s
</span></span><span style="display:flex;"><span>pc-job-jhj49   1/1     Running   <span style="color:#ae81ff">0</span>          5s
</span></span><span style="display:flex;"><span>pc-job-pfcvh   1/1     Running   <span style="color:#ae81ff">0</span>          5s
</span></span><span style="display:flex;"><span>pc-job-684ft   0/1     Completed   <span style="color:#ae81ff">0</span>          11s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   0/1     Pending     <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   0/1     Pending     <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-jhj49   0/1     Completed           <span style="color:#ae81ff">0</span>          11s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-pfcvh   0/1     Completed           <span style="color:#ae81ff">0</span>          11s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   0/1     Pending             <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   0/1     ContainerCreating   <span style="color:#ae81ff">0</span>          0s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   1/1     Running             <span style="color:#ae81ff">0</span>          2s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   1/1     Running             <span style="color:#ae81ff">0</span>          2s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   1/1     Running             <span style="color:#ae81ff">0</span>          3s
</span></span><span style="display:flex;"><span>pc-job-fhwf7   0/1     Completed           <span style="color:#ae81ff">0</span>          12s
</span></span><span style="display:flex;"><span>pc-job-v7rhr   0/1     Completed           <span style="color:#ae81ff">0</span>          12s
</span></span><span style="display:flex;"><span>pc-job-5vg2j   0/1     Completed           <span style="color:#ae81ff">0</span>          12s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl delete -f pc-job.yaml</span>
</span></span><span style="display:flex;"><span>job.batch <span style="color:#e6db74">&#34;pc-job&#34;</span> deleted</span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="七cronjobcj" class="pagebody-header">
    七、CronJob(CJ)
  </h2>
</div><p class="component-content component">CronJob控制器以 Job控制器资源为其管控对象，并借助它管理pod资源对象，Job控制器定义的作业任务在其控制器资源创建之后便会立即执行，但CronJob可以以类似于Linux操作系统的周期性任务作业计划的方式控制其运行时间点及重复运行的方式。也就是说，CronJob可以在特定的时间点(反复的)去运行job任务。</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-88f46a1b0f738ef6a3560966ea6bb2d2" id="lht88f46a1b0f738ef6a3560966ea6bb2d2">
        <picture  class="picture">
          <img class="picture-image" data-src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210842037.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">CronJob的资源清单文件：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1beta1</span> <span style="color:#75715e"># 版本号</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CronJob</span> <span style="color:#75715e"># 类型       </span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>: <span style="color:#75715e"># 元数据</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#75715e"># rs名称 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#75715e"># 所属命名空间 </span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>: <span style="color:#75715e">#标签</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>: <span style="color:#75715e"># 详情描述</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#75715e"># cron格式的作业调度运行时间点,用于控制任务在什么时间执行</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">concurrencyPolicy</span>: <span style="color:#75715e"># 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">failedJobHistoryLimit</span>: <span style="color:#75715e"># 为失败的任务执行保留的历史记录数，默认为1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">successfulJobHistoryLimit</span>: <span style="color:#75715e"># 为成功的任务执行保留的历史记录数，默认为3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">startingDeadlineSeconds</span>: <span style="color:#75715e"># 启动作业错误的超时时长</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobTemplate</span>: <span style="color:#75715e"># job控制器模板，用于为cronjob控制器生成job对象;下面其实就是job的定义</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">completions</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">parallelism</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">activeDeadlineSeconds</span>: <span style="color:#ae81ff">30</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">backoffLimit</span>: <span style="color:#ae81ff">6</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">manualSelector</span>: <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchLabels</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">matchExpressions</span>: <span style="color:#ae81ff">规则</span>
</span></span><span style="display:flex;"><span>          - {<span style="color:#f92672">key: app, operator: In, values</span>: [<span style="color:#ae81ff">counter-pod]}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">app</span>: <span style="color:#ae81ff">counter-pod</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never </span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&#34;</span>]</span></span></code></pre></div></div>
  
</div><blockquote>
<p class="component-content component">需要重点解释的几个选项：
schedule: cron表达式，用于指定任务的执行时间
*/1    *      *    *     *
&lt;分钟&gt; &lt;小时&gt; &lt;日&gt; &lt;月份&gt; &lt;星期&gt;</p>
<p class="component-content component">​	分钟 值从 0 到 59.
​	小时 值从 0 到 23.
​	日 值从 1 到 31.
​	月 值从 1 到 12.
​	星期 值从 0 到 6, 0 代表星期日
​	多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每&hellip;</p>
<p class="component-content component">concurrencyPolicy:
Allow:   允许Jobs并发运行(默认)
Forbid:  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行
Replace: 替换，取消当前正在运行的作业并用新作业替换它</p>
</blockquote>
<p class="component-content component">创建pc-cronjob.yaml，内容如下：</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">batch/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">CronJob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">pc-cronjob</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">namespace</span>: <span style="color:#ae81ff">dev</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">controller</span>: <span style="color:#ae81ff">cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">schedule</span>: <span style="color:#e6db74">&#34;*/1 * * * *&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">jobTemplate</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">restartPolicy</span>: <span style="color:#ae81ff">Never</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">counter</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">image</span>: <span style="color:#ae81ff">busybox:1.30</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">command</span>: [<span style="color:#e6db74">&#34;bin/sh&#34;</span>,<span style="color:#e6db74">&#34;-c&#34;</span>,<span style="color:#e6db74">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span>]</span></span></code></pre></div></div>
  
</div><div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 创建cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl create -f pc-cronjob.yaml</span>
</span></span><span style="display:flex;"><span>cronjob.batch/pc-cronjob created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get cronjobs -n dev</span>
</span></span><span style="display:flex;"><span>NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
</span></span><span style="display:flex;"><span>pc-cronjob   */1 * * * *   False     <span style="color:#ae81ff">0</span>        &lt;none&gt;          6s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看job</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get jobs -n dev</span>
</span></span><span style="display:flex;"><span>NAME                    COMPLETIONS   DURATION   AGE
</span></span><span style="display:flex;"><span>pc-cronjob-1592587800   1/1           28s        3m26s
</span></span><span style="display:flex;"><span>pc-cronjob-1592587860   1/1           28s        2m26s
</span></span><span style="display:flex;"><span>pc-cronjob-1592587920   1/1           28s        86s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看pod</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl get pods -n dev</span>
</span></span><span style="display:flex;"><span>pc-cronjob-1592587800-x4tsm   0/1     Completed   <span style="color:#ae81ff">0</span>          2m24s
</span></span><span style="display:flex;"><span>pc-cronjob-1592587860-r5gv4   0/1     Completed   <span style="color:#ae81ff">0</span>          84s
</span></span><span style="display:flex;"><span>pc-cronjob-1592587920-9dxxq   1/1     Running     <span style="color:#ae81ff">0</span>          24s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除cronjob</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>root@k8s-master01 ~<span style="color:#f92672">]</span><span style="color:#75715e"># kubectl  delete -f pc-cronjob.yaml</span>
</span></span><span style="display:flex;"><span>cronjob.batch <span style="color:#e6db74">&#34;pc-cronjob&#34;</span> deleted</span></span></code></pre></div></div>
  
</div>
          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  版权声明: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">版权声明：署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">作者:  yuanshuai </p>
                <p class="content">发表日期:  2023年7月19日</p>
              </div>
            </div>
          </div></article>
      </section>
  </main>

  <script>
    var script = document.createElement("script");script.src = "https://yuanshuai1122.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:shuaiyuan@gmail.com">shuaiyuan@gmail.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">社交媒体</div>
            
              <a href="https://github.com/yuanshuai1122" target="_blank">Github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">友链</div>
            
              <a href="https://yuanshuaicn.com/" target="_blank">👋</a>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2023
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
