<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Kubernetes-Pod控制器详解 - CN.yuanshuai</title><meta name="author" content="">
<meta name="author-link" content="">
<meta name="description" content="一、Pod控制器介绍 Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类： 自主式pod" /><meta name="keywords" content='docker, k8s, 容器' /><meta itemprop="name" content="Kubernetes-Pod控制器详解">
<meta itemprop="description" content="一、Pod控制器介绍 Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类： 自主式pod"><meta itemprop="datePublished" content="2023-07-19T18:12:20+00:00" />
<meta itemprop="dateModified" content="2023-07-19T18:12:20+00:00" />
<meta itemprop="wordCount" content="9167">
<meta itemprop="keywords" content="docker,k8s,容器," /><meta property="og:title" content="Kubernetes-Pod控制器详解" />
<meta property="og:description" content="一、Pod控制器介绍 Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类： 自主式pod" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://yuanshuai1122.github.io/posts/kubernetes-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-07-19T18:12:20+00:00" />
<meta property="article:modified_time" content="2023-07-19T18:12:20+00:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Kubernetes-Pod控制器详解"/>
<meta name="twitter:description" content="一、Pod控制器介绍 Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类： 自主式pod"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="http://yuanshuai1122.github.io/posts/kubernetes-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3/" /><link rel="prev" href="http://yuanshuai1122.github.io/posts/kubernetes-pod%E8%AF%A6%E8%A7%A3/" /><link rel="next" href="http://yuanshuai1122.github.io/posts/elasticsearch-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Kubernetes-Pod控制器详解",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "http:\/\/yuanshuai1122.github.io\/posts\/kubernetes-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3\/"
    },"genre": "posts","keywords": "docker, k8s, 容器","wordcount":  9167 ,
    "url": "http:\/\/yuanshuai1122.github.io\/posts\/kubernetes-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3\/","datePublished": "2023-07-19T18:12:20+00:00","dateModified": "2023-07-19T18:12:20+00:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "yuanshuai"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="CN.yuanshuai"><img loading="lazy" src="/fixit.min.svg" srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" sizes="auto" data-title="CN.yuanshuai" data-alt="CN.yuanshuai" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">CN.yuanshuai</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="CN.yuanshuai"><img loading="lazy" src="/fixit.min.svg" srcset="/fixit.min.svg, /fixit.min.svg 1.5x, /fixit.min.svg 2x" sizes="auto" data-title="/fixit.min.svg" data-alt="/fixit.min.svg" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/><span class="header-title-text">CN.yuanshuai</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span>Kubernetes-Pod控制器详解</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><span class="author"><i class="fa-solid fa-user-circle" aria-hidden="true"></i>
      yuanshuai</span></span></div>
      <div class="post-meta-line"><span title="发布于 2023-07-19 18:12:20"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2023-07-19">2023-07-19</time></span>&nbsp;<span title="更新于 2023-07-19 18:12:20"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2023-07-19">2023-07-19</time></span>&nbsp;<span title="9167 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 9200 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 19 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一pod控制器介绍">一、Pod控制器介绍</a></li>
    <li><a href="#二replicasetrs">二、ReplicaSet(RS)</a></li>
    <li><a href="#三deploymentdeploy">三、Deployment(Deploy)</a>
      <ul>
        <li><a href="#31-创建deployment">3.1 创建deployment</a></li>
        <li><a href="#32-扩缩容">3.2 扩缩容</a></li>
        <li><a href="#33-版本回退">3.3 版本回退</a></li>
        <li><a href="#34-金丝雀发布">3.4 金丝雀发布</a></li>
      </ul>
    </li>
    <li><a href="#四horizontal-pod-autoscalerhpa">四、Horizontal Pod Autoscaler(HPA)</a>
      <ul>
        <li><a href="#41-安装metrics-server">4.1 安装metrics-server</a></li>
        <li><a href="#42-准备deployment和servie">4.2 准备deployment和servie</a></li>
        <li><a href="#43-部署hpa">4.3 部署HPA</a></li>
        <li><a href="#44-测试">4.4 测试</a></li>
      </ul>
    </li>
    <li><a href="#五daemonsetds">五、DaemonSet(DS)</a></li>
    <li><a href="#六job">六、Job</a></li>
    <li><a href="#七cronjobcj">七、CronJob(CJ)</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><h2 id="一pod控制器介绍">一、Pod控制器介绍</h2>
<p>Pod是kubernetes的最小管理单元，在kubernetes中，按照pod的创建方式可以将其分为两类：</p>
<ul>
<li>自主式pod：kubernetes直接创建出来的Pod，这种pod删除后就没有了，也不会重建</li>
<li>控制器创建的pod：kubernetes通过控制器创建的pod，这种pod删除了之后还会自动重建</li>
</ul>
<blockquote>
<p>什么是Pod控制器</p>
<p>Pod控制器是管理pod的中间层，使用Pod控制器之后，只需要告诉Pod控制器，想要多少个什么样的Pod就可以了，它会创建出满足条件的Pod并确保每一个Pod资源处于用户期望的目标状态。如果Pod资源在运行中出现故障，它会基于指定策略重新编排Pod。</p>
</blockquote>
<p>在kubernetes中，有很多类型的pod控制器，每种都有自己的适合的场景，常见的有下面这些：</p>
<ul>
<li>ReplicationController：比较原始的pod控制器，已经被废弃，由ReplicaSet替代</li>
<li>ReplicaSet：保证副本数量一直维持在期望值，并支持pod数量扩缩容，镜像版本升级</li>
<li>Deployment：通过控制ReplicaSet来控制Pod，并支持滚动升级、回退版本</li>
<li>Horizontal Pod Autoscaler：可以根据集群负载自动水平调整Pod的数量，实现削峰填谷</li>
<li>DaemonSet：在集群中的指定Node上运行且仅运行一个副本，一般用于守护进程类的任务</li>
<li>Job：它创建出来的pod只要完成任务就立即退出，不需要重启或重建，用于执行一次性任务</li>
<li>Cronjob：它创建的Pod负责周期性任务控制，不需要持续后台运行</li>
<li>StatefulSet：管理有状态应用</li>
</ul>
<h2 id="二replicasetrs">二、ReplicaSet(RS)</h2>
<p>ReplicaSet的主要作用是保证一定数量的pod正常运行，它会持续监听这些Pod的运行状态，一旦Pod发生故障，就会重启或重建。同时它还支持对pod数量的扩缩容和镜像版本的升降级。</p>
<p><img loading="lazy" src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840790.png" srcset="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840790.png, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840790.png 1.5x, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840790.png 2x" sizes="auto" data-title="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840790.png" data-alt="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840790.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>ReplicaSet的资源清单文件：</p>
<div class="highlight" id="id-1"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet</span><span class="w"> </span><span class="c"># 类型       </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">rs</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 副本数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择器，通过它指定该控制器管理哪些pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">      </span><span class="c"># Labels匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># Expressions匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">nginx-pod]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></div><p>在这里面，需要新了解的配置项就是spec下面几个选项：</p>
<ul>
<li>replicas：指定副本数量，其实就是当前rs创建出来的pod的数量，默认为1</li>
<li>selector：选择器，它的作用是建立pod控制器和pod之间的关联关系，采用的Label Selector机制</li>
<li>在pod模板上定义label，在控制器上定义选择器，就可以表明当前控制器能管理哪些pod了</li>
<li>template：模板，就是当前控制器创建pod所使用的模板板，里面其实就是前一章学过的pod的定义</li>
</ul>
<p><strong>创建ReplicaSet</strong></p>
<p>创建pc-replicaset.yaml文件，内容如下：</p>
<div class="highlight" id="id-2"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">ReplicaSet   </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-replicaset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span></span></span></code></pre></div><div class="highlight" id="id-3"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建rs</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pc-replicaset.yaml</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看rs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># DESIRED:期望副本数量  </span>
</span></span><span class="line"><span class="cl"><span class="c1"># CURRENT:当前副本数量  </span>
</span></span><span class="line"><span class="cl"><span class="c1"># READY:已经准备好提供服务的副本数量</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs pc-replicaset -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME          DESIRED   CURRENT READY AGE   CONTAINERS   IMAGES             SELECTOR
</span></span><span class="line"><span class="cl">pc-replicaset <span class="m">3</span>         <span class="m">3</span>       <span class="m">3</span>     22s   nginx        nginx:1.17.1       <span class="nv">app</span><span class="o">=</span>nginx-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看当前控制器创建出来的pod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这里发现控制器创建出来的pod的名称是在控制器名称后面拼接了-xxxxx随机码</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod -n dev</span>
</span></span><span class="line"><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-6vmvt   1/1     Running   <span class="m">0</span>          54s
</span></span><span class="line"><span class="cl">pc-replicaset-fmb8f   1/1     Running   <span class="m">0</span>          54s
</span></span><span class="line"><span class="cl">pc-replicaset-snrk2   1/1     Running   <span class="m">0</span>          54s</span></span></code></pre></div><p>扩缩容</p>
<div class="highlight" id="id-4"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 编辑rs的副本数量，修改spec:replicas: 6即可</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl edit rs pc-replicaset -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset edited
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-6vmvt   1/1     Running   <span class="m">0</span>          114m
</span></span><span class="line"><span class="cl">pc-replicaset-cftnp   1/1     Running   <span class="m">0</span>          10s
</span></span><span class="line"><span class="cl">pc-replicaset-fjlm6   1/1     Running   <span class="m">0</span>          10s
</span></span><span class="line"><span class="cl">pc-replicaset-fmb8f   1/1     Running   <span class="m">0</span>          114m
</span></span><span class="line"><span class="cl">pc-replicaset-s2whj   1/1     Running   <span class="m">0</span>          10s
</span></span><span class="line"><span class="cl">pc-replicaset-snrk2   1/1     Running   <span class="m">0</span>          114m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 当然也可以直接使用命令实现</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 使用scale命令实现扩缩容， 后面--replicas=n直接指定目标数量即可</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl scale rs pc-replicaset --replicas=2 -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset scaled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 命令运行完毕，立即查看，发现已经有4个开始准备退出了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS        RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-6vmvt   0/1     Terminating   <span class="m">0</span>          118m
</span></span><span class="line"><span class="cl">pc-replicaset-cftnp   0/1     Terminating   <span class="m">0</span>          4m17s
</span></span><span class="line"><span class="cl">pc-replicaset-fjlm6   0/1     Terminating   <span class="m">0</span>          4m17s
</span></span><span class="line"><span class="cl">pc-replicaset-fmb8f   1/1     Running       <span class="m">0</span>          118m
</span></span><span class="line"><span class="cl">pc-replicaset-s2whj   0/1     Terminating   <span class="m">0</span>          4m17s
</span></span><span class="line"><span class="cl">pc-replicaset-snrk2   1/1     Running       <span class="m">0</span>          118m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#稍等片刻，就只剩下2个了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-fmb8f   1/1     Running   <span class="m">0</span>          119m
</span></span><span class="line"><span class="cl">pc-replicaset-snrk2   1/1     Running   <span class="m">0</span>          119m</span></span></code></pre></div><p>镜像升级</p>
<div class="highlight" id="id-5"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 编辑rs的容器镜像 - image: nginx:1.17.2</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl edit rs pc-replicaset -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset edited
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次查看，发现镜像版本已经变更了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES        ...
</span></span><span class="line"><span class="cl">pc-replicaset       <span class="m">2</span>        <span class="m">2</span>         <span class="m">2</span>       140m   nginx         nginx:1.17.2  ...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 同样的道理，也可以使用命令完成这个工作</span>
</span></span><span class="line"><span class="cl"><span class="c1"># kubectl set image rs rs名称 容器=镜像版本 -n namespace</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl set image rs pc-replicaset nginx=nginx:1.17.1  -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps/pc-replicaset image updated
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 再次查看，发现镜像版本已经变更了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                 DESIRED  CURRENT   READY   AGE    CONTAINERS   IMAGES            ...
</span></span><span class="line"><span class="cl">pc-replicaset        <span class="m">2</span>        <span class="m">2</span>         <span class="m">2</span>       145m   nginx        nginx:1.17.1 ... </span></span></code></pre></div><p>删除ReplicaSet</p>
<div class="highlight" id="id-6"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 使用kubectl delete命令会删除此RS以及它管理的Pod</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 在kubernetes删除RS前，会将RS的replicasclear调整为0，等待所有的Pod被删除后，在执行RS对象的删除</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete rs pc-replicaset -n dev</span>
</span></span><span class="line"><span class="cl">replicaset.apps <span class="s2">&#34;pc-replicaset&#34;</span> deleted
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pod -n dev -o wide</span>
</span></span><span class="line"><span class="cl">No resources found in dev namespace.
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 如果希望仅仅删除RS对象（保留Pod），可以使用kubectl delete命令时添加--cascade=false选项（不推荐）。</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete rs pc-replicaset -n dev --cascade=false</span>
</span></span><span class="line"><span class="cl">replicaset.apps <span class="s2">&#34;pc-replicaset&#34;</span> deleted
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                  READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-replicaset-cl82j   1/1     Running   <span class="m">0</span>          75s
</span></span><span class="line"><span class="cl">pc-replicaset-dslhb   1/1     Running   <span class="m">0</span>          75s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 也可以使用yaml直接删除(推荐)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pc-replicaset.yaml</span>
</span></span><span class="line"><span class="cl">replicaset.apps <span class="s2">&#34;pc-replicaset&#34;</span> deleted</span></span></code></pre></div><h2 id="三deploymentdeploy">三、Deployment(Deploy)</h2>
<p>为了更好的解决服务编排的问题，kubernetes在V1.2版本开始，引入了Deployment控制器。值得一提的是，这种控制器并不直接管理pod，而是通过管理ReplicaSet来简介管理Pod，即：Deployment管理ReplicaSet，ReplicaSet管理Pod。所以Deployment比ReplicaSet功能更加强大。</p>
<p><img loading="lazy" src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840290.png" srcset="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840290.png, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840290.png 1.5x, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840290.png 2x" sizes="auto" data-title="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840290.png" data-alt="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210840290.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>Deployment主要功能有下面几个：</p>
<ul>
<li>支持ReplicaSet的所有功能</li>
<li>支持发布的停止、继续</li>
<li>支持滚动升级和回滚版本</li>
</ul>
<p>Deployment的资源清单文件：</p>
<div class="highlight" id="id-7"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w"> </span><span class="c"># 类型       </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 副本数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 保留历史版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">paused</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="c"># 暂停部署，默认是false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">progressDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">600</span><span class="w"> </span><span class="c"># 部署超时时间（s），默认是600</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># 滚动更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w"> </span><span class="c"># 滚动更新</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max违规词汇</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="l">%</span><span class="w"> </span><span class="c"># 最大额外可以存在的副本数，可以为百分比，也可以为整数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="l">%</span><span class="w"> </span><span class="c"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择器，通过它指定该控制器管理哪些pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">      </span><span class="c"># Labels匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># Expressions匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">nginx-pod]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></div><h3 id="31-创建deployment">3.1 创建deployment</h3>
<p>创建pc-deployment.yaml，内容如下：</p>
<div class="highlight" id="id-8"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment      </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span></span></span></code></pre></div><div class="highlight" id="id-9"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建deployment</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pc-deployment.yaml --record=true</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看deployment</span>
</span></span><span class="line"><span class="cl"><span class="c1"># UP-TO-DATE 最新版本的pod的数量</span>
</span></span><span class="line"><span class="cl"><span class="c1"># AVAILABLE  当前可用的pod的数量</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">NAME            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">pc-deployment   3/3     <span class="m">3</span>            <span class="m">3</span>           15s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看rs</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 发现rs的名称是在原来deployment的名字后面添加了一个10位数的随机串</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78   <span class="m">3</span>         <span class="m">3</span>         <span class="m">3</span>       23s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-d2c8n   1/1     Running   <span class="m">0</span>          107s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-smpvp   1/1     Running   <span class="m">0</span>          107s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-wvjd8   1/1     Running   <span class="m">0</span>          107s</span></span></code></pre></div><h3 id="32-扩缩容">3.2 扩缩容</h3>
<div class="highlight" id="id-10"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 变更副本数量为5个</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl scale deploy pc-deployment --replicas=5  -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment scaled
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看deployment</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">NAME            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">pc-deployment   5/5     <span class="m">5</span>            <span class="m">5</span>           2m
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-d2c8n   1/1     Running   <span class="m">0</span>          4m19s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-jxmdq   1/1     Running   <span class="m">0</span>          94s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-mktqv   1/1     Running   <span class="m">0</span>          93s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-smpvp   1/1     Running   <span class="m">0</span>          4m19s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-wvjd8   1/1     Running   <span class="m">0</span>          4m19s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 编辑deployment的副本数量，修改spec:replicas: 4即可</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl edit deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment edited
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-d2c8n   1/1     Running   <span class="m">0</span>          5m23s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-jxmdq   1/1     Running   <span class="m">0</span>          2m38s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-smpvp   1/1     Running   <span class="m">0</span>          5m23s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78-wvjd8   1/1     Running   <span class="m">0</span>          5m23s</span></span></code></pre></div><p>镜像更新</p>
<p><code>deployment</code>支持两种更新策略:<code>重建更新</code>和<code>滚动更新</code>,可以通过<code>strategy</code>指定策略类型,支持两个属性:</p>
<blockquote>
<p>strategy：指定新的Pod替换旧的Pod的策略， 支持两个属性：
type：指定策略类型，支持两种策略
Recreate：在创建出新的Pod之前会先杀掉所有已存在的Pod
RollingUpdate：滚动更新，就是杀死一部分，就启动一部分，在更新过程中，存在两个版本Pod
rollingUpdate：当type为RollingUpdate时生效，用于为RollingUpdate设置参数，支持两个属性：
maxUnavailable：用来指定在升级过程中不可用Pod的最大数量，默认为25%。
max违规词汇： 用来指定在升级过程中可以超过期望的Pod的最大数量，默认为25%。</p>
</blockquote>
<p>重建更新</p>
<ol>
<li>编辑pc-deployment.yaml,在spec节点下添加更新策略</li>
</ol>
<div class="highlight" id="id-11"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">Recreate</span><span class="w"> </span><span class="c"># 重建更新</span></span></span></code></pre></div><ol start="2">
<li>创建deploy进行验证</li>
</ol>
<div class="highlight" id="id-12"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 变更镜像</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl set image deployment pc-deployment nginx=nginx:1.17.2 -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment image updated
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 观察升级过程</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl get pods -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-65qcw   1/1     Running   <span class="m">0</span>          31s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-w5nzv   1/1     Running   <span class="m">0</span>          31s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-xpt7w   1/1     Running   <span class="m">0</span>          31s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-xpt7w   1/1     Terminating   <span class="m">0</span>          41s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-65qcw   1/1     Terminating   <span class="m">0</span>          41s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-w5nzv   1/1     Terminating   <span class="m">0</span>          41s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-grn8z   0/1     Pending       <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-hbl4v   0/1     Pending       <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-67nz2   0/1     Pending       <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-grn8z   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-hbl4v   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-67nz2   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-grn8z   1/1     Running             <span class="m">0</span>          1s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-67nz2   1/1     Running             <span class="m">0</span>          1s
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b-hbl4v   1/1     Running             <span class="m">0</span>          2s</span></span></code></pre></div><p>滚动更新</p>
<ol>
<li>编辑pc-deployment.yaml,在spec节点下添加更新策略</li>
</ol>
<div class="highlight" id="id-13"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># 滚动更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">max违规词汇</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">% </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">25</span><span class="l">%</span></span></span></code></pre></div><ol start="2">
<li>创建deploy进行验证</li>
</ol>
<div class="highlight" id="id-14"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 变更镜像</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">root@k8s-master01 ~]# kubectl set image deployment pc-deployment nginx=nginx:1.17.3 -n dev </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">deployment.apps/pc-deployment image updated</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 观察升级过程</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">root@k8s-master01 ~]# kubectl get pods -n dev -w</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">NAME                           READY   STATUS    RESTARTS   AGE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-c848d767-8rbzt   1/1     Running   0          31m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-c848d767-h4p68   1/1     Running   0          31m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-c848d767-hlmz4   1/1     Running   0          31m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-c848d767-rrqcn   1/1     Running   0          31m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-226rx   0/1     Pending             0          0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-226rx   0/1     ContainerCreating   0          0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-226rx   1/1     Running             0          1s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-c848d767-h4p68    0/1     Terminating         0          34m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-cnd44   0/1     Pending             0          0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-cnd44   0/1     ContainerCreating   0          0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-cnd44   1/1     Running             0          2s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-c848d767-hlmz4    0/1     Terminating         0          34m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-px48p   0/1     Pending             0          0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-px48p   0/1     ContainerCreating   0          0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-px48p   1/1     Running             0          0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-c848d767-8rbzt    0/1     Terminating         0          34m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-dkmqp   0/1     Pending             0          0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-dkmqp   0/1     ContainerCreating   0          0s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-966bf7f44-dkmqp   1/1     Running             0          2s</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">pc-deployment-c848d767-rrqcn    0/1     Terminating         0          34m</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 至此，新版本的pod创建完毕，就版本的pod销毁完毕</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 中间过程是滚动进行的，也就是边销毁边创建</span></span></span></code></pre></div><p>滚动更新的过程：</p>
<p><img loading="lazy" src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841230.png" srcset="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841230.png, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841230.png 1.5x, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841230.png 2x" sizes="auto" data-title="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841230.png" data-alt="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841230.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>镜像更新中rs的变化</p>
<div class="highlight" id="id-15"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看rs,发现原来的rs的依旧存在，只是pod数量变为了0，而后又新产生了一个rs，pod数量为4</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 其实这就是deployment能够进行版本回退的奥妙所在，后面会详细解释</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       7m37s
</span></span><span class="line"><span class="cl">pc-deployment-6696798b11   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       5m37s
</span></span><span class="line"><span class="cl">pc-deployment-c848d76789   <span class="m">4</span>         <span class="m">4</span>         <span class="m">4</span>       72s</span></span></code></pre></div><h3 id="33-版本回退">3.3 版本回退</h3>
<p>deployment支持版本升级过程中的暂停、继续功能以及版本回退等诸多功能，下面具体来看.</p>
<p>kubectl rollout： 版本升级相关功能，支持下面的选项：</p>
<ul>
<li>status 显示当前升级状态</li>
<li>history 显示 升级历史记录</li>
<li>pause 暂停版本升级过程</li>
<li>resume 继续已经暂停的版本升级过程</li>
<li>restart 重启版本升级过程</li>
<li>undo 回滚到上一级版本（可以使用–to-revision回滚到指定版本）</li>
</ul>
<div class="highlight" id="id-16"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看当前升级版本的状态</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout status deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">deployment <span class="s2">&#34;pc-deployment&#34;</span> successfully rolled out
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看升级历史记录</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout history deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment
</span></span><span class="line"><span class="cl">REVISION  CHANGE-CAUSE
</span></span><span class="line"><span class="cl"><span class="m">1</span>         kubectl create --filename<span class="o">=</span>pc-deployment.yaml --record<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="m">2</span>         kubectl create --filename<span class="o">=</span>pc-deployment.yaml --record<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="m">3</span>         kubectl create --filename<span class="o">=</span>pc-deployment.yaml --record<span class="o">=</span><span class="nb">true</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 可以发现有三次版本记录，说明完成过两次升级</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 版本回滚</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 这里直接使用--to-revision=1回滚到了1版本， 如果省略这个选项，就是回退到上个版本，就是2版本</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout undo deployment pc-deployment --to-revision=1 -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment rolled back
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看发现，通过nginx镜像版本可以发现到了第一版</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get deploy -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME            READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES         
</span></span><span class="line"><span class="cl">pc-deployment   4/4     <span class="m">4</span>            <span class="m">4</span>           74m   nginx        nginx:1.17.1   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看rs，发现第一个rs中有4个pod运行，后面两个版本的rs中pod为运行</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 其实deployment之所以可是实现版本的回滚，就是通过记录下历史rs来实现的，</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 一旦想回滚到哪个版本，只需要将当前版本pod数量降为0，然后将回滚版本的pod提升为目标数量就可以了</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6696798b78   <span class="m">4</span>         <span class="m">4</span>         <span class="m">4</span>       78m
</span></span><span class="line"><span class="cl">pc-deployment-966bf7f44    <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       37m
</span></span><span class="line"><span class="cl">pc-deployment-c848d767     <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       71m</span></span></code></pre></div><h3 id="34-金丝雀发布">3.4 金丝雀发布</h3>
<p>Deployment控制器支持控制更新过程中的控制，如“暂停(pause)”或“继续(resume)”更新操作。</p>
<p>比如有一批新的Pod资源创建完成后立即暂停更新过程，此时，仅存在一部分新版本的应用，主体部分还是旧的版本。然后，再筛选一小部分的用户请求路由到新版本的Pod应用，继续观察能否稳定地按期望的方式运行。确定没问题之后再继续完成余下的Pod资源滚动更新，否则立即回滚更新操作。这就是所谓的金丝雀发布。</p>
<div class="highlight" id="id-17"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 更新deployment的版本，并配置暂停deployment</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl set image deploy pc-deployment nginx=nginx:1.17.4 -n dev &amp;&amp; kubectl rollout pause deployment pc-deployment  -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment image updated
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment paused
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#观察更新状态</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout status deploy pc-deployment -n dev　</span>
</span></span><span class="line"><span class="cl">Waiting <span class="k">for</span> deployment <span class="s2">&#34;pc-deployment&#34;</span> rollout to finish: <span class="m">2</span> out of <span class="m">4</span> new replicas have been updated...
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 监控更新的过程，可以看到已经新增了一个资源，但是并未按照预期的状态去删除一个旧的资源，就是因为使用了pause暂停命令</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9   <span class="m">3</span>         <span class="m">3</span>         <span class="m">3</span>       19m     nginx        nginx:1.17.1   
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       14m     nginx        nginx:1.17.2   
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb   <span class="m">2</span>         <span class="m">2</span>         <span class="m">2</span>       3m16s   nginx        nginx:1.17.4   
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-rj8sq   1/1     Running   <span class="m">0</span>          7m33s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-ttwgg   1/1     Running   <span class="m">0</span>          7m35s
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9-v4wvc   1/1     Running   <span class="m">0</span>          7m34s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-996rt   1/1     Running   <span class="m">0</span>          3m31s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   <span class="m">0</span>          3m31s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 确保更新的pod没问题了，继续更新</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl rollout resume deploy pc-deployment -n dev</span>
</span></span><span class="line"><span class="cl">deployment.apps/pc-deployment resumed
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看最后的更新情况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get rs -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                       DESIRED   CURRENT   READY   AGE     CONTAINERS   IMAGES         
</span></span><span class="line"><span class="cl">pc-deployment-5d89bdfbf9   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       21m     nginx        nginx:1.17.1   
</span></span><span class="line"><span class="cl">pc-deployment-675d469f8b   <span class="m">0</span>         <span class="m">0</span>         <span class="m">0</span>       16m     nginx        nginx:1.17.2   
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb   <span class="m">4</span>         <span class="m">4</span>         <span class="m">4</span>       5m11s   nginx        nginx:1.17.4   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">NAME                             READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-7bfwh   1/1     Running   <span class="m">0</span>          37s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-996rt   1/1     Running   <span class="m">0</span>          5m27s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-j2gtj   1/1     Running   <span class="m">0</span>          5m27s
</span></span><span class="line"><span class="cl">pc-deployment-6c9f56fcfb-rf84v   1/1     Running   <span class="m">0</span>          37s</span></span></code></pre></div><p>删除Deployment</p>
<div class="highlight" id="id-18"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 删除deployment，其下的rs和pod也将被删除</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pc-deployment.yaml</span>
</span></span><span class="line"><span class="cl">deployment.apps <span class="s2">&#34;pc-deployment&#34;</span> deleted</span></span></code></pre></div><h2 id="四horizontal-pod-autoscalerhpa">四、Horizontal Pod Autoscaler(HPA)</h2>
<p>在前面，我们已经可以实现通过手工执行kubectl scale命令实现Pod扩容或缩容，但是这显然不符合Kubernetes的定位目标–自动化、智能化。 Kubernetes期望可以实现通过监测Pod的使用情况，实现pod数量的自动调整，于是就产生了Horizontal Pod Autoscaler（HPA）这种控制器。</p>
<p>HPA可以获取每个Pod利用率，然后和HPA中定义的指标进行对比，同时计算出需要伸缩的具体值，最后实现Pod的数量的调整。其实HPA与之前的Deployment一样，也属于一种Kubernetes资源对象，它通过追踪分析RC控制的所有目标Pod的负载变化情况，来确定是否需要针对性地调整目标Pod的副本数，这是HPA的实现原理。</p>
<p><img loading="lazy" src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841514.png" srcset="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841514.png, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841514.png 1.5x, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841514.png 2x" sizes="auto" data-title="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841514.png" data-alt="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841514.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>接下来，我们来做一个实验</p>
<h3 id="41-安装metrics-server">4.1 安装metrics-server</h3>
<p>metrics-server可以用来收集集群中的资源使用情况</p>
<div class="highlight" id="id-19"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># 安装git</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">root@k8s-master01 ~]# yum install git -y</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 获取metrics-server, 注意使用的版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">root@k8s-master01 ~]# git clone -b v0.3.6 https://github.com/kubernetes-incubator/metrics-server</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c"># 修改deployment, 注意修改的是镜像和初始化参数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">root@k8s-master01 ~]# cd /root/metrics-server/deploy/1.8+/</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">[</span><span class="l">root@k8s-master01 1.8+]# vim metrics-server-deployment.yaml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="l">按图中添加下面选项</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">hostNetwork</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">registry.cn-hangzhou.aliyuncs.com/google_containers/metrics-server-amd64:v0.3.6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">args</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- --<span class="l">kubelet-insecure-tls</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span>- --<span class="l">kubelet-preferred-address-types=InternalIP,Hostname,InternalDNS,ExternalDNS,ExternalIP</span></span></span></code></pre></div><p><img loading="lazy" src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841011.png" srcset="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841011.png, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841011.png 1.5x, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841011.png 2x" sizes="auto" data-title="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841011.png" data-alt="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841011.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<div class="highlight" id="id-20"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 安装metrics-server</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl apply -f ./</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod运行情况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl get pod -n kube-system</span>
</span></span><span class="line"><span class="cl">metrics-server-6b976979db-2xwbj   1/1     Running   <span class="m">0</span>          90s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 使用kubectl top node 查看资源使用情况</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl top node</span>
</span></span><span class="line"><span class="cl">NAME           CPU<span class="o">(</span>cores<span class="o">)</span>   CPU%   MEMORY<span class="o">(</span>bytes<span class="o">)</span>   MEMORY%
</span></span><span class="line"><span class="cl">k8s-master01   289m         14%    1582Mi          54%       
</span></span><span class="line"><span class="cl">k8s-node01     81m          4%     1195Mi          40%       
</span></span><span class="line"><span class="cl">k8s-node02     72m          3%     1211Mi          41%  
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl top pod -n kube-system</span>
</span></span><span class="line"><span class="cl">NAME                              CPU<span class="o">(</span>cores<span class="o">)</span>   MEMORY<span class="o">(</span>bytes<span class="o">)</span>
</span></span><span class="line"><span class="cl">coredns-6955765f44-7ptsb          3m           9Mi
</span></span><span class="line"><span class="cl">coredns-6955765f44-vcwr5          3m           8Mi
</span></span><span class="line"><span class="cl">etcd-master                       14m          145Mi
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="c1"># 至此,metrics-server安装完成</span></span></span></code></pre></div><h3 id="42-准备deployment和servie">4.2 准备deployment和servie</h3>
<p>创建pc-hpa-pod.yaml文件，内容如下：</p>
<div class="highlight" id="id-21"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># 滚动更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">resources</span><span class="p">:</span><span class="w"> </span><span class="c"># 资源配额</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">limits</span><span class="p">:</span><span class="w">  </span><span class="c"># 限制资源（上限）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;1&#34;</span><span class="w"> </span><span class="c"># CPU限制，单位是core数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">requests</span><span class="p">:</span><span class="w"> </span><span class="c"># 请求资源（下限）</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;100m&#34;</span><span class="w">  </span><span class="c"># CPU限制，单位是core数</span></span></span></code></pre></div><div class="highlight" id="id-22"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建deployment</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl run nginx --image=nginx:1.17.1 --requests=cpu=100m -n dev</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 创建service</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl expose deployment nginx --type=NodePort --port=80 -n dev</span></span></span></code></pre></div><div class="highlight" id="id-23"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 查看</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl get deployment,pod,svc -n dev</span>
</span></span><span class="line"><span class="cl">NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">deployment.apps/nginx   1/1     <span class="m">1</span>            <span class="m">1</span>           47s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME                         READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pod/nginx-7df9756ccc-bh8dr   1/1     Running   <span class="m">0</span>          47s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">NAME            TYPE       CLUSTER-IP      EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>        AGE
</span></span><span class="line"><span class="cl">service/nginx   NodePort   10.101.18.29   &lt;none&gt;        80:31830/TCP   35s</span></span></code></pre></div><h3 id="43-部署hpa">4.3 部署HPA</h3>
<p>创建pc-hpa.yaml文件，内容如下：</p>
<div class="highlight" id="id-24"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">autoscaling/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">HorizontalPodAutoscaler</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-hpa</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">minReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">  </span><span class="c">#最小pod数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">maxReplicas</span><span class="p">:</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="c">#最大pod数量</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">targetCPUUtilizationPercentage</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># CPU使用率指标</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">scaleTargetRef</span><span class="p">:</span><span class="w">   </span><span class="c"># 指定要控制的nginx信息</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w">  </span><span class="l">/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span></span></span></code></pre></div><div class="highlight" id="id-25"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建hpa</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl create -f pc-hpa.yaml</span>
</span></span><span class="line"><span class="cl">horizontalpodautoscaler.autoscaling/pc-hpa created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看hpa</span>
</span></span><span class="line"><span class="cl">    <span class="o">[</span>root@k8s-master01 1.8+<span class="o">]</span><span class="c1"># kubectl get hpa -n dev</span>
</span></span><span class="line"><span class="cl">NAME     REFERENCE          TARGETS   MINPODS   MAXPODS   REPLICAS   AGE
</span></span><span class="line"><span class="cl">pc-hpa   Deployment/nginx   0%/3%     <span class="m">1</span>         <span class="m">10</span>        <span class="m">1</span>          62s</span></span></code></pre></div><h3 id="44-测试">4.4 测试</h3>
<p>使用压测工具对service地址192.168.5.4:31830进行压测，然后通过控制台查看hpa和pod的变化</p>
<p>hpa变化</p>
<div class="highlight" id="id-26"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get hpa -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME   REFERENCE      TARGETS  MINPODS  MAXPODS  REPLICAS  AGE
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">1</span>      4m11s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">1</span>      5m19s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  22%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">1</span>      6m50s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  22%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">4</span>      7m5s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  22%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">8</span>      7m21s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  6%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">8</span>      7m51s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">8</span>      9m6s
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">8</span>      13m
</span></span><span class="line"><span class="cl">pc-hpa  Deployment/nginx  0%/3%   <span class="m">1</span>     <span class="m">10</span>     <span class="m">1</span>      14m</span></span></code></pre></div><p>deployment变化</p>
<div class="highlight" id="id-27"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get deployment -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME    READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span class="line"><span class="cl">nginx   1/1     <span class="m">1</span>            <span class="m">1</span>           11m
</span></span><span class="line"><span class="cl">nginx   1/4     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">nginx   1/4     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">nginx   1/4     <span class="m">1</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">nginx   1/4     <span class="m">4</span>            <span class="m">1</span>           13m
</span></span><span class="line"><span class="cl">nginx   1/8     <span class="m">4</span>            <span class="m">1</span>           14m
</span></span><span class="line"><span class="cl">nginx   1/8     <span class="m">4</span>            <span class="m">1</span>           14m
</span></span><span class="line"><span class="cl">nginx   1/8     <span class="m">4</span>            <span class="m">1</span>           14m
</span></span><span class="line"><span class="cl">nginx   1/8     <span class="m">8</span>            <span class="m">1</span>           14m
</span></span><span class="line"><span class="cl">nginx   2/8     <span class="m">8</span>            <span class="m">2</span>           14m
</span></span><span class="line"><span class="cl">nginx   3/8     <span class="m">8</span>            <span class="m">3</span>           14m
</span></span><span class="line"><span class="cl">nginx   4/8     <span class="m">8</span>            <span class="m">4</span>           14m
</span></span><span class="line"><span class="cl">nginx   5/8     <span class="m">8</span>            <span class="m">5</span>           14m
</span></span><span class="line"><span class="cl">nginx   6/8     <span class="m">8</span>            <span class="m">6</span>           14m
</span></span><span class="line"><span class="cl">nginx   7/8     <span class="m">8</span>            <span class="m">7</span>           14m
</span></span><span class="line"><span class="cl">nginx   8/8     <span class="m">8</span>            <span class="m">8</span>           15m
</span></span><span class="line"><span class="cl">nginx   8/1     <span class="m">8</span>            <span class="m">8</span>           20m
</span></span><span class="line"><span class="cl">nginx   8/1     <span class="m">8</span>            <span class="m">8</span>           20m
</span></span><span class="line"><span class="cl">nginx   1/1     <span class="m">1</span>            <span class="m">1</span>           20m</span></span></code></pre></div><p>pod变化</p>
<div class="highlight" id="id-28"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME                     READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-bh8dr   1/1     Running   <span class="m">0</span>          11m
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-cpgrv   0/1     Pending   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-8zhwk   0/1     Pending   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-rr9bn   0/1     Pending   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-cpgrv   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-8zhwk   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-rr9bn   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-m9gsj   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-g56qb   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-sl9c6   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-fgst7   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-g56qb   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-m9gsj   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-sl9c6   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-fgst7   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-8zhwk   1/1     Running             <span class="m">0</span>          19s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-rr9bn   1/1     Running             <span class="m">0</span>          30s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-m9gsj   1/1     Running             <span class="m">0</span>          21s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-cpgrv   1/1     Running             <span class="m">0</span>          47s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-sl9c6   1/1     Running             <span class="m">0</span>          33s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-g56qb   1/1     Running             <span class="m">0</span>          48s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-fgst7   1/1     Running             <span class="m">0</span>          66s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-fgst7   1/1     Terminating         <span class="m">0</span>          6m50s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-8zhwk   1/1     Terminating         <span class="m">0</span>          7m5s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-cpgrv   1/1     Terminating         <span class="m">0</span>          7m5s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-g56qb   1/1     Terminating         <span class="m">0</span>          6m50s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-rr9bn   1/1     Terminating         <span class="m">0</span>          7m5s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-m9gsj   1/1     Terminating         <span class="m">0</span>          6m50s
</span></span><span class="line"><span class="cl">nginx-7df9756ccc-sl9c6   1/1     Terminating         <span class="m">0</span>          6m50s</span></span></code></pre></div><h2 id="五daemonsetds">五、DaemonSet(DS)</h2>
<p>DaemonSet类型的控制器可以保证在集群中的每一台（或指定）节点上都运行一个副本。一般适用于日志收集、节点监控等场景。也就是说，如果一个Pod提供的功能是节点级别的（每个节点都需要且只需要一个），那么这类Pod就适合使用DaemonSet类型的控制器创建。</p>
<p><img loading="lazy" src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841881.png" srcset="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841881.png, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841881.png 1.5x, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841881.png 2x" sizes="auto" data-title="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841881.png" data-alt="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841881.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>DaemonSet控制器的特点：</p>
<ul>
<li>每当向集群中添加一个节点时，指定的 Pod 副本也将添加到该节点上</li>
<li>当节点从集群中移除时，Pod 也就被垃圾回收了</li>
</ul>
<p>下面先来看下DaemonSet的资源清单文件</p>
<div class="highlight" id="id-29"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet</span><span class="w"> </span><span class="c"># 类型       </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">daemonset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">revisionHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="m">3</span><span class="w"> </span><span class="c"># 保留历史版本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">updateStrategy</span><span class="p">:</span><span class="w"> </span><span class="c"># 更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w"> </span><span class="c"># 滚动更新策略</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w"> </span><span class="c"># 滚动更新</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c"># 最大不可用状态的 Pod 的最大值，可以为百分比，也可以为整数</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择器，通过它指定该控制器管理哪些pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">      </span><span class="c"># Labels匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># Expressions匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">nginx-pod]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">80</span></span></span></code></pre></div><p>创建pc-daemonset.yaml，内容如下：</p>
<div class="highlight" id="id-30"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">DaemonSet      </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-daemonset</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">nginx-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">nginx</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.1</span></span></span></code></pre></div><div class="highlight" id="id-31"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建daemonset</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f  pc-daemonset.yaml</span>
</span></span><span class="line"><span class="cl">daemonset.apps/pc-daemonset created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看daemonset</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl get ds -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME        DESIRED  CURRENT  READY  UP-TO-DATE  AVAILABLE   AGE   CONTAINERS   IMAGES         
</span></span><span class="line"><span class="cl">pc-daemonset   <span class="m">2</span>        <span class="m">2</span>        <span class="m">2</span>      <span class="m">2</span>           <span class="m">2</span>        24s   nginx        nginx:1.17.1   
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod,发现在每个Node上都运行一个pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1">#  kubectl get pods -n dev -o wide</span>
</span></span><span class="line"><span class="cl">NAME                 READY   STATUS    RESTARTS   AGE   IP            NODE    
</span></span><span class="line"><span class="cl">pc-daemonset-9bck8   1/1     Running   <span class="m">0</span>          37s   10.244.1.43   node1     
</span></span><span class="line"><span class="cl">pc-daemonset-k224w   1/1     Running   <span class="m">0</span>          37s   10.244.2.74   node2      
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除daemonset</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pc-daemonset.yaml</span>
</span></span><span class="line"><span class="cl">daemonset.apps <span class="s2">&#34;pc-daemonset&#34;</span> deleted</span></span></code></pre></div><h2 id="六job">六、Job</h2>
<p>Job，主要用于负责**批量处理(一次要处理指定数量任务)短暂的一次性(每个任务仅运行一次就结束)**任务。Job特点如下：</p>
<ul>
<li>当Job创建的pod执行成功结束时，Job将记录成功结束的pod数量</li>
<li>当成功结束的pod达到指定的数量时，Job将完成执行</li>
</ul>
<p><img loading="lazy" src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841970.png" srcset="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841970.png, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841970.png 1.5x, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841970.png 2x" sizes="auto" data-title="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841970.png" data-alt="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210841970.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>Job的资源清单文件：</p>
<div class="highlight" id="id-32"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job</span><span class="w"> </span><span class="c"># 类型       </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">completions: 1 # 指定job需要成功运行Pods的次数。默认值</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">parallelism: 1 # 指定job在任一时刻应该并发运行Pods的数量。默认值</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="c"># 指定job可运行的时间期限，超过时间还未结束，系统将会尝试进行终止。</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w"> </span><span class="c"># 指定job失败后进行重试的次数。默认是6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">manualSelector</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="c"># 是否可以使用selector选择器选择pod，默认是false</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w"> </span><span class="c"># 选择器，通过它指定该控制器管理哪些pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">      </span><span class="c"># Labels匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="c"># Expressions匹配规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- {<span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">counter-pod]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"> </span><span class="c"># 模板，当副本数量不足时，会根据下面的模板创建pod副本</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w"> </span><span class="c"># 重启策略只能设置为Never或者OnFailure</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;bin/sh&#34;</span><span class="p">,</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="s2">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 2;done&#34;</span><span class="p">]</span></span></span></code></pre></div><blockquote>
<p>关于重启策略设置的说明：
如果指定为OnFailure，则job会在pod出现故障时重启容器，而不是创建pod，failed次数不变
如果指定为Never，则job会在pod出现故障时创建新的pod，并且故障pod不会消失，也不会重启，failed次数加1
如果指定为Always的话，就意味着一直重启，意味着job任务会重复去执行了，当然不对，所以不能设置为Always</p>
</blockquote>
<p>创建pc-job.yaml，内容如下：</p>
<div class="highlight" id="id-33"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Job      </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-job</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">manualSelector</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;bin/sh&#34;</span><span class="p">,</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="s2">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span><span class="p">]</span></span></span></code></pre></div><div class="highlight" id="id-34"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建job</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pc-job.yaml</span>
</span></span><span class="line"><span class="cl">job.batch/pc-job created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看job</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get job -n dev -o wide  -w</span>
</span></span><span class="line"><span class="cl">NAME     COMPLETIONS   DURATION   AGE   CONTAINERS   IMAGES         SELECTOR
</span></span><span class="line"><span class="cl">pc-job   0/1           21s        21s   counter      busybox:1.30   <span class="nv">app</span><span class="o">=</span>counter-pod
</span></span><span class="line"><span class="cl">pc-job   1/1           31s        79s   counter      busybox:1.30   <span class="nv">app</span><span class="o">=</span>counter-pod
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 通过观察pod状态可以看到，pod在运行完毕任务后，就会变成Completed状态</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME           READY   STATUS     RESTARTS      AGE
</span></span><span class="line"><span class="cl">pc-job-rxg96   1/1     Running     <span class="m">0</span>            29s
</span></span><span class="line"><span class="cl">pc-job-rxg96   0/1     Completed   <span class="m">0</span>            33s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接下来，调整下pod运行的总数量和并行数量 即：在spec下设置下面两个选项</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  completions: 6 # 指定job需要成功运行Pods的次数为6</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  parallelism: 3 # 指定job并发运行Pods的数量为3</span>
</span></span><span class="line"><span class="cl"><span class="c1">#  然后重新运行job，观察效果，此时会发现，job会每次运行3个pod，总共执行了6个pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev -w</span>
</span></span><span class="line"><span class="cl">NAME           READY   STATUS    RESTARTS   AGE
</span></span><span class="line"><span class="cl">pc-job-684ft   1/1     Running   <span class="m">0</span>          5s
</span></span><span class="line"><span class="cl">pc-job-jhj49   1/1     Running   <span class="m">0</span>          5s
</span></span><span class="line"><span class="cl">pc-job-pfcvh   1/1     Running   <span class="m">0</span>          5s
</span></span><span class="line"><span class="cl">pc-job-684ft   0/1     Completed   <span class="m">0</span>          11s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   0/1     Pending     <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   0/1     Pending     <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-jhj49   0/1     Completed           <span class="m">0</span>          11s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-pfcvh   0/1     Completed           <span class="m">0</span>          11s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   0/1     Pending             <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   0/1     ContainerCreating   <span class="m">0</span>          0s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   1/1     Running             <span class="m">0</span>          2s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   1/1     Running             <span class="m">0</span>          2s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   1/1     Running             <span class="m">0</span>          3s
</span></span><span class="line"><span class="cl">pc-job-fhwf7   0/1     Completed           <span class="m">0</span>          12s
</span></span><span class="line"><span class="cl">pc-job-v7rhr   0/1     Completed           <span class="m">0</span>          12s
</span></span><span class="line"><span class="cl">pc-job-5vg2j   0/1     Completed           <span class="m">0</span>          12s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除job</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl delete -f pc-job.yaml</span>
</span></span><span class="line"><span class="cl">job.batch <span class="s2">&#34;pc-job&#34;</span> deleted</span></span></code></pre></div><h2 id="七cronjobcj">七、CronJob(CJ)</h2>
<p>CronJob控制器以 Job控制器资源为其管控对象，并借助它管理pod资源对象，Job控制器定义的作业任务在其控制器资源创建之后便会立即执行，但CronJob可以以类似于Linux操作系统的周期性任务作业计划的方式控制其运行时间点及重复运行的方式。也就是说，CronJob可以在特定的时间点(反复的)去运行job任务。</p>
<p><img loading="lazy" src="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210842037.png" srcset="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210842037.png, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210842037.png 1.5x, https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210842037.png 2x" sizes="auto" data-title="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210842037.png" data-alt="https://aabb-2023.oss-cn-beijing.aliyuncs.com/202308210842037.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const a of ['style','data-title','data-alt','onerror','onload']){this.removeAttribute(a);}"/></p>
<p>CronJob的资源清单文件：</p>
<div class="highlight" id="id-35"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1beta1</span><span class="w"> </span><span class="c"># 版本号</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w"> </span><span class="c"># 类型       </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w"> </span><span class="c"># 元数据</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="c"># rs名称 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="c"># 所属命名空间 </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w"> </span><span class="c">#标签</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">cronjob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w"> </span><span class="c"># 详情描述</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="c"># cron格式的作业调度运行时间点,用于控制任务在什么时间执行</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">concurrencyPolicy</span><span class="p">:</span><span class="w"> </span><span class="c"># 并发执行策略，用于定义前一次作业运行尚未完成时是否以及如何运行后一次的作业</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">failedJobHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="c"># 为失败的任务执行保留的历史记录数，默认为1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">successfulJobHistoryLimit</span><span class="p">:</span><span class="w"> </span><span class="c"># 为成功的任务执行保留的历史记录数，默认为3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">startingDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="c"># 启动作业错误的超时时长</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w"> </span><span class="c"># job控制器模板，用于为cronjob控制器生成job对象;下面其实就是job的定义</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">completions</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">parallelism</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">activeDeadlineSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">backoffLimit</span><span class="p">:</span><span class="w"> </span><span class="m">6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">manualSelector</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">matchExpressions</span><span class="p">:</span><span class="w"> </span><span class="l">规则</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- {<span class="nt">key: app, operator: In, values</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="l">counter-pod]}</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">counter-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;bin/sh&#34;</span><span class="p">,</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="s2">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 20;done&#34;</span><span class="p">]</span></span></span></code></pre></div><blockquote>
<p>需要重点解释的几个选项：
schedule: cron表达式，用于指定任务的执行时间
*/1    *      *    *     *
&lt;分钟&gt; &lt;小时&gt; &lt;日&gt; &lt;月份&gt; &lt;星期&gt;</p>
<p>​	分钟 值从 0 到 59.
​	小时 值从 0 到 23.
​	日 值从 1 到 31.
​	月 值从 1 到 12.
​	星期 值从 0 到 6, 0 代表星期日
​	多个时间可以用逗号隔开； 范围可以用连字符给出；*可以作为通配符； /表示每&hellip;</p>
<p>concurrencyPolicy:
Allow:   允许Jobs并发运行(默认)
Forbid:  禁止并发运行，如果上一次运行尚未完成，则跳过下一次运行
Replace: 替换，取消当前正在运行的作业并用新作业替换它</p>
</blockquote>
<p>创建pc-cronjob.yaml，内容如下：</p>
<div class="highlight" id="id-36"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">batch/v1beta1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">CronJob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">pc-cronjob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l">dev</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">controller</span><span class="p">:</span><span class="w"> </span><span class="l">cronjob</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">schedule</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;*/1 * * * *&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">jobTemplate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">restartPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Never</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">          </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">counter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">busybox:1.30</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">            </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&#34;bin/sh&#34;</span><span class="p">,</span><span class="s2">&#34;-c&#34;</span><span class="p">,</span><span class="s2">&#34;for i in 9 8 7 6 5 4 3 2 1; do echo $i;sleep 3;done&#34;</span><span class="p">]</span></span></span></code></pre></div><div class="highlight" id="id-37"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># 创建cronjob</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl create -f pc-cronjob.yaml</span>
</span></span><span class="line"><span class="cl">cronjob.batch/pc-cronjob created
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看cronjob</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get cronjobs -n dev</span>
</span></span><span class="line"><span class="cl">NAME         SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
</span></span><span class="line"><span class="cl">pc-cronjob   */1 * * * *   False     <span class="m">0</span>        &lt;none&gt;          6s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看job</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get jobs -n dev</span>
</span></span><span class="line"><span class="cl">NAME                    COMPLETIONS   DURATION   AGE
</span></span><span class="line"><span class="cl">pc-cronjob-1592587800   1/1           28s        3m26s
</span></span><span class="line"><span class="cl">pc-cronjob-1592587860   1/1           28s        2m26s
</span></span><span class="line"><span class="cl">pc-cronjob-1592587920   1/1           28s        86s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看pod</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl get pods -n dev</span>
</span></span><span class="line"><span class="cl">pc-cronjob-1592587800-x4tsm   0/1     Completed   <span class="m">0</span>          2m24s
</span></span><span class="line"><span class="cl">pc-cronjob-1592587860-r5gv4   0/1     Completed   <span class="m">0</span>          84s
</span></span><span class="line"><span class="cl">pc-cronjob-1592587920-9dxxq   1/1     Running     <span class="m">0</span>          24s
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 删除cronjob</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>root@k8s-master01 ~<span class="o">]</span><span class="c1"># kubectl  delete -f pc-cronjob.yaml</span>
</span></span><span class="line"><span class="cl">cronjob.batch <span class="s2">&#34;pc-cronjob&#34;</span> deleted</span></span></code></pre></div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2023-07-19 18:12:20">更新于 2023-07-19&nbsp;</span>
      </div><div class="post-info-license">
          <span><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span>
        </div></div>
    <div class="post-info-line">
      <div class="post-info-md"></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="http://yuanshuai1122.github.io/posts/kubernetes-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3/" data-title="Kubernetes-Pod控制器详解" data-hashtags="docker,k8s,容器"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="http://yuanshuai1122.github.io/posts/kubernetes-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3/" data-hashtag="docker"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="http://yuanshuai1122.github.io/posts/kubernetes-pod%E6%8E%A7%E5%88%B6%E5%99%A8%E8%AF%A6%E8%A7%A3/" data-title="Kubernetes-Pod控制器详解"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/docker/' class="post-tag">docker</a><a href='/tags/k8s/' class="post-tag">k8s</a><a href='/tags/%E5%AE%B9%E5%99%A8/' class="post-tag">容器</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/kubernetes-pod%E8%AF%A6%E8%A7%A3/" class="post-nav-item" rel="prev" title="Kubernetes-Pod详解"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Kubernetes-Pod详解</a>
      <a href="/posts/elasticsearch-%E9%AB%98%E7%BA%A7%E7%89%B9%E6%80%A7/" class="post-nav-item" rel="next" title="ElasticSearch-高级特性">ElasticSearch-高级特性<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.119.0">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.18-lts.2"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2023</span><span class="author" itemprop="copyrightHolder">
              <a href="/"></a></span></div><div class="footer-line statistics"></div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/copy-tex.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":10},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
