<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="zh-hans">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:title" content="JVM内存与垃圾回收篇第2章类加载子系统" />
<meta property="og:description" content="第 2 章 类加载子系统 1、内存结构概述 如果自己想手写一个Java虚拟机的话，主要考虑哪些结构呢？ 类加载器 执行引擎 完整框图： 2、类加载子系统 类加载" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanshuai1122.github.io/posts/jvm%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87%E7%AC%AC2%E7%AB%A0%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AD%90%E7%B3%BB%E7%BB%9F-jvm%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87%E7%AC%AC2%E7%AB%A0%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AD%90%E7%B3%BB%E7%BB%9F/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-30T10:58:25+00:00" />
<meta property="article:modified_time" content="2021-11-30T10:58:25+00:00" />
<title>JVM内存与垃圾回收篇第2章类加载子系统</title>

    <link rel="canonical" href="/posts/jvm%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87%E7%AC%AC2%E7%AB%A0%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AD%90%E7%B3%BB%E7%BB%9F-jvm%E5%86%85%E5%AD%98%E4%B8%8E%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E7%AF%87%E7%AC%AC2%E7%AB%A0%E7%B1%BB%E5%8A%A0%E8%BD%BD%E5%AD%90%E7%B3%BB%E7%BB%9F/">

    <link rel="stylesheet" href="/css/global.css">

    <link rel="stylesheet" href="/css/custom.css">

    <link rel="stylesheet" href="/css/search.css" />

    
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/ " class="nav-title">🧀</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="/posts " class="nav-item-content">目录</a>
          </div><div class="nav-item-wrapper">
            <a href="/about" class="nav-item-content">关于</a>
          </div><div class="nav-item-wrapper">
            <a href="/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yuanshuai1122.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        Java
                      
                    
                  </span>
                  <span class="category-eyebrow__date">2021年11月30日</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">JVM内存与垃圾回收篇第2章类加载子系统</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="/tags/java" class="tag">
                    Java
                  </a>
                
                  
                  <a href="/tags/jvm" class="tag">
                    JVM
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            
<div class="component-content pagebody component">
  <h1 id="第-2-章-类加载子系统" class="pagebody-header">
    第 2 章 类加载子系统
  </h1>
</div>
<div class="component-content pagebody component">
  <h2 id="1内存结构概述" class="pagebody-header">
    1、内存结构概述
  </h2>
</div><p class="component-content component">如果自己想手写一个Java虚拟机的话，主要考虑哪些结构呢？</p>
<div class="component-content component"><ol>
<li>类加载器</li>
<li>执行引擎</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-6a0db7f99064b94a30eff3e7054195b6" id="lht6a0db7f99064b94a30eff3e7054195b6">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/20.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component"><strong>完整框图：</strong></p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-1929ffb1ad4dc08859ccc29fbcfb0a63" id="lht1929ffb1ad4dc08859ccc29fbcfb0a63">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/21.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="2类加载子系统" class="pagebody-header">
    2、类加载子系统
  </h2>
</div><blockquote>
<p class="component-content component"><strong>类加载器子系统作用</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>类加载器子系统负责从文件系统或者网络中加载Class文件</strong>，class文件在文件开头有特定的文件标识。</li>
<li>ClassLoader只负责class文件的加载，至于它是否可以运行，则由Execution Engine决定。</li>
<li><strong>加载的类信息存放于一块称为方法区的内存空间</strong>。除了类的信息外，方法区中还会存放运行时常量池信息，可能还包括字符串字面量和数字常量（这部分常量信息是Class文件中常量池部分的内存映射）</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-12b8a5caf306e700d44e7b17f2c206f7" id="lht12b8a5caf306e700d44e7b17f2c206f7">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/22.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component"><strong>class &ndash;&gt; Java.lang.Class</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li>class file存在于本地硬盘上，可以理解为设计师画在纸上的模板，而最终这个模板在执行的时候是要加载到JVM当中来根据这个文件实例化出n个一模一样的实例。</li>
<li><strong>class file加载到JVM中，被称为DNA元数据模板，放在方法区</strong>。</li>
<li>在.class文件–&gt;JVM–&gt;最终成为元数据模板，此过程就要一个运输工具（类装载器Class Loader），扮演一个快递员的角色。</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-078011bd2d0516c7a6f73c2d4a6ff9e8" id="lht078011bd2d0516c7a6f73c2d4a6ff9e8">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/23.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="3类加载过程" class="pagebody-header">
    3、类加载过程
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="31类加载过程概述" class="pagebody-header">
    3.1、类加载过程概述
  </h3>
</div><div class="component-content component"><ul>
<li>看代码</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HelloLoader</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;谢谢ClassLoader加载我....&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;你的大恩大德，我下辈子再报！&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>它的加载过程是怎么样的呢?
<div class="component-content component"><ul>
<li>执行 main() 方法（静态方法）就需要先加载承载类 HelloLoader</li>
<li>加载成功，则进行链接、初始化等操作，完成后调用 HelloLoader 类中的静态方法 main</li>
<li>加载失败则抛出异常</li>
</ul></div>
</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-f8d08686d828e2a66ed4545d5c2a9716" id="lhtf8d08686d828e2a66ed4545d5c2a9716">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/24.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>完整的流程图如下所示：<strong>加载 &ndash;&gt; 链接（验证 &ndash;&gt; 准备 &ndash;&gt; 解析） &ndash;&gt; 初始化</strong></li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-36f1be02902279a8167bb02be9d9265b" id="lht36f1be02902279a8167bb02be9d9265b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/25.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="32加载阶段" class="pagebody-header">
    3.2、加载阶段
  </h3>
</div><blockquote>
<p class="component-content component"><strong>加载流程</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>通过一个类的全限定名获取定义此类的二进制字节流</strong></li>
<li>将这个字节流所代表的静态存储结构转化为<strong>方法区的运行时数据结构</strong></li>
<li><strong>在内存中生成一个代表这个类的java.lang.Class对象</strong>，作为方法区这个类的各种数据的访问入口</li>
</ol></div>
<blockquote>
<p class="component-content component"><strong>加载class文件的方式</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li>从本地系统中直接加载</li>
<li>通过网络获取，典型场景：Web Applet</li>
<li>从zip压缩包中读取，成为日后jar、war格式的基础</li>
<li>运行时计算生成，使用最多的是：动态代理技术</li>
<li>由其他文件生成，典型场景：JSP应用从专有数据库中提取.class文件，比较少见</li>
<li>从加密文件中获取，典型的防Class文件被反编译的保护措施</li>
</ol></div>

<div class="component-content pagebody component">
  <h3 id="33链接阶段" class="pagebody-header">
    3.3、链接阶段
  </h3>
</div><div class="component-content component"><ul>
<li><strong>链接分为三个子阶段：验证 &ndash;&gt; 准备 &ndash;&gt; 解析</strong></li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-2d1ebaad9f6831c9b6226f76096d4f2c" id="lht2d1ebaad9f6831c9b6226f76096d4f2c">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/26.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h4 id="331验证verify" class="pagebody-header">
    3.3.1、验证(Verify)
  </h4>
</div><blockquote>
<p class="component-content component"><strong>验证</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>目的在于确保Class文件的字节流中包含信息符合当前虚拟机要求，保证被加载类的正确性，不会危害虚拟机自身安全</strong></li>
<li>主要包括四种验证，文件格式验证，元数据验证，字节码验证，符号引用验证。</li>
</ol></div>
<blockquote>
<p class="component-content component"><strong>举例</strong></p>
</blockquote>
<div class="component-content component"><ul>
<li>使用 BinaryViewer 查看字节码文件，其开头均为 CAFE BABE ，如果出现不合法的字节码文件，那么将会验证不通过</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-f7a85ad056578335d5b9f2b58c7cec2f" id="lhtf7a85ad056578335d5b9f2b58c7cec2f">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/27.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h4 id="332准备prepare" class="pagebody-header">
    3.3.2、准备(Prepare)
  </h4>
</div><blockquote>
<p class="component-content component"><strong>准备</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>为类变量分配内存并且设置该类变量的默认初始值，即零值</strong></li>
<li>这里不包含用final修饰的static，因为final在编译的时候就会分配好了默认值，准备阶段会显式初始化</li>
<li>注意：这里不会为实例变量分配初始化，类变量会分配在方法区中，而实例变量是会随着对象一起分配到Java堆中</li>
</ol></div>
<blockquote>
<p class="component-content component"><strong>举例</strong></p>
</blockquote>
<div class="component-content component"><ul>
<li>代码：变量a在准备阶段会赋初始值，但不是1，而是0，在初始化阶段会被赋值为 1</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">HelloApp</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>   <span style="color:#75715e">//prepare：a = 0 ---&gt; initial : a = 1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>a<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h4 id="333解析resolve" class="pagebody-header">
    3.3.3、解析(Resolve)
  </h4>
</div><blockquote>
<p class="component-content component"><strong>解析</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>将常量池内的符号引用转换为直接引用的过程</strong></li>
<li>事实上，解析操作往往会伴随着JVM在执行完初始化之后再执行</li>
<li>符号引用就是一组符号来描述所引用的目标。符号引用的字面量形式明确定义在《java虚拟机规范》的class文件格式中。直接引用就是直接指向目标的指针、相对偏移量或一个间接定位到目标的句柄</li>
<li>解析动作主要针对类或接口、字段、类方法、接口方法、方法类型等。对应常量池中的CONSTANT Class info、CONSTANT Fieldref info、CONSTANT Methodref info等</li>
</ol></div>
<blockquote>
<p class="component-content component"><strong>符号引用</strong></p>
</blockquote>
<div class="component-content component"><ul>
<li>反编译 class 文件后可以查看符号引用</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-5a71a0ed0a4e87017a2d0ffae21134a7" id="lht5a71a0ed0a4e87017a2d0ffae21134a7">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/28.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="34初始化阶段" class="pagebody-header">
    3.4、初始化阶段
  </h3>
</div><blockquote>
<p class="component-content component"><strong>初始化阶段</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>初始化阶段就是执行类构造器方法<code>&lt;clinit&gt;()</code>的过程</strong></li>
<li>此方法不需定义，是javac编译器自动收集类中的所有类变量的赋值动作和静态代码块中的语句合并而来。也就是说，<strong>当我们代码中包含static变量的时候，就会有clinit方法</strong></li>
<li><strong><code>&lt;clinit&gt;()</code>方法中的指令按语句在源文件中出现的顺序执行</strong></li>
<li><code>&lt;clinit&gt;()</code>不同于类的构造器。（关联：构造器是虚拟机视角下的<code>&lt;init&gt;()</code>）</li>
<li><strong>若该类具有父类，JVM会保证子类的<code>&lt;clinit&gt;()</code>执行前，父类的<code>&lt;clinit&gt;()</code>已经执行完毕</strong></li>
<li><strong>虚拟机必须保证一个类的<code>&lt;clinit&gt;()</code>方法在多线程下被同步加锁</strong></li>
</ol></div>
<blockquote>
<p class="component-content component"><strong>IDEA 中安装 JClassLib 插件</strong></p>
</blockquote>
<p class="component-content component">在 IDEA 中安装 JClassLib 插件后，重启 IDEA 生效</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-e41513b8a8ead30159832cd861856f25" id="lhte41513b8a8ead30159832cd861856f25">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/29.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>选中对应的 Java 类文件，注意：不是字节码文件~！</li>
<li>点击【View &ndash;&gt; Show Bytecode With jclasslib】即可查看反编译后的代码</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-b07ef30d4f4a678339b86e1d56d494f3" id="lhtb07ef30d4f4a678339b86e1d56d494f3">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/30.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component"><strong>当我们代码中包含static变量的时候，就会有clinit方法</strong></p>
</blockquote>
<p class="component-content component"><strong>示例 1：无 static 变量</strong></p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClinitTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>并没有生成 clinit 方法</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-036cb23cbfdf47b594796dec5175e388" id="lht036cb23cbfdf47b594796dec5175e388">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/31.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component"><strong>示例 2：有 static 变量</strong></p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClinitTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//任何一个类声明以后，内部至少存在一个类的构造器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>在 clinit 方法中初始化静态变量的值为 3</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-d89a65894aa2a4305ff6904d56385bb1" id="lhtd89a65894aa2a4305ff6904d56385bb1">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/32.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component"><strong>构造器方法中指令按语句在源文件中出现的顺序执行</strong></p>
</blockquote>
<p class="component-content component"><strong>示例 1</strong></p>
<div class="component-content component"><ul>
<li>代码：</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClassInitTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> num <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> number <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">;</span>      <span style="color:#75715e">//linking之prepare: number = 0 --&gt; initial: 10 --&gt; 20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        num <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        number <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>num<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//System.out.println(number);    //报错：非法的前向引用（可以赋值，但不能调用）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>ClassInitTest<span style="color:#f92672">.</span><span style="color:#a6e22e">num</span><span style="color:#f92672">);</span><span style="color:#75715e">//2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>ClassInitTest<span style="color:#f92672">.</span><span style="color:#a6e22e">number</span><span style="color:#f92672">);</span><span style="color:#75715e">//10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>静态变量 number 的值变化过程如下
<div class="component-content component"><ul>
<li>准备阶段时：0</li>
<li>执行静态变量初始化：10</li>
<li>执行静态代码块：20</li>
</ul></div>
</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-42339569c8c977ef08a3e946fe68a159" id="lht42339569c8c977ef08a3e946fe68a159">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/33.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component"><strong>示例 2</strong></p>
<div class="component-content component"><ul>
<li>代码</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClassInitTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> num <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">static</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>       num <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>       number <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>       System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>num<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">//System.out.println(number);    //报错：非法的前向引用（可以赋值，但不能调用）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> number <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">;</span>      <span style="color:#75715e">//linking之prepare: number = 0 --&gt; initial: 20 --&gt; 10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>ClassInitTest<span style="color:#f92672">.</span><span style="color:#a6e22e">num</span><span style="color:#f92672">);</span>		<span style="color:#75715e">//2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>ClassInitTest<span style="color:#f92672">.</span><span style="color:#a6e22e">number</span><span style="color:#f92672">);</span>	<span style="color:#75715e">//10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>静态变量 number 的值变化过程如下
<div class="component-content component"><ul>
<li>准备阶段时：0</li>
<li>执行静态代码块：20</li>
<li>执行静态变量初始化：10</li>
</ul></div>
</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-42a446654c6c76f3620089158082eb51" id="lht42a446654c6c76f3620089158082eb51">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/34.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component"><strong>构造器是虚拟机视角下的<code>&lt;init&gt;()</code></strong></p>
</blockquote>
<div class="component-content component"><ul>
<li>代码</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClinitTest</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//任何一个类声明以后，内部至少存在一个类的构造器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> c <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">ClinitTest</span><span style="color:#f92672">(){</span>
</span></span><span style="display:flex;"><span>        a <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> d <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>在构造器中：
<div class="component-content component"><ul>
<li>先将类变量 a 赋值为 10</li>
<li>再将局部变量赋值为 20</li>
</ul></div>
</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-802641dd76479c887a1c2b7b3d4c0460" id="lht802641dd76479c887a1c2b7b3d4c0460">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/35.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component"><strong>若该类具有父类，JVM会保证子类的<code>&lt;clinit&gt;()</code>执行前，父类的<code>&lt;clinit&gt;()</code>已经执行完毕</strong></p>
</blockquote>
<div class="component-content component"><ul>
<li>代码</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClinitTest1</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Father</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> A <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span><span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            A <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Son</span> <span style="color:#66d9ef">extends</span> Father<span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> B <span style="color:#f92672">=</span> A<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//加载Father类，其次加载Son类。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>Son<span style="color:#f92672">.</span><span style="color:#a6e22e">B</span><span style="color:#f92672">);</span><span style="color:#75715e">//2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>如上代码，加载流程如下：
<div class="component-content component"><ul>
<li>首先，执行 main() 方法需要加载 ClinitTest1 类</li>
<li>获取 Son.B 静态变量，需要加载 Son 类</li>
<li>Son 类的父类是 Father 类，所以需要先执行 Father 类的加载，再执行 Son 类的加载</li>
</ul></div>
</li>
</ul></div>
<blockquote>
<p class="component-content component"><strong>虚拟机必须保证一个类的<code>&lt;clinit&gt;()</code>方法在多线程下被同步加锁</strong></p>
</blockquote>
<div class="component-content component"><ul>
<li>代码</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeadThreadTest</span> <span style="color:#f92672">{</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>        Runnable r <span style="color:#f92672">=</span> <span style="color:#f92672">()</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;开始&#34;</span><span style="color:#f92672">);</span>            DeadThread dead <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DeadThread<span style="color:#f92672">();</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;结束&#34;</span><span style="color:#f92672">);</span>        <span style="color:#f92672">};</span>        Thread t1 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;线程1&#34;</span><span style="color:#f92672">);</span>        Thread t2 <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Thread<span style="color:#f92672">(</span>r<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;线程2&#34;</span><span style="color:#f92672">);</span>        t1<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>        t2<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>    <span style="color:#f92672">}}</span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DeadThread</span> <span style="color:#f92672">{</span>    <span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>            System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">()</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;初始化当前类&#34;</span><span style="color:#f92672">);</span>            <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>            <span style="color:#f92672">}</span>        <span style="color:#f92672">}</span>    <span style="color:#f92672">}}</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>程序卡死，分析原因：
<div class="component-content component"><ul>
<li>两个线程同时去加载 DeadThread 类，而 DeadThread 类中静态代码块中有一处死循环</li>
<li>先加载 DeadThread 类的线程抢到了同步锁，然后在类的静态代码块中执行死循环，而另一个线程在等待同步锁的释放</li>
<li>所以无论哪个线程先执行 DeadThread 类的加载，另外一个类也不会继续执行</li>
</ul></div>
</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-45b0c1190557476cb92e698479d47298" id="lht45b0c1190557476cb92e698479d47298">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/36.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="4类加载器的分类" class="pagebody-header">
    4、类加载器的分类
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="41类加载器概述" class="pagebody-header">
    4.1、类加载器概述
  </h3>
</div><blockquote>
<p class="component-content component"><strong>类加载器的分类</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>JVM支持两种类型的类加载器 。分别为引导类加载器（Bootstrap ClassLoader）和自定义类加载器（User-Defined ClassLoader）</strong></li>
<li>从概念上来讲，自定义类加载器一般指的是程序中由开发人员自定义的一类类加载器，但是Java虚拟机规范却没有这么定义，而是<strong>将所有派生于抽象类ClassLoader的类加载器都划分为自定义类加载器</strong></li>
<li>无论类加载器的类型如何划分，在程序中我们最常见的类加载器始终只有3个，如下所示</li>
<li>这里的四者之间是包含关系，不是上层和下层，也不是子父类的继承关系。</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-7bf975dde9f8ea39b9f4fe21c85bbd43" id="lht7bf975dde9f8ea39b9f4fe21c85bbd43">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/37.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<blockquote>
<p class="component-content component"><strong>为什么 ExtClassLoader 和 AppClassLoader 都属于自定义加载器</strong></p>
</blockquote>
<div class="component-content component"><ul>
<li><strong>规范定义：所有派生于抽象类ClassLoader的类加载器都划分为自定义类加载器</strong></li>
<li>ExtClassLoader 继承树</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-cf2b442004778b1cb9a7409c4ba45225" id="lhtcf2b442004778b1cb9a7409c4ba45225">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/38.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>AppClassLoader 继承树</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-0948ead8a2d31124361ef31610a9f9df" id="lht0948ead8a2d31124361ef31610a9f9df">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/39.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>代码：
<div class="component-content component"><ul>
<li>我们尝试获取引导类加载器，获取到的值为 null ，这并不代表引导类加载器不存在，<strong>因为引导类加载器是C/C++ 语言，我们获取不到</strong></li>
<li>两次获取系统类加载器的值都相同：sun.misc.Launcher$AppClassLoader@18b4aac2 ，这说明<strong>系统类加载器是全局唯一的</strong></li>
</ul></div>
</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClassLoaderTest</span> <span style="color:#f92672">{</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>        <span style="color:#75715e">//获取系统类加载器        ClassLoader systemClassLoader = ClassLoader.getSystemClassLoader();        System.out.println(systemClassLoader);//sun.misc.Launcher$AppClassLoader@18b4aac2        //获取其上层：扩展类加载器        ClassLoader extClassLoader = systemClassLoader.getParent();        System.out.println(extClassLoader);//sun.misc.Launcher$ExtClassLoader@1540e19d        //获取其上层：获取不到引导类加载器        ClassLoader bootstrapClassLoader = extClassLoader.getParent();        System.out.println(bootstrapClassLoader);//null        //对于用户自定义类来说：默认使用系统类加载器进行加载        ClassLoader classLoader = ClassLoaderTest.class.getClassLoader();        System.out.println(classLoader);//sun.misc.Launcher$AppClassLoader@18b4aac2        //String类使用引导类加载器进行加载的。---&gt; Java的核心类库都是使用引导类加载器进行加载的。        ClassLoader classLoader1 = String.class.getClassLoader();        System.out.println(classLoader1);//null    }}
</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="42虚拟机自带的加载器" class="pagebody-header">
    4.2、虚拟机自带的加载器
  </h3>
</div>
<div class="component-content pagebody component">
  <h4 id="421启动类加载器" class="pagebody-header">
    4.2.1、启动类加载器
  </h4>
</div><blockquote>
<p class="component-content component"><strong>启动类加载器（引导类加载器，Bootstrap ClassLoader）</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>这个类加载使用C/C++语言实现的，嵌套在JVM内部</strong></li>
<li><strong>它用来加载Java的核心库（JAVA_HOME/jre/lib/rt.jar、resources.jar或sun.boot.class.path路径下的内容），用于提供JVM自身需要的类</strong></li>
<li><strong>并不继承自java.lang.ClassLoader，没有父加载器</strong></li>
<li><strong>加载扩展类和应用程序类加载器，并作为他们的父类加载器（当他俩的爹）</strong></li>
<li><strong>出于安全考虑，Bootstrap启动类加载器只加载包名为java、javax、sun等开头的类</strong></li>
</ol></div>

<div class="component-content pagebody component">
  <h4 id="422扩展类加载器" class="pagebody-header">
    4.2.2、扩展类加载器
  </h4>
</div><blockquote>
<p class="component-content component"><strong>扩展类加载器（Extension ClassLoader）</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>Java语言编写，由sun.misc.Launcher$ExtClassLoader实现</strong></li>
<li><strong>派生于ClassLoader类</strong></li>
<li><strong>父类加载器为启动类加载器</strong></li>
<li><strong>从java.ext.dirs系统属性所指定的目录中加载类库，或从JDK的安装目录的jre/lib/ext子目录（扩展目录）下加载类库。如果用户创建的JAR放在此目录下，也会自动由扩展类加载器加载</strong></li>
</ol></div>

<div class="component-content pagebody component">
  <h4 id="423系统类加载器" class="pagebody-header">
    4.2.3、系统类加载器
  </h4>
</div><blockquote>
<p class="component-content component"><strong>应用程序类加载器（系统类加载器，AppClassLoader）</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li><strong>Java语言编写，由sun.misc.LaunchersAppClassLoader实现</strong></li>
<li><strong>派生于ClassLoader类</strong></li>
<li><strong>父类加载器为扩展类加载器</strong></li>
<li><strong>它负责加载环境变量classpath或系统属性java.class.path指定路径下的类库</strong></li>
<li><strong>该类加载是程序中默认的类加载器，一般来说，Java应用的类都是由它来完成加载</strong></li>
<li><strong>通过classLoader.getSystemclassLoader()方法可以获取到该类加载器</strong></li>
</ol></div>
<blockquote>
<p class="component-content component"><strong>代码举例说明</strong></p>
</blockquote>
<div class="component-content component"><ul>
<li>代码</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClassLoaderTest1</span> <span style="color:#f92672">{</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;**********启动类加载器**************&#34;</span><span style="color:#f92672">);</span>        <span style="color:#75715e">//获取BootstrapClassLoader能够加载的api的路径        URL[] urLs = sun.misc.Launcher.getBootstrapClassPath().getURLs();        for (URL element : urLs) {            System.out.println(element.toExternalForm());        }        //从上面的路径中随意选择一个类,来看看他的类加载器是什么:引导类加载器        ClassLoader classLoader = Provider.class.getClassLoader();        System.out.println(classLoader);//null        System.out.println(&#34;***********扩展类加载器*************&#34;);        String extDirs = System.getProperty(&#34;java.ext.dirs&#34;);        for (String path : extDirs.split(&#34;;&#34;)) {            System.out.println(path);        }        //从上面的路径中随意选择一个类,来看看他的类加载器是什么:扩展类加载器        ClassLoader classLoader1 = CurveDB.class.getClassLoader();        System.out.println(classLoader1);//sun.misc.Launcher$ExtClassLoader@1540e19d    }}
</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>System.out.println(classLoader); 输出 null ，再次证明我们无法获取到启动类加载器</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">**********</span>启动类加载器<span style="color:#f92672">**************</span>file<span style="color:#f92672">:/</span>C<span style="color:#f92672">:/</span>Program<span style="color:#f92672">%</span><span style="color:#ae81ff">20</span>Files<span style="color:#f92672">/</span>Java<span style="color:#f92672">/</span>jdk1<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0_144</span><span style="color:#f92672">/</span>jre<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>resources<span style="color:#f92672">.</span><span style="color:#a6e22e">jarfile</span><span style="color:#f92672">:/</span>C<span style="color:#f92672">:/</span>Program<span style="color:#f92672">%</span><span style="color:#ae81ff">20</span>Files<span style="color:#f92672">/</span>Java<span style="color:#f92672">/</span>jdk1<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0_144</span><span style="color:#f92672">/</span>jre<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>rt<span style="color:#f92672">.</span><span style="color:#a6e22e">jarfile</span><span style="color:#f92672">:/</span>C<span style="color:#f92672">:/</span>Program<span style="color:#f92672">%</span><span style="color:#ae81ff">20</span>Files<span style="color:#f92672">/</span>Java<span style="color:#f92672">/</span>jdk1<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0_144</span><span style="color:#f92672">/</span>jre<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>sunrsasign<span style="color:#f92672">.</span><span style="color:#a6e22e">jarfile</span><span style="color:#f92672">:/</span>C<span style="color:#f92672">:/</span>Program<span style="color:#f92672">%</span><span style="color:#ae81ff">20</span>Files<span style="color:#f92672">/</span>Java<span style="color:#f92672">/</span>jdk1<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0_144</span><span style="color:#f92672">/</span>jre<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>jsse<span style="color:#f92672">.</span><span style="color:#a6e22e">jarfile</span><span style="color:#f92672">:/</span>C<span style="color:#f92672">:/</span>Program<span style="color:#f92672">%</span><span style="color:#ae81ff">20</span>Files<span style="color:#f92672">/</span>Java<span style="color:#f92672">/</span>jdk1<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0_144</span><span style="color:#f92672">/</span>jre<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>jce<span style="color:#f92672">.</span><span style="color:#a6e22e">jarfile</span><span style="color:#f92672">:/</span>C<span style="color:#f92672">:/</span>Program<span style="color:#f92672">%</span><span style="color:#ae81ff">20</span>Files<span style="color:#f92672">/</span>Java<span style="color:#f92672">/</span>jdk1<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0_144</span><span style="color:#f92672">/</span>jre<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>charsets<span style="color:#f92672">.</span><span style="color:#a6e22e">jarfile</span><span style="color:#f92672">:/</span>C<span style="color:#f92672">:/</span>Program<span style="color:#f92672">%</span><span style="color:#ae81ff">20</span>Files<span style="color:#f92672">/</span>Java<span style="color:#f92672">/</span>jdk1<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0_144</span><span style="color:#f92672">/</span>jre<span style="color:#f92672">/</span>lib<span style="color:#f92672">/</span>jfr<span style="color:#f92672">.</span><span style="color:#a6e22e">jarfile</span><span style="color:#f92672">:/</span>C<span style="color:#f92672">:/</span>Program<span style="color:#f92672">%</span><span style="color:#ae81ff">20</span>Files<span style="color:#f92672">/</span>Java<span style="color:#f92672">/</span>jdk1<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0_144</span><span style="color:#f92672">/</span>jre<span style="color:#f92672">/</span>classesnull<span style="color:#f92672">***********</span>扩展类加载器<span style="color:#f92672">*************</span>C<span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">\</span>Program Files<span style="color:#960050;background-color:#1e0010">\</span>Java<span style="color:#960050;background-color:#1e0010">\</span>jdk1<span style="color:#f92672">.</span><span style="color:#a6e22e">8</span><span style="color:#f92672">.</span><span style="color:#a6e22e">0_144</span><span style="color:#960050;background-color:#1e0010">\</span>jre<span style="color:#960050;background-color:#1e0010">\</span>lib<span style="color:#960050;background-color:#1e0010">\</span>extC<span style="color:#f92672">:</span><span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>Sun<span style="color:#960050;background-color:#1e0010">\</span>Java<span style="color:#960050;background-color:#1e0010">\</span>lib<span style="color:#960050;background-color:#1e0010">\</span>extsun<span style="color:#f92672">.</span><span style="color:#a6e22e">misc</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Launcher$ExtClassLoader</span><span style="color:#a6e22e">@7ea987ac</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="43用户自定义类加载器" class="pagebody-header">
    4.3、用户自定义类加载器
  </h3>
</div><blockquote>
<p class="component-content component"><strong>为什么需要自定义类加载器？</strong></p>
</blockquote>
<p class="component-content component">在Java的日常应用程序开发中，类的加载几乎是由上述3种类加载器相互配合执行的，在必要时，我们还可以自定义类加载器，来定制类的加载方式。那为什么还需要自定义类加载器？</p>
<div class="component-content component"><ol>
<li>隔离加载类</li>
<li>修改类加载的方式</li>
<li>扩展加载源</li>
<li>防止源码泄漏</li>
</ol></div>
<blockquote>
<p class="component-content component"><strong>如何自定义类加载器？</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li>开发人员可以通过继承抽象类java.lang.ClassLoader类的方式，实现自己的类加载器，以满足一些特殊的需求</li>
<li>在JDK1.2之前，在自定义类加载器时，总会去继承ClassLoader类并重写loadClass()方法，从而实现自定义的类加载类，但是在JDK1.2之后已不再建议用户去覆盖loadClass()方法，而是建议把自定义的类加载逻辑写在findclass()方法中</li>
<li>在编写自定义类加载器时，如果没有太过于复杂的需求，可以直接继承URLClassLoader类，这样就可以避免自己去编写findclass()方法及其获取字节码流的方式，使自定义类加载器编写更加简洁。</li>
</ol></div>
<p class="component-content component"><strong>代码示例</strong></p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomClassLoader</span> <span style="color:#66d9ef">extends</span> ClassLoader <span style="color:#f92672">{</span>    <span style="color:#a6e22e">@Override</span>    <span style="color:#66d9ef">protected</span> Class<span style="color:#f92672">&lt;?&gt;</span> findClass<span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> ClassNotFoundException <span style="color:#f92672">{</span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>            <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> result <span style="color:#f92672">=</span> getClassFromCustomPath<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>result <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>                <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> FileNotFoundException<span style="color:#f92672">();</span>            <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>                <span style="color:#66d9ef">return</span> defineClass<span style="color:#f92672">(</span>name<span style="color:#f92672">,</span> result<span style="color:#f92672">,</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">,</span> result<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">);</span>            <span style="color:#f92672">}</span>        <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>FileNotFoundException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>            e<span style="color:#f92672">.</span><span style="color:#a6e22e">printStackTrace</span><span style="color:#f92672">();</span>        <span style="color:#f92672">}</span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> ClassNotFoundException<span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>    <span style="color:#f92672">}</span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> <span style="color:#a6e22e">getClassFromCustomPath</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>        <span style="color:#75715e">//从自定义路径中加载指定类:细节略        //如果指定路径的字节码文件进行了加密，则需要在此方法中进行解密操作。        return null;    }    public static void main(String[] args) {        CustomClassLoader customClassLoader = new CustomClassLoader();        try {            Class&lt;?&gt; clazz = Class.forName(&#34;One&#34;, true, customClassLoader);            Object obj = clazz.newInstance();            System.out.println(obj.getClass().getClassLoader());        } catch (Exception e) {            e.printStackTrace();        }    }}
</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h3 id="44关于-classloader" class="pagebody-header">
    4.4、关于 ClassLoader
  </h3>
</div><blockquote>
<p class="component-content component"><strong>ClassLoader 类介绍</strong></p>
</blockquote>
<div class="component-content component"><ul>
<li>ClassLoader类，它是一个抽象类，其后所有的类加载器都继承自ClassLoader（不包括启动类加载器）</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-341e1e007bc1fbdfa24b8c7a63188ca1" id="lht341e1e007bc1fbdfa24b8c7a63188ca1">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/40.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>sun.misc.Launcher 它是一个java虚拟机的入口应用</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-e9791215f99feda765a201f806ef2c16" id="lhte9791215f99feda765a201f806ef2c16">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/41.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component"><strong>获取 ClassLoader 途径</strong></p>
<div class="component-content component"><ul>
<li>获取途径：</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-e96d233cc7345b4bf7ddef4224c6b28a" id="lhte96d233cc7345b4bf7ddef4224c6b28a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/42.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>代码示例：</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ClassLoaderTest2</span> <span style="color:#f92672">{</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>                        <span style="color:#75715e">//1.Class.forName().getClassLoader()            ClassLoader classLoader = Class.forName(&#34;java.lang.String&#34;).getClassLoader();            System.out.println(classLoader); // String 类由启动类加载器加载，我们无法获取            //2.Thread.currentThread().getContextClassLoader()            ClassLoader classLoader1 = Thread.currentThread().getContextClassLoader();            System.out.println(classLoader1);            //3.ClassLoader.getSystemClassLoader().getParent()            ClassLoader classLoader2 = ClassLoader.getSystemClassLoader();            System.out.println(classLoader2);        } catch (ClassNotFoundException e) {            e.printStackTrace();        }    }}// 输出nullsun.misc.Launcher$AppClassLoader@18b4aac2sun.misc.Launcher$AppClassLoader@18b4aac2
</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="5双亲委派机制" class="pagebody-header">
    5、双亲委派机制
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="51双亲委派机制原理" class="pagebody-header">
    5.1、双亲委派机制原理
  </h3>
</div><blockquote>
<p class="component-content component"><strong>双亲委派机制的原理</strong></p>
</blockquote>
<p class="component-content component"><strong>Java虚拟机对class文件采用的是按需加载的方式</strong>，也就是说当需要使用该类时才会将它的class文件加载到内存生成class对象。而且<strong>加载某个类的class文件时，Java虚拟机采用的是双亲委派模式，即把请求交由父类处理，它是一种任务委派模式</strong></p>
<div class="component-content component"><ol>
<li>如果一个类加载器收到了类加载请求，它并不会自己先去加载，而是把这个请求委托给父类的加载器去执行；</li>
<li>如果父类加载器还存在其父类加载器，则进一步向上委托，依次递归，请求最终将到达顶层的启动类加载器；</li>
<li>如果父类加载器可以完成类加载任务，就成功返回，倘若父类加载器无法完成此加载任务，子加载器才会尝试自己去加载，这就是双亲委派模式。</li>
<li>父类加载器一层一层往下分配任务，如果子类加载器能加载，则加载此类，如果将加载任务分配至系统类加载器也无法加载此类，则抛出异常</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-43851b9da0c6ed117df5a1901dbe88a5" id="lht43851b9da0c6ed117df5a1901dbe88a5">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/43.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="52双亲委派机制代码示例" class="pagebody-header">
    5.2、双亲委派机制代码示例
  </h3>
</div><blockquote>
<p class="component-content component"><strong>代码示例</strong></p>
</blockquote>
<p class="component-content component"><strong>举例 1 ：</strong></p>
<div class="component-content component"><ul>
<li>代码：我们自己建立一个 java.lang.String 类，写上 static 代码块</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> java.lang<span style="color:#f92672">;</span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">String</span> <span style="color:#f92672">{</span>    <span style="color:#66d9ef">static</span><span style="color:#f92672">{</span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我是自定义的String类的静态代码块&#34;</span><span style="color:#f92672">);</span>    <span style="color:#f92672">}}</span><span style="color:#ae81ff">1234567</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>在另外的程序中加载 String 类，看看加载的 String 类是 JDK 自带的 String 类，还是我们自己编写的 String 类</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StringTest</span> <span style="color:#f92672">{</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>        java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">String</span> str <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">lang</span><span style="color:#f92672">.</span><span style="color:#a6e22e">String</span><span style="color:#f92672">();</span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello,atguigu.com&#34;</span><span style="color:#f92672">);</span>        StringTest test <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> StringTest<span style="color:#f92672">();</span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span>test<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">().</span><span style="color:#a6e22e">getClassLoader</span><span style="color:#f92672">());</span>    <span style="color:#f92672">}}</span><span style="color:#ae81ff">12345678910</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>程序并没有输出我们静态代码块中的内容，可见仍然加载的是 JDK 自带的 String 类</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-95cf14af96b1736054a7943dd28b0587" id="lht95cf14af96b1736054a7943dd28b0587">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/44.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component"><strong>举例 2 ：</strong></p>
<div class="component-content component"><ul>
<li>代码：在我们自己的 String 类中整个 main() 方法</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> java.lang<span style="color:#f92672">;</span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">String</span> <span style="color:#f92672">{</span>    <span style="color:#66d9ef">static</span><span style="color:#f92672">{</span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;我是自定义的String类的静态代码块&#34;</span><span style="color:#f92672">);</span>    <span style="color:#f92672">}</span>    <span style="color:#75715e">//错误: 在类 java.lang.String 中找不到 main 方法    public static void main(String[] args) {        System.out.println(&#34;hello,String&#34;);    }}1234567891011
</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>由于双亲委派机制找到的是 JDK 自带的 String 类，在那个 String 类中并没有 main() 方法</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-caa42cd6bc75a7c5786c5ecf9d094953" id="lhtcaa42cd6bc75a7c5786c5ecf9d094953">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/45.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component"><strong>举例 3 ：</strong></p>
<div class="component-content component"><ul>
<li>代码：在 java.lang 包下整个 ShkStart 类</li>
</ul></div>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#f92672">package</span> java.lang<span style="color:#f92672">;</span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ShkStart</span> <span style="color:#f92672">{</span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>        System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">println</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;hello!&#34;</span><span style="color:#f92672">);</span>    <span style="color:#f92672">}}</span><span style="color:#ae81ff">1234567</span></span></span></code></pre></div></div>
  
</div><div class="component-content component"><ul>
<li>出于保护机制，java.lang 包下不允许我们自定义类</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-6e267699d2003157f57bf2a3977cd69f" id="lht6e267699d2003157f57bf2a3977cd69f">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/46.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component"><strong>举例 4 ：</strong></p>
<p class="component-content component">当我们加载jdbc.jar 用于实现数据库连接的时候</p>
<div class="component-content component"><ol>
<li>首先我们需要知道的是 jdbc.jar是基于SPI接口进行实现的</li>
<li>所以在加载的时候，会进行双亲委派，最终从根加载器中加载 SPI核心类，然后再加载SPI接口类</li>
<li>接着在进行反向委托，通过线程上下文类加载器进行实现类 jdbc.jar的加载。</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-b233bbfd039d0b1ea6dbbd71df89d72a" id="lhtb233bbfd039d0b1ea6dbbd71df89d72a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/jvm_first/47.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h3 id="53双亲委派机制优势" class="pagebody-header">
    5.3、双亲委派机制优势
  </h3>
</div><blockquote>
<p class="component-content component"><strong>双亲委派机制的优势</strong></p>
</blockquote>
<p class="component-content component">通过上面的例子，我们可以知道，双亲机制可以</p>
<div class="component-content component"><ol>
<li>避免类的重复加载</li>
<li>保护程序安全，防止核心API被随意篡改
<div class="component-content component"><ol>
<li>自定义类：java.lang.String 没有屌用</li>
<li>自定义类：java.lang.ShkStart（报错：阻止创建 java.lang开头的类）</li>
</ol></div>
</li>
</ol></div>

<div class="component-content pagebody component">
  <h2 id="6沙箱安全机制" class="pagebody-header">
    6、沙箱安全机制
  </h2>
</div><div class="component-content component"><ol>
<li>自定义String类时：在加载自定义String类的时候会率先使用引导类加载器加载，而引导类加载器在加载的过程中会先加载jdk自带的文件（rt.jar包中java.lang.String.class），报错信息说没有main方法，就是因为加载的是rt.jar包中的String类。</li>
<li>这样可以保证对java核心源代码的保护，这就是沙箱安全机制。</li>
</ol></div>

<div class="component-content pagebody component">
  <h2 id="7其他" class="pagebody-header">
    7、其他
  </h2>
</div><blockquote>
<p class="component-content component"><strong>如何判断两个class对象是否相同？</strong></p>
</blockquote>
<p class="component-content component">在JVM中表示两个class对象是否为同一个类存在两个必要条件：</p>
<div class="component-content component"><ol>
<li><strong>类的完整类名必须一致，包括包名</strong></li>
<li><strong>加载这个类的ClassLoader（指ClassLoader实例对象）必须相同</strong></li>
<li>换句话说，在JVM中，即使这两个类对象（class对象）来源同一个Class文件，被同一个虚拟机所加载，但只要加载它们的ClassLoader实例对象不同，那么这两个类对象也是不相等的</li>
</ol></div>
<blockquote>
<p class="component-content component"><strong>对类加载器的引用</strong></p>
</blockquote>
<div class="component-content component"><ol>
<li>JVM必须知道一个类型是由启动加载器加载的还是由用户类加载器加载的</li>
<li><strong>如果一个类型是由用户类加载器加载的，那么JVM会将这个类加载器的一个引用作为类型信息的一部分保存在方法区中</strong></li>
<li>当解析一个类型到另一个类型的引用的时候，JVM需要保证这两个类型的类加载器是相同的</li>
</ol></div>
<blockquote>
<p class="component-content component"><strong>类的主动使用和被动使用</strong></p>
</blockquote>
<p class="component-content component">Java程序对类的使用方式分为：主动使用和被动使用。主动使用，又分为七种情况：</p>
<div class="component-content component"><ol>
<li>创建类的实例</li>
<li>访问某个类或接口的静态变量，或者对该静态变量赋值</li>
<li>调用类的静态方法</li>
<li>反射（比如：Class.forName(“com.atguigu.Test”)）</li>
<li>初始化一个类的子类</li>
<li>Java虚拟机启动时被标明为启动类的类</li>
<li>JDK7开始提供的动态语言支持：java.lang.invoke.MethodHandle实例的解析结果REF_getStatic、REF putStatic、REF_invokeStatic句柄对应的类没有初始化，则初始化</li>
</ol></div>
<p class="component-content component">除了以上七种情况，其他使用Java类的方式都被看作是对类的被动使用，都不会导致类的初始化，即不会执行初始化阶段（不会调用 clinit() 方法和 init() 方法）</p>

          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  版权声明: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">版权声明：署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">作者:  yuanshuai </p>
                <p class="content">发表日期:  2021年11月30日</p>
              </div>
            </div>
          </div></article>
      </section>
  </main>

  <script>
    var script = document.createElement("script");script.src = "https://yuanshuai1122.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:shuaiyuan@gmail.com">shuaiyuan@gmail.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">社交媒体</div>
            
              <a href="https://github.com/yuanshuai1122" target="_blank">Github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">友链</div>
            
              <a href="https://yuanshuaicn.com/" target="_blank">👋</a>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2023
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
