<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="zh-hans">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:title" content="æ·±å…¥æ‹†è§£Tomcatå’ŒJettyä¹‹é€šç”¨ç»„ä»¶" />
<meta property="og:description" content="æœ¬ç³»åˆ—æ–‡ç« è½¬è‡ªæå®¢æ—¶é—´å¤§ä½¬æå·åŒçš„ä¸“æ ã€Šæ·±å…¥æ‹†è§£Tomcat &amp; Jettyã€‹ é“¾æ¥ï¼šhttps://time.geekbang.org/colu" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanshuai1122.github.io/posts/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3tomcat%E5%92%8Cjetty%E4%B9%8B%E9%80%9A%E7%94%A8%E7%BB%84%E4%BB%B6-%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3tomcat%E5%92%8Cjetty%E4%B9%8B%E9%80%9A%E7%94%A8%E7%BB%84%E4%BB%B6/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-26T22:11:36+00:00" />
<meta property="article:modified_time" content="2021-11-26T22:11:36+00:00" />
<title>æ·±å…¥æ‹†è§£Tomcatå’ŒJettyä¹‹é€šç”¨ç»„ä»¶</title>

    <link rel="canonical" href="/posts/%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3tomcat%E5%92%8Cjetty%E4%B9%8B%E9%80%9A%E7%94%A8%E7%BB%84%E4%BB%B6-%E6%B7%B1%E5%85%A5%E6%8B%86%E8%A7%A3tomcat%E5%92%8Cjetty%E4%B9%8B%E9%80%9A%E7%94%A8%E7%BB%84%E4%BB%B6/">

    <link rel="stylesheet" href="/css/global.css">

    <link rel="stylesheet" href="/css/custom.css">

    <link rel="stylesheet" href="/css/search.css" />

    
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/ " class="nav-title">ğŸ§€</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="/posts " class="nav-item-content">ç›®å½•</a>
          </div><div class="nav-item-wrapper">
            <a href="/about" class="nav-item-content">å…³äº</a>
          </div><div class="nav-item-wrapper">
            <a href="/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yuanshuai1122.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        Java
                      
                    
                  </span>
                  <span class="category-eyebrow__date">2021å¹´11æœˆ26æ—¥</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">æ·±å…¥æ‹†è§£Tomcatå’ŒJettyä¹‹é€šç”¨ç»„ä»¶</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="/tags/java" class="tag">
                    Java
                  </a>
                
                  
                  <a href="/tags/tomcat" class="tag">
                    Tomcat
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            <blockquote>
<p class="component-content component">æœ¬ç³»åˆ—æ–‡ç« è½¬è‡ªæå®¢æ—¶é—´å¤§ä½¬æå·åŒçš„ä¸“æ ã€Šæ·±å…¥æ‹†è§£Tomcat &amp; Jettyã€‹</p>
<p class="component-content component">é“¾æ¥ï¼šhttps://time.geekbang.org/column/intro/100027701</p>
<p class="component-content component">ä»…ä¾›è‡ªå·±å­¦ä¹ ï¼Œè”ç³»æˆ‘ï¼Œä¾µåˆ ã€‚</p>
</blockquote>

<div class="component-content pagebody component">
  <h1 id="31--loggerç»„ä»¶tomcatçš„æ—¥å¿—æ¡†æ¶åŠå®æˆ˜" class="pagebody-header">
    31 | Loggerç»„ä»¶ï¼šTomcatçš„æ—¥å¿—æ¡†æ¶åŠå®æˆ˜
  </h1>
</div><p class="component-content component">æ¯ä¸€ä¸ªç³»ç»Ÿéƒ½æœ‰ä¸€äº›é€šç”¨çš„æ¨¡å—ï¼Œæ¯”å¦‚æ—¥å¿—æ¨¡å—ã€å¼‚å¸¸å¤„ç†æ¨¡å—ã€å·¥å…·ç±»ç­‰ï¼Œå¯¹äº Tomcat æ¥è¯´ï¼Œæ¯”è¾ƒé‡è¦çš„é€šç”¨æ¨¡å—æœ‰æ—¥å¿—ã€Session ç®¡ç†å’Œé›†ç¾¤ç®¡ç†ã€‚ä»ä»Šå¤©å¼€å§‹æˆ‘ä¼šåˆ†ä¸‰æœŸæ¥ä»‹ç»é€šç”¨æ¨¡å—ï¼Œä»Šå¤©è¿™ä¸€æœŸå…ˆæ¥è®²æ—¥å¿—æ¨¡å—ã€‚</p>
<p class="component-content component">æ—¥å¿—æ¨¡å—ä½œä¸ºä¸€ä¸ªé€šç”¨çš„åŠŸèƒ½ï¼Œåœ¨ç³»ç»Ÿé‡Œé€šå¸¸ä¼šä½¿ç”¨ç¬¬ä¸‰æ–¹çš„æ—¥å¿—æ¡†æ¶ã€‚Java çš„æ—¥å¿—æ¡†æ¶æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼šJULï¼ˆJava Util Loggingï¼‰ã€Log4jã€Logbackã€Log4j2ã€Tinylog ç­‰ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰ JCLï¼ˆApache Commons Loggingï¼‰å’Œ SLF4J è¿™æ ·çš„â€œé—¨é¢æ—¥å¿—â€ã€‚ä¸‹é¢æ˜¯ SLF4J ä¸æ—¥å¿—æ¡†æ¶ Logbackã€Log4j çš„å…³ç³»å›¾ï¼š</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-0893b5574974184b8a46614905b1a92a" id="lht0893b5574974184b8a46614905b1a92a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/tomcat_jetty/69.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">æˆ‘å…ˆæ¥è§£é‡Šä¸€ä¸‹ä»€ä¹ˆæ˜¯â€œé—¨é¢æ—¥å¿—â€ã€‚â€œé—¨é¢æ—¥å¿—â€åˆ©ç”¨äº†è®¾è®¡æ¨¡å¼ä¸­çš„é—¨é¢æ¨¡å¼æ€æƒ³ï¼Œå¯¹å¤–æä¾›ä¸€å¥—é€šç”¨çš„æ—¥å¿—è®°å½•çš„ APIï¼Œè€Œä¸æä¾›å…·ä½“çš„æ—¥å¿—è¾“å‡ºæœåŠ¡ï¼Œå¦‚æœè¦å®ç°æ—¥å¿—è¾“å‡ºï¼Œéœ€è¦é›†æˆå…¶ä»–çš„æ—¥å¿—æ¡†æ¶ï¼Œæ¯”å¦‚ Log4jã€Logbackã€Log4j2 ç­‰ã€‚</p>
<p class="component-content component">è¿™ç§é—¨é¢æ¨¡å¼çš„å¥½å¤„åœ¨äºï¼Œè®°å½•æ—¥å¿—çš„ API å’Œæ—¥å¿—è¾“å‡ºçš„æœåŠ¡åˆ†ç¦»å¼€ï¼Œä»£ç é‡Œé¢åªéœ€è¦å…³æ³¨è®°å½•æ—¥å¿—çš„ APIï¼Œé€šè¿‡ SLF4J æŒ‡å®šçš„æ¥å£è®°å½•æ—¥å¿—ï¼›è€Œæ—¥å¿—è¾“å‡ºé€šè¿‡å¼•å…¥ JAR åŒ…çš„æ–¹å¼å³å¯æŒ‡å®šå…¶ä»–çš„æ—¥å¿—æ¡†æ¶ã€‚å½“æˆ‘ä»¬éœ€è¦æ”¹å˜ç³»ç»Ÿçš„æ—¥å¿—è¾“å‡ºæœåŠ¡æ—¶ï¼Œä¸ç”¨ä¿®æ”¹ä»£ç ï¼Œåªéœ€è¦æ”¹å˜å¼•å…¥æ—¥å¿—è¾“å‡ºæ¡†æ¶ JAR åŒ…ã€‚</p>
<p class="component-content component">ä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹ Tomcat çš„æ—¥å¿—æ¨¡å—æ˜¯å¦‚ä½•å®ç°çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒTomcat ä½¿ç”¨è‡ªèº«çš„ JULI ä½œä¸º Tomcat å†…éƒ¨çš„æ—¥å¿—å¤„ç†ç³»ç»Ÿã€‚JULI çš„æ—¥å¿—é—¨é¢é‡‡ç”¨äº† JCLï¼›è€Œ JULI çš„å…·ä½“å®ç°æ˜¯æ„å»ºåœ¨ Java åŸç”Ÿçš„æ—¥å¿—ç³»ç»Ÿ<code>java.util.logging</code>ä¹‹ä¸Šçš„ï¼Œæ‰€ä»¥åœ¨çœ‹ JULI çš„æ—¥å¿—ç³»ç»Ÿä¹‹å‰ï¼Œæˆ‘å…ˆç®€å•ä»‹ç»ä¸€ä¸‹ Java çš„æ—¥å¿—ç³»ç»Ÿã€‚</p>

<div class="component-content pagebody component">
  <h2 id="java-æ—¥å¿—ç³»ç»Ÿ" class="pagebody-header">
    Java æ—¥å¿—ç³»ç»Ÿ
  </h2>
</div><p class="component-content component">Java çš„æ—¥å¿—åŒ…åœ¨<code>java.util.logging</code>è·¯å¾„ä¸‹ï¼ŒåŒ…å«äº†å‡ ä¸ªæ¯”è¾ƒé‡è¦çš„ç»„ä»¶ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€å¼ å›¾æ¥ç†è§£ä¸€ä¸‹ï¼š</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-104fedbce249156b85345f4cfa57e5bc" id="lht104fedbce249156b85345f4cfa57e5bc">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/tomcat_jetty/70.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">ä»å›¾ä¸Šæˆ‘ä»¬çœ‹åˆ°è¿™æ ·å‡ ä¸ªé‡è¦çš„ç»„ä»¶ï¼š</p>
<div class="component-content component"><ul>
<li>Loggerï¼šç”¨æ¥è®°å½•æ—¥å¿—çš„ç±»ã€‚</li>
<li>Handlerï¼šè§„å®šäº†æ—¥å¿—çš„è¾“å‡ºæ–¹å¼ï¼Œå¦‚æ§åˆ¶å°è¾“å‡ºã€å†™å…¥æ–‡ä»¶ã€‚</li>
<li>Levelï¼šå®šä¹‰äº†æ—¥å¿—çš„ä¸åŒç­‰çº§ã€‚</li>
<li>Formatterï¼šå°†æ—¥å¿—ä¿¡æ¯æ ¼å¼åŒ–ï¼Œæ¯”å¦‚çº¯æ–‡æœ¬ã€XMLã€‚</li>
</ul></div>
<p class="component-content component">æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç æ¥ä½¿ç”¨è¿™äº›ç»„ä»¶ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span><span style="color:#f92672">(</span>String<span style="color:#f92672">[]</span> args<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  Logger logger <span style="color:#f92672">=</span> Logger<span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;com.mycompany.myapp&#34;</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  logger<span style="color:#f92672">.</span><span style="color:#a6e22e">setLevel</span><span style="color:#f92672">(</span>Level<span style="color:#f92672">.</span><span style="color:#a6e22e">FINE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  logger<span style="color:#f92672">.</span><span style="color:#a6e22e">setUseParentHandlers</span><span style="color:#f92672">(</span><span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  Handler hd <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConsoleHandler<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>  hd<span style="color:#f92672">.</span><span style="color:#a6e22e">setLevel</span><span style="color:#f92672">(</span>Level<span style="color:#f92672">.</span><span style="color:#a6e22e">FINE</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  logger<span style="color:#f92672">.</span><span style="color:#a6e22e">addHandler</span><span style="color:#f92672">(</span>hd<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  logger<span style="color:#f92672">.</span><span style="color:#a6e22e">info</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;start log&#34;</span><span style="color:#f92672">);</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="juli" class="pagebody-header">
    JULI
  </h2>
</div><p class="component-content component">JULI å¯¹æ—¥å¿—çš„å¤„ç†æ–¹å¼ä¸ Java è‡ªå¸¦çš„åŸºæœ¬ä¸€è‡´ï¼Œä½†æ˜¯ Tomcat ä¸­å¯ä»¥åŒ…å«å¤šä¸ªåº”ç”¨ï¼Œè€Œæ¯ä¸ªåº”ç”¨çš„æ—¥å¿—ç³»ç»Ÿåº”è¯¥ç›¸äº’ç‹¬ç«‹ã€‚Java çš„åŸç”Ÿæ—¥å¿—ç³»ç»Ÿæ˜¯æ¯ä¸ª JVM æœ‰ä¸€ä»½æ—¥å¿—çš„é…ç½®æ–‡ä»¶ï¼Œè¿™ä¸ç¬¦åˆ Tomcat å¤šåº”ç”¨çš„åœºæ™¯ï¼Œæ‰€ä»¥ JULI é‡æ–°å®ç°äº†ä¸€äº›æ—¥å¿—æ¥å£ã€‚</p>
<p class="component-content component"><strong>DirectJDKLog</strong></p>
<p class="component-content component">Log çš„åŸºç¡€å®ç°ç±»æ˜¯ DirectJDKLogï¼Œè¿™ä¸ªç±»ç›¸å¯¹ç®€å•ï¼Œå°±åŒ…è£…äº†ä¸€ä¸‹ Java çš„ Logger ç±»ã€‚ä½†æ˜¯å®ƒä¹Ÿåœ¨åŸæ¥çš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ï¼Œæ¯”å¦‚ä¿®æ”¹é»˜è®¤çš„æ ¼å¼åŒ–æ–¹å¼ã€‚</p>
<p class="component-content component"><strong>LogFactory</strong></p>
<p class="component-content component">Log ä½¿ç”¨äº†å·¥å‚æ¨¡å¼æ¥å‘å¤–æä¾›å®ä¾‹ï¼ŒLogFactory æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œå¯ä»¥é€šè¿‡ SeviceLoader ä¸º Log æä¾›è‡ªå®šä¹‰çš„å®ç°ç‰ˆæœ¬ï¼Œå¦‚æœæ²¡æœ‰é…ç½®ï¼Œå°±é»˜è®¤ä½¿ç”¨ DirectJDKLogã€‚</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#a6e22e">LogFactory</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é€šè¿‡ ServiceLoader å°è¯•åŠ è½½ Log çš„å®ç°ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ServiceLoader<span style="color:#f92672">&lt;</span>Log<span style="color:#f92672">&gt;</span> logLoader <span style="color:#f92672">=</span> ServiceLoader<span style="color:#f92672">.</span><span style="color:#a6e22e">load</span><span style="color:#f92672">(</span>Log<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    Constructor<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Log<span style="color:#f92672">&gt;</span> m<span style="color:#f92672">=</span><span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Log log<span style="color:#f92672">:</span> logLoader<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Class<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> Log<span style="color:#f92672">&gt;</span> c<span style="color:#f92672">=</span>log<span style="color:#f92672">.</span><span style="color:#a6e22e">getClass</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            m<span style="color:#f92672">=</span>c<span style="color:#f92672">.</span><span style="color:#a6e22e">getConstructor</span><span style="color:#f92672">(</span>String<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NoSuchMethodException <span style="color:#f92672">|</span> SecurityException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> Error<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¦‚ä½•æ²¡æœ‰å®šä¹‰ Log çš„å®ç°ç±»ï¼ŒdiscoveredLogConstructor ä¸º null
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    discoveredLogConstructor <span style="color:#f92672">=</span> m<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">ä¸‹é¢çš„ä»£ç æ˜¯ LogFactory çš„ getInstance æ–¹æ³•ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Log <span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> LogConfigurationException <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¦‚æœ discoveredLogConstructor ä¸º nullï¼Œä¹Ÿå°±æ²¡æœ‰å®šä¹‰ Log ç±»ï¼Œé»˜è®¤ç”¨ DirectJDKLog
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>discoveredLogConstructor <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> DirectJDKLog<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> discoveredLogConstructor<span style="color:#f92672">.</span><span style="color:#a6e22e">newInstance</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>ReflectiveOperationException <span style="color:#f92672">|</span> IllegalArgumentException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> LogConfigurationException<span style="color:#f92672">(</span>e<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component"><strong>Handler</strong></p>
<p class="component-content component">åœ¨ JULI ä¸­å°±è‡ªå®šä¹‰äº†ä¸¤ä¸ª Handlerï¼šFileHandler å’Œ AsyncFileHandlerã€‚FileHandler å¯ä»¥ç®€å•åœ°ç†è§£ä¸ºä¸€ä¸ªåœ¨ç‰¹å®šä½ç½®å†™æ–‡ä»¶çš„å·¥å…·ç±»ï¼Œæœ‰ä¸€äº›å†™æ“ä½œå¸¸ç”¨çš„æ–¹æ³•ï¼Œå¦‚ openã€write(publish)ã€closeã€flush ç­‰ï¼Œä½¿ç”¨äº†è¯»å†™é”ã€‚å…¶ä¸­çš„æ—¥å¿—ä¿¡æ¯é€šè¿‡ Formatter æ¥æ ¼å¼åŒ–ã€‚</p>
<p class="component-content component">AsyncFileHandler ç»§æ‰¿è‡ª FileHandlerï¼Œå®ç°äº†å¼‚æ­¥çš„å†™æ“ä½œã€‚å…¶ä¸­ç¼“å­˜å­˜å‚¨æ˜¯é€šè¿‡é˜»å¡åŒç«¯é˜Ÿåˆ— LinkedBlockingDeque æ¥å®ç°çš„ã€‚å½“åº”ç”¨è¦é€šè¿‡è¿™ä¸ª Handler æ¥è®°å½•ä¸€æ¡æ¶ˆæ¯æ—¶ï¼Œæ¶ˆæ¯ä¼šå…ˆè¢«å­˜å‚¨åˆ°é˜Ÿåˆ—ä¸­ï¼Œè€Œåœ¨åå°ä¼šæœ‰ä¸€ä¸ªä¸“é—¨çš„çº¿ç¨‹æ¥å¤„ç†é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œå–å‡ºçš„æ¶ˆæ¯ä¼šé€šè¿‡çˆ¶ç±»çš„ publish æ–¹æ³•å†™å…¥ç›¸åº”æ–‡ä»¶å†…ã€‚è¿™æ ·å°±å¯ä»¥åœ¨å¤§é‡æ—¥å¿—éœ€è¦å†™å…¥çš„æ—¶å€™èµ·åˆ°ç¼“å†²ä½œç”¨ï¼Œé˜²æ­¢éƒ½é˜»å¡åœ¨å†™æ—¥å¿—è¿™ä¸ªåŠ¨ä½œä¸Šã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºé˜»å¡åŒç«¯é˜Ÿåˆ—è®¾ç½®ä¸åŒçš„æ¨¡å¼ï¼Œåœ¨ä¸åŒæ¨¡å¼ä¸‹ï¼Œå¯¹æ–°è¿›å…¥çš„æ¶ˆæ¯æœ‰ä¸åŒçš„å¤„ç†æ–¹å¼ï¼Œæœ‰äº›æ¨¡å¼ä¸‹ä¼šç›´æ¥ä¸¢å¼ƒä¸€äº›æ—¥å¿—ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>OVERFLOW_DROP_LAST<span style="color:#960050;background-color:#1e0010">ï¼š</span>ä¸¢å¼ƒæ ˆé¡¶çš„å…ƒç´  
</span></span><span style="display:flex;"><span>OVERFLOW_DROP_FIRSH<span style="color:#960050;background-color:#1e0010">ï¼š</span>ä¸¢å¼ƒæ ˆåº•çš„å…ƒç´  
</span></span><span style="display:flex;"><span>OVERFLOW_DROP_FLUSH<span style="color:#960050;background-color:#1e0010">ï¼š</span>ç­‰å¾…ä¸€å®šæ—¶é—´å¹¶é‡è¯•<span style="color:#960050;background-color:#1e0010">ï¼Œ</span>ä¸ä¼šä¸¢å¤±å…ƒç´  
</span></span><span style="display:flex;"><span>OVERFLOW_DROP_CURRENT<span style="color:#960050;background-color:#1e0010">ï¼š</span>ä¸¢å¼ƒæ”¾å…¥çš„å…ƒç´ </span></span></code></pre></div></div>
  
</div><p class="component-content component"><strong>Formatter</strong></p>
<p class="component-content component">Formatter é€šè¿‡ä¸€ä¸ª format æ–¹æ³•å°†æ—¥å¿—è®°å½• LogRecord è½¬åŒ–æˆæ ¼å¼åŒ–çš„å­—ç¬¦ä¸²ï¼ŒJULI æä¾›äº†ä¸‰ä¸ªæ–°çš„ Formatterã€‚</p>
<div class="component-content component"><ul>
<li>OnlineFormatterï¼šåŸºæœ¬ä¸ Java è‡ªå¸¦çš„ SimpleFormatter æ ¼å¼ç›¸åŒï¼Œä¸è¿‡æŠŠæ‰€æœ‰å†…å®¹éƒ½å†™åˆ°äº†ä¸€è¡Œä¸­ã€‚</li>
<li>VerbatimFormatterï¼šåªè®°å½•äº†æ—¥å¿—ä¿¡æ¯ï¼Œæ²¡æœ‰ä»»ä½•é¢å¤–çš„ä¿¡æ¯ã€‚</li>
<li>JdkLoggerFormatterï¼šæ ¼å¼åŒ–äº†ä¸€ä¸ªè½»é‡çº§çš„æ—¥å¿—ä¿¡æ¯ã€‚</li>
</ul></div>
<p class="component-content component"><strong>æ—¥å¿—é…ç½®</strong></p>
<p class="component-content component">Tomcat çš„æ—¥å¿—é…ç½®æ–‡ä»¶ä¸º Tomcat æ–‡ä»¶å¤¹ä¸‹<code>conf/logging.properties</code>ã€‚æˆ‘æ¥æ‹†è§£ä¸€ä¸‹è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œé¦–å…ˆå¯ä»¥çœ‹åˆ°å„ç§ Handler çš„é…ç½®ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>handlers <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>catalina<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">2l</span>ocalhost<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">3</span>manager<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">,</span> <span style="color:#ae81ff">4</span>host<span style="color:#f92672">-</span>manager<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">,</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logging</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ConsoleHandler</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">.</span><span style="color:#a6e22e">handlers</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>catalina<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">,</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logging</span><span style="color:#f92672">.</span><span style="color:#a6e22e">ConsoleHandler</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">ä»¥<code>1catalina.org.apache.juli.AsyncFileHandler</code>ä¸ºä¾‹ï¼Œæ•°å­—æ˜¯ä¸ºäº†åŒºåˆ†åŒä¸€ä¸ªç±»çš„ä¸åŒå®ä¾‹ï¼›catalinaã€localhostã€manager å’Œ host-manager æ˜¯ Tomcat ç”¨æ¥åŒºåˆ†ä¸åŒç³»ç»Ÿæ—¥å¿—çš„æ ‡å¿—ï¼›åé¢çš„å­—ç¬¦ä¸²è¡¨ç¤ºäº† Handler å…·ä½“ç±»å‹ï¼Œå¦‚æœè¦æ·»åŠ  Tomcat æœåŠ¡å™¨çš„è‡ªå®šä¹‰ Handlerï¼Œéœ€è¦åœ¨å­—ç¬¦ä¸²é‡Œæ·»åŠ ã€‚</p>
<p class="component-content component">æ¥ä¸‹æ¥æ˜¯æ¯ä¸ª Handler è®¾ç½®æ—¥å¿—ç­‰çº§ã€ç›®å½•å’Œæ–‡ä»¶å‰ç¼€ï¼Œè‡ªå®šä¹‰çš„ Handler ä¹Ÿè¦åœ¨è¿™é‡Œé…ç½®è¯¦ç»†ä¿¡æ¯:</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ae81ff">1</span>catalina<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">level</span> <span style="color:#f92672">=</span> FINE
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>catalina<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">directory</span> <span style="color:#f92672">=</span> $<span style="color:#f92672">{</span>catalina<span style="color:#f92672">.</span><span style="color:#a6e22e">base</span><span style="color:#f92672">}/</span>logs
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>catalina<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">prefix</span> <span style="color:#f92672">=</span> catalina<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>catalina<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">maxDays</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">90</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>catalina<span style="color:#f92672">.</span><span style="color:#a6e22e">org</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">.</span><span style="color:#a6e22e">juli</span><span style="color:#f92672">.</span><span style="color:#a6e22e">AsyncFileHandler</span><span style="color:#f92672">.</span><span style="color:#a6e22e">encoding</span> <span style="color:#f92672">=</span> UTF<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="tomcat--slf4j--logback" class="pagebody-header">
    Tomcat + SLF4J + Logback
  </h2>
</div><p class="component-content component">åœ¨ä»Šå¤©æ–‡ç« å¼€å¤´æˆ‘æåˆ°ï¼ŒSLF4J å’Œ JCL éƒ½æ˜¯æ—¥å¿—é—¨é¢ï¼Œé‚£å®ƒä»¬æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿå®ƒä»¬çš„åŒºåˆ«ä¸»è¦ä½“ç°åœ¨æ—¥å¿—æœåŠ¡ç±»çš„ç»‘å®šæœºåˆ¶ä¸Šã€‚JCL é‡‡ç”¨è¿è¡Œæ—¶åŠ¨æ€ç»‘å®šçš„æœºåˆ¶ï¼Œåœ¨è¿è¡Œæ—¶åŠ¨æ€å¯»æ‰¾å’ŒåŠ è½½æ—¥å¿—æ¡†æ¶å®ç°ã€‚</p>
<p class="component-content component">SLF4J æ—¥å¿—è¾“å‡ºæœåŠ¡ç»‘å®šåˆ™ç›¸å¯¹ç®€å•å¾ˆå¤šï¼Œåœ¨ç¼–è¯‘æ—¶å°±é™æ€ç»‘å®šæ—¥å¿—æ¡†æ¶ï¼Œåªéœ€è¦æå‰å¼•å…¥éœ€è¦çš„æ—¥å¿—æ¡†æ¶ã€‚å¦å¤– Logback å¯ä»¥è¯´ Log4j çš„è¿›åŒ–ç‰ˆï¼Œåœ¨æ€§èƒ½å’Œå¯ç”¨æ€§æ–¹é¢éƒ½æœ‰æ‰€æå‡ã€‚ä½ å¯ä»¥å‚è€ƒå®˜ç½‘ä¸Šè¿™ç¯‡<a href="https://logback.qos.ch/reasonsToSwitch.html">æ–‡ç« </a>æ¥äº†è§£ Logback çš„ä¼˜åŠ¿ã€‚</p>
<p class="component-content component">åŸºäºæ­¤æˆ‘ä»¬æ¥å®æˆ˜ä¸€ä¸‹å¦‚ä½•å°† Tomcat é»˜è®¤çš„æ—¥å¿—æ¡†æ¶åˆ‡æ¢æˆä¸ºâ€œSLF4J + Logbackâ€ã€‚å…·ä½“çš„æ­¥éª¤æ˜¯ï¼š</p>
<div class="component-content component"><ol>
<li>æ ¹æ®ä½ çš„ Tomcat ç‰ˆæœ¬ï¼Œä»<a href="https://github.com/tomcat-slf4j-logback/tomcat-slf4j-logback/releases">è¿™é‡Œ</a>ä¸‹è½½æ‰€éœ€è¦æ–‡ä»¶ã€‚è§£å‹åä½ ä¼šçœ‹åˆ°ä¸€ä¸ªç±»ä¼¼äº Tomcat ç›®å½•ç»“æ„çš„æ–‡ä»¶å¤¹ã€‚</li>
<li>æ›¿æ¢æˆ–æ‹·è´ä¸‹åˆ—è¿™äº›æ–‡ä»¶åˆ° Tomcat çš„å®‰è£…ç›®å½•ï¼š</li>
</ol></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-0a433623d44f79cea87909db8aa4671c" id="lht0a433623d44f79cea87909db8aa4671c">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/tomcat_jetty/71.jpg" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<ol start="3">
<li>åˆ é™¤<code>&lt;Tomcat&gt;/conf/logging.properties</code></li>
<li>å¯åŠ¨ Tomcat</li>
</ol></div>

<div class="component-content pagebody component">
  <h2 id="æœ¬æœŸç²¾å" class="pagebody-header">
    æœ¬æœŸç²¾å
  </h2>
</div><p class="component-content component">ä»Šå¤©æˆ‘ä»¬è°ˆäº†æ—¥å¿—æ¡†æ¶ä¸æ—¥å¿—é—¨é¢çš„åŒºåˆ«ï¼Œä»¥åŠ Tomcat çš„æ—¥å¿—æ¨¡å—æ˜¯å¦‚ä½•å®ç°çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒTomcat çš„æ—¥å¿—æ¨¡æ¿å«ä½œ JULIï¼ŒJULI çš„æ—¥å¿—é—¨é¢é‡‡ç”¨äº† JCLï¼Œè€Œå…·ä½“å®ç°æ˜¯åŸºäº Java é»˜è®¤çš„æ—¥å¿—æ¡†æ¶ Java Util Loggingï¼ŒTomcat åœ¨ Java Util Logging åŸºç¡€ä¸Šè¿›è¡Œäº†æ”¹é€ ï¼Œä½¿å¾—å®ƒè‡ªèº«çš„æ—¥å¿—æ¡†æ¶ä¸ä¼šå½±å“ Web åº”ç”¨ï¼Œå¹¶ä¸”å¯ä»¥åˆ†æ¨¡æ¿é…ç½®æ—¥å¿—çš„è¾“å‡ºæ–‡ä»¶å’Œæ ¼å¼ã€‚æœ€åæˆ‘åˆ†äº«äº†å¦‚ä½•å°† Tomcat çš„æ—¥å¿—æ¨¡å—åˆ‡æ¢åˆ°æ—¶ä¸‹æµè¡Œçš„â€œSLF4J + Logbackâ€ï¼Œå¸Œæœ›å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚</p>

<div class="component-content pagebody component">
  <h1 id="32--managerç»„ä»¶tomcatçš„sessionç®¡ç†æœºåˆ¶è§£æ" class="pagebody-header">
    32 | Managerç»„ä»¶ï¼šTomcatçš„Sessionç®¡ç†æœºåˆ¶è§£æ
  </h1>
</div><p class="component-content component">æˆ‘ä»¬å¯ä»¥é€šè¿‡ Request å¯¹è±¡çš„ getSession æ–¹æ³•æ¥è·å– Sessionï¼Œå¹¶é€šè¿‡ Session å¯¹è±¡æ¥è¯»å–å’Œå†™å…¥å±æ€§å€¼ã€‚è€Œ Session çš„ç®¡ç†æ˜¯ç”± Web å®¹å™¨æ¥å®Œæˆçš„ï¼Œä¸»è¦æ˜¯å¯¹ Session çš„åˆ›å»ºå’Œé”€æ¯ï¼Œé™¤æ­¤ä¹‹å¤– Web å®¹å™¨è¿˜éœ€è¦å°† Session çŠ¶æ€çš„å˜åŒ–é€šçŸ¥ç»™ç›‘å¬è€…ã€‚</p>
<p class="component-content component">å½“ç„¶ Session ç®¡ç†è¿˜å¯ä»¥äº¤ç»™ Spring æ¥åšï¼Œå¥½å¤„æ˜¯ä¸ç‰¹å®šçš„ Web å®¹å™¨è§£è€¦ï¼ŒSpring Session çš„æ ¸å¿ƒåŸç†æ˜¯é€šè¿‡ Filter æ‹¦æˆª Servlet è¯·æ±‚ï¼Œå°†æ ‡å‡†çš„ ServletRequest åŒ…è£…ä¸€ä¸‹ï¼Œæ¢æˆ Spring çš„ Request å¯¹è±¡ï¼Œè¿™æ ·å½“æˆ‘ä»¬è°ƒç”¨ Request å¯¹è±¡çš„ getSession æ–¹æ³•æ—¶ï¼ŒSpring åœ¨èƒŒåä¸ºæˆ‘ä»¬åˆ›å»ºå’Œç®¡ç† Sessionã€‚</p>
<p class="component-content component">é‚£ä¹ˆ Tomcat çš„ Session ç®¡ç†æœºåˆ¶æˆ‘ä»¬è¿˜éœ€è¦äº†è§£å—ï¼Ÿæˆ‘è§‰å¾—è¿˜æ˜¯æœ‰å¿…è¦ï¼Œå› ä¸ºåªæœ‰äº†è§£è¿™äº›åŸç†ï¼Œæˆ‘ä»¬æ‰èƒ½æ›´å¥½çš„ç†è§£ Spring Sessionï¼Œä»¥åŠ Spring Session ä¸ºä»€ä¹ˆè®¾è®¡æˆè¿™æ ·ã€‚ä»Šå¤©æˆ‘ä»¬å°±ä» Session çš„åˆ›å»ºã€Session çš„æ¸…ç†ä»¥åŠ Session çš„äº‹ä»¶é€šçŸ¥è¿™å‡ ä¸ªæ–¹é¢æ¥äº†è§£ Tomcat çš„ Session ç®¡ç†æœºåˆ¶ã€‚</p>

<div class="component-content pagebody component">
  <h2 id="session-çš„åˆ›å»º" class="pagebody-header">
    Session çš„åˆ›å»º
  </h2>
</div><p class="component-content component">Tomcat ä¸­ä¸»è¦ç”±æ¯ä¸ª Context å®¹å™¨å†…çš„ä¸€ä¸ª Manager å¯¹è±¡æ¥ç®¡ç† Sessionã€‚é»˜è®¤å®ç°ç±»ä¸º StandardManagerã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡å®ƒçš„æ¥å£æ¥äº†è§£ä¸€ä¸‹ StandardManager çš„åŠŸèƒ½ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">Manager</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Context <span style="color:#a6e22e">getContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setContext</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> SessionIdGenerator <span style="color:#a6e22e">getSessionIdGenerator</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setSessionIdGenerator</span><span style="color:#f92672">(</span>SessionIdGenerator sessionIdGenerator<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getSessionCounter</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setSessionCounter</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> sessionCounter<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getMaxActive</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setMaxActive</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> maxActive<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getActiveSessions</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">getExpiredSessions</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setExpiredSessions</span><span style="color:#f92672">(</span><span style="color:#66d9ef">long</span> expiredSessions<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getRejectedSessions</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getSessionMaxAliveTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setSessionMaxAliveTime</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> sessionMaxAliveTime<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getSessionAverageAliveTime</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getSessionCreateRate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getSessionExpireRate</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>Session session<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">changeSessionId</span><span style="color:#f92672">(</span>Session session<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">changeSessionId</span><span style="color:#f92672">(</span>Session session<span style="color:#f92672">,</span> String newId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Session <span style="color:#a6e22e">createEmptySession</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Session <span style="color:#a6e22e">createSession</span><span style="color:#f92672">(</span>String sessionId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Session <span style="color:#a6e22e">findSession</span><span style="color:#f92672">(</span>String id<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Session<span style="color:#f92672">[]</span> <span style="color:#a6e22e">findSessions</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">load</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> ClassNotFoundException<span style="color:#f92672">,</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>Session session<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span>Session session<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> update<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">addPropertyChangeListener</span><span style="color:#f92672">(</span>PropertyChangeListener listener<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">removePropertyChangeListener</span><span style="color:#f92672">(</span>PropertyChangeListener listener<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unload</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">backgroundProcess</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">willAttributeDistribute</span><span style="color:#f92672">(</span>String name<span style="color:#f92672">,</span> Object value<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">ä¸å‡ºæ„å¤–æˆ‘ä»¬åœ¨æ¥å£ä¸­çœ‹åˆ°äº†æ·»åŠ å’Œåˆ é™¤ Session çš„æ–¹æ³•ï¼›å¦å¤–è¿˜æœ‰ load å’Œ unload æ–¹æ³•ï¼Œå®ƒä»¬çš„ä½œç”¨æ˜¯åˆ†åˆ«æ˜¯å°† Session æŒä¹…åŒ–åˆ°å­˜å‚¨ä»‹è´¨å’Œä»å­˜å‚¨ä»‹è´¨åŠ è½½ Sessionã€‚</p>
<p class="component-content component">å½“æˆ‘ä»¬è°ƒç”¨<code>HttpServletRequest.getSession(true)</code>æ—¶ï¼Œè¿™ä¸ªå‚æ•° true çš„æ„æ€æ˜¯â€œå¦‚æœå½“å‰è¯·æ±‚è¿˜æ²¡æœ‰ Sessionï¼Œå°±åˆ›å»ºä¸€ä¸ªæ–°çš„â€ã€‚é‚£ Tomcat åœ¨èƒŒåä¸ºæˆ‘ä»¬åšäº†äº›ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<p class="component-content component">HttpServletRequest æ˜¯ä¸€ä¸ªæ¥å£ï¼ŒTomcat å®ç°äº†è¿™ä¸ªæ¥å£ï¼Œå…·ä½“å®ç°ç±»æ˜¯ï¼š<code>org.apache.catalina.connector.Request</code>ã€‚</p>
<p class="component-content component">ä½†è¿™å¹¶ä¸æ˜¯æˆ‘ä»¬æ‹¿åˆ°çš„ Requestï¼ŒTomcat ä¸ºäº†é¿å…æŠŠä¸€äº›å®ç°ç»†èŠ‚æš´éœ²å‡ºæ¥ï¼Œè¿˜æœ‰åŸºäºå®‰å…¨ä¸Šçš„è€ƒè™‘ï¼Œå®šä¹‰äº† Request çš„åŒ…è£…ç±»ï¼Œå«ä½œ RequestFacadeï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä»£ç æ¥ç†è§£ä¸€ä¸‹ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Request</span> <span style="color:#66d9ef">implements</span> HttpServletRequest <span style="color:#f92672">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">î˜“</span>å¤åˆ¶ä»£ç 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RequestFacade</span> <span style="color:#66d9ef">implements</span> HttpServletRequest <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">protected</span> Request request <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">public</span> HttpSession <span style="color:#a6e22e">getSession</span><span style="color:#f92672">(</span><span style="color:#66d9ef">boolean</span> create<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> request<span style="color:#f92672">.</span><span style="color:#a6e22e">getSession</span><span style="color:#f92672">(</span>create<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">å› æ­¤æˆ‘ä»¬æ‹¿åˆ°çš„ Request ç±»å…¶å®æ˜¯ RequestFacadeï¼ŒRequestFacade çš„ getSession æ–¹æ³•è°ƒç”¨çš„æ˜¯ Request ç±»çš„ getSession æ–¹æ³•ï¼Œæˆ‘ä»¬ç»§ç»­æ¥çœ‹ Session å…·ä½“æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Context context <span style="color:#f92672">=</span> getContext<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>context <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>Manager manager <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getManager</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>manager <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>      
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>session <span style="color:#f92672">=</span> manager<span style="color:#f92672">.</span><span style="color:#a6e22e">createSession</span><span style="color:#f92672">(</span>sessionId<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">access</span><span style="color:#f92672">();</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">ä»ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºï¼ŒRequest å¯¹è±¡ä¸­æŒæœ‰ Context å®¹å™¨å¯¹è±¡ï¼Œè€Œ Context å®¹å™¨æŒæœ‰ Session ç®¡ç†å™¨ Managerï¼Œè¿™æ ·é€šè¿‡ Context ç»„ä»¶å°±èƒ½æ‹¿åˆ° Manager ç»„ä»¶ï¼Œæœ€åç”± Manager ç»„ä»¶æ¥åˆ›å»º Sessionã€‚</p>
<p class="component-content component">å› æ­¤æœ€åè¿˜æ˜¯åˆ°äº† StandardManagerï¼ŒStandardManager çš„çˆ¶ç±»å« ManagerBaseï¼Œè¿™ä¸ª createSession æ–¹æ³•å®šä¹‰åœ¨ ManagerBase ä¸­ï¼ŒStandardManager ç›´æ¥é‡ç”¨è¿™ä¸ªæ–¹æ³•ã€‚</p>
<p class="component-content component">æ¥ç€æˆ‘ä»¬æ¥çœ‹ ManagerBase çš„ createSession æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> Session <span style="color:#a6e22e">createSession</span><span style="color:#f92672">(</span>String sessionId<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é¦–å…ˆåˆ¤æ–­ Session æ•°é‡æ˜¯ä¸æ˜¯åˆ°äº†æœ€å¤§å€¼ï¼Œæœ€å¤§ Session æ•°å¯ä»¥é€šè¿‡å‚æ•°è®¾ç½®
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>maxActiveSessions <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">(</span>getActiveSessions<span style="color:#f92672">()</span> <span style="color:#f92672">&gt;=</span> maxActiveSessions<span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        rejectedSessions<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> TooManyActiveSessionsException<span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>                sm<span style="color:#f92672">.</span><span style="color:#a6e22e">getString</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;managerBase.createSession.ise&#34;</span><span style="color:#f92672">),</span>
</span></span><span style="display:flex;"><span>                maxActiveSessions<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é‡ç”¨æˆ–è€…åˆ›å»ºä¸€ä¸ªæ–°çš„ Session å¯¹è±¡ï¼Œè¯·æ³¨æ„åœ¨ Tomcat ä¸­å°±æ˜¯ StandardSession
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// å®ƒæ˜¯ HttpSession çš„å…·ä½“å®ç°ç±»ï¼Œè€Œ HttpSession æ˜¯ Servlet è§„èŒƒä¸­å®šä¹‰çš„æ¥å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Session session <span style="color:#f92672">=</span> createEmptySession<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// åˆå§‹åŒ–æ–° Session çš„å€¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    session<span style="color:#f92672">.</span><span style="color:#a6e22e">setNew</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span><span style="color:#a6e22e">setValid</span><span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span><span style="color:#a6e22e">setCreationTime</span><span style="color:#f92672">(</span>System<span style="color:#f92672">.</span><span style="color:#a6e22e">currentTimeMillis</span><span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span><span style="color:#a6e22e">setMaxInactiveInterval</span><span style="color:#f92672">(</span>getContext<span style="color:#f92672">().</span><span style="color:#a6e22e">getSessionTimeout</span><span style="color:#f92672">()</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">60</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    String id <span style="color:#f92672">=</span> sessionId<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>id <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        id <span style="color:#f92672">=</span> generateSessionId<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    session<span style="color:#f92672">.</span><span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span><span style="color:#75715e">// è¿™é‡Œä¼šå°† Session æ·»åŠ åˆ° ConcurrentHashMap ä¸­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    sessionCounter<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å°†åˆ›å»ºæ—¶é—´æ·»åŠ åˆ° LinkedList ä¸­ï¼Œå¹¶ä¸”æŠŠæœ€å…ˆæ·»åŠ çš„æ—¶é—´ç§»é™¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#75715e">// ä¸»è¦è¿˜æ˜¯æ–¹ä¾¿æ¸…ç†è¿‡æœŸ Session
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    SessionTiming timing <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SessionTiming<span style="color:#f92672">(</span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">getCreationTime</span><span style="color:#f92672">(),</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span>sessionCreationTiming<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sessionCreationTiming<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>timing<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        sessionCreationTiming<span style="color:#f92672">.</span><span style="color:#a6e22e">poll</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> session
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">åˆ°æ­¤æˆ‘ä»¬æ˜ç™½äº† Session æ˜¯å¦‚ä½•åˆ›å»ºå‡ºæ¥çš„ï¼Œåˆ›å»ºå‡ºæ¥å Session ä¼šè¢«ä¿å­˜åˆ°ä¸€ä¸ª ConcurrentHashMap ä¸­ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Session<span style="color:#f92672">&gt;</span> sessions <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;&gt;();</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">è¯·æ³¨æ„ Session çš„å…·ä½“å®ç°ç±»æ˜¯ StandardSessionï¼ŒStandardSession åŒæ—¶å®ç°äº†<code>javax.servlet.http.HttpSession</code>å’Œ<code>org.apache.catalina.Session</code>æ¥å£ï¼Œå¹¶ä¸”å¯¹ç¨‹åºå‘˜æš´éœ²çš„æ˜¯ StandardSessionFacade å¤–è§‚ç±»ï¼Œä¿è¯äº† StandardSession çš„å®‰å…¨ï¼Œé¿å…äº†ç¨‹åºå‘˜è°ƒç”¨å…¶å†…éƒ¨æ–¹æ³•è¿›è¡Œä¸å½“æ“ä½œã€‚StandardSession çš„æ ¸å¿ƒæˆå‘˜å˜é‡å¦‚ä¸‹ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">StandardSession</span> <span style="color:#66d9ef">implements</span> HttpSession<span style="color:#f92672">,</span> Session<span style="color:#f92672">,</span> Serializable <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> ConcurrentMap<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> attributes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ConcurrentHashMap<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">long</span> creationTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">0L</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">transient</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">boolean</span> expiring <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">transient</span> StandardSessionFacade facade <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> String id <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">long</span> lastAccessedTime <span style="color:#f92672">=</span> creationTime<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">transient</span> ArrayList<span style="color:#f92672">&lt;</span>SessionListener<span style="color:#f92672">&gt;</span> listeners <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">transient</span> Manager manager <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">int</span> maxInactiveInterval <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">boolean</span> isNew <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">volatile</span> <span style="color:#66d9ef">boolean</span> isValid <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">transient</span> Map<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">,</span> Object<span style="color:#f92672">&gt;</span> notes <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Hashtable<span style="color:#f92672">&lt;&gt;();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">transient</span> Principal principal <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="session-çš„æ¸…ç†" class="pagebody-header">
    Session çš„æ¸…ç†
  </h2>
</div><p class="component-content component">æˆ‘ä»¬å†æ¥çœ‹çœ‹ Tomcat æ˜¯å¦‚ä½•æ¸…ç†è¿‡æœŸçš„ Sessionã€‚åœ¨ Tomcat<a href="https://time.geekbang.org/column/article/104423">çƒ­åŠ è½½å’Œçƒ­éƒ¨ç½²</a>çš„æ–‡ç« é‡Œï¼Œæˆ‘è®²åˆ°å®¹å™¨ç»„ä»¶ä¼šå¼€å¯ä¸€ä¸ª ContainerBackgroundProcessor åå°çº¿ç¨‹ï¼Œè°ƒç”¨è‡ªå·±ä»¥åŠå­å®¹å™¨çš„ backgroundProcess è¿›è¡Œä¸€äº›åå°é€»è¾‘çš„å¤„ç†ï¼Œå’Œ Lifecycle ä¸€æ ·ï¼Œè¿™ä¸ªåŠ¨ä½œä¹Ÿæ˜¯å…·æœ‰ä¼ é€’æ€§çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å­å®¹å™¨è¿˜ä¼šæŠŠè¿™ä¸ªåŠ¨ä½œä¼ é€’ç»™è‡ªå·±çš„å­å®¹å™¨ã€‚ä½ å¯ä»¥å‚è€ƒä¸‹å›¾æ¥ç†è§£è¿™ä¸ªè¿‡ç¨‹ã€‚</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-d35e335764c221339391b83c23010127" id="lhtd35e335764c221339391b83c23010127">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/tomcat_jetty/72.jpg" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">å…¶ä¸­çˆ¶å®¹å™¨ä¼šéå†æ‰€æœ‰çš„å­å®¹å™¨å¹¶è°ƒç”¨å…¶ backgroundProcess æ–¹æ³•ï¼Œè€Œ StandardContext é‡å†™äº†è¯¥æ–¹æ³•ï¼Œå®ƒä¼šè°ƒç”¨ StandardManager çš„ backgroundProcess è¿›è€Œå®Œæˆ Session çš„æ¸…ç†å·¥ä½œï¼Œä¸‹é¢æ˜¯ StandardManager çš„ backgroundProcess æ–¹æ³•çš„ä»£ç ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">backgroundProcess</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// processExpiresFrequency é»˜è®¤å€¼ä¸º 6ï¼Œè€Œ backgroundProcess é»˜è®¤æ¯éš” 10s è°ƒç”¨ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´é™¤äº†ä»»åŠ¡æ‰§è¡Œçš„è€—æ—¶ï¼Œæ¯éš” 60s æ‰§è¡Œä¸€æ¬¡
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    count <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">)</span> <span style="color:#f92672">%</span> processExpiresFrequency<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>count <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#75715e">// é»˜è®¤æ¯éš” 60s æ‰§è¡Œä¸€æ¬¡ Session æ¸…ç†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        processExpires<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * å•çº¿ç¨‹å¤„ç†ï¼Œä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">processExpires</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è·å–æ‰€æœ‰çš„ Session
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Session sessions<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> findSessions<span style="color:#f92672">();</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> expireHere <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> sessions<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Session çš„è¿‡æœŸæ˜¯åœ¨ isValid() æ–¹æ³•é‡Œå¤„ç†çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>sessions<span style="color:#f92672">[</span>i<span style="color:#f92672">]!=</span><span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span>sessions<span style="color:#f92672">[</span>i<span style="color:#f92672">].</span><span style="color:#a6e22e">isValid</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            expireHere<span style="color:#f92672">++;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">backgroundProcess ç”± Tomcat åå°çº¿ç¨‹è°ƒç”¨ï¼Œé»˜è®¤æ˜¯æ¯éš” 10 ç§’è°ƒç”¨ä¸€æ¬¡ï¼Œä½†æ˜¯ Session çš„æ¸…ç†åŠ¨ä½œä¸èƒ½å¤ªé¢‘ç¹ï¼Œå› ä¸ºéœ€è¦éå† Session åˆ—è¡¨ï¼Œä¼šè€—è´¹ CPU èµ„æºï¼Œæ‰€ä»¥åœ¨ backgroundProcess æ–¹æ³•ä¸­åšäº†å–æ¨¡å¤„ç†ï¼ŒbackgroundProcess è°ƒç”¨ 6 æ¬¡ï¼Œæ‰æ‰§è¡Œä¸€æ¬¡ Session æ¸…ç†ï¼Œä¹Ÿå°±æ˜¯è¯´ Session æ¸…ç†æ¯ 60 ç§’æ‰§è¡Œä¸€æ¬¡ã€‚</p>

<div class="component-content pagebody component">
  <h2 id="session-äº‹ä»¶é€šçŸ¥" class="pagebody-header">
    Session äº‹ä»¶é€šçŸ¥
  </h2>
</div><p class="component-content component">æŒ‰ç…§ Servlet è§„èŒƒï¼Œåœ¨ Session çš„ç”Ÿå‘½å‘¨æœŸè¿‡ç¨‹ä¸­ï¼Œè¦å°†äº‹ä»¶é€šçŸ¥ç›‘å¬è€…ï¼ŒServlet è§„èŒƒå®šä¹‰äº† Session çš„ç›‘å¬å™¨æ¥å£ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">HttpSessionListener</span> <span style="color:#66d9ef">extends</span> EventListener <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Session åˆ›å»ºæ—¶è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sessionCreated</span><span style="color:#f92672">(</span>HttpSessionEvent se<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//Session é”€æ¯æ—¶è°ƒç”¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">default</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">sessionDestroyed</span><span style="color:#f92672">(</span>HttpSessionEvent se<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">æ³¨æ„åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•çš„å‚æ•°éƒ½æ˜¯ HttpSessionEventï¼Œæ‰€ä»¥ Tomcat éœ€è¦å…ˆåˆ›å»º HttpSessionEvent å¯¹è±¡ï¼Œç„¶åéå† Context å†…éƒ¨çš„ LifecycleListenerï¼Œå¹¶ä¸”åˆ¤æ–­æ˜¯å¦ä¸º HttpSessionListener å®ä¾‹ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™è°ƒç”¨ HttpSessionListener çš„ sessionCreated æ–¹æ³•è¿›è¡Œäº‹ä»¶é€šçŸ¥ã€‚è¿™äº›äº‹æƒ…éƒ½æ˜¯åœ¨ Session çš„ setId æ–¹æ³•ä¸­å®Œæˆçš„ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>session<span style="color:#f92672">.</span><span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span>id<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setId</span><span style="color:#f92672">(</span>String id<span style="color:#f92672">,</span> <span style="color:#66d9ef">boolean</span> notify<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// å¦‚æœè¿™ä¸ª id å·²ç»å­˜åœ¨ï¼Œå…ˆä» Manager ä¸­åˆ é™¤
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span><span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">(</span>manager <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>        manager<span style="color:#f92672">.</span><span style="color:#a6e22e">remove</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">id</span> <span style="color:#f92672">=</span> id<span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// æ·»åŠ æ–°çš„ Session
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>manager <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        manager<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è¿™é‡Œé¢å®Œæˆäº† HttpSessionListener äº‹ä»¶é€šçŸ¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>notify<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        tellNew<span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">ä»ä»£ç æˆ‘ä»¬çœ‹åˆ° setId æ–¹æ³•è°ƒç”¨äº† tellNew æ–¹æ³•ï¼Œé‚£ tellNew åˆæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">tellNew</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// é€šçŸ¥ org.apache.catalina.SessionListener
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    fireSessionEvent<span style="color:#f92672">(</span>Session<span style="color:#f92672">.</span><span style="color:#a6e22e">SESSION_CREATED_EVENT</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// è·å– Context å†…éƒ¨çš„ LifecycleListener å¹¶åˆ¤æ–­æ˜¯å¦ä¸º HttpSessionListener
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    Context context <span style="color:#f92672">=</span> manager<span style="color:#f92672">.</span><span style="color:#a6e22e">getContext</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    Object listeners<span style="color:#f92672">[]</span> <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span><span style="color:#a6e22e">getApplicationLifecycleListeners</span><span style="color:#f92672">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>listeners <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> listeners<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span> <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// åˆ›å»º HttpSessionEvent
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        HttpSessionEvent event <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpSessionEvent<span style="color:#f92672">(</span>getSession<span style="color:#f92672">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> listeners<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// åˆ¤æ–­æ˜¯å¦æ˜¯ HttpSessionListener
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!(</span>listeners<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#66d9ef">instanceof</span> HttpSessionListener<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">continue</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>            HttpSessionListener listener <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>HttpSessionListener<span style="color:#f92672">)</span> listeners<span style="color:#f92672">[</span>i<span style="color:#f92672">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// æ³¨æ„è¿™æ˜¯å®¹å™¨å†…éƒ¨äº‹ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            context<span style="color:#f92672">.</span><span style="color:#a6e22e">fireContainerEvent</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;beforeSessionCreated&#34;</span><span style="color:#f92672">,</span> listener<span style="color:#f92672">);</span>   
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// è§¦å‘ Session Created äº‹ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            listener<span style="color:#f92672">.</span><span style="color:#a6e22e">sessionCreated</span><span style="color:#f92672">(</span>event<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// æ³¨æ„è¿™ä¹Ÿæ˜¯å®¹å™¨å†…éƒ¨äº‹ä»¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            context<span style="color:#f92672">.</span><span style="color:#a6e22e">fireContainerEvent</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;afterSessionCreated&#34;</span><span style="color:#f92672">,</span> listener<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>            
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">ä¸Šé¢ä»£ç çš„é€»è¾‘æ˜¯ï¼Œå…ˆé€šè¿‡ StandardContext å°† HttpSessionListener ç±»å‹çš„ Listener å–å‡ºï¼Œç„¶åä¾æ¬¡è°ƒç”¨å®ƒä»¬çš„ sessionCreated æ–¹æ³•ã€‚</p>

<div class="component-content pagebody component">
  <h2 id="æœ¬æœŸç²¾å-1" class="pagebody-header">
    æœ¬æœŸç²¾å
  </h2>
</div><p class="component-content component">ä»Šå¤©æˆ‘ä»¬ä» Request è°ˆåˆ°äº† Session çš„åˆ›å»ºã€é”€æ¯å’Œäº‹ä»¶é€šçŸ¥ï¼Œé‡Œé¢æ¶‰åŠä¸å°‘ç›¸å…³çš„ç±»ï¼Œä¸‹é¢æˆ‘ç”»äº†ä¸€å¼ å›¾å¸®ä½ ç†è§£å’Œæ¶ˆåŒ–ä¸€ä¸‹è¿™äº›ç±»çš„å…³ç³»ï¼š</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-8365eba347db4de8f4c3f9ff22d82d7a" id="lht8365eba347db4de8f4c3f9ff22d82d7a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/tomcat_jetty/73.jpg" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">Servlet è§„èŒƒä¸­å®šä¹‰äº† HttpServletRequest å’Œ HttpSession æ¥å£ï¼ŒTomcat å®ç°äº†è¿™äº›æ¥å£ï¼Œä½†å…·ä½“å®ç°ç»†èŠ‚å¹¶æ²¡æœ‰æš´éœ²ç»™å¼€å‘è€…ï¼Œå› æ­¤å®šä¹‰äº†ä¸¤ä¸ªåŒ…è£…ç±»ï¼ŒRequestFacade å’Œ StandardSessionFacadeã€‚</p>
<p class="component-content component">Tomcat æ˜¯é€šè¿‡ Manager æ¥ç®¡ç† Session çš„ï¼Œé»˜è®¤å®ç°æ˜¯ StandardManagerã€‚StandardContext æŒæœ‰ StandardManager çš„å®ä¾‹ï¼Œå¹¶å­˜æ”¾äº† HttpSessionListener é›†åˆï¼ŒSession åœ¨åˆ›å»ºå’Œé”€æ¯æ—¶ï¼Œä¼šé€šçŸ¥ç›‘å¬å™¨ã€‚</p>

<div class="component-content pagebody component">
  <h1 id="33--clusterç»„ä»¶tomcatçš„é›†ç¾¤é€šä¿¡åŸç†" class="pagebody-header">
    33 | Clusterç»„ä»¶ï¼šTomcatçš„é›†ç¾¤é€šä¿¡åŸç†
  </h1>
</div><p class="component-content component">ä¸ºäº†æ”¯æŒæ°´å¹³æ‰©å±•å’Œé«˜å¯ç”¨ï¼ŒTomcat æä¾›äº†é›†ç¾¤éƒ¨ç½²çš„èƒ½åŠ›ï¼Œä½†ä¸æ­¤åŒæ—¶ä¹Ÿå¸¦æ¥äº†åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€ä¸ªé€šç”¨é—®é¢˜ï¼Œé‚£å°±æ˜¯å¦‚ä½•åœ¨é›†ç¾¤ä¸­çš„å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ï¼Œæ¯”å¦‚ä¼šè¯ï¼ˆSessionï¼‰ä¿¡æ¯ã€‚</p>
<p class="component-content component">è¦å®ç°è¿™ä¸€ç‚¹ï¼ŒåŸºæœ¬ä¸Šæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯æŠŠæ‰€æœ‰ Session æ•°æ®æ”¾åˆ°ä¸€å°æœåŠ¡å™¨æˆ–è€…ä¸€ä¸ªæ•°æ®åº“ä¸­ï¼Œé›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹é€šè¿‡è®¿é—®è¿™å° Session æœåŠ¡å™¨æ¥è·å–æ•°æ®ã€‚å¦ä¸€ç§æ–¹å¼å°±æ˜¯åœ¨é›†ç¾¤ä¸­çš„èŠ‚ç‚¹é—´è¿›è¡Œ Session æ•°æ®çš„åŒæ­¥æ‹·è´ï¼Œè¿™é‡Œåˆåˆ†ä¸ºä¸¤ç§ç­–ç•¥ï¼šç¬¬ä¸€ç§æ˜¯å°†ä¸€ä¸ªèŠ‚ç‚¹çš„ Session æ‹·è´åˆ°é›†ç¾¤ä¸­å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹ï¼›ç¬¬äºŒç§æ˜¯åªå°†ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„ Session æ•°æ®æ‹·è´åˆ°å¦ä¸€ä¸ªå¤‡ä»½èŠ‚ç‚¹ã€‚</p>
<p class="component-content component">å¯¹äº Tomcat çš„ Session ç®¡ç†æ¥è¯´ï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½æ”¯æŒã€‚ä»Šå¤©æˆ‘ä»¬å°±æ¥çœ‹çœ‹ç¬¬äºŒç§æ–¹å¼çš„å®ç°åŸç†ï¼Œä¹Ÿå°±æ˜¯ Tomcat é›†ç¾¤é€šä¿¡çš„åŸç†å’Œé…ç½®æ–¹æ³•ï¼Œæœ€åé€šè¿‡å®˜ç½‘ä¸Šçš„ä¸€ä¸ªä¾‹å­æ¥äº†è§£ä¸‹ Tomcat é›†ç¾¤åˆ°åº•æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>

<div class="component-content pagebody component">
  <h2 id="é›†ç¾¤é€šä¿¡åŸç†" class="pagebody-header">
    é›†ç¾¤é€šä¿¡åŸç†
  </h2>
</div><p class="component-content component">è¦å®ç°é›†ç¾¤é€šä¿¡ï¼Œé¦–å…ˆè¦çŸ¥é“é›†ç¾¤ä¸­éƒ½æœ‰å“ªäº›æˆå‘˜ã€‚Tomcat æ˜¯é€šè¿‡<strong>ç»„æ’­</strong>ï¼ˆMulticastï¼‰æ¥å®ç°çš„ã€‚é‚£ä»€ä¹ˆæ˜¯ç»„æ’­å‘¢ï¼Ÿä¸ºäº†ç†è§£ç»„æ’­ï¼Œæˆ‘å…ˆæ¥è¯´è¯´ä»€ä¹ˆæ˜¯â€œå•æ’­â€ã€‚ç½‘ç»œèŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡å°±å¥½åƒæ˜¯äººä»¬ä¹‹é—´çš„å¯¹è¯ä¸€æ ·ï¼Œä¸€ä¸ªäººå¯¹å¦å¤–ä¸€ä¸ªäººè¯´è¯ï¼Œæ­¤æ—¶ä¿¡æ¯çš„æ¥æ”¶å’Œä¼ é€’åªåœ¨ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´è¿›è¡Œï¼Œæ¯”å¦‚ä½ åœ¨æ”¶å‘ç”µå­é‚®ä»¶ã€æµè§ˆç½‘é¡µæ—¶ï¼Œä½¿ç”¨çš„å°±æ˜¯å•æ’­ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç†Ÿæ‚‰çš„â€œç‚¹å¯¹ç‚¹é€šä¿¡â€ã€‚</p>
<p class="component-content component">å¦‚æœä¸€å°ä¸»æœºéœ€è¦å°†åŒä¸€ä¸ªæ¶ˆæ¯å‘é€å¤šä¸ªä¸»æœºé€ä¸ªä¼ è¾“ï¼Œæ•ˆç‡å°±ä¼šæ¯”è¾ƒä½ï¼Œäºæ˜¯å°±å‡ºç°ç»„æ’­æŠ€æœ¯ã€‚ç»„æ’­æ˜¯<strong>ä¸€å°ä¸»æœºå‘æŒ‡å®šçš„ä¸€ç»„ä¸»æœºå‘é€æ•°æ®æŠ¥åŒ…</strong>ï¼Œç»„æ’­é€šä¿¡çš„è¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼šæ¯ä¸€ä¸ª Tomcat èŠ‚ç‚¹åœ¨å¯åŠ¨æ—¶å’Œè¿è¡Œæ—¶éƒ½ä¼šå‘¨æœŸæ€§ï¼ˆé»˜è®¤ 500 æ¯«ç§’ï¼‰å‘é€ç»„æ’­å¿ƒè·³åŒ…ï¼ŒåŒä¸€ä¸ªé›†ç¾¤å†…çš„èŠ‚ç‚¹éƒ½åœ¨ç›¸åŒçš„<strong>ç»„æ’­åœ°å€</strong>å’Œ<strong>ç«¯å£</strong>ç›‘å¬è¿™äº›ä¿¡æ¯ï¼›åœ¨ä¸€å®šçš„æ—¶é—´å†…ï¼ˆé»˜è®¤ 3 ç§’ï¼‰ä¸å‘é€<strong>ç»„æ’­æŠ¥æ–‡</strong>çš„èŠ‚ç‚¹å°±ä¼šè¢«è®¤ä¸ºå·²ç»å´©æºƒäº†ï¼Œä¼šä»é›†ç¾¤ä¸­åˆ å»ã€‚å› æ­¤é€šè¿‡ç»„æ’­ï¼Œé›†ç¾¤ä¸­æ¯ä¸ªæˆå‘˜éƒ½èƒ½ç»´æŠ¤ä¸€ä¸ªé›†ç¾¤æˆå‘˜åˆ—è¡¨ã€‚</p>

<div class="component-content pagebody component">
  <h2 id="é›†ç¾¤é€šä¿¡é…ç½®" class="pagebody-header">
    é›†ç¾¤é€šä¿¡é…ç½®
  </h2>
</div><p class="component-content component">æœ‰äº†é›†ç¾¤æˆå‘˜çš„åˆ—è¡¨ï¼Œé›†ç¾¤ä¸­çš„èŠ‚ç‚¹å°±èƒ½é€šè¿‡ TCP è¿æ¥å‘å…¶ä»–èŠ‚ç‚¹ä¼ è¾“ Session æ•°æ®ã€‚Tomcat é€šè¿‡ SimpleTcpCluster ç±»æ¥è¿›è¡Œä¼šè¯å¤åˆ¶ï¼ˆIn-Memory Replicationï¼‰ã€‚è¦å¼€å¯é›†ç¾¤åŠŸèƒ½ï¼Œåªéœ€è¦å°†<code>server.xml</code>é‡Œçš„è¿™ä¸€è¡Œçš„æ³¨é‡Šå»æ‰å°±è¡Œï¼š</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-ac527f2650add1af75167d1fc6d4de0a" id="lhtac527f2650add1af75167d1fc6d4de0a">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/tomcat_jetty/74.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">å˜æˆè¿™æ ·ï¼š</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-d003cfa7e662655edd51b692eaa3e28b" id="lhtd003cfa7e662655edd51b692eaa3e28b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/tomcat_jetty/75.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">è™½ç„¶åªæ˜¯ç®€å•çš„ä¸€è¡Œé…ç½®ï¼Œä½†è¿™ä¸€è¡Œé…ç½®ç­‰åŒäºä¸‹é¢è¿™æ ·çš„é…ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ Tomcat ç»™æˆ‘ä»¬è®¾ç½®äº†å¾ˆå¤šé»˜è®¤å‚æ•°ï¼Œè¿™äº›å‚æ•°éƒ½è·Ÿé›†ç¾¤é€šä¿¡æœ‰å…³ã€‚</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!-- 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  SimpleTcpCluster æ˜¯ç”¨æ¥å¤åˆ¶ Session çš„ç»„ä»¶ã€‚å¤åˆ¶ Session æœ‰åŒæ­¥å’Œå¼‚æ­¥ä¸¤ç§æ–¹å¼ï¼š
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  åŒæ­¥æ¨¡å¼ä¸‹ï¼Œå‘æµè§ˆå™¨çš„å‘é€å“åº”æ•°æ®å‰ï¼Œéœ€è¦å…ˆå°† Session æ‹·è´åˆ°å…¶ä»–èŠ‚ç‚¹å®Œï¼›
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œæ— éœ€ç­‰å¾… Session æ‹·è´å®Œæˆå°±å¯å“åº”ã€‚å¼‚æ­¥æ¨¡å¼æ›´é«˜æ•ˆï¼Œä½†æ˜¯åŒæ­¥æ¨¡å¼
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  å¯é æ€§æ›´é«˜ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  åŒæ­¥å¼‚æ­¥æ¨¡å¼ç”± channelSendOptions å‚æ•°æ§åˆ¶ï¼Œé»˜è®¤å€¼æ˜¯ 8ï¼Œä¸ºå¼‚æ­¥æ¨¡å¼ï¼›4 æ˜¯åŒæ­¥æ¨¡å¼ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  åœ¨å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œå¯ä»¥é€šè¿‡åŠ ä¸Š &#34; æ‹·è´ç¡®è®¤ &#34;ï¼ˆAcknowledgeï¼‰æ¥æé«˜å¯é æ€§ï¼Œæ­¤æ—¶
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  channelSendOptions è®¾ä¸º 10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;Cluster</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.tcp.SimpleTcpCluster&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#a6e22e">channelSendOptions=</span><span style="color:#e6db74">&#34;8&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Manager å†³å®šå¦‚ä½•ç®¡ç†é›†ç¾¤çš„ Session ä¿¡æ¯ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Tomcat æä¾›äº†ä¸¤ç§ Managerï¼šBackupManager å’Œ DeltaManagerã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    BackupManagerï¼é›†ç¾¤ä¸‹çš„æŸä¸€èŠ‚ç‚¹çš„ Sessionï¼Œå°†å¤åˆ¶åˆ°ä¸€ä¸ªå¤‡ä»½èŠ‚ç‚¹ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    DeltaManagerï¼ é›†ç¾¤ä¸‹æŸä¸€èŠ‚ç‚¹çš„ Sessionï¼Œå°†å¤åˆ¶åˆ°æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    DeltaManager æ˜¯ Tomcat é»˜è®¤çš„é›†ç¾¤ Managerã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    expireSessionsOnShutdownï¼è®¾ç½®ä¸º true æ—¶ï¼Œä¸€ä¸ªèŠ‚ç‚¹å…³é—­æ—¶ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    å°†å¯¼è‡´é›†ç¾¤ä¸‹çš„æ‰€æœ‰ Session å¤±æ•ˆ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    notifyListenersOnReplicationï¼é›†ç¾¤ä¸‹èŠ‚ç‚¹é—´çš„ Session å¤åˆ¶ã€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    åˆ é™¤æ“ä½œï¼Œæ˜¯å¦é€šçŸ¥ session listeners
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    maxInactiveIntervalï¼é›†ç¾¤ä¸‹ Session çš„æœ‰æ•ˆæ—¶é—´ (å•ä½:s)ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    maxInactiveInterval å†…æœªæ´»åŠ¨çš„ Sessionï¼Œå°†è¢« Tomcat å›æ”¶ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    é»˜è®¤å€¼ä¸º 1800(30min)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  --&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;Manager</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.session.DeltaManager&#34;</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">expireSessionsOnShutdown=</span><span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">notifyListenersOnReplication=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Channel æ˜¯ Tomcat èŠ‚ç‚¹ä¹‹é—´è¿›è¡Œé€šè®¯çš„å·¥å…·ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Channel åŒ…æ‹¬ 5 ä¸ªç»„ä»¶ï¼šMembershipã€Receiverã€Senderã€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Transportã€Interceptor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">   --&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;Channel</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.group.GroupChannel&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      Membership ç»´æŠ¤é›†ç¾¤çš„å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨ã€‚å®ƒå¯ä»¥æ£€æŸ¥åˆ°æ–°å¢çš„èŠ‚ç‚¹ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      ä¹Ÿå¯ä»¥æ£€æŸ¥æ²¡æœ‰å¿ƒè·³çš„èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      classNameï¼æŒ‡å®š Membership ä½¿ç”¨çš„ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      addressï¼ç»„æ’­åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      portï¼ç»„æ’­ç«¯å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      frequencyï¼å‘é€å¿ƒè·³ (å‘ç»„æ’­åœ°å€å‘é€ UDP æ•°æ®åŒ…) çš„æ—¶é—´é—´éš” (å•ä½:ms)ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      dropTimeï¼Membership åœ¨ dropTime(å•ä½:ms) å†…æœªæ”¶åˆ°æŸä¸€èŠ‚ç‚¹çš„å¿ƒè·³ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      åˆ™å°†è¯¥èŠ‚ç‚¹ä»å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨åˆ é™¤ã€‚é»˜è®¤å€¼ä¸º 3000ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     --&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;Membership</span>  <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.membership.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         McastService&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">address=</span><span style="color:#e6db74">&#34;228.0.0.4&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#34;45564&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">frequency=</span><span style="color:#e6db74">&#34;500&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">dropTime=</span><span style="color:#e6db74">&#34;3000&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       Receiver ç”¨äºå„ä¸ªèŠ‚ç‚¹æ¥æ”¶å…¶ä»–èŠ‚ç‚¹å‘é€çš„æ•°æ®ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       æ¥æ”¶å™¨åˆ†ä¸ºä¸¤ç§ï¼šBioReceiver(é˜»å¡å¼)ã€NioReceiver(éé˜»å¡å¼)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       classNameï¼æŒ‡å®š Receiver ä½¿ç”¨çš„ç±»
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       addressï¼æ¥æ”¶æ¶ˆæ¯çš„åœ°å€
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       portï¼æ¥æ”¶æ¶ˆæ¯çš„ç«¯å£
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       autoBindï¼ç«¯å£çš„å˜åŒ–åŒºé—´ï¼Œå¦‚æœ port ä¸º 4000ï¼ŒautoBind ä¸º 100ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">                 æ¥æ”¶å™¨å°†åœ¨ 4000-4099 é—´å–ä¸€ä¸ªç«¯å£è¿›è¡Œç›‘å¬ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       selectorTimeoutï¼NioReceiver å†… Selector è½®è¯¢çš„è¶…æ—¶æ—¶é—´
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">       maxThreadsï¼çº¿ç¨‹æ± çš„æœ€å¤§çº¿ç¨‹æ•°
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     --&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;Receiver</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.transport.nio.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         NioReceiver&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">address=</span><span style="color:#e6db74">&#34;auto&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#34;4000&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">autoBind=</span><span style="color:#e6db74">&#34;100&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">selectorTimeout=</span><span style="color:#e6db74">&#34;5000&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#a6e22e">maxThreads=</span><span style="color:#e6db74">&#34;6&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         Sender ç”¨äºå‘å…¶ä»–èŠ‚ç‚¹å‘é€æ•°æ®ï¼ŒSender å†…åµŒäº† Transport ç»„ä»¶ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         Transport çœŸæ­£è´Ÿè´£å‘é€æ¶ˆæ¯ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">      --&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&lt;Sender</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.transport.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          ReplicationTransmitter&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            Transport åˆ†ä¸ºä¸¤ç§ï¼šbio.PooledMultiSender(é˜»å¡å¼)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            å’Œ nio.PooledParallelSender(éé˜»å¡å¼)ï¼ŒPooledParallelSender
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            æ˜¯ä» tcp è¿æ¥æ± ä¸­è·å–è¿æ¥ï¼Œå¯ä»¥å®ç°å¹¶è¡Œå‘é€ï¼Œå³é›†ç¾¤ä¸­çš„èŠ‚ç‚¹å¯ä»¥
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">            åŒæ—¶å‘å…¶ä»–æ‰€æœ‰èŠ‚ç‚¹å‘é€æ•°æ®è€Œäº’ä¸å½±å“ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">           --&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;Transport</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          transport.nio.PooledParallelSender&#34;</span><span style="color:#f92672">/&gt;</span>     
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;/Sender&gt;</span>
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         Interceptor : Cluster çš„æ‹¦æˆªå™¨
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         TcpFailureDetectorï¼TcpFailureDetector å¯ä»¥æ‹¦æˆªåˆ°æŸä¸ªèŠ‚ç‚¹å…³é—­
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         çš„ä¿¡æ¯ï¼Œå¹¶å°è¯•é€šè¿‡ TCP è¿æ¥åˆ°æ­¤èŠ‚ç‚¹ï¼Œä»¥ç¡®ä¿æ­¤èŠ‚ç‚¹çœŸæ­£å…³é—­ï¼Œä»è€Œæ›´æ–°é›†
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         ç¾¤å¯ç”¨èŠ‚ç‚¹åˆ—è¡¨                 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        --&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;Interceptor</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.group.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       interceptors.TcpFailureDetector&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>       <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         MessageDispatchInterceptorï¼æŸ¥çœ‹ Cluster ç»„ä»¶å‘é€æ¶ˆæ¯çš„
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         æ–¹å¼æ˜¯å¦è®¾ç½®ä¸º Channel.SEND_OPTIONS_ASYNCHRONOUSï¼Œå¦‚æœæ˜¯ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         MessageDispatchInterceptor å…ˆå°†ç­‰å¾…å‘é€çš„æ¶ˆæ¯è¿›è¡Œæ’é˜Ÿï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         ç„¶åå°†æ’å¥½é˜Ÿçš„æ¶ˆæ¯è½¬ç»™ Senderã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">        --&gt;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">&lt;Interceptor</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.group.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       interceptors.MessageDispatchInterceptor&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;/Channel&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Valve : Tomcat çš„æ‹¦æˆªå™¨ï¼Œ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ReplicationValveï¼åœ¨å¤„ç†è¯·æ±‚å‰åæ‰“æ—¥å¿—ï¼›è¿‡æ»¤ä¸æ¶‰åŠ Session å˜åŒ–çš„è¯·æ±‚ã€‚                 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    --&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;Valve</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.tcp.ReplicationValve&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">filter=</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;Valve</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.session.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  JvmRouteBinderValve&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    Deployer ç”¨äºé›†ç¾¤çš„ farm åŠŸèƒ½ï¼Œç›‘æ§åº”ç”¨ä¸­æ–‡ä»¶çš„æ›´æ–°ï¼Œä»¥ä¿è¯é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    åº”ç”¨çš„ä¸€è‡´æ€§ï¼Œå¦‚æŸä¸ªç”¨æˆ·ä¸Šä¼ æ–‡ä»¶åˆ°é›†ç¾¤ä¸­æŸä¸ªèŠ‚ç‚¹çš„åº”ç”¨ç¨‹åºç›®å½•ä¸‹ï¼ŒDeployer
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ä¼šç›‘æµ‹åˆ°è¿™ä¸€æ“ä½œå¹¶æŠŠæ–‡ä»¶æ‹·è´åˆ°é›†ç¾¤ä¸­å…¶ä»–èŠ‚ç‚¹ç›¸åŒåº”ç”¨çš„å¯¹åº”ç›®å½•ä¸‹ä»¥ä¿æŒ
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    æ‰€æœ‰åº”ç”¨çš„ä¸€è‡´ï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å½“å¼ºå¤§çš„åŠŸèƒ½ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  --&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;Deployer</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.deploy.FarmWarDeployer&#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">tempDir=</span><span style="color:#e6db74">&#34;/tmp/war-temp/&#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">deployDir=</span><span style="color:#e6db74">&#34;/tmp/war-deploy/&#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">watchDir=</span><span style="color:#e6db74">&#34;/tmp/war-listen/&#34;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#a6e22e">watchEnabled=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">&lt;!--
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ClusterListener : ç›‘å¬å™¨ï¼Œç›‘å¬ Cluster ç»„ä»¶æ¥æ”¶çš„æ¶ˆæ¯
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ä½¿ç”¨ DeltaManager æ—¶ï¼ŒCluster æ¥æ”¶çš„ä¿¡æ¯é€šè¿‡ ClusterSessionListener
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ä¼ é€’ç»™ DeltaManagerï¼Œä»è€Œæ›´æ–°è‡ªå·±çš„ Session åˆ—è¡¨ã€‚
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    --&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">&lt;ClusterListener</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.session.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">  ClusterSessionListener&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/Cluster&gt;</span></span></span></code></pre></div></div>
  
</div><p class="component-content component">ä»ä¸Šé¢çš„çš„å‚æ•°åˆ—è¡¨å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤æƒ…å†µä¸‹ Session ç®¡ç†ç»„ä»¶ DeltaManager ä¼šåœ¨èŠ‚ç‚¹ä¹‹é—´æ‹·è´ Sessionï¼ŒDeltaManager é‡‡ç”¨çš„ä¸€ç§ all-to-all çš„å·¥ä½œæ–¹å¼ï¼Œå³é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¼šæŠŠ Session æ•°æ®å‘æ‰€æœ‰å…¶ä»–èŠ‚ç‚¹æ‹·è´ï¼Œè€Œä¸ç®¡å…¶ä»–èŠ‚ç‚¹æ˜¯å¦éƒ¨ç½²äº†å½“å‰åº”ç”¨ã€‚å½“é›†ç¾¤èŠ‚ç‚¹æ•°æ¯”è¾ƒå°‘æ—¶ï¼Œæ¯”å¦‚å°‘äº 4 ä¸ªï¼Œè¿™ç§ all-to-all çš„æ–¹å¼æ˜¯ä¸é”™çš„é€‰æ‹©ï¼›ä½†æ˜¯å½“é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ•°é‡æ¯”è¾ƒå¤šæ—¶ï¼Œæ•°æ®æ‹·è´çš„å¼€é”€æˆæŒ‡æ•°çº§å¢é•¿ï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘ BackupManagerï¼ŒBackupManager åªå‘ä¸€ä¸ªå¤‡ä»½èŠ‚ç‚¹æ‹·è´æ•°æ®ã€‚</p>
<p class="component-content component">åœ¨å¤§ä½“äº†è§£äº† Tomcat é›†ç¾¤å®ç°æ¨¡å‹åï¼Œå°±å¯ä»¥å¯¹é›†ç¾¤ä½œå‡ºæ›´ä¼˜åŒ–çš„é…ç½®äº†ã€‚Tomcat æ¨èäº†ä¸€å¥—é…ç½®ï¼Œä½¿ç”¨äº†æ¯” DeltaManager æ›´é«˜æ•ˆçš„ BackupManagerï¼Œå¹¶ä¸”é€šè¿‡ ReplicationValve è®¾ç½®äº†è¯·æ±‚è¿‡æ»¤ã€‚</p>
<p class="component-content component">è¿™é‡Œè¿˜è¯·æ³¨æ„åœ¨ä¸€å°æœåŠ¡å™¨éƒ¨ç½²å¤šä¸ªèŠ‚ç‚¹æ—¶éœ€è¦ä¿®æ”¹ Receiver çš„ä¾¦å¬ç«¯å£ï¼Œå¦å¤–ä¸ºäº†åœ¨èŠ‚ç‚¹é—´é«˜æ•ˆåœ°æ‹·è´æ•°æ®ï¼Œæ‰€æœ‰ Tomcat èŠ‚ç‚¹æœ€å¥½é‡‡ç”¨ç›¸åŒçš„é…ç½®ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p>
<div class="component-content pagebody component code">
  
  
  
  <div class=""><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;Cluster</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.tcp.SimpleTcpCluster&#34;</span>
</span></span><span style="display:flex;"><span>                 <span style="color:#a6e22e">channelSendOptions=</span><span style="color:#e6db74">&#34;6&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;Manager</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.session.BackupManager&#34;</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">expireSessionsOnShutdown=</span><span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">notifyListenersOnReplication=</span><span style="color:#e6db74">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">mapSendOptions=</span><span style="color:#e6db74">&#34;6&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>         
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;Channel</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.group.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     GroupChannel&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;Membership</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.membership.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     McastService&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">address=</span><span style="color:#e6db74">&#34;228.0.0.4&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#34;45564&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">frequency=</span><span style="color:#e6db74">&#34;500&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">dropTime=</span><span style="color:#e6db74">&#34;3000&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>       
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;Receiver</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.transport.nio.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     NioReceiver&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">address=</span><span style="color:#e6db74">&#34;auto&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">port=</span><span style="color:#e6db74">&#34;5000&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">selectorTimeout=</span><span style="color:#e6db74">&#34;100&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">maxThreads=</span><span style="color:#e6db74">&#34;6&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;Sender</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.transport.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     ReplicationTransmitter&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;Transport</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.transport.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">          nio.PooledParallelSender&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;/Sender&gt;</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;Interceptor</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.group.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     interceptors.TcpFailureDetector&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;Interceptor</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.group.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     interceptors.MessageDispatchInterceptor&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>     
</span></span><span style="display:flex;"><span>     <span style="color:#f92672">&lt;Interceptor</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.tribes.group.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     interceptors.ThroughputInterceptor&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;/Channel&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;Valve</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.tcp.ReplicationValve&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">filter=</span><span style="color:#e6db74">&#34;.*\.gif|.*\.js|.*\.jpeg|.*\.jpg|.*\.png|.*\
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">               .htm|.*\.html|.*\.css|.*\.txt&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">&lt;Deployer</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.deploy.FarmWarDeployer&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">tempDir=</span><span style="color:#e6db74">&#34;/tmp/war-temp/&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">deployDir=</span><span style="color:#e6db74">&#34;/tmp/war-deploy/&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">watchDir=</span><span style="color:#e6db74">&#34;/tmp/war-listen/&#34;</span>
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">watchEnabled=</span><span style="color:#e6db74">&#34;false&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;ClusterListener</span> <span style="color:#a6e22e">className=</span><span style="color:#e6db74">&#34;org.apache.catalina.ha.session.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ClusterSessionListener&#34;</span><span style="color:#f92672">/&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/Cluster&gt;</span></span></span></code></pre></div></div>
  
</div>
<div class="component-content pagebody component">
  <h2 id="é›†ç¾¤å·¥ä½œè¿‡ç¨‹" class="pagebody-header">
    é›†ç¾¤å·¥ä½œè¿‡ç¨‹
  </h2>
</div><p class="component-content component">Tomcat çš„å®˜ç½‘ç»™å‡ºäº†ä¸€ä¸ªä¾‹å­ï¼Œæ¥è¯´æ˜ Tomcat é›†ç¾¤æ¨¡å¼ä¸‹æ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œä»¥åŠ Tomcat é›†ç¾¤æ˜¯å¦‚ä½•å®ç°é«˜å¯ç”¨çš„ã€‚æ¯”å¦‚é›†ç¾¤ç”± Tomcat A å’Œ Tomcat B ä¸¤ä¸ª Tomcat å®ä¾‹ç»„æˆï¼ŒæŒ‰ç…§æ—¶é—´å…ˆåé¡ºåºå‘ç”Ÿäº†å¦‚ä¸‹äº‹ä»¶ï¼š</p>
<p class="component-content component"><strong>1. Tomcat A å¯åŠ¨</strong></p>
<p class="component-content component">Tomcat A å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œå½“ Host å¯¹è±¡è¢«åˆ›å»ºæ—¶ï¼Œä¸€ä¸ª Cluster ç»„ä»¶ï¼ˆé»˜è®¤æ˜¯ SimpleTcpClusterï¼‰è¢«å…³è”åˆ°è¿™ä¸ª Host å¯¹è±¡ã€‚å½“æŸä¸ªåº”ç”¨åœ¨<code>web.xml</code>ä¸­è®¾ç½®äº† Distributable æ—¶ï¼ŒTomcat å°†ä¸ºæ­¤åº”ç”¨çš„ä¸Šä¸‹æ–‡ç¯å¢ƒåˆ›å»ºä¸€ä¸ª DeltaManagerã€‚SimpleTcpCluster å¯åŠ¨ Membership æœåŠ¡å’Œ Replication æœåŠ¡ã€‚</p>
<p class="component-content component"><strong>2. Tomcat B å¯åŠ¨ï¼ˆåœ¨ Tomcat A ä¹‹åå¯åŠ¨ï¼‰</strong></p>
<p class="component-content component">é¦–å…ˆ Tomcat B ä¼šæ‰§è¡Œå’Œ Tomcat A ä¸€æ ·çš„æ“ä½œï¼Œç„¶å SimpleTcpCluster ä¼šå»ºç«‹ä¸€ä¸ªç”± Tomcat A å’Œ Tomcat B ç»„æˆçš„ Membershipã€‚æ¥ç€ Tomcat B å‘é›†ç¾¤ä¸­çš„ Tomcat A è¯·æ±‚ Session æ•°æ®ï¼Œå¦‚æœ Tomcat A æ²¡æœ‰å“åº” Tomcat B çš„æ‹·è´è¯·æ±‚ï¼ŒTomcat B ä¼šåœ¨ 60 ç§’å time outã€‚åœ¨ Session æ•°æ®æ‹·è´å®Œæˆä¹‹å‰ Tomcat B ä¸ä¼šæ¥æ”¶æµè§ˆå™¨çš„è¯·æ±‚ã€‚</p>
<p class="component-content component"><strong>3. Tomcat A æ¥æ”¶ HTTP è¯·æ±‚ï¼Œåˆ›å»º Session 1</strong></p>
<p class="component-content component">Tomcat A å“åº”å®¢æˆ·è¯·æ±‚ï¼Œåœ¨æŠŠç»“æœå‘é€å›å®¢æˆ·ç«¯ä¹‹å‰ï¼ŒReplicationValve ä¼šæ‹¦æˆªå½“å‰è¯·æ±‚ï¼ˆå¦‚æœ Filter ä¸­é…ç½®äº†ä¸éœ€æ‹¦æˆªçš„è¯·æ±‚ç±»å‹ï¼Œè¿™ä¸€æ­¥å°±ä¸ä¼šè¿›è¡Œï¼Œé»˜è®¤é…ç½®ä¸‹æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼‰ï¼Œå¦‚æœå‘ç°å½“å‰è¯·æ±‚æ›´æ–°äº† Sessionï¼Œå°±è°ƒç”¨ Replication æœåŠ¡å»ºç«‹ TCP è¿æ¥å°† Session æ‹·è´åˆ° Membership åˆ—è¡¨ä¸­çš„å…¶ä»–èŠ‚ç‚¹å³ Tomcat Bã€‚åœ¨æ‹·è´æ—¶ï¼Œæ‰€æœ‰ä¿å­˜åœ¨å½“å‰ Session ä¸­çš„å¯åºåˆ—åŒ–çš„å¯¹è±¡éƒ½ä¼šè¢«æ‹·è´ï¼Œè€Œä¸ä»…ä»…æ˜¯å‘ç”Ÿæ›´æ–°çš„éƒ¨åˆ†ã€‚</p>
<p class="component-content component"><strong>4. Tomcat A å´©æºƒ</strong></p>
<p class="component-content component">å½“ Tomcat A å´©æºƒæ—¶ï¼ŒTomcat B ä¼šè¢«å‘ŠçŸ¥ Tomcat A å·²ä»é›†ç¾¤ä¸­é€€å‡ºï¼Œç„¶å Tomcat B å°±ä¼šæŠŠ Tomcat A ä»è‡ªå·±çš„ Membership åˆ—è¡¨ä¸­åˆ é™¤ã€‚å¹¶ä¸” Tomcat B çš„ Session æ›´æ–°æ—¶ä¸å†å¾€ Tomcat A æ‹·è´ï¼ŒåŒæ—¶è´Ÿè½½å‡è¡¡å™¨ä¼šæŠŠåç»­çš„ HTTP è¯·æ±‚å…¨éƒ¨è½¬å‘ç»™ Tomcat Bã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­æ‰€æœ‰çš„ Session æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚</p>
<p class="component-content component"><strong>5. Tomcat B æ¥æ”¶ Tomcat A çš„è¯·æ±‚</strong></p>
<p class="component-content component">Tomcat B æ­£å¸¸å“åº”æœ¬åº”è¯¥å‘å¾€ Tomcat A çš„è¯·æ±‚ï¼Œå› ä¸º Tomcat B ä¿å­˜äº† Tomcat A çš„æ‰€æœ‰ Session æ•°æ®ã€‚</p>
<p class="component-content component"><strong>6. Tomcat A é‡æ–°å¯åŠ¨</strong></p>
<p class="component-content component">Tomcat A æŒ‰æ­¥éª¤ 1ã€2 æ“ä½œå¯åŠ¨ï¼ŒåŠ å…¥é›†ç¾¤ï¼Œå¹¶ä» Tomcat B æ‹·è´æ‰€æœ‰ Session æ•°æ®ï¼Œæ‹·è´å®Œæˆåå¼€å§‹æ¥æ”¶è¯·æ±‚ã€‚</p>
<p class="component-content component"><strong>7. Tomcat A æ¥æ”¶è¯·æ±‚ï¼ŒSession 1 è¢«ç”¨æˆ·æ³¨é”€</strong></p>
<p class="component-content component">Tomcat ç»§ç»­æ¥æ”¶å‘å¾€ Tomcat A çš„è¯·æ±‚ï¼ŒSession 1 è®¾ç½®ä¸ºå¤±æ•ˆã€‚è¯·æ³¨æ„è¿™é‡Œçš„å¤±æ•ˆå¹¶éå› ä¸º Tomcat A å¤„äºéæ´»åŠ¨çŠ¶æ€è¶…è¿‡è®¾ç½®çš„æ—¶é—´ï¼Œè€Œæ˜¯åº”ç”¨ç¨‹åºæ‰§è¡Œäº†æ³¨é”€çš„æ“ä½œï¼ˆæ¯”å¦‚ç”¨æˆ·ç™»å‡ºï¼‰è€Œå¼•èµ·çš„ Session å¤±æ•ˆã€‚è¿™æ—¶ Tomcat A å‘ Tomcat B å‘é€ä¸€ä¸ª Session 1 Expired çš„æ¶ˆæ¯ï¼ŒTomcat B æ”¶åˆ°æ¶ˆæ¯åä¹Ÿä¼šæŠŠ Session 1 è®¾ç½®ä¸ºå¤±æ•ˆã€‚</p>
<p class="component-content component"><strong>8. Tomcat B æ¥æ”¶åˆ°ä¸€ä¸ªæ–°è¯·æ±‚ï¼Œåˆ›å»º Session 2</strong></p>
<p class="component-content component">åŒç†è¿™ä¸ªæ–°çš„ Session ä¹Ÿä¼šè¢«æ‹·è´åˆ° Tomcat Aã€‚</p>
<p class="component-content component"><strong>9. Tomcat A ä¸Šçš„ Session 2 è¿‡æœŸ</strong></p>
<p class="component-content component">å› è¶…æ—¶åŸå› å¼•èµ·çš„ Session å¤±æ•ˆ Tomcat A æ— éœ€é€šçŸ¥ Tomcat Bï¼ŒTomcat B åŒæ ·çŸ¥é“ Session 2 å·²ç»è¶…æ—¶ã€‚å› æ­¤å¯¹äº Tomcat é›†ç¾¤æœ‰ä¸€ç‚¹éå¸¸é‡è¦ï¼Œ<strong>æ‰€æœ‰èŠ‚ç‚¹çš„æ“ä½œç³»ç»Ÿæ—¶é—´å¿…é¡»ä¸€è‡´</strong>ã€‚ä¸ç„¶ä¼šå‡ºç°æŸä¸ªèŠ‚ç‚¹ Session å·²è¿‡æœŸè€Œåœ¨å¦ä¸€èŠ‚ç‚¹æ­¤ Session ä»å¤„äºæ´»åŠ¨çŠ¶æ€çš„ç°è±¡ã€‚</p>

<div class="component-content pagebody component">
  <h2 id="æœ¬æœŸç²¾å-2" class="pagebody-header">
    æœ¬æœŸç²¾å
  </h2>
</div><p class="component-content component">ä»Šå¤©æˆ‘è°ˆäº† Tomcat çš„é›†ç¾¤å·¥ä½œåŸç†å’Œé…ç½®æ–¹å¼ï¼Œè¿˜é€šè¿‡å®˜ç½‘ä¸Šçš„ä¸€ä¸ªä¾‹å­è¯´æ˜äº† Tomcat é›†ç¾¤çš„å·¥ä½œè¿‡ç¨‹ã€‚Tomcat é›†ç¾¤å¯¹ Session çš„æ‹·è´æ”¯æŒä¸¤ç§æ–¹å¼ï¼šDeltaManager å’Œ BackupManagerã€‚</p>
<p class="component-content component">å½“é›†ç¾¤ä¸­èŠ‚ç‚¹æ¯”è¾ƒå°‘æ—¶ï¼Œå¯ä»¥é‡‡ç”¨ DeltaManagerï¼Œå› ä¸º Session æ•°æ®åœ¨é›†ç¾¤ä¸­å„ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¤‡ä»½ï¼Œä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹å´©æºƒéƒ½ä¸ä¼šå¯¹æ•´ä½“é€ æˆå½±å“ï¼Œå¯é æ€§æ¯”è¾ƒé«˜ã€‚</p>
<p class="component-content component">å½“é›†ç¾¤ä¸­èŠ‚ç‚¹æ•°æ¯”è¾ƒå¤šæ—¶ï¼Œå¯ä»¥é‡‡ç”¨ BackupManagerï¼Œè¿™æ˜¯å› ä¸ºä¸€ä¸ªèŠ‚ç‚¹çš„ Session åªä¼šæ‹·è´åˆ°å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ•°æ®æ‹·è´çš„å¼€é”€æ¯”è¾ƒå°‘ï¼ŒåŒæ—¶åªè¦è¿™ä¸¤ä¸ªèŠ‚ç‚¹ä¸åŒæ—¶å´©æºƒï¼ŒSession æ•°æ®å°±ä¸ä¼šä¸¢å¤±ã€‚</p>

<div class="component-content pagebody component">
  <h1 id="ç‰¹åˆ«æ”¾é€--å¦‚ä½•æŒç»­ä¿æŒå¯¹å­¦ä¹ çš„å…´è¶£" class="pagebody-header">
    ç‰¹åˆ«æ”¾é€ | å¦‚ä½•æŒç»­ä¿æŒå¯¹å­¦ä¹ çš„å…´è¶£ï¼Ÿ
  </h1>
</div><p class="component-content component">ä½ å¥½ï¼Œæˆ‘æ˜¯æå·åŒã€‚ä»Šå¤©æˆ‘ä»¬æŠ›å¼€æŠ€æœ¯æœ¬èº«çš„å†…å®¹ï¼Œæ¥èŠèŠä¸“æ æˆ–è€…ä¸€é—¨æ–°æŠ€æœ¯çš„å­¦ä¹ æ–¹æ³•ï¼Œæˆ‘ä¹Ÿåˆ†äº«ä¸€ä¸‹è‡ªå·±æ˜¯å¦‚ä½•å•ƒä¸‹ Tomcat å’Œ Jetty æºç çš„ã€‚</p>
<p class="component-content component">ä¸“æ å¦‚ä»Šå·²ç»æ›´æ–°å®Œäº†äº”ä¸ªæ¨¡å—ï¼Œæˆ‘ä»¬å­¦ä¹ äº† Tomcat å’Œ Jetty çš„æ•´ä½“æ¶æ„ã€è¿æ¥å™¨ã€å®¹å™¨å’Œé€šç”¨ç»„ä»¶ï¼Œè¿™äº›å†…å®¹å¯ä»¥è¯´æ˜¯ Tomcat å’Œ Jetty çš„è®¾è®¡æ ¸å¿ƒã€‚åœ¨æ—¥å¸¸å·¥ä½œçš„ä½¿ç”¨ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ°äº† Tomcat å’Œ Jetty æä¾›çš„åŠŸèƒ½ï¼Œæˆ‘å¸Œæœ›é€šè¿‡å­¦ä¹ ä¸“æ ï¼Œè¿˜èƒ½å¸®ä½ äº†è§£è¿™äº›åŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„ï¼Œä»¥åŠ Tomcat å’Œ Jetty åœ¨è®¾è®¡æ—¶éƒ½è€ƒè™‘äº†å“ªäº›åœ°æ–¹ã€‚</p>
<p class="component-content component">æ‰€ä»¥åœ¨å­¦ä¹ ä¸“æ æ—¶ï¼Œä½ ä¸å¦¨æ€è€ƒè¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œå‡å¦‚è®©ä½ æ¥è®¾è®¡å¹¶å®ç°ä¸€ä¸ª Web å®¹å™¨ï¼Œä½ ä¼šæ€ä¹ˆåšå‘¢ï¼Ÿå¦‚ä½•åˆç†è®¾è®¡é¡¶å±‚æ¨¡å—ï¼Ÿå¦‚ä½•è€ƒè™‘æ–¹æ–¹é¢é¢çš„éœ€æ±‚ï¼Œæ¯”å¦‚æœ€åŸºæœ¬çš„åŠŸèƒ½éœ€æ±‚æ˜¯åŠ è½½å’Œè¿è¡Œ Web ç¨‹åºï¼Œæœ€é‡è¦çš„éåŠŸèƒ½éœ€æ±‚æ˜¯é«˜æ€§èƒ½ã€é«˜å¹¶å‘ã€‚ä½ å¯ä»¥é¡ºç€è¿™ä¸¤æ¡çº¿å…ˆæ€è€ƒä¸‹ä½ ä¼šæ€ä¹ˆåšï¼Œç„¶åå†å›è¿‡å¤´æ¥çœ‹çœ‹ Tomcat å’Œ Jetty æ˜¯å¦‚ä½•åšåˆ°çš„ã€‚è¿™æ ·çš„å­¦ä¹ æ–¹æ³•å…¶å®å°±åœ¨æœ‰æ„è¯†åœ°è®­ç»ƒè‡ªå·±ç‹¬ç«‹è®¾è®¡ä¸€ä¸ªç³»ç»Ÿçš„èƒ½åŠ›ï¼Œä¸ç®¡æ˜¯å¯¹äºå­¦ä¹ è¿™ä¸ªä¸“æ è¿˜æ˜¯å…¶ä»–æŠ€æœ¯ï¼Œå¸¦ç€é—®é¢˜å†å»å­¦ä¹ éƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚</p>
<p class="component-content component">è¯´å®Œå…³äºä¸“æ çš„å­¦ä¹ æ–¹æ³•ï¼Œä¸‹é¢æˆ‘å¿…é¡»è¦é¼“åŠ±ä¸€ä¸‹åšæŒå­¦ä¹ åˆ°ç°åœ¨çš„ä½ ã€‚ä¸“æ ä»ç¬¬ä¸‰æ¨¡å—å¼€å§‹ï¼Œå¼€å§‹è®²è§£è¿æ¥å™¨ã€å®¹å™¨å’Œé€šç”¨ç»„ä»¶çš„è®¾è®¡å’ŒåŸç†ï¼Œæœ‰äº›å†…å®¹å¯èƒ½æ¯”è¾ƒåå‘åº•å±‚ï¼Œç¡®å®éš¾åº¦æ¯”è¾ƒå¤§ï¼Œå¦‚æœå¯¹åº•å±‚æºç ä¸ç†Ÿæ‚‰æˆ–è€…ä¸æ„Ÿå…´è¶£ï¼Œå­¦ä¹ èµ·æ¥ä¼šæœ‰äº›ç—›è‹¦ã€‚ä½†æ˜¯ï¼Œæˆ‘ä¹‹æ‰€ä»¥è®¾è®¡äº†è¿™éƒ¨åˆ†å†…å®¹ï¼Œå°±æ˜¯å¸Œæœ›èƒ½å¤Ÿæ­å¼€ Tomcat å’Œ Jetty çš„å†…éƒ¨ç»†èŠ‚ï¼Œå› ä¸ºä»»ä½•ä¸€ä¸ªä¼˜ç§€çš„ä¸­é—´ä»¶ä¹‹æ‰€ä»¥å¯ä»¥è®©ç”¨æˆ·ä½¿ç”¨æ¯”è¾ƒå®¹æ˜“ï¼Œå…¶å†…éƒ¨ä¸€å®šéƒ½æ˜¯å¾ˆå¤æ‚çš„ã€‚è¿™ä¹Ÿä»ä¾§é¢ä¼ é€’å‡ºä¸€ä¸ªä¿¡å·ï¼šç¾å¥½çš„ä¸œè¥¿éƒ½æ˜¯æœ‰ä»£ä»·çš„ï¼Œéœ€è¦ä¹Ÿå€¼å¾—æˆ‘ä»¬å»ä»˜å‡ºæ—¶é—´å’Œç²¾åŠ›ã€‚</p>
<p class="component-content component">æˆ‘å’Œä½ ä¸€æ ·æˆ‘ä»¬éƒ½èº«å¤„ IT è¡Œä¸šï¼Œè¿™ä¸ªè¡Œä¸šæŠ€æœ¯æ›´æ–°è¿­ä»£éå¸¸å¿«ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä»¥ä¸€ä¸ªå¼€æ”¾çš„å¿ƒæ€æŒç»­å­¦ä¹ ã€‚è€Œå­¦ä¹ æ°æ°åˆæ˜¯ä¸€ä¸ªåäººæ€§çš„è¿‡ç¨‹ï¼Œç”šè‡³æ˜¯æ¯”è¾ƒç—›è‹¦çš„ï¼Œå°¤å…¶æ˜¯æœ‰äº›æŠ€æœ¯æ¡†æ¶æœ¬èº«æ¯”è¾ƒåºå¤§ï¼Œè®¾è®¡å¾—éå¸¸å¤æ‚ï¼Œæˆ‘ä»¬åœ¨å­¦ä¹ åˆæœŸå¾ˆå®¹æ˜“é‡åˆ°â€œæŒ«æŠ˜æ„Ÿâ€ï¼Œä¸€äº›æŠ€æœ¯ç‚¹æ€ä¹ˆæƒ³ä¹Ÿæƒ³ä¸æ˜ç™½ï¼Œå¾€å¾€ä¹Ÿä¼šæœ‰æ”¾å¼ƒçš„æƒ³æ³•ã€‚æˆ‘åŒæ ·ç»å†è¿‡è¿™ä¸ªè¿‡ç¨‹ï¼Œ<strong>æˆ‘çš„ç»éªŒæ˜¯æ‰¾åˆ°é€‚åˆè‡ªå·±çš„å­¦ä¹ æ–¹æ³•éå¸¸é‡è¦ï¼ŒåŒæ ·å…³é”®çš„æ˜¯è¦ä¿æŒå­¦ä¹ çš„å…´è¶£å’ŒåŠ¨åŠ›</strong>ã€‚</p>
<p class="component-content component">ä¸¾ä¸ªæˆ‘å­¦ä¹  Spring æ¡†æ¶çš„ä¾‹å­ï¼Œè®°å¾—å½“æ—¶æˆ‘åœ¨æ¥è§¦ Spring æ¡†æ¶çš„æ—¶å€™ï¼Œä¸€å¼€å§‹å°±é’»è¿›ä¸€ä¸ªæ¨¡å—å¼€å§‹å•ƒèµ·äº†æºä»£ç ã€‚ç”±äº Spring æ¡†æ¶æœ¬èº«æ¯”è¾ƒåºæ‚ï¼Œåˆ†å¾ˆå¤šæ¨¡å—ï¼Œå½“æ—¶ç»™æˆ‘æœ€ç›´è§‚çš„æ„Ÿå—å°±æ˜¯çœ‹ä¸æ‡‚ï¼Œæˆ‘ä¸æ˜ç™½ä»£ç ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Œä¸ºä»€ä¹ˆè®¾è®¡å¾—è¿™ä¹ˆâ€œç»•â€ã€‚è¿™é‡Œé¢çš„é—®é¢˜æ˜¯ï¼Œé¦–å…ˆ<strong>æˆ‘è¿˜æ²¡å¼„æ¸…æ¥šæ£®æ—é•¿ä»€ä¹ˆæ ·å­ï¼Œå°±ç›¯ç€æ ‘å¶çœ‹</strong>ï¼Œå¾ˆå¯èƒ½æ˜¯ç›²äººæ‘¸è±¡ï¼Œçœ‹ä¸åˆ°å…¨è²Œå’Œæ•´ä½“çš„è®¾è®¡æ€è·¯ã€‚ç¬¬äºŒä¸ªé—®é¢˜æ˜¯æˆ‘è¿˜æ²¡å­¦ä¼šç”¨ Springï¼Œå°±å¼€å§‹ç ”ç©¶å®ƒæ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Œç»“æœå¯æƒ³è€ŒçŸ¥ï¼Œä¹Ÿé‡åˆ°äº†æŒ«æŠ˜ã€‚åæ¥æˆ‘é€æ¸æ€»ç»“å‡ºä¸€äº›å­¦ä¹ æ–°æŠ€æœ¯çš„å°ç»éªŒï¼šåœ¨å­¦ä¹ ä¸€é—¨æŠ€æœ¯çš„æ—¶å€™ï¼Œä¸€å®šè¦å…ˆçœ‹æ¸…å®ƒçš„å…¨è²Œï¼Œæˆ‘æ¨èå…ˆçœ‹å®˜æ–¹æ–‡æ¡£ï¼Œçœ‹çœ‹éƒ½æœ‰å“ªäº›æ¨¡å—ã€æ•´ä½“ä¸Šæ˜¯å¦‚ä½•è®¾è®¡çš„ã€‚æ¥ç€æˆ‘ä»¬å…ˆä¸è¦ç›´æ¥çœ‹æºç ï¼Œè€Œæ˜¯è¦åŠ¨æ‰‹è·‘ä¸€è·‘å®˜ç½‘ä¸Šçš„ä¾‹å­ï¼Œæˆ–è€…ç”¨è¿™ä¸ªæ¡†æ¶å®ç°ä¸€ä¸ªå°ç³»ç»Ÿï¼Œå…³é”®æ˜¯è¦å­¦ä¼šæ€ä¹ˆä½¿ç”¨ã€‚åªæœ‰åœ¨è¿™ä¸ªåŸºç¡€ä¸Šï¼Œæ‰èƒ½æ·±å…¥åˆ°ç‰¹å®šæ¨¡å—ï¼Œå»ç ”ç©¶è®¾è®¡æ€è·¯ï¼Œæˆ–è€…æ·±å…¥åˆ°æŸä¸€æ¨¡å—æºç ä¹‹ä¸­ã€‚è¿™æ ·åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼ŒæŒ‰ç…§ä¸€å®šçš„é¡ºåºä¸€æ­¥ä¸€æ­¥æ¥ï¼Œå°±èƒ½å¤Ÿå³æ—¶è·å¾—<strong>æˆå°±æ„Ÿ</strong>ï¼Œæœ‰äº†æˆå°±æ„Ÿä½ æ‰ä¼šæ›´åŠ ä¸“æ³¨ï¼Œæ‰ä¼šæ„¿æ„èŠ±æ›´å¤šæ—¶é—´å’Œç²¾åŠ›å»æ·±å…¥ç ”ç©¶ã€‚å› æ­¤è¦ä¿æŒå­¦ä¹ çš„å…´è¶£ï¼Œæˆ‘è§‰å¾—æœ‰ä¸¤ä¸ªæ–¹é¢æ¯”è¾ƒé‡è¦ï¼š</p>
<p class="component-content component">ç¬¬ä¸€ä¸ªæ˜¯æˆ‘ä»¬éœ€è¦<strong>å¸¦ç€æ˜ç¡®çš„ç›®æ ‡å»å­¦ä¹ </strong>ã€‚æ¯”å¦‚æŸäº›çŸ¥è¯†ç‚¹æ˜¯é¢è¯•çš„çƒ­ç‚¹ï¼Œé‚£å­¦ä¹ ç›®æ ‡å°±æ˜¯å½»åº•ç†è§£å’ŒæŒæ¡å®ƒï¼Œå½“è¢«é—®åˆ°ç›¸å…³é—®é¢˜æ—¶ï¼Œä½ çš„å›ç­”èƒ½å¤Ÿä½¿å¾—é¢è¯•å®˜å¯¹ä½ åˆ®ç›®ç›¸çœ‹ï¼Œæœ‰æ—¶å€™å¾€å¾€å‡­ç€æŸä¸€ä¸ªäº®ç‚¹å°±èƒ½å½±å“æœ€åçš„å½•ç”¨ç»“æœã€‚å†æ¯”å¦‚ä½ æƒ³æŒæ¡ä¸€é—¨æ–°æŠ€æœ¯æ¥è§£å†³å·¥ä½œä¸Šçš„é—®é¢˜ï¼Œé‚£ä½ çš„å­¦ä¹ ç›®æ ‡åº”è¯¥æ˜¯ä¸ä½†è¦æŒæ¡æ¸…æ¥šåŸç†ï¼Œè¿˜è¦èƒ½çœŸæ­£çš„å°†æ–°æŠ€æœ¯åˆç†è¿ç”¨åˆ°å®é™…å·¥ä½œä¸­ï¼Œè§£å†³å®é™…é—®é¢˜ï¼Œäº§ç”Ÿå®é™…æ•ˆæœã€‚æˆ‘ä»¬å­¦ä¹ äº† Tomcat å’Œ Jetty çš„è´£ä»»é“¾æ¨¡å¼ï¼Œæ˜¯ä¸æ˜¯åœ¨å®é™…é¡¹ç›®ä¸­çš„ä¸€äº›åœºæ™¯ä¸‹å°±å¯ä»¥ç”¨åˆ°è¿™ç§è®¾è®¡å‘¢ï¼Ÿå†æ¯”å¦‚å­¦ä¹ äº†è°ƒä¼˜æ–¹æ³•ï¼Œæ˜¯ä¸æ˜¯å¯ä»¥åœ¨ç”Ÿäº§ç¯å¢ƒé‡Œè§£å†³æ€§èƒ½é—®é¢˜å‘¢ï¼Ÿæ€»ä¹‹æŠ€æœ¯éœ€è¦å˜ç°æ‰æœ‰å­¦ä¹ åŠ¨åŠ›ã€‚</p>
<p class="component-content component">ç¬¬äºŒä¸ªæ˜¯<strong>ä¸€å®šè¦åŠ¨æ‰‹å®è·µ</strong>ã€‚åªæœ‰åŠ¨æ‰‹å®è·µæ‰ä¼šè®©æˆ‘ä»¬å¯¹æŠ€æœ¯æœ‰æœ€ç›´è§‚çš„æ„Ÿå—ã€‚æœ‰æ—¶å€™æˆ‘ä»¬å¬åˆ«äººè®²ç»éªŒå’Œç†è®ºï¼Œæ„Ÿè§‰ä¼¼ä¹æ‡‚äº†ï¼Œä½†æ˜¯è¿‡ä¸€æ®µæ—¶é—´ä¾¿åˆå¿˜è®°äº†ã€‚å¦‚æœæˆ‘ä»¬åŠ¨æ‰‹å®è·µäº†ï¼Œç‰¹åˆ«æ˜¯åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ç¢°åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œé€šè¿‡ç½‘ä¸ŠæŸ¥æ‰¾èµ„æ–™ï¼Œæˆ–è€…è·ŸåŒäº‹è®¨è®ºè§£å†³äº†é—®é¢˜ï¼Œè¿™ä¾¿æ˜¯ä½ ç§¯ç´¯çš„å®è´µç»éªŒï¼Œæƒ³å¿˜è®°éƒ½éš¾ã€‚å¦å¤–é€‚å½“çš„åŠ¨æ‰‹å®è·µèƒ½å¤Ÿæ ‘ç«‹èµ·ä¿¡å¿ƒï¼ŒåŸ¹å…»èµ·å…´è¶£ï¼Œè¿™è·Ÿç©æ¸¸æˆä¸Šç˜¾æœ‰ç‚¹ç±»ä¼¼ï¼Œé€šè¿‡æ‰“æ€ªå‡çº§ï¼Œä¸€ç‚¹ç‚¹ç§¯ç´¯èµ·æˆå°±æ„Ÿã€‚æ¯”å¦‚å­¦ä¹ äº† Tomcat çš„çº¿ç¨‹æ± å®ç°ï¼Œæˆ‘ä»¬å°±å¯ä»¥è‡ªå·±å†™ä¸€ä¸ªå®šåˆ¶ç‰ˆçš„çº¿ç¨‹æ± ï¼›å­¦ä¹ äº† Tomcat çš„ç±»åŠ è½½å™¨ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±åŠ¨æ‰‹å†™ä¸€ä¸ªç±»åŠ è½½å™¨ã€‚</p>
<p class="component-content component">ä¸“æ æ›´æ–°åˆ°ç°åœ¨ï¼Œå†…å®¹æœ€éš¾çš„éƒ¨åˆ†å·²ç»ç»“æŸï¼Œåœ¨åé¢çš„å®æˆ˜è°ƒä¼˜æ¨¡å—ï¼Œæˆ‘åœ¨è®¾è®¡å†…å®¹æ—¶éƒ½å®‰æ’äº†å®æˆ˜ç¯èŠ‚ã€‚æ¯•ç«Ÿè°ƒä¼˜æœ¬èº«å°±æ˜¯ä¸€ä¸ªå¾ˆè´´è¿‘å®é™…åœºæ™¯çš„è¯é¢˜ï¼Œåº”è¯¥åŸºäºç‰¹å®šåœºæ™¯ï¼Œå»è§£å†³æŸä¸ªæ€§èƒ½é—®é¢˜ï¼Œè€Œä¸æ˜¯ä¸ºäº†è°ƒä¼˜è€Œè°ƒä¼˜ã€‚æ‰€ä»¥è¿™éƒ¨åˆ†å†…å®¹ä¹Ÿæ›´è´´è¿‘å®é™…å·¥ä½œåœºæ™¯ï¼Œä½ å¯ä»¥å°è¯•ç”¨æˆ‘å‰é¢è®²çš„æ–¹æ³•ï¼Œå¸¦ç€é—®é¢˜å­¦ä¹ åé¢çš„ä¸“æ ã€‚</p>
<p class="component-content component">è°ƒä¼˜çš„è¿‡ç¨‹ä¸­éœ€è¦ä¸€äº›çŸ¥è¯†å‚¨å¤‡ï¼Œæ¯”å¦‚æˆ‘ä»¬éœ€è¦æŒæ¡æ“ä½œç³»ç»Ÿã€JVM ä»¥åŠç½‘ç»œé€šä¿¡çš„åŸç†ï¼Œè¿™äº›åŸç†åœ¨ä¸“æ å‰é¢çš„æ–‡ç« ä¹Ÿè®²åˆ°è¿‡ã€‚è™½ç„¶æ¶‰åŠå¾ˆå¤šåŸç†ä¹Ÿå¾ˆå¤æ‚ï¼Œå¹¶ä¸æ˜¯è¯´è¦é¢é¢ä¿±åˆ°ï¼Œæˆ‘ä»¬ä¹Ÿä¸å¤ªå®¹æ˜“æ·±å…¥åˆ°æ¯ä¸ªç»†èŠ‚ï¼Œæ‰€ä»¥æœ€å…³é”®çš„æ˜¯è¦å¼„æ‡‚ç›¸å…³å‚æ•°çš„å«ä¹‰ï¼Œæ¯”å¦‚ JVM å†…å­˜çš„å‚æ•°ã€GC çš„å‚æ•°ã€Linux å†…æ ¸çš„ç›¸å…³å‚æ•°ç­‰ã€‚</p>
<p class="component-content component">é™¤æ­¤ä¹‹å¤–ï¼Œè°ƒä¼˜çš„è¿‡ç¨‹è¿˜éœ€è¦å€ŸåŠ©å¤§é‡çš„å·¥å…·ï¼ŒåŒ…æ‹¬æ€§èƒ½ç›‘æ§å·¥å…·ã€æ—¥å¿—åˆ†æå·¥å…·ã€ç½‘ç»œæŠ“åŒ…å·¥å…·å’Œæµé‡å‹æµ‹å·¥å…·ç­‰ï¼Œç†Ÿç»ƒä½¿ç”¨è¿™äº›å·¥å…·ä¹Ÿæ˜¯æ¯ä¸€ä¸ªåç«¯ç¨‹åºå‘˜å¿…é¡»æŒæ¡çš„çœ‹å®¶æœ¬é¢†ï¼Œå› æ­¤åœ¨å®æˆ˜ç¯èŠ‚ï¼Œæˆ‘ä¹Ÿè®¾è®¡äº†ä¸€äº›åœºæ™¯æ¥å¸¦ä½ ç†Ÿæ‚‰è¿™äº›å·¥å…·ã€‚</p>
<p class="component-content component">è¯´äº†é‚£ä¹ˆå¤šï¼Œå°±æ˜¯å¸Œæœ›ä½ ä¿æŒå¯¹å­¦ä¹ çš„çƒ­æƒ…ï¼Œæ ‘ç«‹æ˜ç¡®çš„ç›®æ ‡ï¼Œå†åŠ ä¸Šäº²è‡ªåŠ¨æ‰‹å®è·µã€‚ä¸“æ å­¦ä¹ åˆ°ç°åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæ˜¯æ—¶å€™å¼€å§‹åŠ¨æ‰‹å®è·µäº†ï¼Œå¸Œæœ›ä½ æ¯å¤©éƒ½èƒ½ç§¯ç´¯ä¸€ç‚¹ï¼Œæ¯å¤©éƒ½èƒ½æœ‰æ‰€è¿›æ­¥ã€‚</p>

          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  ç‰ˆæƒå£°æ˜: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">ç‰ˆæƒå£°æ˜ï¼šç½²å-éå•†ä¸šæ€§ä½¿ç”¨-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™… (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">ä½œè€…:  yuanshuai </p>
                <p class="content">å‘è¡¨æ—¥æœŸ:  2021å¹´11æœˆ26æ—¥</p>
              </div>
            </div>
          </div></article>
      </section>
  </main>

  <script>
    var script = document.createElement("script");script.src = "https://yuanshuai1122.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:shuaiyuan@gmail.com">shuaiyuan@gmail.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">ç¤¾äº¤åª’ä½“</div>
            
              <a href="https://github.com/yuanshuai1122" target="_blank">Github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">å‹é“¾</div>
            
              <a href="https://yuanshuaicn.com/" target="_blank">ğŸ‘‹</a>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2023
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
