<!DOCTYPE html>
<html class="js no-touch  progressive-image  no-reduced-motion progressive" lang="zh-hans">
  <head>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="/img/favicon.ico">

    <meta name="keyword" content=""><meta property="og:title" content="Redis之持久化" />
<meta property="og:description" content="1、RDB（Redis DataBase） 1.1、是什么 在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的Snapshot快照，它" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://yuanshuai1122.github.io/posts/redis%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96-redis%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-26T21:30:48+00:00" />
<meta property="article:modified_time" content="2021-11-26T21:30:48+00:00" />
<title>Redis之持久化</title>

    <link rel="canonical" href="/posts/redis%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96-redis%E4%B9%8B%E6%8C%81%E4%B9%85%E5%8C%96/">

    <link rel="stylesheet" href="/css/global.css">

    <link rel="stylesheet" href="/css/custom.css">

    <link rel="stylesheet" href="/css/search.css" />

    
    

    
    

</head>
  </head>
  <body class=" page-article   ">
    <header>
      <nav class="nav">
  <div class="nav-wrapper">
    <div class="nav-content-wrapper">
      <div class="nav-content">
        <a href="/ " class="nav-title">🧀</a>
        <div class="nav-menu">
          <div class="nav-item-wrapper">
            <a href="/posts " class="nav-item-content">目录</a>
          </div><div class="nav-item-wrapper">
            <a href="/about" class="nav-item-content">关于</a>
          </div><div class="nav-item-wrapper">
            <a href="/index.xml" class="nav-item-content" target="_blank">RSS</a>
          </div></div>
      </div>
    </div>
  </div>
</nav>

<script>
  function toggleSearchModal(){
    const template = `
    <div class="modal-body">
      <div id="autocomplete" onclick="event.stopPropagation();"></div>
    </div>
    `
    const modal = document.querySelector("#modal-wrapper")
    if(!modal){
      const div = document.createElement("div")
      document.body.setAttribute("style","overflow: hidden;")
      div.setAttribute("id", "modal-wrapper")
      div.setAttribute("onclick", "toggleSearchModal()")
      div.innerHTML = template
      const script = document.createElement("script");script.setAttribute("src", "https://yuanshuai1122.github.io/js/algolia.js")
      div.appendChild(script)
      document.body.append(div)
    } else {
      document.body.removeAttribute("style")
      document.body.removeChild(modal)
    }
  }
</script>
    </header>
    
  
  
  <main id="main" class="main">
      <section>
        <article class="article">
          
          <div class=" article-header ">
            <div class="category component">
              <div class="component-content">
                <div class="category-eyebrow">
                  <span class="category-eyebrow__category category_original">
                    
                      
                        数据库
                      
                    
                  </span>
                  <span class="category-eyebrow__date">2021年11月26日</span>
                </div>
              </div>
            </div>
            <div class="pagetitle component">
              <div class="component-content">
                <h1 class="hero-headline">Redis之持久化</h1>
              </div>
            </div>
            <div class="component  article-subhead ">
              <div class="component-content"></div>
            </div>

            <div class="tagssheet component">
              <div class="component-content">
                
                  
                  <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93" class="tag">
                    数据库
                  </a>
                
                  
                  <a href="/tags/redis" class="tag">
                    Redis
                  </a>
                
              </div>
            </div>
          </div>
          
          <div class="pagebody">
            
            
            
            
            
            
            
            
            
<div class="component-content pagebody component">
  <h1 id="1rdbredis-database" class="pagebody-header">
    1、RDB（Redis DataBase）
  </h1>
</div>
<div class="component-content pagebody component">
  <h2 id="11是什么" class="pagebody-header">
    1.1、是什么
  </h2>
</div><div class="component-content component"><ul>
<li>
<p class="component-content component">在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话讲的Snapshot快照，它恢复时是将快照文件直接读到内存里</p>
</li>
<li>
<p class="component-content component">Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何IO操作的，这就确保了极高的性能如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。RDB的缺点是最后一次持久化后的数据可能丢失。</p>
</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="12fork" class="pagebody-header">
    1.2、Fork
  </h2>
</div><p class="component-content component">Fork的作用是复制一个与当前进程一样的进程。新进程的所有数据（变量、环境变量、程序计数器等）数值都和原进程一致，但是是一个全新的进程，并作为原进程的子进程</p>

<div class="component-content pagebody component">
  <h2 id="13rdb-保存的是dumprdb文件" class="pagebody-header">
    1.3、Rdb 保存的是dump.rdb文件
  </h2>
</div>
<div class="component-content pagebody component">
  <h2 id="14配置位置" class="pagebody-header">
    1.4、配置位置
  </h2>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-934e72139aa4592d48cc06cd52fae098" id="lht934e72139aa4592d48cc06cd52fae098">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/redis/87.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="15如何触发rdb快照" class="pagebody-header">
    1.5、如何触发RDB快照
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="151配置文件中默认的快照配置" class="pagebody-header">
    1.5.1、配置文件中默认的快照配置
  </h3>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-697685abe67d9b575baf820944994dd8" id="lht697685abe67d9b575baf820944994dd8">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/redis/88.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">冷拷贝后重新使用</p>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-3aa3bc7efe34fdbb2926466f8908dc2f" id="lht3aa3bc7efe34fdbb2926466f8908dc2f">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/redis/89.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">可以cp dump.rdb dump_new.rdb</p>

<div class="component-content pagebody component">
  <h3 id="152命令save或者是bgsave" class="pagebody-header">
    1.5.2、命令save或者是bgsave
  </h3>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-ccc70421cb815fdf223262803cdd3e0c" id="lhtccc70421cb815fdf223262803cdd3e0c">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/redis/90.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<p class="component-content component">Save：save时只管保存，其它不管，全部阻塞</p>
<p class="component-content component">BGSAVE：Redis会在后台异步进行快照操作，快照同时还可以响应客户端请求。可以通过lastsave命令获取最后一次成功执行快照的时间</p>

<div class="component-content pagebody component">
  <h3 id="153执行flushall命令也会产生dumprdb文件但里面是空的无意义" class="pagebody-header">
    1.5.3、执行flushall命令，也会产生dump.rdb文件，但里面是空的，无意义
  </h3>
</div>
<div class="component-content pagebody component">
  <h2 id="16如何恢复" class="pagebody-header">
    1.6、如何恢复
  </h2>
</div><div class="component-content component"><ul>
<li>
<p class="component-content component">将备份文件 (dump.rdb) 移动到 redis 安装目录并启动服务即可</p>
</li>
<li>
<p class="component-content component">CONFIG GET dir获取目录</p>
</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="17优势" class="pagebody-header">
    1.7、优势
  </h2>
</div><div class="component-content component"><ul>
<li>
<p class="component-content component">适合大规模的数据恢复</p>
</li>
<li>
<p class="component-content component">对数据完整性和一致性要求不高</p>
</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="18劣势" class="pagebody-header">
    1.8、劣势
  </h2>
</div><div class="component-content component"><ul>
<li>
<p class="component-content component">在一定间隔时间做一次备份，所以如果redis意外down掉的话，就会丢失最后一次快照后的所有修改</p>
</li>
<li>
<p class="component-content component">Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑</p>
</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="19如何停止" class="pagebody-header">
    1.9、如何停止
  </h2>
</div><p class="component-content component">动态所有停止RDB保存规则的方法：redis-cli config set save &quot;&quot;</p>

<div class="component-content pagebody component">
  <h2 id="110小总结" class="pagebody-header">
    1.10、小总结
  </h2>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-b5edbbb5fd4d239d7e7506e3dcd3404f" id="lhtb5edbbb5fd4d239d7e7506e3dcd3404f">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/redis/91.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h1 id="2aofappend-only-file" class="pagebody-header">
    2、<strong>AOF</strong>（Append Only File）
  </h1>
</div>
<div class="component-content pagebody component">
  <h2 id="21是什么" class="pagebody-header">
    2.1、是什么
  </h2>
</div><p class="component-content component">以日志的形式来记录每个写操作，将Redis执行过的所有写指令记录下来(读操作不记录)，只许追加文件但不可以改写文件，redis启动之初会读取该文件重新构建数据，换言之，redis重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p>

<div class="component-content pagebody component">
  <h2 id="22aof保存的是appendonlyaof文件" class="pagebody-header">
    2.2、Aof保存的是appendonly.aof文件
  </h2>
</div>
<div class="component-content pagebody component">
  <h2 id="23配置位置" class="pagebody-header">
    2.3、配置位置
  </h2>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-4099fececfbca350a3ab23ceecd257b2" id="lht4099fececfbca350a3ab23ceecd257b2">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/redis/92.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h2 id="24aof启动修复恢复" class="pagebody-header">
    2.4、AOF启动/修复/恢复
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="241正常恢复" class="pagebody-header">
    2.4.1、正常恢复
  </h3>
</div><div class="component-content component"><ul>
<li>启动：设置Yes
<div class="component-content component"><ul>
<li>修改默认的appendonly no，改为yes</li>
</ul></div>
</li>
<li>将有数据的aof文件复制一份保存到对应目录(config get dir)</li>
<li>恢复：重启redis然后重新加载</li>
</ul></div>

<div class="component-content pagebody component">
  <h3 id="242异常恢复" class="pagebody-header">
    2.4.2、异常恢复
  </h3>
</div><div class="component-content component"><ul>
<li>启动：设置Yes
<div class="component-content component"><ul>
<li>修改默认的appendonly no，改为yes</li>
</ul></div>
</li>
<li>备份被写坏的AOF文件
<div class="component-content component"><ul>
<li>修复：Redis-check-aof &ndash;fix进行修复</li>
</ul></div>
</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-3a8a5b8b94b337aa310df3d65fdc21a6" id="lht3a8a5b8b94b337aa310df3d65fdc21a6">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/redis/93.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li></li>
<li>恢复：重启redis然后重新加载</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="25rewrite" class="pagebody-header">
    2.5、Rewrite
  </h2>
</div>
<div class="component-content pagebody component">
  <h3 id="251是什么" class="pagebody-header">
    2.5.1、是什么
  </h3>
</div><p class="component-content component">AOF采用文件追加方式，文件会越来越大为避免出现此种情况，新增了重写机制,当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集.可以使用命令bgrewriteaof</p>

<div class="component-content pagebody component">
  <h3 id="252重写原理" class="pagebody-header">
    2.5.2、重写原理
  </h3>
</div><p class="component-content component">AOF文件持续增长而过大时，会fork出一条新进程来将文件重写(也是先写临时文件最后再rename)，遍历新进程的内存中数据，每条记录有一条的Set语句。重写aof文件的操作，并没有读取旧的aof文件，而是将整个内存中的数据库内容用命令的方式重写了一个新的aof文件，这点和快照有点类似</p>

<div class="component-content pagebody component">
  <h3 id="253触发机制" class="pagebody-header">
    2.5.3、触发机制
  </h3>
</div><p class="component-content component">Redis会记录上次重写时的AOF大小，默认配置是当AOF文件大小是上次rewrite后大小的一倍且文件大于64M时触发</p>

<div class="component-content pagebody component">
  <h2 id="26优势" class="pagebody-header">
    2.6、优势
  </h2>
</div><div class="component-content component"><ul>
<li>
<p class="component-content component">每修改同步：appendfsync always  同步持久化 每次发生数据变更会被立即记录到磁盘 性能较差但数据完整性比较好</p>
</li>
<li>
<p class="component-content component">每秒同步：appendfsync everysec  异步操作，每秒记录  如果一秒内宕机，有数据丢失</p>
</li>
<li>
<p class="component-content component">不同步：appendfsync no  从不同步</p>
</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="27劣势" class="pagebody-header">
    2.7、劣势
  </h2>
</div><div class="component-content component"><ul>
<li>
<p class="component-content component">相同数据集的数据而言aof文件要远大于rdb文件，恢复速度慢于rdb</p>
</li>
<li>
<p class="component-content component">Aof运行效率要慢于rdb,每秒同步策略效率较好，不同步效率和rdb相同</p>
</li>
</ul></div>

<div class="component-content pagebody component">
  <h2 id="28小总结" class="pagebody-header">
    2.8、小总结
  </h2>
</div><p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-959b1701b11b2ae87890f610247032c8" id="lht959b1701b11b2ae87890f610247032c8">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/redis/94.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>

<div class="component-content pagebody component">
  <h1 id="3总结which-one" class="pagebody-header">
    3、<strong>总结</strong>(Which one)
  </h1>
</div><div class="component-content component"><ul>
<li>官网建议</li>
</ul></div>
<p class="component-content component">








<figure class="image component image-fullbleed body-copy-wide nr-scroll-animation nr-scroll-animation--on image-big">  <div class="component-content">
    <div class="image-sharesheet">
      <div class="image image-load image-asset image-3232e0161b7460490fbea1a0ef6a2e5b" id="lht3232e0161b7460490fbea1a0ef6a2e5b">
        <picture  class="picture">
          <img class="picture-image" data-src="https://hexobbblog.oss-cn-beijing.aliyuncs.com/images/redis/95.png" alt=""  />
        </picture>
      </div>
    </div>
    <div class="image-description">
      <div class="image-caption">
        
      </div>
    </div>
  </div>
</figure>
</p>
<div class="component-content component"><ul>
<li>
<p class="component-content component">RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储</p>
</li>
<li>
<p class="component-content component">AOF持久化方式记录每次对服务器写的操作,当服务器重启的时候会重新执行这些命令来恢复原始的数据,AOF命令以redis协议追加保存每次写的操作到文件末尾，Redis还能对AOF文件进行后台重写,使得AOF文件的体积不至于过大</p>
</li>
<li>
<p class="component-content component">只做缓存：如果你只希望你的数据在服务器运行的时候存在,你也可以不使用任何持久化方式.</p>
</li>
<li>
<p class="component-content component">同时开启两种持久化方式</p>
<div class="component-content component"><ul>
<li>在这种情况下,当redis重启的时候会优先载入AOF文件来恢复原始的数据,因为在通常情况下AOF文件保存的数据集要比RDB文件保存的数据集要完整.</li>
<li>RDB的数据不实时，同时使用两者时服务器重启也只会找AOF文件。那要不要只使用AOF呢？作者建议不要，因为RDB更适合用于备份数据库(AOF在不断变化不好备份)，快速重启，而且不会有AOF可能潜在的bug，留着作为一个万一的手段。</li>
</ul></div>
</li>
<li>
<p class="component-content component">性能建议</p>
<div class="component-content component"><ul>
<li>因为RDB文件只用作后备用途，建议只在Slave上持久化RDB文件，而且只要15分钟备份一次就够了，只保留save 900 1这条规则。</li>
<li>如果Enalbe AOF，好处是在最恶劣情况下也只会丢失不超过两秒数据，启动脚本较简单只load自己的AOF文件就可以了。代价一是带来了持续的IO，二是AOF rewrite的最后将rewrite过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。只要硬盘许可，应该尽量减少AOF rewrite的频率，AOF重写的基础大小默认值64M太小了，可以设到5G以上。默认超过原大小100%大小时重写可以改到适当的数值。</li>
<li>如果不Enable AOF ，仅靠Master-Slave Replication 实现高可用性也可以。能省掉一大笔IO也减少了rewrite时带来的系统波动。代价是如果Master/Slave同时倒掉，会丢失十几分钟的数据，启动脚本也要比较两个Master/Slave中的RDB文件，载入较新的那个。新浪微博就选用了这种架构</li>
</ul></div>
</li>
</ul></div>

          </div><div class="component">
            <div class="component-content">
              <div class="article-copyright">
                <p class="content">
                  版权声明: <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">版权声明：署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0)</a>
                </p>
                <p class="content">作者:  yuanshuai </p>
                <p class="content">发表日期:  2021年11月26日</p>
              </div>
            </div>
          </div></article>
      </section>
  </main>

  <script>
    var script = document.createElement("script");script.src = "https://yuanshuai1122.github.io/js/initPost.js";
    document.head.appendChild(script);
  </script>

    
    <div class="footer-main ">
  <div class="content-body footer-wraper">
    <div class="footer-box">
      <div class="foot-nav">
        <div class="foot-nav-items">
          <div class="item">
            <div class="logo"></div>
            <div class="email">Email: <a href="mailto:shuaiyuan@gmail.com">shuaiyuan@gmail.com</a></div>
          </div>

          <div class="item community">
            <div class="item-title">社交媒体</div>
            
              <a href="https://github.com/yuanshuai1122" target="_blank">Github</a>
            
          </div>

          <div class="item resources">
            <div class="item-title">友链</div>
            
              <a href="https://yuanshuaicn.com/" target="_blank">👋</a>
            
          </div>
        </div>
      </div>
      <div class="bottom">
        <div class="item copyright">
          &copy; 2023
          Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> & <a href="https://github.com/floyd-li/hugo-theme-itheme" target="_blank">iTheme</a>
        </div>
      </div>
    </div>
  </div>
</div>

  </body>
    
    

    
    
</html>
